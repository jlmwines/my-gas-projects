<div class="container-fluid">
    <h1 class="mt-4">Orders</h1>

    <!-- Section for Open Orders -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Open Orders</h5> <!-- Actual Title -->
          <a href="#" id="trigger-web-order-import-link" class="text-primary text-decoration-none">Import Web Orders</a> <!-- Text link to trigger action -->
      </div>
      <div class="card-body">
          <div id="open-orders-list"></div>
          <div id="web-order-import-status" class="mt-2 small text-center"></div>
      </div>
    </div>
</div>

<script>
  // showToast function should ideally be global from AppView or a shared JS library,
  // but if not, it needs to be defined within each view that uses it.
  // For now, assuming it's defined in AppView.html or globally.
  // This version assumes it's defined in AppView.html or globally.

  function loadOpenOrdersData() {
    const openOrdersListDiv = document.getElementById('open-orders-list');
    if (!openOrdersListDiv) return; // Guard against element not existing
    openOrdersListDiv.innerHTML = 'Loading open orders...';

    try {
      google.script.run
        .withSuccessHandler(orders => {
          if (orders.length === 0) {
            openOrdersListDiv.innerHTML = '<p>No open orders (on-hold or processing).</p>';
            return;
          }

          let tableHtml = '<table class="table table-hover"><thead><tr><th>Order ID</th><th>Status</th><th>Order Date</th><th>Customer Name</th><th>Shipping City</th></tr></thead><tbody>';
          orders.forEach(order => {
            tableHtml += `<tr>
                            <td>${order.orderId}</td>
                            <td>${order.status}</td>
                            <td>${order.orderDate}</td>
                            <td>${order.customerName}</td>
                            <td>${order.shippingCity}</td>
                          </tr>`;
          });
          tableHtml += '</tbody></table>';
          openOrdersListDiv.innerHTML = tableHtml;
        })
        .withFailureHandler(err => {
          openOrdersListDiv.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
          if (window.parent && window.parent.showError) {
              window.parent.showError(err); // Call parent's showError
          } else {
              console.error('Failed to load open orders:', err);
              alert('Failed to load open orders: ' + err.message);
          }
        })
        .WebAppOrders_getOpenOrdersForManager(); // Reuse the manager function
    } catch (e) {
      if (window.parent && window.parent.showError) {
          window.parent.showError(e); // Call parent's showError
      } else {
          console.error('Client-side error in loadOpenOrdersData: ' + e.message);
          alert('A client-side error occurred: ' + e.message);
      }
    }
  }

  function handleTriggerWebOrderImport(event) {
      event.preventDefault(); // Prevent default link behavior
      const link = document.getElementById('trigger-web-order-import-link');
      const statusDiv = document.getElementById('web-order-import-status');
      const originalText = link.textContent;
      link.textContent = 'Importing...';
      link.style.pointerEvents = 'none'; // Disable link
      statusDiv.innerHTML = '';

      google.script.run
          .withSuccessHandler(response => {
              if (response.success) {
                  statusDiv.innerHTML = `<span class="text-success">${response.message}</span>`;
                  if (window.parent && window.parent.showToast) {
                      window.parent.showToast(response.message);
                  }
                  loadOpenOrdersData(); // Refresh order list after import
              } else {
                  statusDiv.innerHTML = `<span class="text-danger">Error: ${response.message}</span>`;
                   if (window.parent && window.parent.showToast) {
                      window.parent.showToast(`Error: ${response.message}`, 'error');
                   }
              }
              link.textContent = originalText;
              link.style.pointerEvents = 'auto'; // Re-enable link
          })
          .withFailureHandler(err => {
              statusDiv.innerHTML = `<span class="text-danger">Error: ${err.message}</span>`;
              if (window.parent && window.parent.showToast) {
                 window.parent.showToast(`Error: ${err.message}`, 'error');
              }
              console.error('Web Order Import failed:', err);
              link.textContent = originalText;
              link.style.pointerEvents = 'auto'; // Re-enable link
          })
          .WebAppOrders_triggerWebOrderImport();
  }

  // Self-execute to load the data and attach event listeners as soon as the view is loaded.
  loadOpenOrdersData();
  const importLink = document.getElementById('trigger-web-order-import-link');
  if (importLink) {
      importLink.addEventListener('click', handleTriggerWebOrderImport);
  }
