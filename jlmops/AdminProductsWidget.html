<div id="products-widget" style="padding: 0;">
  <p>Loading...</p>
</div>

<script>
  /**
   * Populates the products widget.
   * @param {Object} dashboardData - The full dashboard data from the backend.
   */
  function adminProductsWidget_updateView(dashboardData) {
    const widget = document.getElementById('products-widget');
    if (dashboardData.error) {
      widget.innerHTML = `<p class="text-danger">${dashboardData.error}</p>`;
      return;
    }

    let html = '';

    // Check for blocked product import job
    if (dashboardData.blockedJobs && dashboardData.blockedJobs.length > 0) {
      const productJob = dashboardData.blockedJobs.find(job => job.jobType === 'import.drive.web_products_en');
      if (productJob) {
        html += `<div class="alert alert-info p-2" style="font-size: 0.9rem;">
                   <strong>Workflow Paused:</strong><br>Product import is waiting for the 'Web Translations' file to be processed.
                 </div>`;
      }
    }

    html += '<h5>Product Tasks</h5>';
    const data = dashboardData.productData;
    const taskLabels = {
      'task.validation.sku_not_in_comax': 'SKU Not in Comax',
      'task.validation.translation_missing': 'Translation Missing',
      'task.validation.comax_internal_audit': 'Comax Internal Audit',
      'task.validation.field_mismatch': 'Field Mismatch',
      'task.validation.name_mismatch': 'Name Mismatch',
      'task.validation.web_master_discrepancy': 'Web Master Discrepancy',
      'task.validation.comax_master_discrepancy': 'Comax Master Discrepancy',
      'task.validation.row_count_decrease': 'Row Count Decrease',
      'task.validation.comax_not_web_product': 'Comax Not Web Product'
    };

    let hasTasks = false;
    if (data) {
        for (const taskType in data) {
          if (data.hasOwnProperty(taskType) && data[taskType] > 0) {
            hasTasks = true;
            const label = taskLabels[taskType] || taskType;
            html += `<p>${label}: <span class="badge badge-warning">${data[taskType]}</span></p>`;
          }
        }
    }

    if (!hasTasks) {
      html += '<p>No open product tasks.</p>';
    }

    // TODO: If a "Web Product Detail Update Export" feature is implemented, add a UI element here
    // to trigger the export and create a corresponding confirmation task.

    widget.innerHTML = html;
  }

  // Initial data load for this view
  google.script.run.withSuccessHandler(adminProductsWidget_updateView).withFailureHandler(showError).getDashboardData();
</script>