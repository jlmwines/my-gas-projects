<div class="container-fluid">
  <div class="row mb-3">
    <div class="col-12">
      <h4>Dashboard</h4>
      <small id="dashboard-timestamp" class="text-muted"></small>
    </div>
  </div>

  <!-- Row 1: System Health, Orders, Inventory, Products -->
  <div class="row">
    <div class="col-md-3">
      <div class="card">
        <div class="card-header">System Health</div>
        <div class="card-body" id="card-system">
          <p class="text-muted">Loading...</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-header">Orders</div>
        <div class="card-body" id="card-orders">
          <p class="text-muted">Loading...</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-header">Inventory</div>
        <div class="card-body" id="card-inventory">
          <p class="text-muted">Loading...</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-header">Products</div>
        <div class="card-body" id="card-products">
          <p class="text-muted">Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 2: Projects, Admin Tasks -->
  <div class="row mt-3">
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">Projects</div>
        <div class="card-body" id="card-projects">
          <p class="text-muted">Loading...</p>
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">Admin Tasks</div>
        <div class="card-body" id="card-tasks" style="max-height: 300px; overflow-y: auto;">
          <p class="text-muted">Loading...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  function loadDashboard() {
    google.script.run
      .withSuccessHandler(handleData)
      .withFailureHandler(handleError)
      .WebAppDashboardV2_getData();
  }

  function handleData(response) {
    if (!response.success) {
      handleError({ message: response.error });
      return;
    }

    var data = response.data;

    // Timestamp
    document.getElementById('dashboard-timestamp').textContent =
      'Updated: ' + new Date(data.timestamp).toLocaleTimeString();

    // Cards
    renderSystemHealthCard(data.systemHealth);
    renderOrdersCard(data.orders);
    renderInventoryCard(data.inventory);
    renderProductsCard(data.products);
    renderProjectsCard(data.projects);
    renderTasksCard(data.adminTasks);
  }

  function handleError(err) {
    console.error('Dashboard error:', err);
    document.querySelectorAll('.card-body').forEach(function(el) {
      el.innerHTML = '<p class="text-danger">Error loading data</p>';
    });
  }

  function formatTime(isoString) {
    if (!isoString) return 'Never';
    var d = new Date(isoString);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  function formatDate(isoString) {
    if (!isoString) return '-';
    return new Date(isoString).toLocaleDateString();
  }

  function statusIcon(status) {
    if (status === 'ok') return '<span class="text-success">&#10003;</span>';
    if (status === 'issues' || status === 'partial') return '<span class="text-warning">&#9888;</span>';
    if (status === 'error') return '<span class="text-danger">&#10007;</span>';
    return '<span class="text-muted">?</span>';
  }

  function formatTimeAgo(timestamp) {
    if (!timestamp) return '';
    var now = new Date();
    var then = new Date(timestamp);
    var diffMs = now - then;
    var diffMins = Math.floor(diffMs / 60000);
    var diffHours = Math.floor(diffMs / 3600000);
    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return diffMins + ' min ago';
    if (diffHours < 24) return diffHours + ' hr ago';
    return Math.floor(diffMs / 86400000) + ' days ago';
  }

  function renderSystemHealthCard(health) {
    var el = document.getElementById('card-system');

    if (!health || !health.available) {
      el.innerHTML = '<p class="text-muted">No health data available</p>';
      return;
    }

    var html = '';

    // Urgent Alerts first (most important)
    if (health.urgentAlerts && health.urgentAlerts.length > 0) {
      html += '<div class="mb-2">';
      health.urgentAlerts.forEach(function(alert) {
        var alertClass = alert.severity === 'Critical' ? 'bg-danger text-white' : 'bg-warning';
        html += '<div class="p-2 mb-1 rounded small ' + alertClass + '">';
        html += '<strong>' + alert.message + '</strong>';
        html += '<div style="font-size: 0.75rem;">' + formatTimeAgo(alert.timestamp) + '</div>';
        html += '</div>';
      });
      html += '</div>';
    }

    html += '<table class="table table-sm mb-0"><tbody>';

    // Daily Sync
    if (health.dailySync) {
      var syncStatus = health.dailySync.status;
      var syncStage = health.dailySync.stage;
      var syncLabel = 'Daily Sync';
      if (syncStage && syncStage !== 'COMPLETE' && syncStage !== 'IDLE') {
        syncLabel += ' (' + syncStage.replace(/_/g, ' ').toLowerCase() + ')';
      }
      html += '<tr><td>' + statusIcon(syncStatus) + ' ' + syncLabel + '</td>';
      html += '<td class="text-right small text-muted">' + formatTime(health.dailySync.timestamp) + '</td></tr>';
    }

    // Housekeeping
    var hkExtra = '';
    if (health.housekeeping.failures && health.housekeeping.failures.length > 0) {
      hkExtra = ' <span class="text-danger">(' + health.housekeeping.failures.length + ' failed)</span>';
    }
    html += '<tr><td>' + statusIcon(health.housekeeping.status) + ' Housekeeping' + hkExtra + '</td>';
    html += '<td class="text-right small text-muted">' + formatTime(health.housekeeping.timestamp) + '</td></tr>';
    if (health.housekeeping.failures && health.housekeeping.failures.length > 0) {
      html += '<tr><td colspan="2" class="small text-danger pl-4">Failed: ' + health.housekeeping.failures.join(', ') + '</td></tr>';
    }

    // Schema Validation
    html += '<tr><td>' + statusIcon(health.schemaValidation.status) + ' Schema Validation</td>';
    html += '<td class="text-right small text-muted">' + formatTime(health.schemaValidation.timestamp) + '</td></tr>';

    // Data Validation
    var dvStatus = health.dataValidation.status;
    var dvExtra = health.dataValidation.issues > 0 ? ' (' + health.dataValidation.issues + ')' : '';
    html += '<tr><td>' + statusIcon(dvStatus) + ' Data Validation' + dvExtra + '</td>';
    html += '<td class="text-right small text-muted">' + formatTime(health.dataValidation.timestamp) + '</td></tr>';

    // Unit Tests
    var utExtra = health.unitTests.result ? ' (' + health.unitTests.result + ')' : '';
    html += '<tr><td>' + statusIcon(health.unitTests.status) + ' Unit Tests' + utExtra + '</td>';
    html += '<td class="text-right small text-muted">' + formatTime(health.unitTests.timestamp) + '</td></tr>';

    html += '</tbody></table>';
    el.innerHTML = html;
  }

  function renderOrdersCard(orders) {
    var el = document.getElementById('card-orders');

    if (orders.error) {
      el.innerHTML = '<p class="text-danger">' + orders.error + '</p>';
      return;
    }

    var html = '<table class="table table-sm mb-0"><tbody>';

    // Packing slips - highlight if there are any ready
    var packingClass = orders.packingReady > 0 ? 'table-warning' : '';
    var packingIcon = orders.packingReady > 0 ? '<span class="text-warning">&#9888;</span> ' : '';
    html += '<tr class="' + packingClass + '"><td>' + packingIcon + 'Packing Slips</td><td class="text-right"><strong>' + orders.packingReady + '</strong></td></tr>';

    html += '<tr><td>New Orders</td><td class="text-right"><strong>' + orders.newOrders + '</strong></td></tr>';
    html += '<tr><td>Orders to Export</td><td class="text-right"><strong>' + orders.ordersToExport + '</strong></td></tr>';
    html += '<tr><td>On Hold</td><td class="text-right"><strong>' + orders.onHold + '</strong></td></tr>';
    html += '<tr><td>Processing</td><td class="text-right"><strong>' + orders.processing + '</strong></td></tr>';
    html += '</tbody></table>';

    el.innerHTML = html;
  }

  function renderInventoryCard(inv) {
    var el = document.getElementById('card-inventory');

    if (inv.error) {
      el.innerHTML = '<p class="text-danger">' + inv.error + '</p>';
      return;
    }

    var html = '<table class="table table-sm mb-0"><tbody>';
    var bruryaDays = inv.bruryaDaysSince;
    var bruryaOverdue = bruryaDays !== null && bruryaDays > 7;
    var bruryaClass = bruryaOverdue ? 'table-warning' : '';
    var bruryaIcon = bruryaOverdue ? '<span class="text-warning">&#9888;</span> ' : '';
    var bruryaValue = bruryaDays !== null ? bruryaDays + ' days' : '-';
    html += '<tr class="' + bruryaClass + '"><td>' + bruryaIcon + 'Brurya Update</td><td class="text-right"><strong>' + bruryaValue + '</strong></td></tr>';
    html += '<tr><td>Negative Inventory</td><td class="text-right"><strong>' + inv.negativeInventory + '</strong></td></tr>';
    html += '<tr><td>Count Tasks</td><td class="text-right"><strong>' + inv.inventoryCountTasks + '</strong></td></tr>';
    html += '<tr><td>Counts in Review</td><td class="text-right"><strong>' + inv.inventoryAwaitingReview + '</strong></td></tr>';
    html += '</tbody></table>';

    el.innerHTML = html;
  }

  function renderProductsCard(prod) {
    var el = document.getElementById('card-products');

    if (prod.error) {
      el.innerHTML = '<p class="text-danger">' + prod.error + '</p>';
      return;
    }

    var html = '<table class="table table-sm mb-0"><tbody>';
    html += '<tr><td>Vintage Update</td><td class="text-right"><strong>' + prod.vintageUpdate + '</strong></td></tr>';
    html += '<tr><td>Detail Review</td><td class="text-right"><strong>' + prod.detailReview + '</strong></td></tr>';
    html += '<tr><td>New Suggestions</td><td class="text-right"><strong>' + prod.newProductSuggestion + '</strong></td></tr>';
    html += '<tr><td>New - Edit</td><td class="text-right"><strong>' + prod.newProductEdit + '</strong></td></tr>';
    html += '<tr><td>New - Review</td><td class="text-right"><strong>' + prod.newProductReview + '</strong></td></tr>';
    if (prod.bundleCritical > 0) {
      html += '<tr class="table-danger"><td>Bundle Critical</td><td class="text-right"><strong>' + prod.bundleCritical + '</strong></td></tr>';
    } else {
      html += '<tr><td>Bundle Critical</td><td class="text-right text-success"><strong>0</strong></td></tr>';
    }
    html += '<tr><td>Bundle Low</td><td class="text-right"><strong>' + prod.bundleLow + '</strong></td></tr>';
    html += '<tr><td>Category Low</td><td class="text-right"><strong>' + prod.categoryLow + '</strong></td></tr>';
    html += '</tbody></table>';

    el.innerHTML = html;
  }

  function renderProjectsCard(projects) {
    var el = document.getElementById('card-projects');
    var html = '<table class="table table-sm table-hover mb-0"><tbody>';
    projects.forEach(function(proj) {
      var badge = proj.taskCount > 0 ? '<strong>' + proj.taskCount + '</strong>' : '<span class="text-success">0</span>';
      html += '<tr class="project-row" data-project-id="' + proj.id + '" style="cursor:pointer;"><td>' + proj.name + '</td><td class="text-right">' + badge + '</td></tr>';
    });
    html += '</tbody></table>';
    el.innerHTML = html;

    // Add click handlers to navigate to Projects view
    el.querySelectorAll('.project-row').forEach(function(row) {
      row.addEventListener('click', function() {
        var projectId = this.dataset.projectId;
        sessionStorage.setItem('selectProjectId', projectId);
        loadView('AdminProjects');
      });
    });
  }

  function renderTasksCard(tasks) {
    var el = document.getElementById('card-tasks');

    if (!tasks || tasks.length === 0) {
      el.innerHTML = '<p class="text-success mb-0">No open tasks</p>';
      return;
    }

    var html = '<table class="table table-sm table-hover mb-0"><thead><tr>';
    html += '<th>Task</th><th>Entity</th><th>Due</th>';
    html += '</tr></thead><tbody>';

    tasks.forEach(function(task) {
      var priorityClass = '';
      if (task.priority === 'Critical') priorityClass = 'table-danger';
      else if (task.priority === 'High') priorityClass = 'table-warning';

      var entityDisplay = task.entityName || task.entityId || '-';
      if (entityDisplay.length > 20) entityDisplay = entityDisplay.substring(0, 17) + '...';

      var dueDisplay = formatDate(task.dueDate);

      html += '<tr class="task-row ' + priorityClass + '" data-task-id="' + task.id + '" data-project-id="' + (task.projectId || '') + '" style="cursor:pointer;">';
      html += '<td title="' + task.typeId + '">' + task.name + '</td>';
      html += '<td title="' + task.entityId + '">' + entityDisplay + '</td>';
      html += '<td>' + dueDisplay + '</td>';
      html += '</tr>';
    });

    html += '</tbody></table>';
    el.innerHTML = html;

    // Add click handlers to navigate to task in Projects view
    el.querySelectorAll('.task-row').forEach(function(row) {
      row.addEventListener('click', function() {
        var taskId = this.dataset.taskId;
        var projectId = this.dataset.projectId;
        // Store selection for Projects view to pick up
        sessionStorage.setItem('selectTaskId', taskId);
        sessionStorage.setItem('selectProjectId', projectId);
        // Navigate to Projects view
        loadView('AdminProjects');
      });
    });
  }

  // Load on init
  loadDashboard();
})();
</script>
