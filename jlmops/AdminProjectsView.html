<div class="container-fluid">
  <div class="row">
    <!-- LEFT COLUMN: Navigation -->
    <div class="col-md-8">
      <div class="card" style="height: calc(100vh - 120px);">
        <!-- Header: Nav + Breadcrumb + New button -->
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <button id="btn-home" class="btn btn-sm btn-light mr-1" title="Home">⌂</button>
            <button id="btn-back" class="btn btn-sm btn-light mr-2" title="Back" style="display:none;">←</button>
            <span id="breadcrumb">Projects</span>
          </div>
          <button id="btn-new" class="btn btn-sm btn-light">+ Project</button>
        </div>

        <!-- Subheader: Column headers + filters (Projects mode) -->
        <div id="subheader-projects" class="border-bottom bg-light px-2 py-1">
          <div class="row small font-weight-bold text-muted">
            <div class="col-5">
              <a href="#" class="text-muted sort-col" data-field="name">Name <span id="sort-icon-name">▾</span></a>
            </div>
            <div class="col-3">
              <select id="filter-project-status" class="form-control form-control-sm py-0" style="height:22px;font-size:11px;">
                <option value="all">Status</option>
                <option value="PLANNING">Planning</option>
                <option value="ACTIVE">Active</option>
                <option value="COMPLETED">Completed</option>
              </select>
            </div>
            <div class="col-2 text-center">Tasks</div>
            <div class="col-2"></div>
          </div>
        </div>

        <!-- Subheader: Column headers + filters (Tasks mode) -->
        <div id="subheader-tasks" class="border-bottom bg-light px-2 py-1" style="display:none;">
          <div class="row small font-weight-bold text-muted align-items-center">
            <div class="col-3">Title</div>
            <div class="col-2">
              <select id="filter-task-assignee" class="form-control form-control-sm py-0" style="height:24px;font-size:11px;">
                <option value="all">Assignee</option>
              </select>
            </div>
            <div class="col-1">
              <select id="filter-task-status" class="form-control form-control-sm py-0" style="height:24px;font-size:11px;">
                <option value="all">Status</option>
              </select>
            </div>
            <div class="col-2">
              <select id="filter-task-priority" class="form-control form-control-sm py-0" style="height:24px;font-size:11px;">
                <option value="all">Priority</option>
              </select>
            </div>
            <div class="col-1">
              <a href="#" class="text-muted sort-col" data-field="due">Due <span id="sort-icon-due"></span></a>
            </div>
            <div class="col-1">Done</div>
            <div class="col-2 text-right">
              <label class="mb-0 small" style="font-weight:normal;">
                <input type="checkbox" id="toggle-show-all"> Show all
              </label>
            </div>
          </div>
        </div>

        <!-- List Area -->
        <div class="card-body p-0" style="overflow-y: auto;">
          <div id="list-container"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN: Detail Panel -->
    <div class="col-md-4">
      <div class="card" style="height: calc(100vh - 120px);">
        <div class="card-header py-2">
          <strong id="detail-title">Overview</strong>
        </div>
        <div class="card-body" style="overflow-y: auto;">
          <!-- Default: Stats summary -->
          <div id="detail-summary">
            <div class="row text-center mb-4">
              <div class="col">
                <div class="h3 mb-0" id="stat-total">-</div>
                <div class="small text-muted">Projects</div>
              </div>
              <div class="col">
                <div class="h3 mb-0 text-success" id="stat-active">-</div>
                <div class="small text-muted">Active</div>
              </div>
              <div class="col">
                <div class="h3 mb-0" id="stat-tasks">-</div>
                <div class="small text-muted">Open Tasks</div>
              </div>
              <div class="col">
                <div class="h3 mb-0 text-danger" id="stat-critical">-</div>
                <div class="small text-muted">Critical</div>
              </div>
            </div>
          </div>

          <!-- Project detail form -->
          <div id="detail-project" style="display:none;">
            <form id="project-form">
              <div class="form-group">
                <label class="small font-weight-bold">Project Name</label>
                <input type="text" class="form-control" id="field-name">
              </div>
              <div class="form-row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="small font-weight-bold">Type</label>
                    <select class="form-control" id="field-type">
                      <option value="ONE_OFF">One-Off</option>
                      <option value="CAMPAIGN">Campaign</option>
                      <option value="OPERATIONAL">Operational</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="small font-weight-bold">Status</label>
                    <select class="form-control" id="field-status">
                      <option value="PLANNING">Planning</option>
                      <option value="ACTIVE">Active</option>
                      <option value="COMPLETED">Completed</option>
                      <option value="ARCHIVED">Archived</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="form-row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="small font-weight-bold">Start Date</label>
                    <input type="date" class="form-control" id="field-start-date">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="small font-weight-bold">End Date</label>
                    <input type="date" class="form-control" id="field-end-date">
                  </div>
                </div>
              </div>
              <hr>
              <button type="button" id="btn-save-project" class="btn btn-light">Save Changes</button>
            </form>
          </div>

          <!-- Task detail form -->
          <div id="detail-task" style="display:none;">
            <form id="task-form">
              <div class="form-group">
                <label class="small font-weight-bold">Title</label>
                <input type="text" class="form-control" id="task-field-title" readonly>
              </div>
              <div class="form-row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="small font-weight-bold">Status</label>
                    <select class="form-control" id="task-field-status"></select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="small font-weight-bold">Priority</label>
                    <select class="form-control" id="task-field-priority">
                      <option value="Critical">Critical</option>
                      <option value="High">High</option>
                      <option value="Normal">Normal</option>
                      <option value="Low">Low</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="form-row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="small font-weight-bold">Assigned To</label>
                    <input type="text" class="form-control" id="task-field-assignee" readonly>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="small font-weight-bold">Due Date</label>
                    <input type="text" class="form-control" id="task-field-due" readonly>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label class="small font-weight-bold">Linked Entity</label>
                <input type="text" class="form-control" id="task-field-entity" readonly>
              </div>
              <div class="form-group">
                <label class="small font-weight-bold">Notes</label>
                <textarea class="form-control" id="task-field-notes" rows="3" readonly></textarea>
              </div>
              <hr>
              <div class="d-flex justify-content-between">
                <button type="button" id="btn-save-task" class="btn btn-light">Save Status</button>
                <div>
                  <button type="button" id="btn-complete-task" class="btn btn-light mr-2">Mark Done</button>
                  <button type="button" id="btn-cancel-task" class="btn btn-light">Cancel Task</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-body py-4">
        <p id="confirm-message" class="mb-0 text-center">Are you sure?</p>
      </div>
      <div class="modal-footer py-2 justify-content-center">
        <button type="button" class="btn btn-sm btn-light" data-dismiss="modal">No</button>
        <button type="button" class="btn btn-sm btn-danger" id="confirm-yes">Yes</button>
      </div>
    </div>
  </div>
</div>

<!-- New Project Modal -->
<div class="modal fade" id="newProjectModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">New Project</h6>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="new-project-form">
          <div class="form-group">
            <input type="text" class="form-control form-control-sm" id="new-project-name" placeholder="Project name" required>
          </div>
          <div class="form-row">
            <div class="col">
              <select class="form-control form-control-sm" id="new-project-type">
                <option value="ONE_OFF">One-Off</option>
                <option value="CAMPAIGN">Campaign</option>
                <option value="OPERATIONAL">Operational</option>
              </select>
            </div>
            <div class="col">
              <select class="form-control form-control-sm" id="new-project-status">
                <option value="PLANNING">Planning</option>
                <option value="ACTIVE">Active</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-sm btn-light" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-sm btn-light" id="btn-create-project">Create</button>
      </div>
    </div>
  </div>
</div>

<!-- New Task Modal -->
<div class="modal fade" id="newTaskModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">New Task</h6>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="new-task-form">
          <div class="form-group">
            <input type="text" class="form-control form-control-sm" id="new-task-title" placeholder="Task title" required>
          </div>
          <div class="form-group">
            <select class="form-control form-control-sm" id="new-task-priority">
              <option value="Normal">Normal Priority</option>
              <option value="High">High Priority</option>
              <option value="Critical">Critical</option>
              <option value="Low">Low Priority</option>
            </select>
          </div>
          <div class="form-group mb-0">
            <textarea class="form-control form-control-sm" id="new-task-notes" placeholder="Notes (optional)" rows="2"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-sm btn-light" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-sm btn-light" id="btn-create-task">Create</button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // State
  var state = {
    projects: [],
    tasks: [],
    allTasks: [],  // includes done/closed
    statusOptions: ['New', 'Assigned', 'Review', 'Done', 'Closed'],
    priorityOptions: ['Critical', 'High', 'Normal', 'Low'],
    assignees: [],
    mode: 'projects',
    selectedProjectId: null,
    selectedTaskId: null,
    projectStatusFilter: 'all',
    taskStatusFilter: 'all',
    taskPriorityFilter: 'all',
    taskAssigneeFilter: 'all',
    showAllTasks: false,
    sortField: 'name',
    sortDir: 'asc'
  };

  var confirmCallback = null;

  // Init
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  function init() {
    populateFilterDropdowns();
    loadData();
    bindEventHandlers();
  }

  function populateFilterDropdowns() {
    // Status filter
    var filterStatus = document.getElementById('filter-task-status');
    filterStatus.innerHTML = '<option value="all">Status</option>' +
      state.statusOptions.map(function(s) {
        return '<option value="' + s + '">' + s + '</option>';
      }).join('');

    // Priority filter
    var filterPriority = document.getElementById('filter-task-priority');
    filterPriority.innerHTML = '<option value="all">Pri</option>' +
      state.priorityOptions.map(function(p) {
        return '<option value="' + p + '">' + p + '</option>';
      }).join('');

    // Task detail status dropdown
    var taskFieldSelect = document.getElementById('task-field-status');
    taskFieldSelect.innerHTML = state.statusOptions.map(function(s) {
      return '<option value="' + s + '">' + s + '</option>';
    }).join('');
  }

  function populateAssigneeFilter() {
    // Extract unique assignees from tasks
    var assigneeSet = {};
    state.tasks.forEach(function(t) {
      if (t.st_AssignedTo) assigneeSet[t.st_AssignedTo] = true;
    });
    state.assignees = Object.keys(assigneeSet).sort();

    var filterAssignee = document.getElementById('filter-task-assignee');
    filterAssignee.innerHTML = '<option value="all">Assignee</option>' +
      state.assignees.map(function(a) {
        var short = a.split('@')[0];
        return '<option value="' + a + '">' + short + '</option>';
      }).join('');
  }

  function loadData() {
    google.script.run
      .withSuccessHandler(function(result) {
        if (!result.error) {
          state.projects = result.data || [];
          render();
          updateStats();
        }
      })
      .WebAppProjects_getAllProjects();

    loadTasks();
  }

  function loadTasks() {
    var fetchFn = state.showAllTasks ? 'WebAppTasks_getAllTasks' : 'WebAppTasks_getAllOpenTasks';

    google.script.run
      .withSuccessHandler(function(result) {
        if (!result.error) {
          state.tasks = result.data || [];
          populateAssigneeFilter();
          render();
          updateStats();
        }
      })
      [fetchFn]();
  }

  function bindEventHandlers() {
    document.getElementById('btn-home').addEventListener('click', goHome);
    document.getElementById('btn-back').addEventListener('click', goBack);
    document.getElementById('btn-new').addEventListener('click', handleNew);

    document.getElementById('filter-project-status').addEventListener('change', function() {
      state.projectStatusFilter = this.value;
      render();
    });

    document.getElementById('filter-task-status').addEventListener('change', function() {
      state.taskStatusFilter = this.value;
      render();
    });

    document.getElementById('filter-task-priority').addEventListener('change', function() {
      state.taskPriorityFilter = this.value;
      render();
    });

    document.getElementById('filter-task-assignee').addEventListener('change', function() {
      state.taskAssigneeFilter = this.value;
      render();
    });

    document.getElementById('toggle-show-all').addEventListener('change', function() {
      state.showAllTasks = this.checked;
      loadTasks();
    });

    document.querySelectorAll('.sort-col').forEach(function(el) {
      el.addEventListener('click', function(e) {
        e.preventDefault();
        var field = this.dataset.field;
        if (state.sortField === field) {
          state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
        } else {
          state.sortField = field;
          state.sortDir = 'asc';
        }
        render();
      });
    });

    document.getElementById('btn-save-project').addEventListener('click', saveProject);
    document.getElementById('btn-save-task').addEventListener('click', saveTaskStatus);

    document.getElementById('btn-complete-task').addEventListener('click', function() {
      showConfirm('Mark this task as complete?', function() {
        completeTask(state.selectedTaskId);
      });
    });

    document.getElementById('btn-cancel-task').addEventListener('click', function() {
      showConfirm('Cancel this task? This cannot be undone.', function() {
        cancelTask(state.selectedTaskId);
      });
    });

    document.getElementById('confirm-yes').addEventListener('click', function() {
      $('#confirmModal').modal('hide');
      if (confirmCallback) confirmCallback();
    });

    document.getElementById('btn-create-project').addEventListener('click', createProject);
    document.getElementById('btn-create-task').addEventListener('click', createTask);
  }

  // === NAVIGATION ===

  function goHome() {
    state.mode = 'projects';
    state.selectedProjectId = null;
    state.selectedTaskId = null;
    state.taskStatusFilter = 'all';
    state.taskPriorityFilter = 'all';
    state.taskAssigneeFilter = 'all';
    document.getElementById('filter-task-status').value = 'all';
    document.getElementById('filter-task-priority').value = 'all';
    document.getElementById('filter-task-assignee').value = 'all';
    render();
  }

  function goBack() {
    if (state.mode === 'tasks') {
      goHome();
    }
  }

  function selectProject(projectId) {
    state.selectedProjectId = projectId;
    state.selectedTaskId = null;
    state.mode = 'tasks';
    state.taskStatusFilter = 'all';
    document.getElementById('filter-task-status').value = 'all';
    render();
  }

  function selectTask(taskId) {
    state.selectedTaskId = taskId;
    renderDetailPanel();
  }

  function handleNew() {
    if (state.mode === 'projects') {
      $('#newProjectModal').modal('show');
    } else {
      $('#newTaskModal').modal('show');
    }
  }

  // === RENDERING ===

  function render() {
    renderHeader();
    renderSubheader();
    renderList();
    renderDetailPanel();
  }

  function renderHeader() {
    var backBtn = document.getElementById('btn-back');
    var breadcrumb = document.getElementById('breadcrumb');
    var newBtn = document.getElementById('btn-new');

    if (state.mode === 'projects') {
      backBtn.style.display = 'none';
      breadcrumb.textContent = 'Projects';
      newBtn.textContent = '+ Project';
    } else {
      backBtn.style.display = '';
      var project = getSelectedProject();
      var projectName = project ? (project.name || project.spro_Name) : 'Project';
      breadcrumb.innerHTML = '<span class="text-muted">Projects ›</span> ' + esc(projectName);
      newBtn.textContent = '+ Task';
    }
  }

  function renderSubheader() {
    var projectsHeader = document.getElementById('subheader-projects');
    var tasksHeader = document.getElementById('subheader-tasks');

    if (state.mode === 'projects') {
      projectsHeader.style.display = '';
      tasksHeader.style.display = 'none';
      updateSortIcons('name');
    } else {
      projectsHeader.style.display = 'none';
      tasksHeader.style.display = '';
      updateSortIcons('title');
    }
  }

  function updateSortIcons(defaultField) {
    document.querySelectorAll('.sort-col span').forEach(function(el) {
      el.textContent = '';
    });
    var iconId = 'sort-icon-' + state.sortField;
    var icon = document.getElementById(iconId);
    if (icon) {
      icon.textContent = state.sortDir === 'asc' ? '▾' : '▴';
    }
  }

  function renderList() {
    var container = document.getElementById('list-container');

    if (state.mode === 'projects') {
      renderProjectsList(container);
    } else {
      renderTasksList(container);
    }
  }

  function renderProjectsList(container) {
    var projects = getFilteredProjects();

    // Sort
    projects = sortItems(projects, function(p) {
      if (state.sortField === 'name') return (p.name || p.spro_Name || '').toLowerCase();
      return '';
    });

    if (projects.length === 0) {
      container.innerHTML = '<div class="text-muted p-3">No projects</div>';
      return;
    }

    container.innerHTML = projects.map(function(p) {
      var id = p.projectid || p.spro_ProjectId;
      var name = p.name || p.spro_Name || '-';
      var status = p.status || p.spro_Status || '';
      var type = p.type || p.spro_Type || '';
      var taskCount = getProjectTaskCount(id);
      var isSelected = id === state.selectedProjectId;

      var statusClass = status === 'ACTIVE' ? 'text-success' : status === 'PLANNING' ? 'text-warning' : 'text-muted';

      return '<div class="row border-bottom py-2 px-2 project-row' + (isSelected ? ' bg-light' : '') + '" data-id="' + id + '" style="cursor:pointer;margin:0;">' +
        '<div class="col-5 text-truncate">' + esc(name) + '</div>' +
        '<div class="col-3"><small class="' + statusClass + '">' + status.toLowerCase() + '</small></div>' +
        '<div class="col-2 text-center"><span class="badge badge-secondary">' + taskCount + '</span></div>' +
        '<div class="col-2 text-right text-muted">›</div>' +
      '</div>';
    }).join('');

    container.querySelectorAll('.project-row').forEach(function(el) {
      el.addEventListener('click', function() {
        selectProject(this.dataset.id);
      });
    });
  }

  function renderTasksList(container) {
    var tasks = getFilteredTasks();

    // Sort
    tasks = sortItems(tasks, function(t) {
      if (state.sortField === 'title') return (t.st_Title || '').toLowerCase();
      if (state.sortField === 'created') return t.st_CreatedDate || '9999';
      if (state.sortField === 'start') return t.st_StartDate || '9999';
      if (state.sortField === 'due') return t.st_DueDate || '9999';
      if (state.sortField === 'done') return t.st_DoneDate || '9999';
      return '';
    });

    if (tasks.length === 0) {
      container.innerHTML = '<div class="text-muted p-3">No tasks</div>';
      return;
    }

    container.innerHTML = tasks.map(function(t) {
      var id = t.st_TaskId;
      var title = t.st_Title || '-';
      var assignee = t.st_AssignedTo ? t.st_AssignedTo.split('@')[0] : '-';
      var status = t.st_Status || 'New';
      var priority = t.st_Priority || 'Normal';
      var createdDate = t.st_CreatedDate ? formatDateShort(t.st_CreatedDate) : '-';
      var startDate = t.st_StartDate ? formatDateShort(t.st_StartDate) : '-';
      var dueDate = t.st_DueDate ? formatDateShort(t.st_DueDate) : '-';
      var doneDate = t.st_DoneDate ? formatDateShort(t.st_DoneDate) : '-';
      var isOverdue = t.st_DueDate && new Date(t.st_DueDate) < new Date() && status !== 'Done' && status !== 'Closed';
      var isSelected = id === state.selectedTaskId;

      var priBadge = '';
      if (priority === 'Critical') priBadge = '<span class="badge badge-danger">C</span>';
      else if (priority === 'High') priBadge = '<span class="badge badge-warning">H</span>';
      else if (priority === 'Normal') priBadge = '<span class="badge badge-secondary">N</span>';
      else priBadge = '<span class="badge badge-light">L</span>';

      var dueClass = isOverdue ? 'text-danger font-weight-bold' : '';

      var isDone = status === 'Done' || status === 'Closed';
      var rowClass = isDone ? ' text-muted' : '';

      return '<div class="row border-bottom py-2 px-2 task-row' + (isSelected ? ' bg-light' : '') + rowClass + '" data-id="' + id + '" style="cursor:pointer;margin:0;">' +
        '<div class="col-3 text-truncate">' + esc(title) + '</div>' +
        '<div class="col-2 text-truncate">' + assignee + '</div>' +
        '<div class="col-1">' + status + '</div>' +
        '<div class="col-2 text-center">' + priBadge + '</div>' +
        '<div class="col-1 ' + dueClass + '">' + dueDate + '</div>' +
        '<div class="col-1">' + doneDate + '</div>' +
      '</div>';
    }).join('');

    container.querySelectorAll('.task-row').forEach(function(el) {
      el.addEventListener('click', function() {
        selectTask(this.dataset.id);
      });
    });
  }

  function renderDetailPanel() {
    var summary = document.getElementById('detail-summary');
    var projectDetail = document.getElementById('detail-project');
    var taskDetail = document.getElementById('detail-task');
    var title = document.getElementById('detail-title');

    summary.style.display = 'none';
    projectDetail.style.display = 'none';
    taskDetail.style.display = 'none';

    if (state.selectedTaskId) {
      var task = getSelectedTask();
      if (task) {
        title.textContent = 'Task Details';
        taskDetail.style.display = '';
        populateTaskForm(task);
      }
    } else if (state.selectedProjectId && state.mode === 'tasks') {
      var project = getSelectedProject();
      if (project) {
        title.textContent = 'Project Details';
        projectDetail.style.display = '';
        populateProjectForm(project);
      }
    } else {
      title.textContent = 'Overview';
      summary.style.display = '';
    }
  }

  function populateProjectForm(project) {
    document.getElementById('field-name').value = project.name || project.spro_Name || '';
    document.getElementById('field-type').value = project.type || project.spro_Type || 'ONE_OFF';
    document.getElementById('field-status').value = project.status || project.spro_Status || 'PLANNING';
    document.getElementById('field-start-date').value = formatDateInput(project.startdate || project.spro_StartDate);
    document.getElementById('field-end-date').value = formatDateInput(project.enddate || project.spro_EndDate);
  }

  function populateTaskForm(task) {
    document.getElementById('task-field-title').value = task.st_Title || '';
    document.getElementById('task-field-status').value = task.st_Status || 'New';
    document.getElementById('task-field-priority').value = task.st_Priority || 'Normal';
    document.getElementById('task-field-assignee').value = task.st_AssignedTo || '';
    document.getElementById('task-field-due').value = task.st_DueDate ? formatDate(task.st_DueDate) : '';
    document.getElementById('task-field-entity').value = task.st_LinkedEntityName || task.st_LinkedEntityId || '';
    document.getElementById('task-field-notes').value = task.st_Notes || '';

    var isDone = task.st_Status === 'Done' || task.st_Status === 'Cancelled';
    document.getElementById('btn-complete-task').disabled = isDone;
    document.getElementById('btn-cancel-task').disabled = isDone;
    document.getElementById('task-field-status').disabled = isDone;
  }

  function updateStats() {
    document.getElementById('stat-total').textContent = state.projects.length;
    document.getElementById('stat-active').textContent = state.projects.filter(function(p) {
      return (p.status || p.spro_Status) === 'ACTIVE';
    }).length;
    document.getElementById('stat-tasks').textContent = state.tasks.length;
    document.getElementById('stat-critical').textContent = state.tasks.filter(function(t) {
      return t.st_Priority === 'Critical';
    }).length;
  }

  // === HELPERS ===

  function getSelectedProject() {
    if (!state.selectedProjectId) return null;
    return state.projects.find(function(p) {
      return (p.projectid || p.spro_ProjectId) === state.selectedProjectId;
    });
  }

  function getSelectedTask() {
    if (!state.selectedTaskId) return null;
    return state.tasks.find(function(t) {
      return t.st_TaskId === state.selectedTaskId;
    });
  }

  function getProjectTaskCount(projectId) {
    return state.tasks.filter(function(t) {
      return t.st_ProjectId === projectId;
    }).length;
  }

  function getFilteredProjects() {
    return state.projects.filter(function(p) {
      if (state.projectStatusFilter !== 'all') {
        var status = p.status || p.spro_Status;
        if (status !== state.projectStatusFilter) return false;
      }
      return true;
    });
  }

  function getFilteredTasks() {
    return state.tasks.filter(function(t) {
      if (state.selectedProjectId && t.st_ProjectId !== state.selectedProjectId) return false;
      if (state.taskStatusFilter !== 'all' && t.st_Status !== state.taskStatusFilter) return false;
      if (state.taskPriorityFilter !== 'all' && t.st_Priority !== state.taskPriorityFilter) return false;
      if (state.taskAssigneeFilter !== 'all' && t.st_AssignedTo !== state.taskAssigneeFilter) return false;
      return true;
    });
  }

  function sortItems(items, keyFn) {
    return items.slice().sort(function(a, b) {
      var aVal = keyFn(a);
      var bVal = keyFn(b);
      if (aVal < bVal) return state.sortDir === 'asc' ? -1 : 1;
      if (aVal > bVal) return state.sortDir === 'asc' ? 1 : -1;
      return 0;
    });
  }

  function formatDate(v) {
    if (!v) return '';
    try {
      var d = new Date(v);
      return isNaN(d) ? '' : d.toLocaleDateString();
    } catch(e) { return ''; }
  }

  function formatDateShort(v) {
    if (!v) return '';
    try {
      var d = new Date(v);
      if (isNaN(d)) return '';
      var m = d.getMonth() + 1;
      var day = d.getDate();
      return m + '/' + day;
    } catch(e) { return ''; }
  }

  function formatDateInput(v) {
    if (!v) return '';
    try {
      var d = new Date(v);
      return isNaN(d) ? '' : d.toISOString().split('T')[0];
    } catch(e) { return ''; }
  }

  function esc(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function showConfirm(message, callback) {
    document.getElementById('confirm-message').textContent = message;
    confirmCallback = callback;
    $('#confirmModal').modal('show');
  }

  // === API ACTIONS ===

  function createProject() {
    var name = document.getElementById('new-project-name').value.trim();
    if (!name) { alert('Enter project name'); return; }

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.error) { alert('Error: ' + result.error); return; }
        $('#newProjectModal').modal('hide');
        document.getElementById('new-project-form').reset();
        loadData();
      })
      .WebAppProjects_createProject({
        name: name,
        type: document.getElementById('new-project-type').value,
        status: document.getElementById('new-project-status').value
      });
  }

  function createTask() {
    var title = document.getElementById('new-task-title').value.trim();
    if (!title) { alert('Enter task title'); return; }
    if (!state.selectedProjectId) { alert('No project selected'); return; }

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.error) { alert('Error: ' + result.error); return; }
        $('#newTaskModal').modal('hide');
        document.getElementById('new-task-form').reset();
        loadData();
      })
      .WebAppTasks_createTask({
        projectId: state.selectedProjectId,
        title: title,
        priority: document.getElementById('new-task-priority').value,
        notes: document.getElementById('new-task-notes').value
      });
  }

  function saveProject() {
    if (!state.selectedProjectId) return;

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.error) { alert('Error: ' + result.error); return; }
        loadData();
      })
      .WebAppProjects_updateProject(state.selectedProjectId, {
        name: document.getElementById('field-name').value.trim(),
        type: document.getElementById('field-type').value,
        status: document.getElementById('field-status').value,
        startDate: document.getElementById('field-start-date').value || null,
        endDate: document.getElementById('field-end-date').value || null
      });
  }

  function saveTaskStatus() {
    if (!state.selectedTaskId) return;

    var newStatus = document.getElementById('task-field-status').value;
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.error) { alert('Error: ' + result.error); return; }
        loadData();
      })
      .WebAppTasks_updateTaskStatus(state.selectedTaskId, newStatus);
  }

  function completeTask(taskId) {
    google.script.run
      .withSuccessHandler(function(success) {
        if (!success) { alert('Could not complete task'); return; }
        state.selectedTaskId = null;
        loadData();
      })
      .WebAppTasks_completeTaskById(taskId);
  }

  function cancelTask(taskId) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.error) { alert('Error: ' + result.error); return; }
        state.selectedTaskId = null;
        loadData();
      })
      .WebAppTasks_updateTaskStatus(taskId, 'Cancelled');
  }

})();
</script>
