<div class="container-fluid">
  <!-- Section 1: Stats Overview -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
          <span><strong>Projects</strong></span>
          <div>
            <button id="btn-refresh-projects" class="btn btn-sm btn-light mr-1">Refresh</button>
            <button id="btn-new-project" class="btn btn-sm btn-light">+ New</button>
          </div>
        </div>
        <div class="card-body py-2">
          <div class="row text-center">
            <div class="col"><div class="small text-muted">Total</div><div class="h5 mb-0" id="stat-total">-</div></div>
            <div class="col"><div class="small text-muted">Planning</div><div class="h5 mb-0 text-warning" id="stat-planning">-</div></div>
            <div class="col"><div class="small text-muted">Active</div><div class="h5 mb-0 text-success" id="stat-active">-</div></div>
            <div class="col"><div class="small text-muted">Done</div><div class="h5 mb-0 text-info" id="stat-completed">-</div></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header py-2"><strong>Open Tasks</strong></div>
        <div class="card-body py-2">
          <div class="row text-center">
            <div class="col"><div class="small text-muted">Total</div><div class="h5 mb-0" id="task-stat-total">-</div></div>
            <div class="col"><div class="small text-muted">Critical</div><div class="h5 mb-0 text-danger" id="task-stat-critical">-</div></div>
            <div class="col"><div class="small text-muted">High</div><div class="h5 mb-0 text-warning" id="task-stat-high">-</div></div>
            <div class="col"><div class="small text-muted">New</div><div class="h5 mb-0 text-primary" id="task-stat-new">-</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Section 2: Project List -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
            <table class="table table-sm table-hover mb-0">
              <thead class="thead-light">
                <tr>
                  <th>Project</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Tasks</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="project-list-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Section 3: All Tasks -->
  <div class="row mb-3" id="all-tasks-section">
    <div class="col-12">
      <div class="card">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
          <div>
            <strong>All Tasks</strong>
            <div class="btn-group btn-group-sm ml-3" id="task-filter-tabs">
              <button class="btn btn-outline-secondary active" data-filter="mine">My Tasks</button>
              <button class="btn btn-outline-secondary" data-filter="unassigned">Unassigned</button>
              <button class="btn btn-outline-secondary" data-filter="all">All</button>
            </div>
          </div>
          <span class="text-muted small" id="all-tasks-count">-</span>
        </div>
        <div class="card-body p-0">
          <div id="all-tasks-container" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Section 4: Project Detail + Tasks -->
  <div class="row" id="project-detail-section" style="display: none;">
    <div class="col-md-4">
      <div class="card">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
          <strong id="editor-project-name">Project</strong>
          <button id="btn-close-editor" class="btn btn-sm btn-light">&times;</button>
        </div>
        <div class="card-body">
          <form id="project-form">
            <div class="form-group">
              <label class="small">Name</label>
              <input type="text" class="form-control form-control-sm" id="field-name">
            </div>
            <div class="form-row">
              <div class="col-6">
                <div class="form-group">
                  <label class="small">Type</label>
                  <select class="form-control form-control-sm" id="field-type">
                    <option value="CAMPAIGN">Campaign</option>
                    <option value="OPERATIONAL">Operational</option>
                    <option value="ONE_OFF">One-Off</option>
                  </select>
                </div>
              </div>
              <div class="col-6">
                <div class="form-group">
                  <label class="small">Status</label>
                  <select class="form-control form-control-sm" id="field-status">
                    <option value="PLANNING">Planning</option>
                    <option value="ACTIVE">Active</option>
                    <option value="COMPLETED">Completed</option>
                    <option value="ARCHIVED">Archived</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="col-6">
                <div class="form-group">
                  <label class="small">Start</label>
                  <input type="date" class="form-control form-control-sm" id="field-start-date">
                </div>
              </div>
              <div class="col-6">
                <div class="form-group">
                  <label class="small">End</label>
                  <input type="date" class="form-control form-control-sm" id="field-end-date">
                </div>
              </div>
            </div>
            <button type="button" id="btn-save-project" class="btn btn-sm btn-primary btn-block">Save</button>
          </form>
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <div class="card">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
          <strong>Tasks</strong>
          <span class="text-muted small" id="task-count-label">0 tasks</span>
        </div>
        <div class="card-body p-0">
          <div id="project-tasks-container" style="max-height: 350px; overflow-y: auto;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Project Modal -->
<div class="modal fade" id="newProjectModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">New Project</h6>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="new-project-form">
          <div class="form-group">
            <input type="text" class="form-control form-control-sm" id="new-project-name" placeholder="Project name" required>
          </div>
          <div class="form-row">
            <div class="col">
              <select class="form-control form-control-sm" id="new-project-type">
                <option value="ONE_OFF">One-Off</option>
                <option value="CAMPAIGN">Campaign</option>
                <option value="OPERATIONAL">Operational</option>
              </select>
            </div>
            <div class="col">
              <select class="form-control form-control-sm" id="new-project-status">
                <option value="PLANNING">Planning</option>
                <option value="ACTIVE">Active</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-sm" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-sm btn-primary" id="btn-create-project">Create</button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  var currentProjectId = null;
  var allProjects = [];
  var allTasks = [];
  var currentUserEmail = '';
  var currentFilter = 'mine';
  var statusOptions = ['New', 'In Progress', 'Review', 'Blocked', 'Done', 'Cancelled'];

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  function init() {
    loadCurrentUser();
    loadStats();
    loadTaskStats();
    loadProjects();
    loadAllTasks();
    bindEventHandlers();
  }

  function loadCurrentUser() {
    google.script.run
      .withSuccessHandler(function(email) {
        currentUserEmail = email || '';
        renderAllTasks(); // Re-render with user context
      })
      .WebAppTasks_getCurrentUserEmail();
  }

  function bindEventHandlers() {
    document.getElementById('btn-refresh-projects').addEventListener('click', function() {
      loadStats(); loadTaskStats(); loadProjects(); loadAllTasks();
      if (currentProjectId) loadProjectForEditing(currentProjectId);
    });
    document.getElementById('btn-new-project').addEventListener('click', function() {
      $('#newProjectModal').modal('show');
    });
    document.getElementById('btn-create-project').addEventListener('click', createProject);
    document.getElementById('btn-save-project').addEventListener('click', saveProject);
    document.getElementById('btn-close-editor').addEventListener('click', closeEditor);

    // Task filter tabs
    document.querySelectorAll('#task-filter-tabs button').forEach(function(btn) {
      btn.addEventListener('click', function() {
        document.querySelectorAll('#task-filter-tabs button').forEach(function(b) { b.classList.remove('active'); });
        this.classList.add('active');
        currentFilter = this.dataset.filter;
        renderAllTasks();
      });
    });
  }

  function loadStats() {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.error) return;
        var stats = result.data;
        document.getElementById('stat-total').textContent = stats.total || 0;
        document.getElementById('stat-planning').textContent = stats.byStatus.PLANNING || 0;
        document.getElementById('stat-active').textContent = stats.byStatus.ACTIVE || 0;
        document.getElementById('stat-completed').textContent = stats.byStatus.COMPLETED || 0;
      })
      .WebAppProjects_getStats();
  }

  function loadTaskStats() {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.error) return;
        var stats = result.data;
        document.getElementById('task-stat-total').textContent = stats.total || 0;
        document.getElementById('task-stat-critical').textContent = stats.byPriority.Critical || 0;
        document.getElementById('task-stat-high').textContent = stats.byPriority.High || 0;
        document.getElementById('task-stat-new').textContent = stats.byStatus.New || 0;
      })
      .WebAppTasks_getStats();
  }

  function loadProjects() {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.error) return;
        allProjects = result.data || [];
        renderProjectList(allProjects);
      })
      .WebAppProjects_getAllProjects();
  }

  function loadAllTasks() {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.error) return;
        allTasks = result.data || [];
        renderAllTasks();
      })
      .WebAppTasks_getAllOpenTasks();
  }

  function renderAllTasks() {
    var container = document.getElementById('all-tasks-container');
    var countLabel = document.getElementById('all-tasks-count');

    // Filter tasks
    var filtered = allTasks.filter(function(t) {
      var assignee = t.st_AssignedTo || '';
      if (currentFilter === 'mine') return assignee === currentUserEmail;
      if (currentFilter === 'unassigned') return !assignee;
      return true; // 'all'
    });

    // Sort by priority (Critical > High > Normal > Low)
    var priOrder = { 'Critical': 0, 'High': 1, 'Normal': 2, 'Low': 3 };
    filtered.sort(function(a, b) {
      return (priOrder[a.st_Priority] || 2) - (priOrder[b.st_Priority] || 2);
    });

    countLabel.textContent = filtered.length + ' task' + (filtered.length !== 1 ? 's' : '');

    if (filtered.length === 0) {
      container.innerHTML = '<div class="text-muted p-3">No tasks</div>';
      return;
    }

    container.innerHTML = '<table class="table table-sm mb-0"><tbody>' + filtered.map(function(t) {
      var taskId = t.st_TaskId;
      var title = t.st_Title || '-';
      var status = t.st_Status || 'New';
      var priority = t.st_Priority || 'Normal';
      var assignee = t.st_AssignedTo || '';
      var entity = t.st_LinkedEntityName || t.st_LinkedEntityId || '';
      var isDone = status === 'Done' || status === 'Cancelled';

      var priBadge = priority === 'Critical' ? '<span class="badge badge-danger">!</span> ' :
                     priority === 'High' ? '<span class="badge badge-warning">H</span> ' : '';

      var assigneeBadge = '';
      if (currentFilter === 'all' && assignee) {
        var shortName = assignee.split('@')[0];
        assigneeBadge = '<span class="badge badge-light ml-1">' + shortName + '</span>';
      }

      var statusSelect = '<select class="form-control form-control-sm all-task-status" data-task-id="' + taskId + '" ' + (isDone ? 'disabled' : '') + '>' +
        statusOptions.map(function(s) {
          return '<option value="' + s + '"' + (s === status ? ' selected' : '') + '>' + s + '</option>';
        }).join('') + '</select>';

      var completeBtn = isDone ? '' : '<button class="btn btn-sm btn-outline-success ml-1 all-task-complete" data-task-id="' + taskId + '" title="Complete"><i class="fas fa-check"></i></button>';

      return '<tr class="' + (isDone ? 'text-muted' : '') + '">' +
        '<td style="width:45%">' + priBadge + esc(title) + assigneeBadge + (entity ? '<br><small class="text-muted">' + esc(entity) + '</small>' : '') + '</td>' +
        '<td style="width:35%">' + statusSelect + '</td>' +
        '<td style="width:20%" class="text-right">' + completeBtn + '</td>' +
      '</tr>';
    }).join('') + '</tbody></table>';

    // Bind handlers
    container.querySelectorAll('.all-task-status').forEach(function(sel) {
      sel.addEventListener('change', function() {
        updateAllTaskStatus(this.dataset.taskId, this.value);
      });
    });
    container.querySelectorAll('.all-task-complete').forEach(function(btn) {
      btn.addEventListener('click', function() {
        completeAllTask(this.dataset.taskId);
      });
    });
  }

  function updateAllTaskStatus(taskId, newStatus) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.error) { alert('Error: ' + result.error); return; }
        loadTaskStats();
        loadAllTasks();
        loadProjects();
      })
      .WebAppTasks_updateTaskStatus(taskId, newStatus);
  }

  function completeAllTask(taskId) {
    google.script.run
      .withSuccessHandler(function(success) {
        if (!success) { alert('Could not complete task'); return; }
        loadStats(); loadTaskStats(); loadProjects(); loadAllTasks();
      })
      .WebAppTasks_completeTaskById(taskId);
  }

  function renderProjectList(projects) {
    var tbody = document.getElementById('project-list-body');
    if (!projects || projects.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">No projects</td></tr>';
      return;
    }

    tbody.innerHTML = projects.map(function(p) {
      var id = p.projectid || p.spro_ProjectId;
      var name = p.name || p.spro_Name || '-';
      var type = p.type || p.spro_Type || '-';
      var status = p.status || p.spro_Status || '-';
      var openTasks = (p.taskCount || 0) - (p.completedTaskCount || 0);

      return '<tr class="project-row" data-id="' + id + '" style="cursor:pointer">' +
        '<td>' + esc(name) + '</td>' +
        '<td>' + typeBadge(type) + '</td>' +
        '<td>' + statusBadge(status) + '</td>' +
        '<td>' + (openTasks > 0 ? '<span class="badge badge-warning">' + openTasks + '</span>' : '<span class="text-muted">0</span>') + '</td>' +
        '<td class="text-right"><i class="fas fa-chevron-right text-muted"></i></td>' +
      '</tr>';
    }).join('');

    document.querySelectorAll('.project-row').forEach(function(row) {
      row.addEventListener('click', function() {
        loadProjectForEditing(this.dataset.id);
      });
    });
  }

  function typeBadge(t) {
    if (t === 'CAMPAIGN') return '<span class="badge" style="background:#6f42c1;color:#fff">Campaign</span>';
    if (t === 'OPERATIONAL') return '<span class="badge badge-info">Ops</span>';
    return '<span class="badge badge-secondary">One-Off</span>';
  }

  function statusBadge(s) {
    var c = { PLANNING: 'warning', ACTIVE: 'success', COMPLETED: 'info', ARCHIVED: 'secondary' };
    return '<span class="badge badge-' + (c[s] || 'secondary') + '">' + s + '</span>';
  }

  function loadProjectForEditing(projectId) {
    currentProjectId = projectId;
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.error || !result.data) {
          alert('Error: ' + (result.error || 'Not found'));
          return;
        }
        renderProjectEditor(result.data);
      })
      .WebAppProjects_getProjectWithTasks(projectId);
  }

  function renderProjectEditor(project) {
    document.getElementById('project-detail-section').style.display = 'flex';
    document.getElementById('editor-project-name').textContent = project.name || project.spro_Name || 'Project';
    document.getElementById('field-name').value = project.name || project.spro_Name || '';
    document.getElementById('field-type').value = project.type || project.spro_Type || 'ONE_OFF';
    document.getElementById('field-status').value = project.status || project.spro_Status || 'PLANNING';
    document.getElementById('field-start-date').value = fmtDateInput(project.startdate || project.spro_StartDate);
    document.getElementById('field-end-date').value = fmtDateInput(project.enddate || project.spro_EndDate);

    var tasks = project.tasks || [];
    document.getElementById('task-count-label').textContent = tasks.length + ' task' + (tasks.length !== 1 ? 's' : '');
    renderProjectTasks(tasks);
  }

  function renderProjectTasks(tasks) {
    var container = document.getElementById('project-tasks-container');
    if (!tasks || tasks.length === 0) {
      container.innerHTML = '<div class="text-muted p-3">No tasks</div>';
      return;
    }

    container.innerHTML = '<table class="table table-sm mb-0"><tbody>' + tasks.map(function(t) {
      var taskId = t.st_TaskId;
      var title = t.st_Title || '-';
      var status = t.st_Status || 'New';
      var priority = t.st_Priority || 'Normal';
      var entity = t.st_LinkedEntityName || t.st_LinkedEntityId || '';
      var isDone = status === 'Done' || status === 'Cancelled';

      var priBadge = priority === 'Critical' ? '<span class="badge badge-danger">!</span> ' :
                     priority === 'High' ? '<span class="badge badge-warning">H</span> ' : '';

      var statusSelect = '<select class="form-control form-control-sm task-status-select" data-task-id="' + taskId + '" ' + (isDone ? 'disabled' : '') + '>' +
        statusOptions.map(function(s) {
          return '<option value="' + s + '"' + (s === status ? ' selected' : '') + '>' + s + '</option>';
        }).join('') + '</select>';

      var completeBtn = isDone ? '' : '<button class="btn btn-sm btn-outline-success ml-1 task-complete-btn" data-task-id="' + taskId + '" title="Complete"><i class="fas fa-check"></i></button>';

      return '<tr class="' + (isDone ? 'text-muted' : '') + '">' +
        '<td style="width:50%">' + priBadge + esc(title) + (entity ? '<br><small class="text-muted">' + esc(entity) + '</small>' : '') + '</td>' +
        '<td style="width:35%">' + statusSelect + '</td>' +
        '<td style="width:15%" class="text-right">' + completeBtn + '</td>' +
      '</tr>';
    }).join('') + '</tbody></table>';

    // Bind status change handlers
    container.querySelectorAll('.task-status-select').forEach(function(sel) {
      sel.addEventListener('change', function() {
        updateTaskStatus(this.dataset.taskId, this.value);
      });
    });

    // Bind complete button handlers
    container.querySelectorAll('.task-complete-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        completeTask(this.dataset.taskId);
      });
    });
  }

  function updateTaskStatus(taskId, newStatus) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.error) {
          alert('Error: ' + result.error);
          return;
        }
        loadTaskStats();
        loadProjectForEditing(currentProjectId);
      })
      .WebAppTasks_updateTaskStatus(taskId, newStatus);
  }

  function completeTask(taskId) {
    google.script.run
      .withSuccessHandler(function(success) {
        if (!success) {
          alert('Could not complete task');
          return;
        }
        loadStats();
        loadTaskStats();
        loadProjects();
        loadProjectForEditing(currentProjectId);
      })
      .WebAppTasks_completeTaskById(taskId);
  }

  function closeEditor() {
    currentProjectId = null;
    document.getElementById('project-detail-section').style.display = 'none';
  }

  function createProject() {
    var name = document.getElementById('new-project-name').value.trim();
    if (!name) { alert('Enter project name'); return; }

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.error) { alert('Error: ' + result.error); return; }
        $('#newProjectModal').modal('hide');
        document.getElementById('new-project-form').reset();
        loadStats();
        loadProjects();
      })
      .WebAppProjects_createProject({
        name: name,
        type: document.getElementById('new-project-type').value,
        status: document.getElementById('new-project-status').value
      });
  }

  function saveProject() {
    if (!currentProjectId) return;
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.error) { alert('Error: ' + result.error); return; }
        loadStats();
        loadProjects();
        document.getElementById('editor-project-name').textContent = document.getElementById('field-name').value;
      })
      .WebAppProjects_updateProject(currentProjectId, {
        name: document.getElementById('field-name').value.trim(),
        type: document.getElementById('field-type').value,
        status: document.getElementById('field-status').value,
        startDate: document.getElementById('field-start-date').value || null,
        endDate: document.getElementById('field-end-date').value || null
      });
  }

  function fmtDateInput(v) {
    if (!v) return '';
    try { var d = new Date(v); return isNaN(d) ? '' : d.toISOString().split('T')[0]; } catch(e) { return ''; }
  }

  function esc(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

})();
</script>
