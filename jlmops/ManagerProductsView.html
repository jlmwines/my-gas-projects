<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    /* Minimal custom styles, relying on Bootstrap from Dashboard.html */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-container { background: white; width: 90%; max-width: 900px; max-height: 85vh; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    
    /* Header Redesign */
    .modal-header { padding: 10px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: flex-start; background-color: #f8f9fa; border-radius: 8px 8px 0 0; }
    .modal-title-area { display: flex; flex-direction: column; }
    .modal-main-title { font-size: 18px; font-weight: 700; color: #333; }
    .modal-sub-title { font-size: 14px; color: #666; }
    .modal-close { background: none; border: none; font-size: 24px; line-height: 1; cursor: pointer; color: #999; }
    .modal-close:hover { color: #333; }

    .form-body { flex: 1; overflow-y: auto; padding: 20px; }
    
    /* Compact Tab Bar with Actions */
    .tab-bar { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; justify-content: space-between; align-items: center; }
    .tab-group { display: flex; }
    .tab-btn { padding: 8px 15px; cursor: pointer; border-bottom: 2px solid transparent; color: #666; font-weight: 500; font-size: 14px; }
    .tab-btn:hover { color: #007bff; }
    .tab-btn.active { border-bottom-color: #007bff; color: #007bff; }
    
    .tab-actions { padding-right: 10px; } /* Always visible */
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
    .col-header { font-weight: 600; color: #555; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .hebrew-text { direction: rtl; text-align: right; }
    .preview-box { background: #fafafa; border: 1px solid #eee; padding: 15px; border-radius: 4px; min-height: 200px; white-space: pre-wrap; font-size: 13px; }

    /* Flexible Description Boxes */
    .desc-short, .desc-long { 
        width: 100%; 
        font-size: 14px; 
        line-height: 1.4;
        padding: 8px;
    }
    
    /* Read-only Divs */
    div.desc-short, div.desc-long {
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        border-radius: 4px;
        overflow-y: auto;
    }

    /* Editable Textareas */
    textarea.desc-short, textarea.desc-long {
        resize: vertical;
    }

    /* 2 lines approx */
    .desc-short { min-height: 60px; }
    /* 5 lines approx */
    .desc-long { min-height: 130px; }

  </style>
</head>
<body>
  <div class="container-fluid p-4">
    <!-- Main Card: Detail Updates -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Detail Updates</h5>
        <span id="stat-mismatch" class="badge badge-secondary badge-pill">0</span>
      </div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th class="border-top-0">Task</th>
              <th class="border-top-0">SKU</th>
              <th class="border-top-0">Date</th>
              <th class="border-top-0">Action</th>
            </tr>
          </thead>
          <tbody id="task-list-body">
            <!-- Tasks will be populated here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Product Editor Modal -->
  <div class="modal-overlay" id="editor-modal">
    <div class="modal-container">
      <!-- Consolidated Header -->
      <div class="modal-header">
        <div class="modal-title-area">
            <div id="modal-product-header" style="font-size: 14px; display: flex; align-items: center; flex-wrap: wrap;">
                <span class="mr-1">Editing:</span>
                <span id="header-sku-display" class="font-weight-bold mr-1"></span>
                <span id="header-name-en-display" class="mr-1"></span>
                <span id="header-name-he-display" class="hebrew-text"></span>
            </div>
        </div>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      
      <div class="form-body">
        <!-- Tabs with Right-Aligned Actions -->
        <div class="tab-bar">
          <div class="tab-group">
            <div class="tab-btn active" onclick="switchTab('desc')">Descriptions</div>
            <div class="tab-btn" onclick="switchTab('specs')">Specs</div>
            <div class="tab-btn" onclick="switchTab('attr')">Attributes</div>
            <div class="tab-btn" onclick="switchTab('pair')">Pairing</div>
            <div class="tab-btn" onclick="switchTab('preview')">Preview</div>
          </div>
          <div class="tab-actions" id="global-actions">
             <button class="btn btn-sm border" onclick="globalFill()">Fill</button>
             <button class="btn btn-sm border" onclick="globalClear()">Clear</button>
          </div>
        </div>

        <div id="tab-desc" class="tab-content active">
          <div class="comparison-grid">
            <!-- Current Column -->
            <div>
              <div class="col-header">Current</div>
              <div class="form-group">
                <label class="small text-muted mb-1">Hebrew Short Description</label>
                <div class="desc-short hebrew-text" id="cur-ShortDescrHe"></div>
              </div>
              <div class="form-group">
                <label class="small text-muted mb-1">Hebrew Description</label>
                <div class="desc-long hebrew-text" id="cur-DescriptionHe"></div>
              </div>
              <div class="form-group">
                <label class="small text-muted mb-1">English Short Description</label>
                <div class="desc-short" id="cur-ShortDescrEn"></div>
              </div>
              <div class="form-group">
                <label class="small text-muted mb-1">English Description</label>
                <div class="desc-long" id="cur-DescriptionEn"></div>
              </div>
            </div>
            
            <!-- Edit Column -->
            <div>
              <div class="col-header">Edit</div>
              <div class="form-group">
                <label class="small text-muted mb-1">Hebrew Short Description</label>
                <textarea class="form-control hebrew-text desc-short" id="edit-ShortDescrHe"></textarea>
              </div>
              <div class="form-group">
                <label class="small text-muted mb-1">Hebrew Description</label>
                <textarea class="form-control hebrew-text desc-long" id="edit-DescriptionHe"></textarea>
              </div>
              <div class="form-group">
                <label class="small text-muted mb-1">English Short Description</label>
                <textarea class="form-control desc-short" id="edit-ShortDescrEn"></textarea>
              </div>
              <div class="form-group">
                <label class="small text-muted mb-1">English Description</label>
                <textarea class="form-control desc-long" id="edit-DescriptionEn"></textarea>
              </div>
            </div>
          </div>
        </div>

        <div id="tab-specs" class="tab-content">
          <div class="comparison-grid">
            <div>
              <div class="col-header">Current</div>
               <div class="form-group"><label>Comax Vintage</label><div class="p-2 bg-light border rounded" id="cur-CmxVintage"></div></div>
               <div class="form-group"><label>Comax Size</label><div class="p-2 bg-light border rounded" id="cur-CmxSize"></div></div>
               <div class="form-group"><label>Comax Division</label><div class="p-2 bg-light border rounded" id="cur-CmxDivision"></div></div>
               <div class="form-group"><label>Comax Group</label><div class="p-2 bg-light border rounded" id="cur-CmxGroup"></div></div>
               <div class="form-group"><label>Region</label><div class="p-2 bg-light border rounded" id="cur-Region"></div></div>
            </div>
            <div>
              <div class="col-header">Edit</div>
              <div class="form-group"><label>Region</label><input type="text" class="form-control" id="edit-Region"></div>
            </div>
          </div>
        </div>

        <div id="tab-attr" class="tab-content">
           <div class="comparison-grid">
            <div>
              <div class="col-header">Current</div>
              <div class="form-group"><label>Intensity</label><div class="p-2 bg-light border rounded" id="cur-Intensity"></div></div>
              <div class="form-group"><label>Complexity</label><div class="p-2 bg-light border rounded" id="cur-Complexity"></div></div>
            </div>
            <div>
              <div class="col-header">Edit</div>
              <div class="form-group"><label>Intensity (1-5)</label><input type="number" min="1" max="5" class="form-control" id="edit-Intensity"></div>
              <div class="form-group"><label>Complexity (1-5)</label><input type="number" min="1" max="5" class="form-control" id="edit-Complexity"></div>
            </div>
          </div>
        </div>
        
         <div id="tab-pair" class="tab-content">
           <p class="text-muted p-3">Pairing options will be implemented here.</p>
        </div>

        <div id="tab-preview" class="tab-content">
           <div class="comparison-grid">
             <div>
               <div class="col-header">English Preview</div>
               <div class="preview-box" id="preview-en"></div>
             </div>
             <div>
               <div class="col-header">Hebrew Preview</div>
               <div class="preview-box hebrew-text" id="preview-he"></div>
             </div>
           </div>
        </div>

      </div>
      
      <div class="modal-footer bg-light">
        <div id="modal-status" class="mr-auto text-muted small"></div>
        <button class="btn border" onclick="closeModal()">Cancel</button>
        <button class="btn" onclick="submitChanges()">Submit</button>
      </div>
    </div>
  </div>

  <script>
    let currentTaskId = null;
    let currentSku = null;
    let currentMasterData = {};
    let currentActiveTab = 'desc';

    function refreshView() {
      loadWidgetData();
      loadTaskList();
    }

    function loadWidgetData() {
      google.script.run.withSuccessHandler(data => {
        if (data.error) return console.error(data.error);
        const widget = document.getElementById('stat-mismatch');
        if (widget) {
            widget.textContent = data.data['vintage_mismatch_tasks'] || 0;
        } else {
            console.warn('Widget element "stat-mismatch" not found.');
        }
      }).WebAppProducts_getProductsWidgetData();
    }

    function loadTaskList() {
      const tbody = document.getElementById('task-list-body');
      tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
      
      google.script.run.withSuccessHandler(tasks => {
        tbody.innerHTML = '';
        if (!tasks || tasks.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4">No tasks found.</td></tr>';
          return;
        }
        
        tasks.forEach(task => {
          try {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${task.title}</td>
                <td>${task.sku}</td>
                <td>${new Date(task.createdDate).toLocaleDateString()}</td>
                <td><button class="btn btn-sm" onclick="openEditor('${task.taskId}')">Open</button></td>
              `;
              tbody.appendChild(tr);
          } catch (e) {
              console.error('Error rendering row:', e);
          }
        });
      }).WebAppProducts_getManagerProductTasks();
    }

    function openEditor(taskId) {
      currentTaskId = taskId;
      document.getElementById('editor-modal').style.display = 'flex';
      document.getElementById('modal-status').textContent = 'Loading data...';
      
      // Clear inputs
      document.querySelectorAll('input, textarea, .p-2').forEach(el => {
        if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.value = '';
        else if(el.classList.contains('p-2')) el.textContent = '';
        else if(el.classList.contains('desc-short') || el.classList.contains('desc-long')) {
             if(el.tagName === 'DIV') el.textContent = '';
        }
      });
      
      // Reset tab to first
      switchTab('desc');

      google.script.run
      .withSuccessHandler(data => {
         currentSku = data.sku;
         currentMasterData = data.masterData || {}; 
         
         // Populate Header
         const headerSku = data.sku;
         const headerNameEn = currentMasterData.wdm_NameEn || 'Unknown Product';
         const headerNameHe = currentMasterData.wdm_NameHe || '';
         
         document.getElementById('header-sku-display').textContent = headerSku;
         document.getElementById('header-name-en-display').textContent = `- ${headerNameEn}`;
         document.getElementById('header-name-he-display').textContent = headerNameHe ? `- ${headerNameHe}` : '';

         try {
             populateEditor(data.masterData, data.stagingData, data.comaxData);
             document.getElementById('modal-status').textContent = '';
         } catch (e) {
             console.error('Error populating editor:', e);
             document.getElementById('modal-status').textContent = 'Error displaying data.';
         }
      })
      .withFailureHandler(err => {
          console.error('Failed to load editor data:', err);
          document.getElementById('modal-status').textContent = 'Error: ' + err.message;
      })
      .WebAppProducts_loadProductEditorData(taskId);
    }

    function populateEditor(master, staging, comax) {
      const m = master || {};
      const s = staging || {};
      const c = comax || {};

      // Populate Current Column (Read Only)
      setVal('cur-ShortDescrHe', m.wdm_ShortDescrHe);
      setVal('cur-DescriptionHe', m.wdm_DescriptionHe);
      setVal('cur-ShortDescrEn', m.wdm_ShortDescrEn);
      setVal('cur-DescriptionEn', m.wdm_DescriptionEn);
      
      setVal('cur-Region', m.wdm_Region);
      setVal('cur-Intensity', m.wdm_Intensity);
      setVal('cur-Complexity', m.wdm_Complexity);

      setVal('cur-CmxVintage', c.cpm_Vintage);
      setVal('cur-CmxSize', c.cpm_Size);
      setVal('cur-CmxDivision', c.cpm_Division);
      setVal('cur-CmxGroup', c.cpm_Group);

      // Populate Edit Column
      setInp('edit-ShortDescrHe', s.wdm_ShortDescrHe || '');
      setInp('edit-DescriptionHe', s.wdm_DescriptionHe || '');
      setInp('edit-ShortDescrEn', s.wdm_ShortDescrEn || '');
      setInp('edit-DescriptionEn', s.wdm_DescriptionEn || '');
      
      setInp('edit-Region', s.wdm_Region || m.wdm_Region);
      setInp('edit-Intensity', s.wdm_Intensity || m.wdm_Intensity);
      setInp('edit-Complexity', s.wdm_Complexity || m.wdm_Complexity);
      
      updatePreview();
    }
    
    function setVal(id, val) { document.getElementById(id).textContent = val || '-'; }
    function setInp(id, val) { document.getElementById(id).value = val || ''; }

    function closeModal() {
      document.getElementById('editor-modal').style.display = 'none';
    }

    function switchTab(tabName) {
      currentActiveTab = tabName;
      document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      
      document.getElementById('tab-' + tabName).style.display = 'block';
      // Find button by text or index, but event.target is easier if clicked. 
      // If called programmatically, we need to find the btn. 
      // Simple loop:
      const btns = document.querySelectorAll('.tab-btn');
      if(tabName === 'desc') btns[0].classList.add('active');
      if(tabName === 'specs') btns[1].classList.add('active');
      if(tabName === 'attr') btns[2].classList.add('active');
      if(tabName === 'pair') btns[3].classList.add('active');
      if(tabName === 'preview') btns[4].classList.add('active');

      // Toggle Actions
      // const actions = document.getElementById('global-actions');
      // if(tabName === 'preview') actions.classList.remove('visible');
      // else actions.classList.add('visible');
    }
    
    function globalFill() {
        const m = currentMasterData || {};
        if (currentActiveTab === 'desc') {
            document.getElementById('edit-ShortDescrHe').value = m.wdm_ShortDescrHe || '';
            document.getElementById('edit-DescriptionHe').value = m.wdm_DescriptionHe || '';
            document.getElementById('edit-ShortDescrEn').value = m.wdm_ShortDescrEn || '';
            document.getElementById('edit-DescriptionEn').value = m.wdm_DescriptionEn || '';
        } else if (currentActiveTab === 'specs') {
            document.getElementById('edit-Region').value = m.wdm_Region || '';
        } else if (currentActiveTab === 'attr') {
            document.getElementById('edit-Intensity').value = m.wdm_Intensity || '';
            document.getElementById('edit-Complexity').value = m.wdm_Complexity || '';
        }
        updatePreview();
    }

    function globalClear() {
        if (currentActiveTab === 'desc') {
            document.getElementById('edit-ShortDescrHe').value = '';
            document.getElementById('edit-DescriptionHe').value = '';
            document.getElementById('edit-ShortDescrEn').value = '';
            document.getElementById('edit-DescriptionEn').value = '';
        } else if (currentActiveTab === 'specs') {
            document.getElementById('edit-Region').value = '';
        } else if (currentActiveTab === 'attr') {
            document.getElementById('edit-Intensity').value = '';
            document.getElementById('edit-Complexity').value = '';
        }
        updatePreview();
    }

    function updatePreview() {
        const name = currentMasterData.wdm_NameEn || '';
        const desc = document.getElementById('edit-DescriptionEn').value;
        document.getElementById('preview-en').textContent = `${name}\n\n${desc}`;
    }
    
    document.querySelectorAll('input, textarea').forEach(el => {
        el.addEventListener('input', updatePreview);
    });

    function submitChanges() {
      const formData = {
        wdm_NameEn: currentMasterData.wdm_NameEn,
        wdm_NameHe: currentMasterData.wdm_NameHe,
        wdm_ShortDescrHe: document.getElementById('edit-ShortDescrHe').value,
        wdm_DescriptionHe: document.getElementById('edit-DescriptionHe').value,
        wdm_ShortDescrEn: document.getElementById('edit-ShortDescrEn').value,
        wdm_DescriptionEn: document.getElementById('edit-DescriptionEn').value,
        wdm_Region: document.getElementById('edit-Region').value,
        wdm_Intensity: document.getElementById('edit-Intensity').value,
        wdm_Complexity: document.getElementById('edit-Complexity').value
      };

      document.getElementById('modal-status').textContent = 'Submitting...';
      google.script.run.withSuccessHandler(res => {
        if (res.success) {
          closeModal();
          refreshView();
        } else {
          alert('Error: ' + res.message);
        }
      }).WebAppProducts_handleManagerSubmit(currentTaskId, currentSku, formData);
    }

    // Init
    refreshView();
  </script>
</body>
</html>