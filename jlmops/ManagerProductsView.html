<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    /* Minimal custom styles, relying on Bootstrap from Dashboard.html */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: flex-start; padding-top: 80px; overflow-y: auto; }
    .modal-container { background: white; width: 90%; max-width: 900px; max-height: 85vh; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-bottom: 50px; }
    
    /* Header Redesign */
    .modal-header { padding: 10px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; background-color: #f8f9fa; border-radius: 8px 8px 0 0; }
    .modal-product-info { display: flex; justify-content: space-between; align-items: center; width: 100%; padding-right: 20px; }
    .header-item { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .header-left { text-align: left; font-weight: 600; color: #333; }
    .header-center { text-align: center; font-weight: 700; color: #007bff; font-size: 1.1em; }
    .header-right { text-align: right; direction: rtl; font-weight: 600; color: #333; }
    .modal-close { background: none; border: none; font-size: 24px; line-height: 1; cursor: pointer; color: #999; flex-shrink: 0; }
    .modal-close:hover { color: #333; }

    .form-body { flex: 1; overflow-y: auto; padding: 20px; }
    
    /* Compact Tab Bar with Actions */
    .tab-bar { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; justify-content: space-between; align-items: center; }
    .tab-group { display: flex; }
    .tab-btn { padding: 8px 15px; cursor: pointer; border-bottom: 2px solid transparent; color: #666; font-weight: 500; font-size: 14px; }
    .tab-btn:hover { color: #007bff; }
    .tab-btn.active { border-bottom-color: #007bff; color: #007bff; }
    
    .tab-actions { padding-right: 10px; } /* Always visible */
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
    .col-header { font-weight: 600; color: #555; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .hebrew-text { direction: rtl; text-align: right; }
    select#edit-Region option { text-align: right !important; }
    .preview-box { background: #fafafa; border: 1px solid #eee; padding: 15px; border-radius: 4px; min-height: 200px; white-space: pre-wrap; font-size: 13px; }

    /* Flexible Description Boxes */
    .desc-short, .desc-long { 
        width: 100%; 
        font-size: 14px; 
        line-height: 1.4;
        padding: 8px;
    }
    
    /* Read-only Divs */
    div.desc-short, div.desc-long {
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        border-radius: 4px;
        overflow-y: auto;
    }

    /* Editable Textareas */
    textarea.desc-short, textarea.desc-long {
        resize: vertical;
    }

    /* 2 lines approx */
    .desc-short { min-height: 40px; }
    /* 3 lines approx */
    .desc-long { min-height: 80px; }

  </style>
</head>
<body>
  <div class="container-fluid p-4">
    <!-- Main Card: Detail Updates -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Detail Updates</h5>
        <span id="stat-mismatch" class="badge badge-secondary badge-pill">0</span>
      </div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th class="border-top-0">Task</th>
              <th class="border-top-0">SKU</th>
              <th class="border-top-0">Date</th>
              <th class="border-top-0">Action</th>
            </tr>
          </thead>
          <tbody id="task-list-body">
            <!-- Tasks will be populated here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Product Editor Modal -->
  <div class="modal-overlay" id="editor-modal">
    <div class="modal-container">
      <!-- Consolidated Header -->
      <div class="modal-header">
        <div class="modal-product-info">
            <div id="header-name-en-display" class="header-item header-left"></div>
            <div id="header-sku-display" class="header-item header-center"></div>
            <div id="header-name-he-display" class="header-item header-right"></div>
        </div>
        <button class="modal-close" onclick="ManagerProductsView.closeModal()">&times;</button>
      </div>
      
      <div class="form-body">
        <!-- Tabs with Right-Aligned Actions -->
        <div class="tab-bar">
          <div class="tab-group">
            <div class="tab-btn active" onclick="ManagerProductsView.switchTab('desc')">Descriptions</div>
            <div class="tab-btn" onclick="ManagerProductsView.switchTab('specs')">Specs</div>
            <div class="tab-btn" onclick="ManagerProductsView.switchTab('attr')">Attributes</div>
            <div class="tab-btn" onclick="ManagerProductsView.switchTab('pair')">Pairing</div>
            <div class="tab-btn" onclick="ManagerProductsView.switchTab('grapes')">Grapes</div>
            <div class="tab-btn" onclick="ManagerProductsView.switchTab('kashrut')">Kashrut</div>
            <div class="tab-btn" onclick="ManagerProductsView.switchTab('preview')">Preview</div>
          </div>
          <div class="tab-actions" id="global-actions">
             <button class="btn btn-sm border" onclick="ManagerProductsView.globalFill()">Fill</button>
             <button class="btn btn-sm border" onclick="ManagerProductsView.globalClear()">Clear</button>
          </div>
        </div>

        <div id="tab-desc" class="tab-content active">
          <div class="comparison-grid">
            <!-- Current Column -->
            <div>
              <div class="col-header">Current</div>
              <div class="form-group">
                <label class="small text-muted mb-1">Hebrew Short Description</label>
                <div class="desc-short hebrew-text" id="cur-ShortDescrHe"></div>
              </div>
              <div class="form-group">
                <label class="small text-muted mb-1">Hebrew Description</label>
                <div class="desc-long hebrew-text" id="cur-DescriptionHe"></div>
              </div>
              <div class="form-group">
                <label class="small text-muted mb-1">English Short Description</label>
                <div class="desc-short" id="cur-ShortDescrEn"></div>
              </div>
              <div class="form-group">
                <label class="small text-muted mb-1">English Description</label>
                <div class="desc-long" id="cur-DescriptionEn"></div>
              </div>
            </div>
            
            <!-- Edit Column -->
            <div>
              <div class="col-header">Edit</div>
              <div class="form-group">
                <label class="small text-muted mb-1">Hebrew Short Description</label>
                <textarea class="form-control hebrew-text desc-short" id="edit-ShortDescrHe"></textarea>
              </div>
              <div class="form-group">
                <label class="small text-muted mb-1">Hebrew Description</label>
                <textarea class="form-control hebrew-text desc-long" id="edit-DescriptionHe"></textarea>
              </div>
              <div class="form-group">
                <label class="small text-muted mb-1">English Short Description</label>
                <textarea class="form-control desc-short" id="edit-ShortDescrEn"></textarea>
              </div>
              <div class="form-group">
                <label class="small text-muted mb-1">English Description</label>
                <textarea class="form-control desc-long" id="edit-DescriptionEn"></textarea>
              </div>
            </div>
          </div>
        </div>

        <div id="tab-specs" class="tab-content">
          <div class="comparison-grid">
            <div>
              <div class="col-header">Current</div>
               <div class="form-group"><label>Region</label><div class="p-2 bg-light border rounded" id="cur-Region"></div></div>
               <div class="form-group"><label>Alcohol by Volume</label><div class="p-2 bg-light border rounded" id="cur-ABV"></div></div>
               <div class="form-group"><label>Comax Vintage</label><div class="p-2 bg-light border rounded" id="cur-CmxVintage"></div></div>
               <div class="form-group"><label>Comax Size</label><div class="p-2 bg-light border rounded" id="cur-CmxSize"></div></div>
               <div class="form-group"><label>Comax Division</label><div class="p-2 bg-light border rounded" id="cur-CmxDivision"></div></div>
               <div class="form-group"><label>Comax Group</label><div class="p-2 bg-light border rounded" id="cur-CmxGroup"></div></div>
            </div>
            <div>
              <div class="col-header">Edit</div>
              <div class="form-group"><label>Region</label><select class="form-control" id="edit-Region"></select></div>
              <div class="form-group"><label>Alcohol by Volume (%)</label><input type="text" class="form-control" id="edit-ABV" list="abv-options" placeholder=""></div>
            </div>
          </div>
        </div>

        <div id="tab-attr" class="tab-content">
           <div class="comparison-grid">
            <div>
              <div class="col-header">Current</div>
              <div class="form-group"><label>Intensity</label><div class="p-2 bg-light border rounded" id="cur-Intensity"></div></div>
              <div class="form-group"><label>Complexity</label><div class="p-2 bg-light border rounded" id="cur-Complexity"></div></div>
              <div class="form-group"><label>Acidity</label><div class="p-2 bg-light border rounded" id="cur-Acidity"></div></div>
              <div class="form-group"><label>Decant</label><div class="p-2 bg-light border rounded" id="cur-Decant"></div></div>
            </div>
            <div>
              <div class="col-header">Edit</div>
              <div class="form-group"><label>Intensity (1-5)</label><select class="form-control" id="edit-Intensity"></select></div>
              <div class="form-group"><label>Complexity (1-5)</label><select class="form-control" id="edit-Complexity"></select></div>
              <div class="form-group"><label>Acidity (1-5)</label><select class="form-control" id="edit-Acidity"></select></div>
              <div class="form-group"><label>Decant (minutes)</label><select class="form-control" id="edit-Decant"></select></div>
            </div>
          </div>
        </div>
        
         <div id="tab-pair" class="tab-content">
           <div class="comparison-grid">
             <div>
               <div class="col-header">Current</div>
               <div class="form-group">
                 <label>Harmonize</label>
                 <div class="p-2 bg-light border rounded" id="cur-Harmonize"></div>
               </div>
               <div class="form-group">
                 <label>Contrast</label>
                 <div class="p-2 bg-light border rounded" id="cur-Contrast"></div>
               </div>
             </div>
             <div>
               <div class="col-header">Edit</div>
               
               <label class="mb-2 font-weight-bold text-muted small">Harmonize With</label>
               <div class="mb-3">
                 <div class="custom-control custom-checkbox">
                   <input type="checkbox" class="custom-control-input" id="edit-PairHarMild">
                   <label class="custom-control-label" for="edit-PairHarMild">Mild</label>
                 </div>
                 <div class="custom-control custom-checkbox">
                   <input type="checkbox" class="custom-control-input" id="edit-PairHarRich">
                   <label class="custom-control-label" for="edit-PairHarRich">Rich</label>
                 </div>
                 <div class="custom-control custom-checkbox">
                   <input type="checkbox" class="custom-control-input" id="edit-PairHarIntense">
                   <label class="custom-control-label" for="edit-PairHarIntense">Intense</label>
                 </div>
                 <div class="custom-control custom-checkbox">
                   <input type="checkbox" class="custom-control-input" id="edit-PairHarSweet">
                   <label class="custom-control-label" for="edit-PairHarSweet">Sweet</label>
                 </div>
               </div>

               <label class="mb-2 font-weight-bold text-muted small">Contrast With</label>
               <div>
                 <div class="custom-control custom-checkbox">
                   <input type="checkbox" class="custom-control-input" id="edit-PairConMild">
                   <label class="custom-control-label" for="edit-PairConMild">Mild</label>
                 </div>
                 <div class="custom-control custom-checkbox">
                   <input type="checkbox" class="custom-control-input" id="edit-PairConRich">
                   <label class="custom-control-label" for="edit-PairConRich">Rich</label>
                 </div>
                 <div class="custom-control custom-checkbox">
                   <input type="checkbox" class="custom-control-input" id="edit-PairConIntense">
                   <label class="custom-control-label" for="edit-PairConIntense">Intense</label>
                 </div>
                 <div class="custom-control custom-checkbox">
                   <input type="checkbox" class="custom-control-input" id="edit-PairConSweet">
                   <label class="custom-control-label" for="edit-PairConSweet">Sweet</label>
                 </div>
               </div>

             </div>
           </div>
        </div>

        <div id="tab-grapes" class="tab-content">
           <div class="comparison-grid">
             <div>
               <div class="col-header">Current</div>
               <div class="form-group"><label>Grape 1</label><div class="p-2 bg-light border rounded" id="cur-Grape1"></div></div>
               <div class="form-group"><label>Grape 2</label><div class="p-2 bg-light border rounded" id="cur-Grape2"></div></div>
               <div class="form-group"><label>Grape 3</label><div class="p-2 bg-light border rounded" id="cur-Grape3"></div></div>
               <div class="form-group"><label>Grape 4</label><div class="p-2 bg-light border rounded" id="cur-Grape4"></div></div>
               <div class="form-group"><label>Grape 5</label><div class="p-2 bg-light border rounded" id="cur-Grape5"></div></div>
             </div>
             <div>
               <div class="col-header">Edit</div>
               <div class="form-group"><label>Grape 1</label><select class="form-control" id="edit-Grape1"></select></div>
               <div class="form-group"><label>Grape 2</label><select class="form-control" id="edit-Grape2"></select></div>
               <div class="form-group"><label>Grape 3</label><select class="form-control" id="edit-Grape3"></select></div>
               <div class="form-group"><label>Grape 4</label><select class="form-control" id="edit-Grape4"></select></div>
               <div class="form-group"><label>Grape 5</label><select class="form-control" id="edit-Grape5"></select></div>
             </div>
           </div>
        </div>

        <div id="tab-kashrut" class="tab-content">
           <div class="comparison-grid">
             <div>
               <div class="col-header">Current</div>
               <div class="custom-control custom-checkbox mb-3">
                   <input type="checkbox" class="custom-control-input" id="cur-HeterMechira" disabled>
                   <label class="custom-control-label" for="cur-HeterMechira">Heter Mechira</label>
               </div>
               <div class="form-group"><label>Kashrut 1</label><div class="p-2 bg-light border rounded" id="cur-Kashrut1"></div></div>
               <div class="form-group"><label>Kashrut 2</label><div class="p-2 bg-light border rounded" id="cur-Kashrut2"></div></div>
               <div class="form-group"><label>Kashrut 3</label><div class="p-2 bg-light border rounded" id="cur-Kashrut3"></div></div>
               <div class="form-group"><label>Kashrut 4</label><div class="p-2 bg-light border rounded" id="cur-Kashrut4"></div></div>
               <div class="form-group"><label>Kashrut 5</label><div class="p-2 bg-light border rounded" id="cur-Kashrut5"></div></div>
             </div>
             <div>
               <div class="col-header">Edit</div>
               <div class="custom-control custom-checkbox mb-3">
                   <input type="checkbox" class="custom-control-input" id="edit-HeterMechira">
                   <label class="custom-control-label" for="edit-HeterMechira">Heter Mechira (היתר מכירה)</label>
               </div>
               <div class="form-group"><label>Kashrut 1</label><select class="form-control" id="edit-Kashrut1"></select></div>
               <div class="form-group"><label>Kashrut 2</label><select class="form-control" id="edit-Kashrut2"></select></div>
               <div class="form-group"><label>Kashrut 3</label><select class="form-control" id="edit-Kashrut3"></select></div>
               <div class="form-group"><label>Kashrut 4</label><select class="form-control" id="edit-Kashrut4"></select></div>
               <div class="form-group"><label>Kashrut 5</label><select class="form-control" id="edit-Kashrut5"></select></div>
             </div>
           </div>
        </div>

        <div id="tab-preview" class="tab-content">
           <div class="comparison-grid">
             <div>
               <div class="col-header">English Preview</div>
               <div class="preview-box" id="preview-en"></div>
             </div>
             <div>
               <div class="col-header">Hebrew Preview</div>
               <div class="preview-box hebrew-text" id="preview-he"></div>
             </div>
           </div>
        </div>

      </div>
      <datalist id="abv-options"></datalist>
      <div class="modal-footer bg-light">
        <div id="modal-status" class="mr-auto text-muted small"></div>
        <button class="btn border" onclick="ManagerProductsView.closeModal()">Cancel</button>
        <button class="btn" onclick="ManagerProductsView.submitChanges()">Submit</button>
      </div>
    </div>
  </div>

  <script>
    // Namespace to prevent global scope pollution on reload
    window.ManagerProductsView = {};

    // State Variables attached to namespace
    ManagerProductsView.currentTaskId = null;
    ManagerProductsView.currentSku = null;
    ManagerProductsView.currentMasterData = {};
    ManagerProductsView.currentActiveTab = 'desc';

    ManagerProductsView.refreshView = function() {
      ManagerProductsView.loadWidgetData();
      ManagerProductsView.loadTaskList();
    };

    ManagerProductsView.loadWidgetData = function() {
      google.script.run.withSuccessHandler(data => {
        if (data.error) return console.error(data.error);
        const widget = document.getElementById('stat-mismatch');
        if (widget) {
            widget.textContent = data.data['vintage_mismatch_tasks'] || 0;
        }
      }).WebAppProducts_getProductsWidgetData();
    };

    ManagerProductsView.loadTaskList = function() {
      const tbody = document.getElementById('task-list-body');
      tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
      
      google.script.run.withSuccessHandler(tasks => {
        tbody.innerHTML = '';
        if (!tasks || tasks.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4">No tasks found.</td></tr>';
          return;
        }
        
        tasks.forEach(task => {
          try {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${task.title}</td>
                <td>${task.sku}</td>
                <td>${new Date(task.createdDate).toLocaleDateString()}</td>
                <td><button class="btn btn-sm" onclick="ManagerProductsView.openEditor('${task.taskId}')">Open</button></td>
              `;
              tbody.appendChild(tr);
          } catch (e) {
              console.error('Error rendering row:', e);
          }
        });
      }).WebAppProducts_getManagerProductTasks();
    };

    // Helper to populate select dropdowns with data objects {code, textEN, textHE}
    ManagerProductsView.populateSelectWithData = function(selectIds, data) {
        selectIds.forEach(selectId => {
            const selectEl = document.getElementById(selectId);
            if (!selectEl) return;

            selectEl.innerHTML = '<option value="">-- Select --</option>'; 
            if (data && Array.isArray(data)) {
                data.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.code;
                    opt.textContent = item.textEN;
                    selectEl.appendChild(opt);
                });
            }
        });
    };

    // Helper to get lookup text by code
    ManagerProductsView.getLookupText = function(code, data, lang = 'en') {
        if (!code || !data) return '-';
        const normalizedCode = String(code).trim().toUpperCase();
        const item = data.find(d => String(d.code).trim().toUpperCase() === normalizedCode);
        if (!item) return code;
        if (lang === 'he') return item.textHE;
        return item.textEN;
    };

    ManagerProductsView.openEditor = function(taskId) {
      ManagerProductsView.currentTaskId = taskId;
      document.getElementById('editor-modal').style.display = 'flex';
      document.getElementById('modal-status').textContent = 'Loading data...';
      
      // Clear inputs
      document.querySelectorAll('input, textarea, .p-2').forEach(el => {
        if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
             if(el.type === 'checkbox') el.checked = false;
             else el.value = '';
        }
        else if(el.classList.contains('p-2')) el.textContent = '';
        else if(el.classList.contains('desc-short') || el.classList.contains('desc-long')) {
             if(el.tagName === 'DIV') el.textContent = '';
        }
      });
      
      // Reset tab to first
      ManagerProductsView.switchTab('desc');

      google.script.run
            .withSuccessHandler(data => {
               console.log('Received data from backend in openEditor:', data); 
               ManagerProductsView.currentSku = data.sku;
               ManagerProductsView.currentMasterData = data.masterData || {}; 
               ManagerProductsView.currentComaxData = data.comaxData || {}; // Store Comax Data
               ManagerProductsView.lookupRegions = data.regions || []; 
               ManagerProductsView.lookupGrapes = data.grapes || []; // Store grapes
               ManagerProductsView.lookupKashrut = data.kashrut || []; // Store kashrut
               
               // Populate dropdowns and datalists
               ManagerProductsView.populateRegionDropdown(data.regions);
               ManagerProductsView.populateABVDatalist(data.abvOptions);
               
               // Populate attribute dropdowns
               ManagerProductsView.populateSelectRange(['edit-Intensity', 'edit-Complexity', 'edit-Acidity'], [1, 2, 3, 4, 5]);
               ManagerProductsView.populateSelectRange(['edit-Decant'], [15, 30, 45, 60]);

               // Populate Grape dropdowns
               ManagerProductsView.populateSelectWithData(['edit-Grape1', 'edit-Grape2', 'edit-Grape3', 'edit-Grape4', 'edit-Grape5'], data.grapes);

               // Populate Kashrut dropdowns
               ManagerProductsView.populateSelectWithData(['edit-Kashrut1', 'edit-Kashrut2', 'edit-Kashrut3', 'edit-Kashrut4', 'edit-Kashrut5'], data.kashrut);

                      // Populate Header
                      const headerSku = data.sku;
                      const headerNameEn = ManagerProductsView.currentMasterData.wdm_NameEn || 'Unknown Product';
                      const headerNameHe = ManagerProductsView.currentMasterData.wdm_NameHe || '';
                      
                      document.getElementById('header-sku-display').textContent = headerSku;
                      document.getElementById('header-name-en-display').textContent = headerNameEn;
                      document.getElementById('header-name-he-display').textContent = headerNameHe;
             
                      try {
                          ManagerProductsView.populateEditor(data.masterData, data.stagingData, data.comaxData);
                          document.getElementById('modal-status').textContent = '';
                      } catch (e) {
                          console.error('Error populating editor:', e);
                          document.getElementById('modal-status').textContent = 'Error displaying data.';
                      }
                   })      .withFailureHandler(err => {
          console.error('Failed to load editor data:', err);
          document.getElementById('modal-status').textContent = 'Error: ' + err.message;
      })
      .WebAppProducts_loadProductEditorData(taskId);
    };

    ManagerProductsView.populateEditor = function(master, staging, comax) {
      const m = master || {};
      const s = staging || {};
      const c = comax || {};

      // Populate Current Column (Read Only)
      ManagerProductsView.setVal('cur-ShortDescrHe', m.wdm_ShortDescrHe);
      ManagerProductsView.setVal('cur-DescriptionHe', m.wdm_DescriptionHe);
      ManagerProductsView.setVal('cur-ShortDescrEn', m.wdm_ShortDescrEn);
      ManagerProductsView.setVal('cur-DescriptionEn', m.wdm_DescriptionEn);
      
      // Specs Tab - Current
      ManagerProductsView.setVal('cur-Region', m.wdm_Region);
      ManagerProductsView.setVal('cur-ABV', ManagerProductsView.formatABV(m.wdm_ABV));
      ManagerProductsView.setVal('cur-CmxVintage', c.cpm_Vintage);
      ManagerProductsView.setVal('cur-CmxSize', c.cpm_Size);
      ManagerProductsView.setVal('cur-CmxDivision', c.cpm_Division);
      ManagerProductsView.setVal('cur-CmxGroup', c.cpm_Group);

      // Attributes Tab - Current
      ManagerProductsView.setVal('cur-Intensity', m.wdm_Intensity);
      ManagerProductsView.setVal('cur-Complexity', m.wdm_Complexity);
      ManagerProductsView.setVal('cur-Acidity', m.wdm_Acidity); // New
      ManagerProductsView.setVal('cur-Decant', m.wdm_Decant); // New

      // Populate Edit Column - Default to Empty, or Staging if available
      ManagerProductsView.setInp('edit-ShortDescrHe', s.wds_ShortDescrHe || '');
      ManagerProductsView.setInp('edit-DescriptionHe', s.wds_DescriptionHe || '');
      ManagerProductsView.setInp('edit-ShortDescrEn', s.wds_ShortDescrEn || '');
      ManagerProductsView.setInp('edit-DescriptionEn', s.wds_DescriptionEn || '');
      
      // Specs Tab - Edit
      ManagerProductsView.setInp('edit-Region', ''); 
      ManagerProductsView.setInp('edit-ABV', ''); 

      // Attributes Tab - Edit
      ManagerProductsView.setInp('edit-Intensity', ''); 
      ManagerProductsView.setInp('edit-Complexity', '');
      ManagerProductsView.setInp('edit-Acidity', ''); 
      ManagerProductsView.setInp('edit-Decant', ''); 
      
      // Pairing Tab - Current
      const harFields = {'wdm_PairHarMild':'Mild', 'wdm_PairHarRich':'Rich', 'wdm_PairHarIntense':'Intense', 'wdm_PairHarSweet':'Sweet'};
      const conFields = {'wdm_PairConMild':'Mild', 'wdm_PairConRich':'Rich', 'wdm_PairConIntense':'Intense', 'wdm_PairConSweet':'Sweet'};
      
      // Enforce specific order: Mild, Rich, Intense, Sweet
      const flavorOrder = ['Mild', 'Rich', 'Intense', 'Sweet'];
      
      const buildPairingString = (fieldsMap, masterData) => {
          return flavorOrder.filter(flavor => {
              // Find the key in fieldsMap that maps to this flavor
              const key = Object.keys(fieldsMap).find(k => fieldsMap[k] === flavor);
              return masterData[key] == 1;
          }).join(', ');
      };

      const curHar = buildPairingString(harFields, m);
      const curCon = buildPairingString(conFields, m);
      
      ManagerProductsView.setVal('cur-Harmonize', curHar);
      ManagerProductsView.setVal('cur-Contrast', curCon);

      // Grapes Tab - Current
      for (let i = 1; i <= 5; i++) {
          ManagerProductsView.setVal(`cur-Grape${i}`, ManagerProductsView.getLookupText(m[`wdm_GrapeG${i}`], ManagerProductsView.lookupGrapes));
      }

      // Kashrut Tab - Current
      const curHmEl = document.getElementById('cur-HeterMechira');
      if (curHmEl) curHmEl.checked = (m.wdm_HeterMechira == 1);
      
      for (let i = 1; i <= 5; i++) {
          ManagerProductsView.setVal(`cur-Kashrut${i}`, ManagerProductsView.getLookupText(m[`wdm_KashrutK${i}`], ManagerProductsView.lookupKashrut));
      }

      // Pairing Tab - Edit (Reset checkboxes)
      ['edit-PairHarSweet', 'edit-PairHarIntense', 'edit-PairHarRich', 'edit-PairHarMild',
       'edit-PairConSweet', 'edit-PairConIntense', 'edit-PairConRich', 'edit-PairConMild'].forEach(id => {
           const el = document.getElementById(id);
           if(el) el.checked = false;
       });
       
      // Grapes Tab - Edit (Reset)
      ['edit-Grape1', 'edit-Grape2', 'edit-Grape3', 'edit-Grape4', 'edit-Grape5'].forEach(id => {
          const el = document.getElementById(id);
          if(el) el.value = '';
      });

      // Kashrut Tab - Edit (Reset)
      const hmEl = document.getElementById('edit-HeterMechira');
      if(hmEl) hmEl.checked = false;
      ['edit-Kashrut1', 'edit-Kashrut2', 'edit-Kashrut3', 'edit-Kashrut4', 'edit-Kashrut5'].forEach(id => {
          const el = document.getElementById(id);
          if(el) el.value = '';
      });
      
      ManagerProductsView.updatePreview();
    };
    
    // Helper function to format ABV for display (e.g., "12.5%")
    ManagerProductsView.formatABV = function(value) {
        const num = parseFloat(value);
        return isNaN(num) ? '-' : `${(num * 100).toFixed(1)}%`;
    };

    // Helper function to format ABV for input (e.g., "12.5")
    ManagerProductsView.formatABVForInput = function(value) {
        const num = parseFloat(value);
        return isNaN(num) ? '' : (num * 100).toFixed(1);
    };





    // Helper to populate the ABV datalist
    ManagerProductsView.populateABVDatalist = function(abvOptions) {
        const datalistEl = document.getElementById('abv-options');
        if (!datalistEl) return;
        datalistEl.innerHTML = '';
        abvOptions.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option;
            datalistEl.appendChild(opt);
        });
    };

    // Helper to populate select dropdowns with a range or specific options
    ManagerProductsView.populateSelectRange = function(selectIds, options) {
        selectIds.forEach(selectId => {
            const selectEl = document.getElementById(selectId);
            if (!selectEl) return;

            selectEl.innerHTML = '<option value="">-- Select --</option>'; // Default empty option
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectEl.appendChild(opt);
            });
        });
    };

    // Helper to populate the Region dropdown
    ManagerProductsView.populateRegionDropdown = function(regions) {
        const selectEl = document.getElementById('edit-Region');
        if (!selectEl) return;

        // Clear existing options and add a default "Select Region" option
        selectEl.innerHTML = '<option value="">Select Region</option>'; 

        if (regions && Array.isArray(regions)) {
            regions.forEach(region => {
                const opt = document.createElement('option');
                opt.value = region.code; // Use 'code' property from the mapped object
                opt.textContent = region.code; // Use 'code' property for display text for testing
                selectEl.appendChild(opt);
            });
        }
    };

    ManagerProductsView.setVal = function(id, val) { document.getElementById(id).textContent = val || '-'; };
    ManagerProductsView.setInp = function(id, val) { document.getElementById(id).value = val || ''; };

    ManagerProductsView.closeModal = function() {
      document.getElementById('editor-modal').style.display = 'none';
    };

    ManagerProductsView.switchTab = function(tabName) {
      ManagerProductsView.currentActiveTab = tabName;
      document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.tab-btn').forEach(el => {
          el.classList.remove('active');
          // Check if this button corresponds to the tabName
          if (el.getAttribute('onclick').includes(`'${tabName}'`)) {
              el.classList.add('active');
          }
      });
      
      document.getElementById('tab-' + tabName).style.display = 'block';
    };
    
    ManagerProductsView.globalFill = function() {
        const m = ManagerProductsView.currentMasterData || {};
        const tab = ManagerProductsView.currentActiveTab;
        if (tab === 'desc') {
            document.getElementById('edit-ShortDescrHe').value = m.wdm_ShortDescrHe || '';
            document.getElementById('edit-DescriptionHe').value = m.wdm_DescriptionHe || '';
            document.getElementById('edit-ShortDescrEn').value = m.wdm_ShortDescrEn || '';
            document.getElementById('edit-DescriptionEn').value = m.wdm_DescriptionEn || '';
        } else if (tab === 'specs') {
            // Special Logic for Region: Map Name to Code if needed
            let regionVal = m.wdm_Region || '';
            const selectEl = document.getElementById('edit-Region');
            
            // 1. Try direct assignment (assuming regionVal is a Code)
            selectEl.value = regionVal;
            
            // 2. If failed (selectedIndex is -1 or 0/default but value was not empty), try to find by Name or Code match
            if (regionVal && selectEl.selectedIndex <= 0) {
                // Try finding by TextHE
                let match = ManagerProductsView.lookupRegions.find(r => r.textHE === regionVal);
                
                // If not found, try finding by Code (just in case strict equality failed above due to types)
                if (!match) {
                    match = ManagerProductsView.lookupRegions.find(r => String(r.code) === String(regionVal));
                }

                if (match) {
                    selectEl.value = match.code;
                }
            }
            
            document.getElementById('edit-ABV').value = ManagerProductsView.formatABVForInput(m.wdm_ABV || '');
        } else if (tab === 'attr') {
            document.getElementById('edit-Intensity').value = m.wdm_Intensity || '';
            document.getElementById('edit-Complexity').value = m.wdm_Complexity || '';
            document.getElementById('edit-Acidity').value = m.wdm_Acidity || ''; // New
            document.getElementById('edit-Decant').value = m.wdm_Decant || ''; // New
        } else if (tab === 'pair') {
            const map = {
                'edit-PairHarSweet': 'wdm_PairHarSweet', 'edit-PairHarIntense': 'wdm_PairHarIntense', 
                'edit-PairHarRich': 'wdm_PairHarRich', 'edit-PairHarMild': 'wdm_PairHarMild',
                'edit-PairConSweet': 'wdm_PairConSweet', 'edit-PairConIntense': 'wdm_PairConIntense', 
                'edit-PairConRich': 'wdm_PairConRich', 'edit-PairConMild': 'wdm_PairConMild'
            };
            for (const [id, key] of Object.entries(map)) {
                const el = document.getElementById(id);
                if (el) el.checked = (m[key] == 1);
            }
        } else if (tab === 'grapes') {
             for (let i = 1; i <= 5; i++) {
                 const val = m[`wdm_GrapeG${i}`];
                 if (val) document.getElementById(`edit-Grape${i}`).value = val;
             }
        } else if (tab === 'kashrut') {
             const hmEl = document.getElementById('edit-HeterMechira');
             if (hmEl) hmEl.checked = (m.wdm_HeterMechira == 1);
             for (let i = 1; i <= 5; i++) {
                 const val = m[`wdm_KashrutK${i}`];
                 if (val) document.getElementById(`edit-Kashrut${i}`).value = val;
             }
        }
        ManagerProductsView.updatePreview();
    };

    ManagerProductsView.globalClear = function() {
        const tab = ManagerProductsView.currentActiveTab;
        if (tab === 'desc') {
            document.getElementById('edit-ShortDescrHe').value = '';
            document.getElementById('edit-DescriptionHe').value = '';
            document.getElementById('edit-ShortDescrEn').value = '';
            document.getElementById('edit-DescriptionEn').value = '';
        } else if (tab === 'specs') {
            document.getElementById('edit-Region').value = '';
            document.getElementById('edit-ABV').value = '';
        } else if (tab === 'attr') {
            document.getElementById('edit-Intensity').value = '';
            document.getElementById('edit-Complexity').value = '';
            document.getElementById('edit-Acidity').value = ''; // New
            document.getElementById('edit-Decant').value = ''; // New
        } else if (tab === 'pair') {
             ['edit-PairHarSweet', 'edit-PairHarIntense', 'edit-PairHarRich', 'edit-PairHarMild',
              'edit-PairConSweet', 'edit-PairConIntense', 'edit-PairConRich', 'edit-PairConMild'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.checked = false;
            });
        } else if (tab === 'grapes') {
             ['edit-Grape1', 'edit-Grape2', 'edit-Grape3', 'edit-Grape4', 'edit-Grape5'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
        } else if (tab === 'kashrut') {
             const hmEl = document.getElementById('edit-HeterMechira');
             if (hmEl) hmEl.checked = false;
             ['edit-Kashrut1', 'edit-Kashrut2', 'edit-Kashrut3', 'edit-Kashrut4', 'edit-Kashrut5'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
        }
        ManagerProductsView.updatePreview();
    };

    ManagerProductsView.updatePreview = function() {
        const m = ManagerProductsView.currentMasterData || {};
        const c = ManagerProductsView.currentComaxData || {};
        
        // Helper to escape HTML characters
        const escapeHtml = (unsafe) => {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        };

        // Helper to generate preview text for a specific language
        const generatePreview = (lang) => {
            const isEn = lang === 'en';
            let descriptionBlock = [];
            let detailsBlock = [];
            
            // Heter Mechira text for insertion
            const isHeterMechira = document.getElementById('edit-HeterMechira').checked;
            const hmText = isEn ? '*** Heter Mechira ***' : '*** היתר מכירה ***';

            // 1. Product Name (Always from Master)
            const name = isEn ? (m.wdm_NameEn || '') : (m.wdm_NameHe || '');
            if (name) descriptionBlock.push(`<b>${escapeHtml(name)}</b>`);
            
            // Add first divider if name exists
            if (name) descriptionBlock.push('<hr>');

            // 2. Short Description (From Edit)
            let shortDesc = document.getElementById(isEn ? 'edit-ShortDescrEn' : 'edit-ShortDescrHe').value;
            if (shortDesc && isHeterMechira) {
                 shortDesc += ` ${hmText}`;
            } else if (!shortDesc && isHeterMechira) {
                 shortDesc = hmText;
            }
            if (shortDesc) descriptionBlock.push(escapeHtml(shortDesc));

            // Add second divider if shortDesc exists
            if (shortDesc) descriptionBlock.push('<hr>');

            // 3. Product Name + Long Description (From Edit)
            const longDesc = document.getElementById(isEn ? 'edit-DescriptionEn' : 'edit-DescriptionHe').value;
            let nameAndLongDesc = '';
            if (name) nameAndLongDesc += escapeHtml(name);
            if (name && longDesc) nameAndLongDesc += ' ';
            if (longDesc) nameAndLongDesc += escapeHtml(longDesc);
            if (nameAndLongDesc) descriptionBlock.push(nameAndLongDesc);
            if (nameAndLongDesc) descriptionBlock.push('<br>'); // Add blank row here


            // 4. Details Section
            const addDetail = (label, val) => { if (val) detailsBlock.push(`${label}: ${escapeHtml(String(val))}`); };

            // Comax Fields
            addDetail(isEn ? 'Type' : 'סוג', c.cpm_Group);
            addDetail(isEn ? 'Vintage' : 'שנת בציר', c.cpm_Vintage);
            
            // ABV
            const abv = document.getElementById('edit-ABV').value;
            if (abv) addDetail(isEn ? 'Alcohol' : 'אלכוהול', `${abv}%`);
            
            // Volume
            addDetail(isEn ? 'Volume' : 'גודל', c.cpm_Size);

            // Region
            const regionCode = document.getElementById('edit-Region').value;
            if (regionCode) {
                addDetail(isEn ? 'Region' : 'אזור', ManagerProductsView.getLookupText(regionCode, ManagerProductsView.lookupRegions, lang));
            }
            
            // Attributes
            const attrMap = isEn ? 
                { intensity: 'Intensity', complexity: 'Complexity', acidity: 'Acidity', decant: 'Decant' } : 
                { intensity: 'עוצמה', complexity: 'מורכבות', acidity: 'חומציות', decant: 'דקנטר' };
                
            addDetail(attrMap.intensity, document.getElementById('edit-Intensity').value);
            addDetail(attrMap.complexity, document.getElementById('edit-Complexity').value);
            addDetail(attrMap.acidity, document.getElementById('edit-Acidity').value);
            
            const decant = document.getElementById('edit-Decant').value;
            if (decant) addDetail(attrMap.decant, `${decant} ${isEn ? 'min' : 'דקות'}`);

            // Pairings
            const flavorKeys = ['Mild', 'Rich', 'Intense', 'Sweet'];
            const flavorsEn = { 'Mild': 'Mild', 'Rich': 'Rich', 'Intense': 'Intense', 'Sweet': 'Sweet' };
            const flavorsHe = { 'Mild': 'עדין', 'Rich': 'עשיר', 'Intense': 'עוצמתי', 'Sweet': 'מתוק' };
            const currentFlavors = isEn ? flavorsEn : flavorsHe;
            
            // Harmonize
            const harSelected = flavorKeys.filter(key => document.getElementById(`edit-PairHar${key}`).checked)
                                          .map(key => currentFlavors[key]);
            if (harSelected.length > 0) {
                const label = isEn ? 'Harmonize with' : 'הרמוניה עם טעמים';
                const separator = isEn ? ' or ' : ' או ';
                const suffix = isEn ? ' flavors' : '';
                detailsBlock.push(`${label}: ${harSelected.join(separator)}${suffix}`);
            }
            
            // Contrast
            const conSelected = flavorKeys.filter(key => document.getElementById(`edit-PairCon${key}`).checked)
                                          .map(key => currentFlavors[key]);
            if (conSelected.length > 0) {
                const label = isEn ? 'Contrast with' : 'קונטרסט עם טעמים';
                const separator = isEn ? ' or ' : ' או ';
                const suffix = isEn ? ' flavors' : '';
                detailsBlock.push(`${label}: ${conSelected.join(separator)}${suffix}`);
            }
            
            // Grapes
            const grapeList = [];
            for(let i=1; i<=5; i++) {
                const val = document.getElementById(`edit-Grape${i}`).value;
                if(val) {
                     grapeList.push(ManagerProductsView.getLookupText(val, ManagerProductsView.lookupGrapes, lang));
                }
            }
            if (grapeList.length > 0) {
                addDetail(isEn ? 'Grapes' : 'זנים', grapeList.join(', '));
            }

            // Kashrut
            const kashrutList = [];
            for(let i=1; i<=5; i++) {
                const val = document.getElementById(`edit-Kashrut${i}`).value;
                if(val) {
                     kashrutList.push(ManagerProductsView.getLookupText(val, ManagerProductsView.lookupKashrut, lang));
                }
            }
            if (kashrutList.length > 0) {
                addDetail(isEn ? 'Kashrut' : 'כשרות', kashrutList.join(', '));
            }

            let combinedHtml = descriptionBlock.filter(Boolean).join('');
            if (detailsBlock.length > 0) {
                if (combinedHtml.length > 0) {
                    combinedHtml += '<br>'; // Single blank line
                }
                combinedHtml += detailsBlock.join('<br>');
            }
            
            return combinedHtml;
        };

        document.getElementById('preview-en').innerHTML = generatePreview('en');
        document.getElementById('preview-he').innerHTML = generatePreview('he');
    };
    
    document.querySelectorAll('input, textarea, select').forEach(el => {
        // Remove old listeners to prevent duplicates on reload
        el.removeEventListener('input', ManagerProductsView.updatePreview);
        el.removeEventListener('change', ManagerProductsView.updatePreview); // Added change listener for selects
        el.addEventListener('input', ManagerProductsView.updatePreview);
        el.addEventListener('change', ManagerProductsView.updatePreview); // Added change listener for selects
    });

    ManagerProductsView.submitChanges = function() {
      const formData = {
        wdm_NameEn: ManagerProductsView.currentMasterData.wdm_NameEn,
        wdm_NameHe: ManagerProductsView.currentMasterData.wdm_NameHe,
        wdm_ShortDescrHe: document.getElementById('edit-ShortDescrHe').value,
        wdm_DescriptionHe: document.getElementById('edit-DescriptionHe').value,
        wdm_ShortDescrEn: document.getElementById('edit-ShortDescrEn').value,
        wdm_DescriptionEn: document.getElementById('edit-DescriptionEn').value,
        wdm_Region: document.getElementById('edit-Region').value,
        wdm_ABV: document.getElementById('edit-ABV').value,
        wdm_Intensity: document.getElementById('edit-Intensity').value,
        wdm_Complexity: document.getElementById('edit-Complexity').value,
        wdm_Acidity: document.getElementById('edit-Acidity').value, // New
        wdm_Decant: document.getElementById('edit-Decant').value, // New
        
        // Pairings
        wdm_PairHarSweet: document.getElementById('edit-PairHarSweet').checked ? 1 : 0,
        wdm_PairHarIntense: document.getElementById('edit-PairHarIntense').checked ? 1 : 0,
        wdm_PairHarRich: document.getElementById('edit-PairHarRich').checked ? 1 : 0,
        wdm_PairHarMild: document.getElementById('edit-PairHarMild').checked ? 1 : 0,
        wdm_PairConSweet: document.getElementById('edit-PairConSweet').checked ? 1 : 0,
        wdm_PairConIntense: document.getElementById('edit-PairConIntense').checked ? 1 : 0,
        wdm_PairConRich: document.getElementById('edit-PairConRich').checked ? 1 : 0,
        wdm_PairConMild: document.getElementById('edit-PairConMild').checked ? 1 : 0,
        
        // Grapes
        wdm_GrapeG1: document.getElementById('edit-Grape1').value,
        wdm_GrapeG2: document.getElementById('edit-Grape2').value,
        wdm_GrapeG3: document.getElementById('edit-Grape3').value,
        wdm_GrapeG4: document.getElementById('edit-Grape4').value,
        wdm_GrapeG5: document.getElementById('edit-Grape5').value,

        // Kashrut
        wdm_HeterMechira: document.getElementById('edit-HeterMechira').checked ? 1 : 0,
        wdm_KashrutK1: document.getElementById('edit-Kashrut1').value,
        wdm_KashrutK2: document.getElementById('edit-Kashrut2').value,
        wdm_KashrutK3: document.getElementById('edit-Kashrut3').value,
        wdm_KashrutK4: document.getElementById('edit-Kashrut4').value,
        wdm_KashrutK5: document.getElementById('edit-Kashrut5').value
      };

      document.getElementById('modal-status').textContent = 'Submitting...';
      google.script.run.withSuccessHandler(res => {
        if (res.success) {
          ManagerProductsView.closeModal();
          ManagerProductsView.refreshView();
        } else {
          alert('Error: ' + res.message);
        }
      }).WebAppProducts_handleManagerSubmit(ManagerProductsView.currentTaskId, ManagerProductsView.currentSku, formData);
    };

    // Init
    ManagerProductsView.refreshView();
  </script>
</body>
</html>