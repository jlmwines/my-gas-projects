<div id="inventory-widget" style="padding: 0;">
  <p>Loading...</p>
</div>

<script>
  /**
   * Handles the click event for the 'Web Export' button.
   */
  function handleWebExportClick() {
    const exportBtn = document.getElementById('btn-web-export');
    const messageArea = document.getElementById('web-inventory-message-area');
    
    if (confirm("Are you sure you want to export web inventory?")) {
      exportBtn.disabled = true;
      exportBtn.className = 'btn';
      messageArea.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Processing...';

      google.script.run
        .withSuccessHandler(response => {
          google.script.run.withSuccessHandler(updateInventoryView).withFailureHandler(showError).getInventoryWidgetData();
        })
        .withFailureHandler(showError)
        .exportWebInventory(); // This global function needs to exist in WebApp.js
    }
  }

  /**
   * Handles the click event for the 'Web Updated' button.
   * @param {string} taskId - The ID of the confirmation task to complete.
   */
  function handleWebConfirmClick(taskId) {
    const confirmBtn = document.getElementById('btn-web-updated');
    const messageArea = document.getElementById('web-inventory-message-area');

    if (confirm("Are you sure you want to confirm the web inventory update?")) {
      confirmBtn.disabled = true;
      confirmBtn.className = 'btn';
      messageArea.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Processing...';
      
      google.script.run
        .withSuccessHandler(wasCompleted => {
          if (!wasCompleted) {
            showError('Failed to confirm task. It may have already been completed.');
          }
          google.script.run.withSuccessHandler(updateInventoryView).withFailureHandler(showError).getInventoryWidgetData();
        })
        .withFailureHandler(showError)
        .completeTaskById(taskId);
    }
  }

  /**
   * Populates the inventory widget.
   * @param {Object} data - The inventory data from the backend.
   */
  function updateInventoryView(data) {
    const widget = document.getElementById('inventory-widget');
    if (!data) {
      widget.innerHTML = `<p class="text-danger">Error: No data received from server.</p>`;
      return;
    }
    if (data.error) {
      widget.innerHTML = `<p class="text-danger">${data.error}</p>`;
      return;
    }

    let html = '<h5>Inventory Overview</h5>';

    // Brurya Summary
    html += '<p>Brurya Products: <strong>' + (data.bruryaProductCount || 0) + '</strong></p>';
    html += '<p>Brurya Total Stock: <strong>' + (data.bruryaTotalStock || 0) + '</strong></p>';
    html += '<hr>';

    // Open Inventory Tasks
    html += '<h6>Open Inventory Tasks</h6>';
    html += '<p>Negative Inventory Tasks: <strong>' + (data.openNegativeInventoryTasksCount || 0) + '</strong></p>';
    html += '<p>Inventory Count Tasks: <strong>' + (data.openInventoryCountTasksCount > 0 ? data.openInventoryCountTasksCount : '') + '</strong></p>';
    html += '<p>Inventory Count Review Tasks: <strong>' + (data.openInventoryCountReviewTasksCount > 0 ? data.openInventoryCountReviewTasksCount : '') + '</strong></p>';
    html += '<hr>';

    // Web Inventory Update Section
    html += '<h6>Web Inventory Update</h6>';
    html += '<div id="web-inventory-message-area" style="margin-bottom: 0.5rem;"></div>';
    html += '<button id="btn-web-export" class="btn" disabled>Web Export</button>';
    html += '<button id="btn-web-updated" class="btn" style="margin-left: 0.5rem;" disabled>Web Updated</button>';
    html += '<hr>';

    // Disabled Comax Inventory Export Section
    html += '<p>Comax Inventory Export functionality is currently disabled.</p>';

    widget.innerHTML = html;

    // --- State-Aware Logic for Web Inventory Update ---
    const exportBtn = document.getElementById('btn-web-export');
    const confirmBtn = document.getElementById('btn-web-updated');
    const messageArea = document.getElementById('web-inventory-message-area');

    exportBtn.className = 'btn';
    confirmBtn.className = 'btn';

    if (data.webInventoryConfirmationTask) {
      messageArea.innerHTML = `<div class="alert alert-warning" style="padding: 0.5rem 1rem;">${data.webInventoryConfirmationTask.notes}</div>`;
      confirmBtn.disabled = false;
      confirmBtn.className = 'btn';
      confirmBtn.setAttribute('onclick', `handleWebConfirmClick('${data.webInventoryConfirmationTask.id}')`);
    } else if (data.webInventoryExportReadyTask) {
      messageArea.innerHTML = `<div class="alert alert-info" style="padding: 0.5rem 1rem;">Web inventory export is ready.</div>`;
      exportBtn.disabled = false;
      exportBtn.className = 'btn';
      exportBtn.setAttribute('onclick', 'handleWebExportClick()');
    } else {
      messageArea.innerHTML = '<p>Awaiting product imports.</p>';
    }
  }

  // Initial data load for this view
  google.script.run.withSuccessHandler(updateInventoryView).withFailureHandler(showError).getInventoryWidgetData();
</script>
