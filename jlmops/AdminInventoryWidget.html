<div id="inventory-widget" style="padding: 0;">
  <p>Loading...</p>
</div>

<script>
  /**
   * Handles the click event for the 'Web Export' button.
   */
  function handleWebExportClick() {
    const exportBtn = document.getElementById('btn-web-export');
    const messageArea = document.getElementById('web-inventory-message-area');
    
    if (confirm("Are you sure you want to export web inventory?")) {
      exportBtn.disabled = true;
      exportBtn.className = 'btn';
      messageArea.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Processing...';

      google.script.run
        .withSuccessHandler(response => {
          if (response && response.message) {
            alert(response.message);
          }
          google.script.run.withSuccessHandler(updateInventoryView).withFailureHandler(showError).WebAppInventory_getInventoryWidgetData();
        })
        .withFailureHandler(showError)
        .WebAppInventory_exportWebInventory();
    }
  }

  /**
   * Handles the click event for the 'Web Updated' button.
   * @param {string} taskId - The ID of the confirmation task to complete.
   */
  function handleWebConfirmClick(taskId) {
    const confirmBtn = document.getElementById('btn-web-updated');
    const messageArea = document.getElementById('web-inventory-message-area');

    if (confirm("Are you sure you want to confirm the web inventory update?")) {
      confirmBtn.disabled = true;
      confirmBtn.className = 'btn';
      messageArea.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Processing...';
      
      google.script.run
        .withSuccessHandler(wasCompleted => {
          if (!wasCompleted) {
            showError('Failed to confirm task. It may have already been completed.');
          }
          google.script.run.withSuccessHandler(updateInventoryView).withFailureHandler(showError).WebAppInventory_getInventoryWidgetData();
        })
        .withFailureHandler(showError)
        .WebAppTasks_completeTaskById(taskId);
    }
  }

  /**
   * Populates the inventory widget.
   * @param {Object} data - The inventory data from the backend.
   */
  function updateInventoryView(data) {
    const widget = document.getElementById('inventory-widget');
    if (!data) {
      widget.innerHTML = `<p class="text-danger">Error: No data received from server.</p>`;
      return;
    }
    if (data.error) {
      widget.innerHTML = `<p class="text-danger">${data.error}</p>`;
      return;
    }

    let html = '<h5>Inventory</h5>';

    // Brurya Summary
    html += '<p>Brurya Products: <strong>' + (data.bruryaProductCount || 0) + '</strong></p>';
    html += '<p>Brurya Total Stock: <strong>' + (data.bruryaTotalStock || 0) + '</strong></p>';
    html += '<hr>';

    html += '<h6>Open Inventory Tasks</h6>';
    html += '<p>Negative Inventory: <strong>' + (data.openNegativeInventoryTasksCount || 0) + '</strong></p>';
    html += '<p>Inventory Count: <strong>' + (data.openInventoryCountTasksCount || 0) + '</strong></p>';
    html += '<p>Inventory Count Reviews: <strong>' + (data.openInventoryCountReviewTasksCount || 0) + '</strong></p>';
    html += '<hr>';

    // Web Inventory Update Section
    html += '<h6>Web Inventory Update</h6>';
    html += '<div id="web-inventory-message-area" style="margin-bottom: 0.5rem;"></div>';
    html += '<button id="btn-web-export" class="btn" disabled>Web Export</button>';
    html += '<button id="btn-web-updated" class="btn" style="margin-left: 0.5rem;" disabled>Web Updated</button>';
    html += '<hr>';

    // Comax Inventory Export Section
    html += '<h6>Comax Inventory Export</h6>';
    html += '<div id="comax-inventory-message-area" style="margin-bottom: 0.5rem;"></div>';
    html += '<button id="btn-comax-export" class="btn" disabled>Comax Export</button>';
    html += '<button id="btn-comax-updated" class="btn" style="margin-left: 0.5rem;" disabled>Comax Updated</button>';
    html += '<hr>';

    widget.innerHTML = html;

    // --- State-Aware Logic for Web Inventory Update ---
    const exportBtn = document.getElementById('btn-web-export');
    const confirmBtn = document.getElementById('btn-web-updated');
    const messageArea = document.getElementById('web-inventory-message-area');

    exportBtn.className = 'btn';
    confirmBtn.className = 'btn';

    if (data.webInventoryConfirmationTask) {
      messageArea.innerHTML = `<div class="alert alert-warning" style="padding: 0.5rem 1rem;">${data.webInventoryConfirmationTask.notes}</div>`;
      confirmBtn.disabled = false;
      confirmBtn.className = 'btn'; // Reverted to original 'btn'
      confirmBtn.onclick = function() { handleWebConfirmClick(data.webInventoryConfirmationTask.id); };
    } else if (data.webInventoryExportReadyTask) {
      messageArea.innerHTML = `<div class="alert alert-info" style="padding: 0.5rem 1rem;">Web inventory export is ready.</div>`;
      exportBtn.disabled = false;
      exportBtn.className = 'btn'; // Reverted to original 'btn'
      exportBtn.onclick = function() { handleWebExportClick(); };
    } else if (data.canWebInventoryExport) {
      // Fallback: Enable button manually if no confirmation is pending and system is ready
      messageArea.innerHTML = ''; 
      exportBtn.disabled = false;
      exportBtn.className = 'btn'; // Reverted to original 'btn'
      exportBtn.onclick = function() { handleWebExportClick(); };
    } else {
      // Explicitly state why it is disabled
      messageArea.innerHTML = '<p style="font-size: 0.85rem;" class="text-muted">Export disabled. Please complete the Daily Inventory Cycle (see System Health).</p>';
      exportBtn.disabled = true;
    }

    // --- State-Aware Logic for Comax Inventory Export ---
    const comaxExportBtn = document.getElementById('btn-comax-export');
    const comaxConfirmBtn = document.getElementById('btn-comax-updated');
    const comaxMessageArea = document.getElementById('comax-inventory-message-area');

    comaxExportBtn.className = 'btn';
    comaxConfirmBtn.className = 'btn';

    if (data.openComaxInventoryConfirmationTask) {
        comaxMessageArea.innerHTML = `<div class="alert alert-warning" style="padding: 0.5rem 1rem;">${data.openComaxInventoryConfirmationTask.notes}</div>`;
        comaxConfirmBtn.disabled = false;
        comaxConfirmBtn.className = 'btn'; // Reverted to original 'btn'
        comaxConfirmBtn.onclick = function() { handleComaxConfirmClick(data.openComaxInventoryConfirmationTask.id); };
        comaxExportBtn.disabled = true;
    } else if (data.comaxInventoryExportCount > 0) {
        comaxMessageArea.innerHTML = `<p>${data.comaxInventoryExportCount} items ready for export.</p>`;
        comaxExportBtn.disabled = false;
        comaxExportBtn.className = 'btn'; // Reverted to original 'btn'
        comaxExportBtn.onclick = function() { handleComaxExportClick(); };
    } else {
        comaxMessageArea.innerHTML = '<p style="font-size: 0.85rem;" class="text-muted">No items to export.</p>';
        comaxExportBtn.disabled = true;
    }
  }

  /**
   * Handles the click event for the 'Comax Export' button.
   */
  function handleComaxExportClick() {
    const exportBtn = document.getElementById('btn-comax-export');
    const messageArea = document.getElementById('comax-inventory-message-area');
    
    if (confirm("Export Comax adjustments?")) {
      exportBtn.disabled = true;
      messageArea.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Processing...';

      google.script.run
        .withSuccessHandler(response => {
          if (response && response.message) {
            alert(response.message);
          }
          google.script.run.withSuccessHandler(updateInventoryView).withFailureHandler(showError).WebAppInventory_getInventoryWidgetData();
        })
        .withFailureHandler(showError)
        .WebAppInventory_generateComaxInventoryExport();
    }
  }

  /**
   * Handles the click event for the 'Comax Updated' button.
   * @param {string} taskId - The ID of the confirmation task to complete.
   */
  function handleComaxConfirmClick(taskId) {
    console.log('Confirmation clicked for task:', taskId);
    if (!taskId) {
        alert('Error: Task ID is missing. Please check the logs.');
        return;
    }

    const confirmBtn = document.getElementById('btn-comax-updated');
    const messageArea = document.getElementById('comax-inventory-message-area');

    if (confirm("Confirm Comax adjustment applied and closed?")) {
      confirmBtn.disabled = true;
      messageArea.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Processing...';
      
      google.script.run
        .withSuccessHandler(wasCompleted => {
          if (!wasCompleted) {
            showError('Failed to confirm task.');
          }
          google.script.run.withSuccessHandler(updateInventoryView).withFailureHandler(showError).WebAppInventory_getInventoryWidgetData();
        })
        .withFailureHandler(showError)
        .WebAppTasks_completeTaskById(taskId);
    }
  }

  // Initial data load for this view
  google.script.run.withSuccessHandler(updateInventoryView).withFailureHandler(showError).WebAppInventory_getInventoryWidgetData();
</script>
