<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3>Development Tools</h3>
      </div>
      <div class="card-body">
        <button class="btn btn-warning mr-2" onclick="runRebuild()">Rebuild SysConfig from Source</button>
        <button class="btn btn-info mr-2" onclick="downloadSnapshot()">Download SysConfig Snapshot</button>
        <button class="btn mr-2" onclick="runMasterValidation()">Run Master Validation</button>
        <div id="master-validation-results" class="mt-3"></div>
        <div id="sysconfig-result" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<script>
  function runRebuild() {
    const resultDiv = document.getElementById('sysconfig-result');
    resultDiv.innerHTML = '<p class="text-info">Rebuilding SysConfig...</p>';
    google.script.run
      .withSuccessHandler(message => {
        resultDiv.innerHTML = `<p class="alert alert-success">${message}</p>`;
      })
      .withFailureHandler(err => {
        resultDiv.innerHTML = `<p class="alert alert-danger">${err.message}</p>`;
      })
      .WebAppSystem_runRebuildSysConfigFromSource();
  }

  function downloadSnapshot() {
    const resultDiv = document.getElementById('sysconfig-result');
    resultDiv.innerHTML = '<p class="text-info">Preparing download...</p>';
    google.script.run
      .withSuccessHandler(fileData => {
        resultDiv.innerHTML = '';
        const a = document.createElement("a");
        a.href = "data:text/csv;base64," + fileData.content;
        a.download = fileData.filename;
        a.click();
      })
      .withFailureHandler(err => {
        resultDiv.innerHTML = `<p class="alert alert-danger">${err.message}</p>`;
      })
      .WebAppSystem_getSysConfigCsvAsBase64();
  }

  function runMasterValidation() {
    const validationResultsDiv = document.getElementById('master-validation-results');
    validationResultsDiv.innerHTML = '<p class="text-info">Running master validation...</p>';

    google.script.run
      .withSuccessHandler(response => {
        if (response.success) {
          let html = `<p class="alert alert-success">Validation completed successfully. ${response.message}</p>`;
          if (response.results && response.results.length > 0) {
            html += `<h5>Detailed Results:</h5><ul>`;
            response.results.forEach(result => {
              const statusClass = result.status === 'PASSED' ? 'text-success' : 'text-danger';
              html += `<li class="${statusClass}">${result.ruleName}: ${result.status} - ${result.message || ''}</li>`;
            });
            html += `</ul>`;
          }
          validationResultsDiv.innerHTML = html;
        } else {
          validationResultsDiv.innerHTML = `<p class="alert alert-danger">Validation failed: ${response.error || 'Unknown error'}</p>`;
        }
      })
      .withFailureHandler(error => {
        validationResultsDiv.innerHTML = `<p class="alert alert-danger">Failed to run validation: ${error.message}</p>`;
      })
      .WebAppSystem_runMasterValidationAndReturnResults(); // Renamed backend call
  }
