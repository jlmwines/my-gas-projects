<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3>Development Tools</h3>
      </div>
      <div class="card-body">
        <button class="btn mr-2" onclick="runRebuildSysConfig()">Rebuild SysConfig</button>
        <button class="btn mr-2" onclick="runProtectHeaders()">Protect Headers</button>
        <button class="btn mr-2" onclick="runValidateSchema()">Validate Schema</button>
        <button class="btn mr-2" onclick="runDailyHousekeeping()">Daily Housekeeping</button>
        <button class="btn mr-2" onclick="runUnitTests()">Run Unit Tests</button>
        <div id="dev-tools-results" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<div class="row mt-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3>CRM Tools</h3>
      </div>
      <div class="card-body">
        <button class="btn mr-2" onclick="runCrmImportData()">Import CRM Data</button>
        <button class="btn mr-2" onclick="runCrmValidate()">Validate CRM</button>
        <button class="btn mr-2" onclick="runCrmCorrect()">Correct Data</button>
        <button class="btn mr-2" onclick="runCrmRefresh()">Refresh Contacts</button>
        <button class="btn mr-2" onclick="runCrmEnrich()">Enrich Contacts</button>
        <button class="btn mr-2" onclick="runCrmIntelligence()">Run Intelligence</button>
        <div id="crm-tools-results" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<div class="row mt-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3>Developer Wishlist</h3>
      </div>
      <div class="card-body">
        <textarea id="dev-wishlist-textarea" class="form-control" rows="10" placeholder="Enter your notes here..."></textarea>
        <button class="btn mt-2" onclick="saveWishlist()">Save Wishlist</button>
        <div id="wishlist-status" class="mt-2"></div>
      </div>
    </div>
  </div>
</div>

<script>
  function runRebuildSysConfig() {
    const resultDiv = document.getElementById('dev-tools-results');
    resultDiv.innerHTML = '<p class="text-info">Rebuilding SysConfig...</p>';
    google.script.run
      .withSuccessHandler(message => {
        resultDiv.innerHTML = `<p class="alert alert-success">${message}</p>`;
      })
      .withFailureHandler(err => {
        resultDiv.innerHTML = `<p class="alert alert-danger">${err.message}</p>`;
      })
      .runRebuildSysConfigFromSource();
  }

  function runProtectHeaders() {
    const resultDiv = document.getElementById('dev-tools-results');
    resultDiv.innerHTML = '<p class="text-info">Protecting headers...</p>';
    google.script.run
      .withSuccessHandler(message => {
        resultDiv.innerHTML = `<p class="alert alert-success">${message}</p>`;
      })
      .withFailureHandler(err => {
        resultDiv.innerHTML = `<p class="alert alert-danger">${err.message}</p>`;
      })
      .protectAllSheetHeadersFromUI(); // Backend function name
  }

  function runValidateSchema() {
    const resultDiv = document.getElementById('dev-tools-results');
    resultDiv.innerHTML = '<p class="text-info">Validating schema...</p>';
    google.script.run
      .withSuccessHandler(response => {
        let html = '';
        if (response.status === 'PASSED') {
            html += `<p class="alert alert-success">${response.message}</p>`;
        } else {
            html += `<p class="alert alert-danger">${response.message}</p>`;
            if (response.discrepancies && response.discrepancies.length > 0) {
                html += '<h5>Discrepancies:</h5><ul>';
                response.discrepancies.forEach(disc => {
                    html += `<li><strong>Sheet:</strong> ${disc.sheet}, <strong>Issue:</strong> ${disc.issue}, <strong>Severity:</strong> ${disc.severity}`;
                    if (disc.details) html += `, <strong>Details:</strong> ${disc.details}`;
                    html += `</li>`;
                });
                html += '</ul>';
            }
        }
        resultDiv.innerHTML = html;
      })
      .withFailureHandler(err => {
        resultDiv.innerHTML = `<p class="alert alert-danger">Failed to validate schema: ${err.message}</p>`;
      })
      .validateDatabaseSchemaFromUI(); // Backend function name
  }

  function runDailyHousekeeping() {
    const resultDiv = document.getElementById('dev-tools-results');
    resultDiv.innerHTML = '<p class="text-info">Running daily housekeeping...</p>';
    google.script.run
      .withSuccessHandler(message => {
        resultDiv.innerHTML = `<p class="alert alert-success">${message || 'Daily housekeeping completed successfully.'}</p>`;
      })
      .withFailureHandler(err => {
        resultDiv.innerHTML = `<p class="alert alert-danger">Error during daily housekeeping: ${err.message}</p>`;
      })
      .runDailyMaintenance();
  }

  function runUnitTests() {
    const resultDiv = document.getElementById('dev-tools-results');
    resultDiv.innerHTML = '<p class="text-info">Running unit tests...</p>';
    google.script.run
      .withSuccessHandler(response => {
        let html = '';
        if (response.success) {
          const results = response.results;
          const statusClass = results.failed > 0 ? 'alert-danger' : 'alert-success';
          html += `<div class="alert ${statusClass}">
                     <strong>Tests Completed:</strong> Total: ${results.total}, Passed: ${results.passed}, Failed: ${results.failed}
                   </div>`;
          
          if (results.details && results.details.length > 0) {
            html += '<ul class="list-group">';
            results.details.forEach(test => {
              const itemClass = test.status === 'PASSED' ? 'list-group-item-success' : 'list-group-item-danger';
              html += `<li class="list-group-item ${itemClass}">
                         <strong>${test.suite}</strong> - ${test.test}: ${test.status}
                         ${test.error ? `<br><small>${test.error}</small>` : ''}
                       </li>`;
            });
            html += '</ul>';
          }
          resultDiv.innerHTML = html;
        } else {
          resultDiv.innerHTML = `<p class="alert alert-danger">Unit tests failed to run: ${response.error}</p>`;
        }
      })
      .withFailureHandler(err => {
        resultDiv.innerHTML = `<p class="alert alert-danger">Error calling backend: ${err.message}</p>`;
      })
      .WebAppSystem_runUnitTests();
  }

  // --- CRM Tools Functions ---
  function runCrmImportData() {
    const resultDiv = document.getElementById('crm-tools-results');
    resultDiv.innerHTML = '<p class="text-info">Importing CRM data from order history...</p>';
    google.script.run
      .withSuccessHandler(result => {
        let html = '<div class="alert alert-success">';
        if (result.orders) {
          html += `Orders: ${result.orders.imported || 0} contacts imported from ${result.orders.total || 0} unique emails`;
          if (result.orders.errors && result.orders.errors.length > 0) {
            html += ` (${result.orders.errors.length} errors)`;
          }
        }
        if (result.mailchimp && result.mailchimp.imported) {
          html += `<br>Mailchimp: ${result.mailchimp.imported} new, ${result.mailchimp.updated} updated`;
        }
        html += '</div>';
        resultDiv.innerHTML = html;
      })
      .withFailureHandler(err => {
        resultDiv.innerHTML = `<p class="alert alert-danger">Error: ${err.message}</p>`;
      })
      .runCrmImport();
  }

  function runCrmValidate() {
    const resultDiv = document.getElementById('crm-tools-results');
    resultDiv.innerHTML = '<p class="text-info">Running CRM validation rules...</p>';
    google.script.run
      .withSuccessHandler(result => {
        let html = '';
        if (result.crmFailed === 0) {
          html = `<p class="alert alert-success">CRM Validation Passed: ${result.crmPassed}/${result.crmRules} rules passed</p>`;
        } else {
          html = `<p class="alert alert-danger">CRM Validation: ${result.crmFailed} failed, ${result.crmPassed} passed</p>`;
          html += '<ul class="list-group mt-2">';
          result.failures.forEach(f => {
            html += `<li class="list-group-item list-group-item-danger">
              <strong>${f.rule}</strong>: ${f.message}
              ${f.failedItems.length > 0 ? '<br><small>Items: ' + f.failedItems.slice(0,5).join(', ') + '</small>' : ''}
            </li>`;
          });
          html += '</ul>';
        }
        resultDiv.innerHTML = html;
      })
      .withFailureHandler(err => {
        resultDiv.innerHTML = `<p class="alert alert-danger">Error: ${err.message}</p>`;
      })
      .runCrmValidation();
  }

  function runCrmCorrect() {
    const resultDiv = document.getElementById('crm-tools-results');
    resultDiv.innerHTML = '<p class="text-info">Correcting contact data (IsCore/CustomerType)...</p>';
    google.script.run
      .withSuccessHandler(result => {
        let html = `<p class="alert alert-success">Correction complete: ${result.corrected} fixed out of ${result.checked} checked</p>`;
        if (result.corrections && result.corrections.length > 0) {
          html += '<table class="table table-sm mt-2"><thead><tr><th>Email</th><th>Was</th><th>Now</th><th>Type</th></tr></thead><tbody>';
          result.corrections.forEach(c => {
            html += `<tr><td>${c.email}</td><td>${c.oldIsCore}</td><td>${c.newIsCore}</td><td>${c.newType}</td></tr>`;
          });
          html += '</tbody></table>';
        }
        resultDiv.innerHTML = html;
      })
      .withFailureHandler(err => {
        resultDiv.innerHTML = `<p class="alert alert-danger">Error: ${err.message}</p>`;
      })
      .runContactDataCorrection();
  }

  function runCrmRefresh() {
    const resultDiv = document.getElementById('crm-tools-results');
    resultDiv.innerHTML = '<p class="text-info">Refreshing contacts (DaysSinceOrder, LifecycleStatus, etc.)...</p>';
    google.script.run
      .withSuccessHandler(message => {
        resultDiv.innerHTML = `<p class="alert alert-success">${message}</p>`;
      })
      .withFailureHandler(err => {
        resultDiv.innerHTML = `<p class="alert alert-danger">Error: ${err.message}</p>`;
      })
      .runContactRefresh();
  }

  function runCrmEnrich() {
    const resultDiv = document.getElementById('crm-tools-results');
    resultDiv.innerHTML = '<p class="text-info">Enriching contacts (preferences from order history)...</p>';
    google.script.run
      .withSuccessHandler(result => {
        const msg = `Enriched: ${result.enriched}, Skipped: ${result.skipped}, Errors: ${result.errors.length}`;
        resultDiv.innerHTML = `<p class="alert alert-success">${msg}</p>`;
      })
      .withFailureHandler(err => {
        resultDiv.innerHTML = `<p class="alert alert-danger">Error: ${err.message}</p>`;
      })
      .runContactEnrichment();
  }

  function runCrmIntelligence() {
    const resultDiv = document.getElementById('crm-tools-results');
    resultDiv.innerHTML = '<p class="text-info">Running CRM intelligence analysis...</p>';
    google.script.run
      .withSuccessHandler(result => {
        let html = `<p class="alert alert-success">Analysis complete: ${result.suggestions.length} suggestions, ${result.tasksCreated} tasks created</p>`;
        if (result.suggestions && result.suggestions.length > 0) {
          html += '<ul class="list-group mt-2">';
          result.suggestions.forEach(s => {
            html += `<li class="list-group-item"><strong>${s.title}</strong><br><small>${s.description}</small></li>`;
          });
          html += '</ul>';
        }
        resultDiv.innerHTML = html;
      })
      .withFailureHandler(err => {
        resultDiv.innerHTML = `<p class="alert alert-danger">Error: ${err.message}</p>`;
      })
      .runCrmIntelligence();
  }

  // --- Wishlist Functions ---
  function loadWishlist() {
    google.script.run
      .withSuccessHandler(content => {
        if(document.getElementById('dev-wishlist-textarea')) {
          document.getElementById('dev-wishlist-textarea').value = content;
        }
      })
      .withFailureHandler(err => {
        if(document.getElementById('wishlist-status')) {
          document.getElementById('wishlist-status').innerHTML = `<p class="alert alert-danger">${err.message}</p>`;
        }
      })
      .getDevWishlistContent();
  }

  function saveWishlist() {
    const content = document.getElementById('dev-wishlist-textarea').value;
    const statusDiv = document.getElementById('wishlist-status');
    statusDiv.innerHTML = '<p class="text-info">Saving...</p>';
    google.script.run
      .withSuccessHandler(message => {
        statusDiv.innerHTML = `<p class="alert alert-success">${message}</p>`;
        setTimeout(() => { statusDiv.innerHTML = ''; }, 3000);
      })
      .withFailureHandler(err => {
        statusDiv.innerHTML = `<p class="alert alert-danger">${err.message}</p>`;
      })
      .saveDevWishlistContent(content);
  }

  // Load wishlist content after a short delay to ensure the element exists.
  setTimeout(loadWishlist, 200);
</script>