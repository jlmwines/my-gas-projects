<div class="container-fluid">
    <h1 class="mt-4">Orders</h1>
    
    <!-- Section for Packing Slips -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-file-alt mr-1"></i>
            Packing Slips
        </div>
        <div class="card-body">
            <p>Select order documents to print.</p>
            <button class="btn mb-3" onclick="generateSelectedPackingSlips()">Print Selected</button>
            <div id="packing-slips-list"></div>
            <div id="print-result" class="mt-3"></div>
        </div>
    </div>

    <!-- Section for Open Orders -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-box-open mr-1"></i> Open Orders</span>
          <button id="btn-refresh-orders" class="btn btn-sm" onclick="refreshOrders()">Refresh Orders</button>
      </div>
      <div class="card-body">
          <div id="open-orders-list"></div>
          <div id="gift-result" class="mt-3"></div>
      </div>
    </div>
</div>

<script>
  function loadPackingSlipsData() {
    const ordersListDiv = document.getElementById('packing-slips-list');
    ordersListDiv.innerHTML = 'Loading packable orders...';

    try {
      google.script.run
        .withSuccessHandler(orders => {
          if (orders.length === 0) {
            ordersListDiv.innerHTML = '<p>No orders are currently ready for packing.</p>';
            return;
          }

          let tableHtml = '<table class="table table-hover"><thead><tr><th><input type="checkbox" onclick="toggleAll(this)"></th><th>Order #</th><th>Status</th><th>Billing Name</th><th>Shipping Name</th><th>Customer Note</th><th></th></tr></thead><tbody>';
          orders.forEach(order => {
            let giftButton = '';
            if (order.customerNote) {
              giftButton = `<button class="btn btn-sm" onclick="createGiftMessage('${order.orderId}', '${order.customerNote}')">Create Gift Doc</button>`;
            }
            tableHtml += `<tr>
                            <td><input type="checkbox" class="order-checkbox" value="${order.orderId}"></td>
                            <td>${order.orderNumber || order.orderId}</td>
                            <td>${order.status}</td>
                            <td>${order.billingName || ''}</td>
                            <td>${order.shippingName || ''}</td>
                            <td>${order.customerNote || ''}</td>
                            <td>${giftButton}</td>
                          </tr>`;
          });
          tableHtml += '</tbody></table>';
          ordersListDiv.innerHTML = tableHtml;
        })
        .withFailureHandler(err => {
          ordersListDiv.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        })
        .WebAppOrders_getPackableOrders();
    } catch (e) {
      alert('A client-side error occurred: ' + e.message);
    }
  }

  function loadOpenOrdersData() {
    const openOrdersListDiv = document.getElementById('open-orders-list');
    openOrdersListDiv.innerHTML = 'Loading open orders...';

    try {
      google.script.run
        .withSuccessHandler(orders => {
          if (orders.length === 0) {
            openOrdersListDiv.innerHTML = '<p>No open orders (on-hold or processing).</p>';
            return;
          }

          let tableHtml = '<table class="table table-hover"><thead><tr><th>Order ID</th><th>Status</th><th>Order Date</th><th>Billing Name</th><th>Shipping Name</th><th>Shipping City</th></tr></thead><tbody>';
          orders.forEach(order => {
            tableHtml += `<tr>
                            <td>${order.orderId}</td>
                            <td>${order.status}</td>
                            <td>${order.orderDate}</td>
                            <td>${order.billingName || ''}</td>
                            <td>${order.shippingName || ''}</td>
                            <td>${order.shippingCity}</td>
                          </tr>`;
          });
          tableHtml += '</tbody></table>';
          openOrdersListDiv.innerHTML = tableHtml;
        })
        .withFailureHandler(err => {
          openOrdersListDiv.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        })
        .WebAppOrders_getOpenOrdersForManager();
    } catch (e) {
      alert('A client-side error occurred: ' + e.message);
    }
  }

  function toggleAll(source) {
    const checkboxes = document.querySelectorAll('.order-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.checked = source.checked;
    });
  }

  function createGiftMessage(orderId, noteContent) {
    const giftResultDiv = document.getElementById('gift-result');
    giftResultDiv.innerHTML = `Creating gift message for order ${orderId}...`;

    google.script.run
      .withSuccessHandler(docUrl => {
        giftResultDiv.innerHTML = `<div class="alert alert-success">Gift message created for order ${orderId}. <a href="${docUrl}" target="_blank" class="btn btn-sm btn-primary ml-2">Open Document</a></div>`;
      })
      .withFailureHandler(err => {
        giftResultDiv.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
      })
      .WebAppOrders_createGiftMessageDoc(orderId, noteContent);
  }

  function generateSelectedPackingSlips() {
    const printResultDiv = document.getElementById('print-result');
    printResultDiv.innerHTML = 'Generating document...';
    const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
    const orderIds = Array.from(selectedCheckboxes).map(cb => cb.value);

    if (orderIds.length === 0) {
      printResultDiv.innerHTML = '<div class="alert alert-warning">Please select at least one order to print.</div>';
      return;
    }

    google.script.run
      .withSuccessHandler(docUrl => {
        printResultDiv.innerHTML = `<div class="alert alert-success">Successfully generated document. <a href="${docUrl}" target="_blank">Open Document</a></div>`;
        // Refresh the list
        loadPackingSlipsData();
      })
      .withFailureHandler(err => {
        printResultDiv.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
      })
      .WebAppOrders_generatePackingSlips(orderIds);
  }

  function refreshOrders() {
    const btn = document.getElementById('btn-refresh-orders');
    const originalText = btn.textContent;
    btn.textContent = 'Refreshing...';
    btn.disabled = true;

    google.script.run
      .withSuccessHandler(function(result) {
        btn.textContent = originalText;
        btn.disabled = false;
        loadPackingSlipsData();
        loadOpenOrdersData();
      })
      .withFailureHandler(function(err) {
        btn.textContent = originalText;
        btn.disabled = false;
        alert('Refresh failed: ' + err.message);
      })
      .WebAppOrders_triggerWebOrderImport();
  }

  // Self-execute to load the data as soon as the view is loaded.
  loadPackingSlipsData();
  loadOpenOrdersData();

</script>