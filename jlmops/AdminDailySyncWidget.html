<div class="card shadow-sm mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="text-start">
                <span id="sessionIdDisplay" class="small text-muted"></span>
            </div>
            <div class="text-center flex-grow-1">
                <h5 class="mb-0" id="inventoryReceiptsDisplay"></h5> <!-- Centered, larger text -->
            </div>
            <div class="text-end">
                 <a href="#" id="resetSyncLink" class="btn btn-sm btn-outline-secondary">Reset</a> <!-- Larger size, more button-like -->
            </div>
        </div>
        <div class="card-body">
            
            <!-- Visual Steps Flow -->
            <div class="row row-cols-5 g-1 text-center mb-4">
                <!-- Step 1: Import Web Data -->
                <div class="col" id="step1Col">
                    <div class="card h-100">
                        <div class="card-body p-2 d-flex flex-column justify-content-start align-items-center">
                            <h6 class="card-title mb-1">1. Import Web Data</h6>
                            <div id="step1Actions" class="d-none mt-2">
                                <a href="#" onclick="handleSyncAction(event, 'startSync')" class="d-block small fw-bold text-primary text-decoration-none">Start</a>
                                <span id="step1Loading" class="d-none small text-muted">Processing...</span>
                            </div>
                            <!-- Step 1 Details -->
                            <div id="step1Details" class="small text-start mt-2 w-100 ps-2 d-none">
                                <div>Orders: <span id="webOrdersStatus" class="fw-bold text-muted">...</span></div>
                                <div>Products: <span id="webProductsStatus" class="fw-bold text-muted">...</span></div>
                                <div>Trans.: <span id="webTranslationsStatus" class="fw-bold text-muted">...</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Export to Comax -->
                <div class="col" id="step2Col">
                    <div class="card h-100">
                        <div class="card-body p-2 d-flex flex-column justify-content-start align-items-center">
                            <h6 class="card-title mb-1">2. Export to Comax</h6>
                            <div id="step2Actions" class="d-none mt-2">
                                <a href="#" id="linkExportOrders" onclick="handleSyncAction(event, 'exportComaxOrders')" class="d-block small fw-bold text-primary text-decoration-none mb-1">Export Orders</a>
                                <a href="#" id="linkConfirmComax" onclick="handleSyncAction(event, 'confirmComaxUpdate')" class="d-block small fw-bold text-info text-decoration-none">Confirm Comax Update</a>
                            </div>
                            <div id="step2NoOrdersMsg" class="d-none small text-muted mt-2"></div>
                            <!-- Step 2 Details -->
                            <div id="step2Details" class="small text-start mt-2 w-100 ps-2 d-none">
                                <div>Export: <span id="comaxExportStatus" class="fw-bold text-muted">Pending</span></div>
                                <div>Confirm: <span id="comaxConfirmStatus" class="fw-bold text-muted">Pending</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Import Comax Data -->
                <div class="col" id="step3Col">
                    <div class="card h-100">
                        <div class="card-body p-2 d-flex flex-column justify-content-start align-items-center">
                            <h6 class="card-title mb-0">3. Import Comax Data</h6>
                            <div id="step3Actions" class="d-none mt-2">
                                <a href="#" onclick="handleSyncAction(event, 'startComaxImport')" class="d-block small fw-bold text-primary text-decoration-none">Start Import</a>
                            </div>
                            <span id="step3Status" class="d-none small text-muted mt-1">Processing...</span>
                            <!-- Step 3 Details -->
                            <div id="step3Details" class="small text-start mt-2 w-100 ps-2 d-none">
                                <div>Import: <span id="comaxImportJobStatus" class="fw-bold text-muted">Pending</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Validation -->
                <div class="col" id="step4Col">
                    <div class="card h-100">
                        <div class="card-body p-2 d-flex flex-column justify-content-start align-items-center">
                            <h6 class="card-title mb-0">4. Validation</h6>
                            <span id="step4Status" class="d-none small text-muted mt-1">Validating...</span>
                            <!-- Step 4 Details -->
                            <div id="step4Details" class="small text-start mt-2 w-100 ps-2 d-none">
                                <div>Master: <span id="masterValidationStatus" class="fw-bold text-muted">Pending</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Export Web Inventory -->
                <div class="col" id="step5Col">
                    <div class="card h-100">
                        <div class="card-body p-2 d-flex flex-column justify-content-start align-items-center">
                            <h6 class="card-title mb-1">5. Export Web Inv.</h6>
                            <div id="step5Actions" class="d-none mt-2">
                                <a href="#" id="linkGenerateWebExport" onclick="handleSyncAction(event, 'generateWebExport')" class="d-block small fw-bold text-primary text-decoration-none mb-1">Generate Export</a>
                                <a href="#" id="linkConfirmWebUpdate" onclick="handleSyncAction(event, 'confirmWebUpdate')" class="d-block small fw-bold text-success text-decoration-none d-none">Confirm Web Update</a>
                                <span id="step5Loading" class="d-none small text-muted">Processing...</span>
                            </div>
                            <!-- Step 5 Details -->
                            <div id="step5Details" class="small text-start mt-2 w-100 ps-2 d-none">
                                <div>Export: <span id="webExportJobStatus" class="fw-bold text-muted">Pending</span></div>
                                <div id="webExportFileContainer" class="d-none">File: <span id="webExportFilename" class="fw-bold text-info">...</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Error Message Container -->
            <div id="errorMessageContainer" class="alert alert-danger d-none mt-3 text-center p-1" role="alert">
                <small><strong>Error:</strong> <span id="errorMessageDisplay"></span></small>
            </div>

            <!-- Live Log Container -->
            <div id="liveLogContainer" class="mt-3 p-2 bg-light border rounded d-none">
                 <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted fw-bold">Live Status</small>
                 </div>
                 <div id="liveLogDisplay" class="small font-monospace text-muted" style="max-height: 60px; overflow-y: auto;"></div>
            </div>

        </div>
        <div class="card-footer text-muted small" id="footerStatus">
            Loading status...
        </div>
    </div>

    <script>
        // Removed 'const syncApp = {}' to prevent redeclaration errors on reload

        function refreshDailySyncWidgetState() {
             console.log('Daily Sync Widget: Calling backend getSyncStateFromBackend...');
             google.script.run.withSuccessHandler(updateSyncUI)
                              .withFailureHandler(handleSyncError)
                              .getSyncStateFromBackend();
        }

        function updateSyncUI(state) {
            console.log('Daily Sync Widget: Received state', state);
            // 1. Session Info
            const sessionIdDisplay = document.getElementById('sessionIdDisplay');
            if (sessionIdDisplay) {
                sessionIdDisplay.innerText = state.sessionId ? 'Session: ' + state.sessionId : '';
            }

            // 2. Footer
            const footerStatus = document.getElementById('footerStatus');
            if (footerStatus) {
                footerStatus.innerText = 'Last Updated: ' + (state.lastUpdated ? new Date(state.lastUpdated).toLocaleTimeString() : 'Just now');
            }

            // 3. Reset Link Logic
            const resetSyncLink = document.getElementById('resetSyncLink');
            if (resetSyncLink) {
                if (state.currentStage && state.currentStage !== 'IDLE') {
                    resetSyncLink.style.pointerEvents = 'auto'; 
                    resetSyncLink.className = 'btn btn-sm btn-danger'; // More prominent for active reset
                    resetSyncLink.onclick = (e) => { e.preventDefault(); resetSyncWorkflow(); };
                } else {
                    resetSyncLink.style.pointerEvents = 'none'; 
                    resetSyncLink.className = 'btn btn-sm btn-outline-secondary'; // Matched with new HTML structure
                    resetSyncLink.onclick = null;
                }
            }

            // 4. Error Message Display
            const errContainer = document.getElementById('errorMessageContainer');
            const errDisplay = document.getElementById('errorMessageDisplay');
            if (errContainer && errDisplay) {
                if (state.errorMessage) {
                    errDisplay.innerText = state.errorMessage;
                    errContainer.classList.remove('d-none');
                } else {
                    errContainer.classList.add('d-none');
                }
            }
            
            // 5. Live Log Display
            const logContainer = document.getElementById('liveLogContainer');
            const logDisplay = document.getElementById('liveLogDisplay');
            if (logContainer && logDisplay) {
                if (state.latestLogMessage && state.currentStage !== 'IDLE') {
                    logDisplay.innerText = state.latestLogMessage;
                    logContainer.classList.remove('d-none');
                } else {
                    logContainer.classList.add('d-none');
                }
            }

            // 6. Highlight & Actions Logic
            renderSyncSteps(state);
        }

        function getStatusClass(status) {
            if (!status) return 'fw-bold text-muted';
            switch(status) {
                case 'COMPLETED': return 'fw-bold text-success';
                case 'FAILED': return 'fw-bold text-danger';
                case 'PROCESSING': return 'fw-bold text-primary';
                case 'PENDING': return 'fw-bold text-info';
                default: return 'fw-bold text-muted';
            }
        }
        
        function updateDetailStatus(elementId, statusText) {
            const el = document.getElementById(elementId);
            if (el) {
                el.innerText = statusText || '...';
                el.className = getStatusClass(statusText);
            }
        }

        function renderSyncSteps(state) {
            // Reset UI state (remove highlights, hide actions/loading)
            for (let i = 1; i <= 5; i++) {
                const col = document.getElementById(`step${i}Col`);
                if (!col) continue;
                const card = col.querySelector('.card');
                if (card) card.classList.remove('border-primary', 'shadow', 'border-danger');
                
                const actions = document.getElementById(`step${i}Actions`);
                if(actions) actions.classList.add('d-none');
                
                const status = document.getElementById(`step${i}Status`);
                if(status) status.classList.add('d-none');
            }
            
            // Explicitly reset Step 5 links to hidden
            const linkGen = document.getElementById('linkGenerateWebExport');
            const linkConf = document.getElementById('linkConfirmWebUpdate');
            if(linkGen) linkGen.classList.add('d-none');
            if(linkConf) linkConf.classList.add('d-none');
            
            const loadingEl = document.getElementById('step1Loading');
            if (loadingEl) loadingEl.classList.add('d-none');
            
            // Step 5 specific loading
            const step5LoadingEl = document.getElementById('step5Loading');
            if (step5LoadingEl) step5LoadingEl.classList.add('d-none');


            // Populate Details (History)
            if (state.currentStage !== 'IDLE') {
                // Step 1 Details
                document.getElementById('step1Details').classList.remove('d-none');
                updateDetailStatus('webOrdersStatus', state.webOrdersJobStatus);
                updateDetailStatus('webProductsStatus', state.webProductsJobStatus);
                updateDetailStatus('webTranslationsStatus', state.webTranslationsJobStatus);

                // Step 2 Details
                // Only show details if calculation has happened (not -1)
                if (state.ordersPendingExportCount !== -1 || state.currentStage === 'COMAX_IMPORT_PROCESSING' || state.currentStage === 'READY_FOR_COMAX_IMPORT' || state.currentStage === 'VALIDATING' || state.currentStage === 'COMPLETE' || state.currentStage === 'READY_FOR_WEB_EXPORT' || state.currentStage === 'WEB_EXPORT_PROCESSING' || state.currentStage === 'WEB_EXPORT_GENERATED') {
                    document.getElementById('step2Details').classList.remove('d-none');
                    updateDetailStatus('comaxExportStatus', state.comaxOrdersExported ? 'COMPLETED' : (state.ordersPendingExportCount > 0 ? 'PENDING' : 'N/A'));
                    const isConfirmed = state.currentStage === 'READY_FOR_COMAX_IMPORT' || state.currentStage === 'COMAX_IMPORT_PROCESSING' || state.currentStage === 'VALIDATING' || state.currentStage === 'COMPLETE' || state.currentStage === 'READY_FOR_WEB_EXPORT' || state.currentStage === 'WEB_EXPORT_PROCESSING' || state.currentStage === 'WEB_EXPORT_GENERATED';
                    updateDetailStatus('comaxConfirmStatus', isConfirmed ? 'COMPLETED' : (state.comaxOrdersExported ? 'PENDING' : 'N/A'));
                }


                // Step 3 Details
                if (state.comaxProductsJobStatus !== 'NOT_STARTED') {
                    document.getElementById('step3Details').classList.remove('d-none');
                    updateDetailStatus('comaxImportJobStatus', state.comaxProductsJobStatus);
                }

                // Step 4 Details
                if (state.masterValidationJobStatus !== 'NOT_STARTED') {
                    document.getElementById('step4Details').classList.remove('d-none');
                    updateDetailStatus('masterValidationStatus', state.masterValidationJobStatus);
                }

                // Step 5 Details
                if (state.webInventoryExportJobStatus !== 'NOT_STARTED' || state.currentStage === 'COMPLETE' || state.currentStage === 'READY_FOR_WEB_EXPORT' || state.currentStage === 'WEB_EXPORT_PROCESSING' || state.currentStage === 'WEB_EXPORT_GENERATED') {
                    document.getElementById('step5Details').classList.remove('d-none');
                    updateDetailStatus('webExportJobStatus', state.webInventoryExportJobStatus);
                    
                    if (state.webExportFilename) {
                        document.getElementById('webExportFileContainer').classList.remove('d-none');
                        document.getElementById('webExportFilename').innerText = state.webExportFilename;
                    }
                }
            } else {
                // Hide all details if IDLE
                for (let i = 1; i <= 5; i++) {
                    const details = document.getElementById(`step${i}Details`);
                    if (details) details.classList.add('d-none');
                }
            }

            // Determine Active Step & Action Visibility
            let activeStep = 0;
            const stage = state.currentStage;

            switch (stage) {
                case 'IDLE':
                    activeStep = 1;
                    const s1Actions = document.getElementById('step1Actions');
                    if(s1Actions) {
                        s1Actions.classList.remove('d-none');
                        // Reset Start Link State
                        const startLink = s1Actions.querySelector('a');
                        if(startLink) {
                            startLink.classList.remove('d-none');
                            startLink.innerText = 'Start';
                            startLink.style.pointerEvents = 'auto';
                        }
                    }
                    break;
                case 'WEB_IMPORT_PROCESSING':
                    activeStep = 1;
                    const s1Processing = document.getElementById('step1Actions');
                    if(s1Processing) {
                        s1Processing.classList.remove('d-none');
                        const link = s1Processing.querySelector('a');
                        if(link) link.classList.add('d-none');
                    }
                    if (loadingEl) loadingEl.classList.remove('d-none');
                    break;
                case 'WAITING_FOR_COMAX':
                    activeStep = 2;
                    const s2Actions = document.getElementById('step2Actions');
                    const noOrdersMsg = document.getElementById('step2NoOrdersMsg');

                    if (state.ordersPendingExportCount === 0) {
                        if (s2Actions) s2Actions.classList.add('d-none'); // Hide links
                        if (noOrdersMsg) { // Show message
                            noOrdersMsg.classList.remove('d-none');
                            noOrdersMsg.innerText = 'No orders to export. Click "Start Import" in Step 3.';
                        }
                        // Orchestrator should have transitioned to READY_FOR_COMAX_IMPORT
                        // If not, something is wrong, but UI should reflect that.
                    } else if (s2Actions) { // Orders > 0, show export/confirm links
                        if (noOrdersMsg) noOrdersMsg.classList.add('d-none'); // Hide message

                        s2Actions.classList.remove('d-none');
                        const exportLink = document.getElementById('linkExportOrders');
                        const confirmLink = document.getElementById('linkConfirmComax');
                        
                        if (exportLink && confirmLink) {
                            if (state.comaxOrdersExported) {
                                exportLink.classList.add('d-none');
                                confirmLink.classList.remove('d-none');
                            } else {
                                exportLink.classList.remove('d-none');
                                confirmLink.classList.add('d-none');
                            }
                            // Ensure links are clickable
                            exportLink.style.pointerEvents = 'auto';
                            confirmLink.style.pointerEvents = 'auto';
                            if (exportLink.innerText === '...') exportLink.innerText = 'Export Orders';
                            if (confirmLink.innerText === '...') confirmLink.innerText = 'Confirm Comax Update';
                        }
                    }
                    break;
                case 'READY_FOR_COMAX_IMPORT':
                    activeStep = 3;
                    const s3Actions = document.getElementById('step3Actions');
                    if(s3Actions) {
                         s3Actions.classList.remove('d-none');
                         const startComaxLink = s3Actions.querySelector('a');
                         if(startComaxLink) {
                             startComaxLink.style.pointerEvents = 'auto';
                             startComaxLink.innerText = 'Start Import';
                         }
                    }
                    break;
                case 'COMAX_IMPORT_PROCESSING':
                    activeStep = 3;
                    const s3Status = document.getElementById('step3Status');
                    if(s3Status) {
                        s3Status.classList.remove('d-none');
                        s3Status.innerText = 'Processing...';
                    }
                    break;
                case 'VALIDATING':
                    activeStep = 4;
                    const s4Status = document.getElementById('step4Status');
                    if(s4Status) {
                        s4Status.classList.remove('d-none');
                        s4Status.innerText = 'Validating...';
                    }
                    break;
                case 'READY_FOR_WEB_EXPORT': // New Stage
                    activeStep = 5;
                    const s5ActionsReady = document.getElementById('step5Actions');
                    const linkGenerateWebExport = document.getElementById('linkGenerateWebExport');
                    const linkConfirmWebUpdate = document.getElementById('linkConfirmWebUpdate');
                    if(s5ActionsReady && linkGenerateWebExport && linkConfirmWebUpdate) {
                        s5ActionsReady.classList.remove('d-none');
                        linkGenerateWebExport.classList.remove('d-none');
                        linkConfirmWebUpdate.classList.add('d-none'); // Ensure confirm is hidden
                        
                        linkGenerateWebExport.style.pointerEvents = 'auto';
                        linkGenerateWebExport.innerText = 'Generate Export';
                    }
                    break;
                case 'WEB_EXPORT_PROCESSING': // New Stage
                    activeStep = 5;
                    const s5ActionsProcessing = document.getElementById('step5Actions');
                    if(s5ActionsProcessing) {
                        s5ActionsProcessing.classList.remove('d-none');
                        document.getElementById('linkGenerateWebExport').classList.add('d-none'); // Hide generate
                        document.getElementById('linkConfirmWebUpdate').classList.add('d-none'); // Hide confirm
                    }
                    if (step5LoadingEl) step5LoadingEl.classList.remove('d-none'); // Show loading
                    break;
                case 'WEB_EXPORT_GENERATED': // New Stage (or after job completion)
                    activeStep = 5;
                    const s5ActionsGenerated = document.getElementById('step5Actions');
                    if(s5ActionsGenerated) {
                        s5ActionsGenerated.classList.remove('d-none');
                        document.getElementById('linkGenerateWebExport').classList.add('d-none'); // Hide generate
                        const confirmLink = document.getElementById('linkConfirmWebUpdate');
                        confirmLink.classList.remove('d-none'); // Show confirm
                        confirmLink.style.pointerEvents = 'auto';
                        confirmLink.innerText = 'Confirm Web Update';
                    }
                    break;
                case 'COMPLETE':
                    activeStep = 5;
                    const s5ActionsComplete = document.getElementById('step5Actions');
                    if(s5ActionsComplete) {
                        s5ActionsComplete.classList.remove('d-none');
                        document.getElementById('linkGenerateWebExport').classList.add('d-none'); // Hide generate
                        document.getElementById('linkConfirmWebUpdate').classList.add('d-none'); // Hide confirm
                        // Maybe add a "Confirmed" text here
                    }
                    break;
                case 'FAILED':
                    // Highlight the step that likely failed
                    if (state.webOrdersJobStatus === 'FAILED') {
                        activeStep = 1;
                        if(document.getElementById('step1Actions')) document.getElementById('step1Actions').classList.remove('d-none');
                    }
                    else if (state.comaxProductsJobStatus === 'FAILED') {
                        activeStep = 3;
                        if(document.getElementById('step3Actions')) document.getElementById('step3Actions').classList.remove('d-none');
                    }
                    else if (state.masterValidationJobStatus === 'FAILED') activeStep = 4;
                    else if (state.webInventoryExportJobStatus === 'FAILED') {
                        activeStep = 5;
                        const s5Actions = document.getElementById('step5Actions');
                        if(s5Actions) {
                            s5Actions.classList.remove('d-none');
                            document.getElementById('linkGenerateWebExport').classList.remove('d-none');
                        }
                    }
                    else activeStep = 5; // Fallback
                    
                    const col = document.getElementById(`step${activeStep}Col`);
                    if(col) col.querySelector('.card').classList.add('border-danger');
                    return; 
            }

            // Apply Highlight
            if (activeStep > 0) {
                const col = document.getElementById(`step${activeStep}Col`);
                if(col) {
                    const card = col.querySelector('.card');
                    if(card) card.classList.add('border-primary', 'shadow');
                }
            }
        }

        function handleSyncAction(e, actionName) {
            e.preventDefault();
            const link = e.target;
            const originalText = link.innerText;
            link.innerText = '...'; 
            link.style.pointerEvents = 'none';

            if (actionName === 'startSync') {
                google.script.run.withSuccessHandler(updateSyncUI).withFailureHandler(handleSyncError).startDailySyncBackend();
            } else if (actionName === 'exportComaxOrders') {
                google.script.run.withSuccessHandler((res) => {
                    if (res.success) {
                        if (res.fileUrl) {
                            prompt('Export successful. Copy filename for Comax upload:', res.fileName);
                        } else {
                            alert(res.message || 'No orders to export. Proceeding to confirmation.');
                        }
                    } else {
                        alert('Export failed: ' + (res.message || 'Unknown error'));
                    }
                    link.innerText = originalText;
                    link.style.pointerEvents = 'auto';
                    refreshDailySyncWidgetState(); 
                }).exportComaxOrdersBackend();
            } else if (actionName === 'confirmComaxUpdate') {
                 google.script.run.withSuccessHandler(updateSyncUI).withFailureHandler(handleSyncError).confirmComaxUpdateBackend();
            } else if (actionName === 'startComaxImport') {
                 google.script.run.withSuccessHandler(updateSyncUI).withFailureHandler(handleSyncError).startComaxImportBackend();
            } else if (actionName === 'generateWebExport') { // New action
                 google.script.run.withSuccessHandler(updateSyncUI).withFailureHandler(handleSyncError).generateWebExportBackend();
            } else if (actionName === 'confirmWebUpdate') { // New action
                 google.script.run.withSuccessHandler(updateSyncUI).withFailureHandler(handleSyncError).confirmWebInventoryUpdateBackend();
            }
        }

        function resetSyncWorkflow() {
            if (!confirm('Reset Sync State?')) return;
             google.script.run.withSuccessHandler(updateSyncUI).withFailureHandler(handleSyncError).resetSyncStateBackend();
        }

        function handleSyncError(error) {
            console.error(error);
            const errContainer = document.getElementById('errorMessageContainer');
            const errDisplay = document.getElementById('errorMessageDisplay');
            if (errContainer && errDisplay) {
                errDisplay.innerText = error.message;
                errContainer.classList.remove('d-none');
            }
        }
        
        // Initialize immediately
        console.log('Daily Sync Widget: Initializing...');
        
        // Fetch inventory receipts info once on load
        google.script.run
            .withSuccessHandler(info => {
                const receiptsDisplay = document.getElementById('inventoryReceiptsDisplay');
                if (receiptsDisplay) {
                    if (info.count > 0 && info.folderUrl) {
                        receiptsDisplay.innerHTML = `Inventory Receipts: <a href="${info.folderUrl}" target="_blank" class="fw-bold text-danger">${info.count} Files</a>`;
                    } else if (info.count === 0) {
                        receiptsDisplay.innerHTML = `Inventory Receipts: <span class="text-success">0 Files</span>`;
                    } else {
                        receiptsDisplay.innerHTML = `Inventory Receipts: <span class="text-muted">N/A</span>`; // Error or not available
                    }
                }
            })
            .withFailureHandler(err => {
                console.error('Failed to load inventory receipts info:', err);
                const receiptsDisplay = document.getElementById('inventoryReceiptsDisplay');
                if (receiptsDisplay) {
                    receiptsDisplay.innerHTML = `Inventory Receipts: <span class="text-danger">Error</span>`;
                }
            })
            .getInventoryReceiptsInfo(); // Call the new backend function

        refreshDailySyncWidgetState();
        // Poll every 30s
        setInterval(refreshDailySyncWidgetState, 30000);
    </script>