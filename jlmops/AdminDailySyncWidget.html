<div class="card shadow-sm mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="text-start">
                <span id="sessionIdDisplay" class="small text-muted"></span>
            </div>
            <div class="text-end">
                 <a href="#" id="resetSyncLink" class="btn btn-sm btn-outline-secondary">Reset</a> <!-- Larger size, more button-like -->
            </div>
        </div>
        <div class="card-body">
            
            <!-- Visual Steps Flow -->
            <div class="row row-cols-6 g-1 text-center mb-4">
                <!-- Step 0: Invoices (Informational) -->
                <div class="col" id="step0Col">
                    <div class="card h-100">
                        <div class="card-body p-2 d-flex flex-column justify-content-start align-items-center">
                            <h6 class="card-title mb-1">Invoices</h6>
                            <div id="step0Status" class="mt-2">
                                <span id="invoiceCountDisplay" class="fw-bold">...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Step 1: Import Web Data -->
                <div class="col" id="step1Col">
                    <div class="card h-100">
                        <div class="card-body p-2 d-flex flex-column justify-content-start align-items-center">
                            <h6 class="card-title mb-1">1. Import Web Data</h6>
                            <div id="step1Actions" class="d-none mt-2">
                                <a href="#" onclick="handleSyncAction(event, 'startSync')" class="d-block small fw-bold text-primary text-decoration-none">Start</a>
                                <span id="step1Loading" class="d-none small text-muted">Processing...</span>
                            </div>
                            <!-- Step 1 Details -->
                            <div id="step1Details" class="small text-start mt-2 w-100 ps-2 d-none">
                                <div>Orders: <span id="webOrdersStatus" class="fw-bold text-muted">...</span></div>
                                <div>Products: <span id="webProductsStatus" class="fw-bold text-muted">...</span></div>
                                <div>Trans.: <span id="webTranslationsStatus" class="fw-bold text-muted">...</span></div>
                                <div id="step1Timestamp" class="text-muted mt-1 d-none"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Export to Comax -->
                <div class="col" id="step2Col">
                    <div class="card h-100">
                        <div class="card-body p-2 d-flex flex-column justify-content-start align-items-center">
                            <h6 class="card-title mb-1">2. Export to Comax</h6>
                            <div id="step2Actions" class="d-none mt-2">
                                <a href="#" id="linkExportOrders" onclick="handleSyncAction(event, 'exportComaxOrders')" class="d-block small fw-bold text-primary text-decoration-none mb-1">Export Orders</a>
                                <a href="#" id="linkConfirmComax" onclick="handleSyncAction(event, 'confirmComaxUpdate')" class="d-block small fw-bold text-info text-decoration-none">Confirm Comax Update</a>
                            </div>
                            <div id="step2NoOrdersMsg" class="d-none small text-muted mt-2"></div>
                            <!-- Step 2 Details -->
                            <div id="step2Details" class="small text-start mt-2 w-100 ps-2 d-none">
                                <div>Export: <span id="comaxExportStatus" class="fw-bold text-muted">Pending</span></div>
                                <div>Confirm: <span id="comaxConfirmStatus" class="fw-bold text-muted">Pending</span></div>
                                <div id="step2Timestamp" class="text-muted mt-1 d-none"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Import Comax Data -->
                <div class="col" id="step3Col">
                    <div class="card h-100">
                        <div class="card-body p-2 d-flex flex-column justify-content-start align-items-center">
                            <h6 class="card-title mb-0">3. Import Comax Data</h6>
                            <div id="step3Actions" class="d-none mt-2">
                                <a href="#" onclick="handleSyncAction(event, 'startComaxImport')" class="d-block small fw-bold text-primary text-decoration-none">Start Import</a>
                            </div>
                            <span id="step3Status" class="d-none small text-muted mt-1">Processing...</span>
                            <!-- Step 3 Details -->
                            <div id="step3Details" class="small text-start mt-2 w-100 ps-2 d-none">
                                <div>Import: <span id="comaxImportJobStatus" class="fw-bold text-muted">Pending</span></div>
                                <div id="step3Timestamp" class="text-muted mt-1 d-none"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Validation -->
                <div class="col" id="step4Col">
                    <div class="card h-100">
                        <div class="card-body p-2 d-flex flex-column justify-content-start align-items-center">
                            <h6 class="card-title mb-0">4. Validation</h6>
                            <span id="step4Status" class="d-none small text-muted mt-1">Validating...</span>
                            <!-- Step 4 Details -->
                            <div id="step4Details" class="small text-start mt-2 w-100 ps-2 d-none">
                                <div>Master: <span id="masterValidationStatus" class="fw-bold text-muted">Pending</span></div>
                                <div id="step4Timestamp" class="text-muted mt-1 d-none"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Export Web Inventory -->
                <div class="col" id="step5Col">
                    <div class="card h-100">
                        <div class="card-body p-2 d-flex flex-column justify-content-start align-items-center">
                            <h6 class="card-title mb-1">5. Export Web Inventory</h6>
                            <div id="step5Actions" class="d-none mt-2">
                                <a href="#" id="linkGenerateWebExport" onclick="handleSyncAction(event, 'generateWebExport')" class="d-block small fw-bold text-primary text-decoration-none mb-1">Generate Export</a>
                                <a href="#" id="linkConfirmWebUpdate" onclick="handleSyncAction(event, 'confirmWebUpdate')" class="d-block small fw-bold text-success text-decoration-none d-none">Confirm Web Update</a>
                                <span id="step5Loading" class="d-none small text-muted">Processing...</span>
                            </div>
                            <!-- Step 5 Details -->
                            <div id="step5Details" class="small text-start mt-2 w-100 ps-2 d-none">
                                <div>Export: <span id="webExportJobStatus" class="fw-bold text-muted">Pending</span></div>
                                <div id="webExportFileContainer" class="d-none">File: <span id="webExportFilename" class="fw-bold text-info">...</span></div>
                                <div id="step5Timestamp" class="text-muted mt-1 d-none"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Error Message Container -->
            <div id="errorMessageContainer" class="alert alert-danger d-none mt-3 text-center p-1" role="alert">
                <small><strong>Error:</strong> <span id="errorMessageDisplay"></span></small>
            </div>

            <!-- Current Status Line -->
            <div id="currentStatusContainer" class="mt-3 p-2 border rounded bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <span id="currentStatusMessage" class="small">Ready to sync</span>
                    <span id="currentStatusTime" class="small text-muted"></span>
                </div>
            </div>

            <!-- Expandable Activity Log -->
            <div id="activityLogContainer" class="mt-2">
                <div class="d-flex justify-content-between align-items-center p-1" onclick="toggleActivityLog()" style="cursor:pointer">
                    <small class="text-muted">Activity Log</small>
                    <small id="activityLogToggle" class="text-muted">▼</small>
                </div>
                <div id="activityLogContent" class="border rounded p-2 small" style="display:none; max-height:150px; overflow-y:auto">
                    <div class="text-muted text-center">No activity yet</div>
                </div>
            </div>

        </div>
        <div class="card-footer text-muted small" id="footerStatus">
            Loading status...
        </div>
    </div>

    <script>
        // Removed 'const syncApp = {}' to prevent redeclaration errors on reload
        // refreshDailySyncWidgetState function is defined at the bottom with adaptive polling

        // Helper: Format time as HH:MM (no seconds) - global version
        function formatTimeHHMMGlobal(date) {
            if (!date) return '';
            const d = date instanceof Date ? date : new Date(date);
            if (isNaN(d.getTime())) return '';
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Toggle activity log visibility
        function toggleActivityLog() {
            var content = document.getElementById('activityLogContent');
            var toggle = document.getElementById('activityLogToggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '▲';
            } else {
                content.style.display = 'none';
                toggle.textContent = '▼';
            }
        }

        // Update current status line
        function updateCurrentStatus(message, isProcessing) {
            var el = document.getElementById('currentStatusMessage');
            var timeEl = document.getElementById('currentStatusTime');
            if (!el) return;
            if (isProcessing) {
                el.innerHTML = '<span class="spinner-border spinner-border-sm mr-1"></span>' + message;
            } else {
                el.textContent = message;
            }
            if (timeEl) {
                timeEl.textContent = formatTimeHHMMGlobal(new Date());
            }
        }

        // Add message to activity log
        function addToActivityLog(message) {
            var log = document.getElementById('activityLogContent');
            if (!log) return;
            // Remove placeholder if present
            var placeholder = log.querySelector('.text-center.text-muted');
            if (placeholder && placeholder.textContent === 'No activity yet') {
                placeholder.remove();
            }
            var entry = document.createElement('div');
            entry.className = 'border-bottom py-1';
            entry.innerHTML = '<span class="text-muted mr-2">' + formatTimeHHMMGlobal(new Date()) + '</span>' + message;
            log.insertBefore(entry, log.firstChild);
            // Keep only last 10 entries
            while (log.children.length > 10) {
                log.removeChild(log.lastChild);
            }
        }

        // Track last known stage to detect transitions
        var lastKnownStage = null;

        function updateSyncUI(state) {
            // Only log when stage changes or during active processing
            const activeStages = ['WEB_IMPORT_PROCESSING', 'COMAX_IMPORT_PROCESSING', 'VALIDATING', 'WEB_EXPORT_PROCESSING'];
            if (activeStages.includes(state.currentStage)) {
                console.log('Sync Widget: Stage=' + state.currentStage + ', Jobs:', {
                    orders: state.webOrdersJobStatus,
                    products: state.webProductsJobStatus,
                    translations: state.webTranslationsJobStatus
                });
            }

            // Log stage transitions to activity log
            if (lastKnownStage !== state.currentStage) {
                var logMessage = null;
                switch (state.currentStage) {
                    case 'WEB_IMPORT_PROCESSING':
                        if (lastKnownStage === 'IDLE') logMessage = 'Sync started';
                        break;
                    case 'WAITING_FOR_COMAX':
                        logMessage = 'Web import complete';
                        break;
                    case 'READY_FOR_COMAX_IMPORT':
                        if (state.ordersPendingExportCount === 0) {
                            logMessage = 'No orders to export - skipped';
                        } else {
                            logMessage = 'Orders exported to Comax';
                        }
                        break;
                    case 'VALIDATING':
                        logMessage = 'Comax import complete';
                        break;
                    case 'READY_FOR_WEB_EXPORT':
                        logMessage = 'Validation complete';
                        break;
                    case 'COMPLETE':
                        logMessage = 'Sync completed successfully';
                        break;
                    case 'FAILED':
                        logMessage = 'Sync failed - see error above';
                        break;
                }
                if (logMessage) {
                    addToActivityLog(logMessage);
                }
                lastKnownStage = state.currentStage;
            }

            // Helper: Format time as HH:MM (no seconds)
            function formatTimeHHMM(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return '';
                return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            // 0. Invoice Status (Step 0)
            const invoiceCountDisplay = document.getElementById('invoiceCountDisplay');
            const step0Col = document.getElementById('step0Col');
            if (invoiceCountDisplay && step0Col) {
                const count = state.invoiceFileCount || 0;
                const card = step0Col.querySelector('.card');

                if (count === 0) {
                    invoiceCountDisplay.innerHTML = '<span class="text-success">✓ 0 files</span>';
                    if (card) {
                        card.classList.remove('border-warning', 'border-danger');
                        card.classList.add('border-primary'); // Blue border for 0 files
                    }
                } else if (count > 0) {
                    invoiceCountDisplay.innerHTML = `<span class="text-warning">${count} file${count > 1 ? 's' : ''}</span>`;
                    if (card) {
                        card.classList.add('border-warning');
                        card.classList.remove('border-danger', 'border-primary');
                    }
                } else {
                    invoiceCountDisplay.innerHTML = '<span class="text-muted">N/A</span>';
                    if (card) card.classList.remove('border-warning', 'border-danger', 'border-primary');
                }
            }

            // 1. Session Info
            const sessionIdDisplay = document.getElementById('sessionIdDisplay');
            if (sessionIdDisplay) {
                sessionIdDisplay.innerText = state.sessionId ? 'Session: ' + state.sessionId : '';
            }

            // 2. Footer
            const footerStatus = document.getElementById('footerStatus');
            if (footerStatus) {
                footerStatus.innerText = 'Last Updated: ' + (state.lastUpdated ? formatTimeHHMM(state.lastUpdated) : 'Just now');
            }

            // 3. Reset Link Logic
            const resetSyncLink = document.getElementById('resetSyncLink');
            if (resetSyncLink) {
                if (state.currentStage && state.currentStage !== 'IDLE') {
                    resetSyncLink.style.pointerEvents = 'auto'; 
                    resetSyncLink.className = 'btn btn-sm btn-danger'; // More prominent for active reset
                    resetSyncLink.onclick = (e) => { e.preventDefault(); resetSyncWorkflow(); };
                } else {
                    resetSyncLink.style.pointerEvents = 'none'; 
                    resetSyncLink.className = 'btn btn-sm btn-outline-secondary'; // Matched with new HTML structure
                    resetSyncLink.onclick = null;
                }
            }

            // 4. Error Message Display
            const errContainer = document.getElementById('errorMessageContainer');
            const errDisplay = document.getElementById('errorMessageDisplay');
            if (errContainer && errDisplay) {
                if (state.errorMessage) {
                    errDisplay.innerText = state.errorMessage;
                    errContainer.classList.remove('d-none');
                } else {
                    errContainer.classList.add('d-none');
                }
            }
            
            // 5. Highlight & Actions Logic (Live log replaced by currentStatus area)
            renderSyncSteps(state);
        }

        function getStatusClass(status) {
            if (!status) return 'fw-bold text-muted';
            switch(status) {
                case 'COMPLETED': return 'fw-bold text-success';
                case 'FAILED': return 'fw-bold text-danger';
                case 'PROCESSING': return 'fw-bold text-primary';
                case 'PENDING': return 'fw-bold text-info';
                default: return 'fw-bold text-muted';
            }
        }
        
        function updateDetailStatus(elementId, statusText) {
            const el = document.getElementById(elementId);
            if (el) {
                el.innerText = statusText || '...';
                el.className = getStatusClass(statusText);
            }
        }

        function renderSyncSteps(state) {
            // Reset UI state (remove highlights, hide actions/loading)
            for (let i = 1; i <= 5; i++) {
                const col = document.getElementById(`step${i}Col`);
                if (!col) continue;
                const card = col.querySelector('.card');
                if (card) card.classList.remove('border-primary', 'shadow', 'border-danger');
                
                const actions = document.getElementById(`step${i}Actions`);
                if(actions) actions.classList.add('d-none');
                
                const status = document.getElementById(`step${i}Status`);
                if(status) status.classList.add('d-none');
            }
            
            // Explicitly reset Step 2 links to hidden
            const linkExport = document.getElementById('linkExportOrders');
            const linkConfirmComax = document.getElementById('linkConfirmComax');
            if(linkExport) linkExport.classList.add('d-none');
            if(linkConfirmComax) linkConfirmComax.classList.add('d-none');

            // Explicitly reset Step 5 links to hidden
            const linkGen = document.getElementById('linkGenerateWebExport');
            const linkConf = document.getElementById('linkConfirmWebUpdate');
            if(linkGen) linkGen.classList.add('d-none');
            if(linkConf) linkConf.classList.add('d-none');
            
            const loadingEl = document.getElementById('step1Loading');
            if (loadingEl) loadingEl.classList.add('d-none');
            
            // Step 5 specific loading
            const step5LoadingEl = document.getElementById('step5Loading');
            if (step5LoadingEl) step5LoadingEl.classList.add('d-none');


            // Helper: Update step timestamp display
            function updateStepTimestamp(stepNum, stepData) {
                const el = document.getElementById(`step${stepNum}Timestamp`);
                if (el && stepData && stepData.timestamp) {
                    el.innerText = formatTimeHHMM(stepData.timestamp);
                    el.classList.remove('d-none');
                } else if (el) {
                    el.classList.add('d-none');
                }
            }

            // Populate Details (History)
            if (state.currentStage !== 'IDLE') {
                // Step 1 Details
                document.getElementById('step1Details').classList.remove('d-none');
                updateDetailStatus('webOrdersStatus', state.webOrdersJobStatus);
                updateDetailStatus('webProductsStatus', state.webProductsJobStatus);
                updateDetailStatus('webTranslationsStatus', state.webTranslationsJobStatus);
                updateStepTimestamp(1, state.step1);

                // Step 1: Blue border after completion
                if (state.step1 && state.step1.status === 'completed') {
                    const step1Col = document.getElementById('step1Col');
                    if (step1Col) {
                        const card = step1Col.querySelector('.card');
                        if (card) card.classList.add('border-primary');
                    }
                }

                // Step 2 Details
                // Only show details if calculation has happened (not -1)
                if (state.ordersPendingExportCount !== -1 || state.currentStage === 'COMAX_IMPORT_PROCESSING' || state.currentStage === 'READY_FOR_COMAX_IMPORT' || state.currentStage === 'VALIDATING' || state.currentStage === 'COMPLETE' || state.currentStage === 'READY_FOR_WEB_EXPORT' || state.currentStage === 'WEB_EXPORT_PROCESSING' || state.currentStage === 'WEB_EXPORT_GENERATED') {
                    document.getElementById('step2Details').classList.remove('d-none');
                    updateDetailStatus('comaxExportStatus', state.comaxOrdersExported ? 'COMPLETED' : (state.ordersPendingExportCount > 0 ? 'PENDING' : 'N/A'));
                    const isConfirmed = state.currentStage === 'READY_FOR_COMAX_IMPORT' || state.currentStage === 'COMAX_IMPORT_PROCESSING' || state.currentStage === 'VALIDATING' || state.currentStage === 'COMPLETE' || state.currentStage === 'READY_FOR_WEB_EXPORT' || state.currentStage === 'WEB_EXPORT_PROCESSING' || state.currentStage === 'WEB_EXPORT_GENERATED';
                    updateDetailStatus('comaxConfirmStatus', isConfirmed ? 'COMPLETED' : (state.comaxOrdersExported ? 'PENDING' : 'N/A'));
                    updateStepTimestamp(2, state.step2);
                }


                // Step 3 Details
                if (state.comaxProductsJobStatus !== 'NOT_STARTED') {
                    document.getElementById('step3Details').classList.remove('d-none');
                    updateDetailStatus('comaxImportJobStatus', state.comaxProductsJobStatus);
                    updateStepTimestamp(3, state.step3);
                }

                // Step 4 Details
                if (state.masterValidationJobStatus !== 'NOT_STARTED') {
                    document.getElementById('step4Details').classList.remove('d-none');
                    updateDetailStatus('masterValidationStatus', state.masterValidationJobStatus);
                    updateStepTimestamp(4, state.step4);
                }

                // Step 5 Details
                if (state.webInventoryExportJobStatus !== 'NOT_STARTED' || state.currentStage === 'COMPLETE' || state.currentStage === 'READY_FOR_WEB_EXPORT' || state.currentStage === 'WEB_EXPORT_PROCESSING' || state.currentStage === 'WEB_EXPORT_GENERATED') {
                    document.getElementById('step5Details').classList.remove('d-none');
                    updateDetailStatus('webExportJobStatus', state.webInventoryExportJobStatus);
                    updateStepTimestamp(5, state.step5);

                    if (state.webExportFilename) {
                        document.getElementById('webExportFileContainer').classList.remove('d-none');
                        document.getElementById('webExportFilename').innerText = state.webExportFilename;
                    }
                }
            } else {
                // Hide all details if IDLE
                for (let i = 1; i <= 5; i++) {
                    const details = document.getElementById(`step${i}Details`);
                    if (details) details.classList.add('d-none');
                }
            }

            // Determine Active Step & Action Visibility
            let activeStep = 0;
            const stage = state.currentStage;

            switch (stage) {
                case 'IDLE':
                    activeStep = 1;
                    updateCurrentStatus('Ready to sync');
                    const s1Actions = document.getElementById('step1Actions');
                    if(s1Actions) {
                        s1Actions.classList.remove('d-none');
                        // Reset Start Link State
                        const startLink = s1Actions.querySelector('a');
                        if(startLink) {
                            startLink.classList.remove('d-none');
                            startLink.innerText = 'Start';
                            startLink.style.pointerEvents = 'auto';
                        }
                    }
                    break;
                case 'WEB_IMPORT_PROCESSING':
                    activeStep = 1;
                    updateCurrentStatus('Importing web data...', true);
                    const s1Processing = document.getElementById('step1Actions');
                    if(s1Processing) {
                        s1Processing.classList.remove('d-none');
                        const link = s1Processing.querySelector('a');
                        if(link) link.classList.add('d-none');
                    }
                    const step1LoadingEl = document.getElementById('step1Loading');
                    if (step1LoadingEl) step1LoadingEl.classList.remove('d-none');
                    break;
                case 'WAITING_FOR_COMAX':
                    const s2Actions = document.getElementById('step2Actions');
                    const noOrdersMsg = document.getElementById('step2NoOrdersMsg');

                    // Key fix: Only show UI when order count is definitively known (>= 0)
                    // -1 means still calculating - don't show anything yet
                    if (state.ordersPendingExportCount === -1) {
                        // Still calculating - keep Step 1 highlighted, show waiting message
                        activeStep = 1;
                        updateCurrentStatus('Calculating orders to export...', true);
                    } else if (state.ordersPendingExportCount === 0) {
                        // No orders - skip to Step 3
                        activeStep = 3;
                        updateCurrentStatus('No orders to export - proceeding to import');

                        if (s2Actions) s2Actions.classList.add('d-none');
                        if (noOrdersMsg) {
                            noOrdersMsg.classList.remove('d-none');
                            noOrdersMsg.innerText = 'No orders to export.';
                        }

                        // Show Step 3 "Start Import" button
                        const s3Actions = document.getElementById('step3Actions');
                        if(s3Actions) {
                             s3Actions.classList.remove('d-none');
                             const startComaxLink = s3Actions.querySelector('a');
                             if(startComaxLink) {
                                 startComaxLink.style.pointerEvents = 'auto';
                                 startComaxLink.innerText = 'Start Import';
                             }
                        }
                    } else if (state.ordersPendingExportCount > 0) {
                        // Orders exist - show export/confirm links
                        activeStep = 2;
                        if (noOrdersMsg) noOrdersMsg.classList.add('d-none');

                        if (s2Actions) {
                            s2Actions.classList.remove('d-none');
                            const exportLink = document.getElementById('linkExportOrders');
                            const confirmLink = document.getElementById('linkConfirmComax');

                            if (exportLink && confirmLink) {
                                if (state.comaxOrdersExported) {
                                    exportLink.classList.add('d-none');
                                    confirmLink.classList.remove('d-none');
                                    updateCurrentStatus(state.ordersPendingExportCount + ' orders exported - confirm Comax update');
                                } else {
                                    exportLink.classList.remove('d-none');
                                    confirmLink.classList.add('d-none');
                                    updateCurrentStatus(state.ordersPendingExportCount + ' orders ready for export');
                                }
                                exportLink.style.pointerEvents = 'auto';
                                confirmLink.style.pointerEvents = 'auto';
                                if (exportLink.innerText === '...') exportLink.innerText = 'Export Orders';
                                if (confirmLink.innerText === '...') confirmLink.innerText = 'Confirm Comax Update';
                            }
                        }
                    }
                    break;
                case 'READY_FOR_COMAX_IMPORT':
                    activeStep = 3;
                    updateCurrentStatus('Ready to import Comax data');
                    const s3Actions = document.getElementById('step3Actions');
                    if(s3Actions) {
                         s3Actions.classList.remove('d-none');
                         const startComaxLink = s3Actions.querySelector('a');
                         if(startComaxLink) {
                             startComaxLink.style.pointerEvents = 'auto';
                             startComaxLink.innerText = 'Start Import';
                         }
                    }
                    break;
                case 'COMAX_IMPORT_PROCESSING':
                    activeStep = 3;
                    updateCurrentStatus('Importing Comax products...', true);
                    const s3ActionsProcessing = document.getElementById('step3Actions');
                    const s3StatusProcessing = document.getElementById('step3Status');
                    // Hide the action link, show processing status
                    if(s3ActionsProcessing) s3ActionsProcessing.classList.add('d-none');
                    if(s3StatusProcessing) {
                        s3StatusProcessing.classList.remove('d-none');
                        s3StatusProcessing.innerText = 'Processing...';
                    }
                    break;
                case 'VALIDATING':
                    activeStep = 4;
                    updateCurrentStatus('Running validation...', true);
                    const s4Status = document.getElementById('step4Status');
                    if(s4Status) {
                        s4Status.classList.remove('d-none');
                        s4Status.innerText = 'Validating...';
                    }
                    break;
                case 'READY_FOR_WEB_EXPORT': // New Stage
                    activeStep = 5;
                    updateCurrentStatus('Ready to generate web export');
                    const s5ActionsReady = document.getElementById('step5Actions');
                    const linkGenerateWebExport = document.getElementById('linkGenerateWebExport');
                    const linkConfirmWebUpdate = document.getElementById('linkConfirmWebUpdate');
                    if(s5ActionsReady && linkGenerateWebExport && linkConfirmWebUpdate) {
                        s5ActionsReady.classList.remove('d-none');
                        linkGenerateWebExport.classList.remove('d-none');
                        linkConfirmWebUpdate.classList.add('d-none'); // Ensure confirm is hidden

                        linkGenerateWebExport.style.pointerEvents = 'auto';
                        linkGenerateWebExport.innerText = 'Generate Export';
                    }
                    break;
                case 'WEB_EXPORT_PROCESSING': // New Stage
                    activeStep = 5;
                    updateCurrentStatus('Generating web export...', true);
                    const s5ActionsProcessing = document.getElementById('step5Actions');
                    if(s5ActionsProcessing) {
                        s5ActionsProcessing.classList.remove('d-none');
                        document.getElementById('linkGenerateWebExport').classList.add('d-none'); // Hide generate
                        document.getElementById('linkConfirmWebUpdate').classList.add('d-none'); // Hide confirm
                    }
                    if (step5LoadingEl) step5LoadingEl.classList.remove('d-none'); // Show loading
                    break;
                case 'WEB_EXPORT_GENERATED': // Only show confirm after export succeeds
                    activeStep = 5;
                    updateCurrentStatus('Export generated - confirm web update');
                    const s5ActionsGenerated = document.getElementById('step5Actions');
                    const linkGenWeb = document.getElementById('linkGenerateWebExport');
                    const linkConfWeb = document.getElementById('linkConfirmWebUpdate');
                    if(s5ActionsGenerated && linkGenWeb && linkConfWeb) {
                        s5ActionsGenerated.classList.remove('d-none');
                        linkGenWeb.classList.add('d-none'); // Hide generate button
                        linkConfWeb.classList.remove('d-none'); // Show confirm button (only after export succeeds)
                        linkConfWeb.style.pointerEvents = 'auto';
                        linkConfWeb.innerText = 'Confirm Web Update';
                        console.log('Step 5: Showing Confirm Web Update button (export completed successfully)');
                    }
                    break;
                case 'COMPLETE':
                    activeStep = 5;
                    updateCurrentStatus('Sync complete ✓');
                    const s5ActionsComplete = document.getElementById('step5Actions');
                    if(s5ActionsComplete) {
                        s5ActionsComplete.classList.remove('d-none');
                        document.getElementById('linkGenerateWebExport').classList.add('d-none'); // Hide generate
                        document.getElementById('linkConfirmWebUpdate').classList.add('d-none'); // Hide confirm
                        // Maybe add a "Confirmed" text here
                    }
                    break;
                case 'FAILED':
                    // Highlight the step that likely failed
                    if (state.webOrdersJobStatus === 'FAILED') {
                        activeStep = 1;
                        if(document.getElementById('step1Actions')) document.getElementById('step1Actions').classList.remove('d-none');
                    }
                    else if (state.comaxProductsJobStatus === 'FAILED') {
                        activeStep = 3;
                        if(document.getElementById('step3Actions')) document.getElementById('step3Actions').classList.remove('d-none');
                    }
                    else if (state.masterValidationJobStatus === 'FAILED') activeStep = 4;
                    else if (state.webInventoryExportJobStatus === 'FAILED') {
                        activeStep = 5;
                        const s5Actions = document.getElementById('step5Actions');
                        if(s5Actions) {
                            s5Actions.classList.remove('d-none');
                            document.getElementById('linkGenerateWebExport').classList.remove('d-none');
                        }
                    }
                    else activeStep = 5; // Fallback
                    
                    const col = document.getElementById(`step${activeStep}Col`);
                    if(col) col.querySelector('.card').classList.add('border-danger');
                    return; 
            }

            // Apply Highlight
            if (activeStep > 0) {
                const col = document.getElementById(`step${activeStep}Col`);
                if(col) {
                    const card = col.querySelector('.card');
                    if(card) card.classList.add('border-primary', 'shadow');
                }
            }
        }

        function handleSyncAction(e, actionName) {
            e.preventDefault();
            const link = e.target;
            const originalText = link.innerText;

            // Add confirmation dialogs for certain actions
            if (actionName === 'exportComaxOrders') {
                if (!confirm('Export orders to Comax CSV file?')) {
                    return;
                }
            } else if (actionName === 'confirmComaxUpdate') {
                if (!confirm('Confirm that you have uploaded the file to Comax and are ready to proceed?')) {
                    return;
                }
            } else if (actionName === 'generateWebExport') {
                if (!confirm('Generate web inventory export file?')) {
                    return;
                }
            } else if (actionName === 'confirmWebUpdate') {
                if (!confirm('Confirm that you have uploaded the inventory file to the website?')) {
                    return;
                }
            }

            link.innerText = '...';
            link.style.pointerEvents = 'none';

            // Common success handler that updates UI
            const handleActionSuccess = (state) => {
                updateSyncUI(state);
            };

            if (actionName === 'startSync') {
                google.script.run.withSuccessHandler(handleActionSuccess).withFailureHandler(handleSyncError).startDailySyncBackend();
            } else if (actionName === 'exportComaxOrders') {
                google.script.run.withSuccessHandler((res) => {
                    if (res.success) {
                        if (res.fileUrl) {
                            prompt('Export successful. Copy filename for Comax upload:', res.fileName);
                        } else {
                            alert(res.message || 'No orders to export. Proceeding to confirmation.');
                        }
                    } else {
                        alert('Export failed: ' + (res.message || 'Unknown error'));
                    }
                    link.innerText = originalText;
                    link.style.pointerEvents = 'auto';
                    refreshDailySyncWidgetState();
                }).exportComaxOrdersBackend();
            } else if (actionName === 'confirmComaxUpdate') {
                 google.script.run.withSuccessHandler(handleActionSuccess).withFailureHandler(handleSyncError).confirmComaxUpdateBackend();
            } else if (actionName === 'startComaxImport') {
                 google.script.run.withSuccessHandler(handleActionSuccess).withFailureHandler(handleSyncError).startComaxImportBackend();
            } else if (actionName === 'generateWebExport') { // New action
                 google.script.run.withSuccessHandler(handleActionSuccess).withFailureHandler(handleSyncError).generateWebExportBackend();
            } else if (actionName === 'confirmWebUpdate') { // New action
                 google.script.run.withSuccessHandler(handleActionSuccess).withFailureHandler(handleSyncError).confirmWebInventoryUpdateBackend();
            }
        }

        function resetSyncWorkflow() {
            if (!confirm('Reset Sync State?')) return;
             google.script.run.withSuccessHandler(updateSyncUI).withFailureHandler(handleSyncError).resetSyncStateBackend();
        }

        function handleSyncError(error) {
            console.error(error);
            const errContainer = document.getElementById('errorMessageContainer');
            const errDisplay = document.getElementById('errorMessageDisplay');
            if (errContainer && errDisplay) {
                errDisplay.innerText = error.message;
                errContainer.classList.remove('d-none');
            }
        }
        
        // Initialize immediately
        console.log('Daily Sync Widget: Initializing...');

        // ===== SMART POLLING: Fast when active, slow when idle =====
        let currentPollInterval = null;
        let pollIntervalId = null;

        function refreshDailySyncWidgetState() {
            google.script.run
                .withSuccessHandler((state) => {
                    updateSyncUI(state);
                    adjustPollingSpeed(state);
                })
                .withFailureHandler(handleSyncError)
                .getSyncStateFromBackend();
        }

        function adjustPollingSpeed(state) {
            const activeStages = ['WEB_IMPORT_PROCESSING', 'COMAX_IMPORT_PROCESSING', 'VALIDATING', 'WEB_EXPORT_PROCESSING'];
            const isActive = activeStages.includes(state.currentStage);

            const newInterval = isActive ? 3000 : 30000; // 3s when active, 30s when idle

            if (newInterval !== currentPollInterval) {
                currentPollInterval = newInterval;
                if (pollIntervalId) clearInterval(pollIntervalId);
                pollIntervalId = setInterval(refreshDailySyncWidgetState, currentPollInterval);
                console.log(`Polling: ${isActive ? 'ACTIVE' : 'IDLE'} - ${currentPollInterval/1000}s interval`);
            }
        }

        // Initialize - fetch state once on load
        refreshDailySyncWidgetState();

        // Start with idle polling (will switch to fast if needed)
        currentPollInterval = 30000;
        pollIntervalId = setInterval(refreshDailySyncWidgetState, 30000);
    </script>