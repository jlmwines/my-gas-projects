<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    /* Styles reused from ManagerProductsView for consistency */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: flex-start; padding-top: 80px; overflow-y: auto; }
    .modal-container { background: white; width: 90%; max-width: 900px; max-height: 85vh; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-bottom: 50px; }
    .modal-header { padding: 10px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; background-color: #f8f9fa; border-radius: 8px 8px 0 0; }
    .modal-product-info { display: flex; justify-content: space-between; align-items: center; width: 100%; padding-right: 20px; }
    .header-item { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .header-left { text-align: left; font-weight: 600; color: #333; }
    .header-center { text-align: center; font-weight: 700; color: #007bff; font-size: 1.1em; }
    .header-right { text-align: right; direction: rtl; font-weight: 600; color: #333; }
    .form-body { flex: 1; overflow-y: auto; padding: 20px; }
    .tab-bar { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; justify-content: space-between; align-items: center; }
    .tab-group { display: flex; }
    .tab-btn { padding: 8px 15px; cursor: pointer; border-bottom: 2px solid transparent; color: #666; font-weight: 500; font-size: 14px; }
    .tab-btn:hover { color: #007bff; }
    .tab-btn.active { border-bottom-color: #007bff; color: #007bff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
    .col-header { font-weight: 600; color: #555; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
    .hebrew-text { direction: rtl; text-align: right; }
    select#edit-Region option { text-align: right !important; }
    .preview-box { background: #fafafa; border: 1px solid #eee; padding: 15px; border-radius: 4px; min-height: 200px; white-space: pre-wrap; font-size: 13px; }
    .desc-short, .desc-long { width: 100%; font-size: 14px; line-height: 1.4; padding: 8px; }
    div.desc-short, div.desc-long { background-color: #f8f9fa; border: 1px solid #ced4da; border-radius: 4px; overflow-y: auto; }
    textarea.desc-short, textarea.desc-long { resize: vertical; }
    .desc-short { min-height: 40px; }
    /* 3 lines approx */
    .desc-long { min-height: 120px; }
  </style>
</head>
<body>
  <div class="container-fluid p-4">
    <h2 class="mb-4">Products</h2>
    
    <!-- CARD 1: DETAIL UPDATES -->
    <div class="card mb-4">
      <div class="card-header bg-white font-weight-bold">
        Detail Updates
      </div>
      <div class="card-body">
        
        <!-- Section A: Review Pending (Primary) -->
        <h6 class="text-muted mb-2">Review Pending (<span id="stat-review">0</span>)</h6>
        <div class="table-responsive mb-4 border rounded">
            <table class="table table-hover mb-0">
              <thead class="thead-light">
                <tr>
                  <th class="border-top-0">Product</th>
                  <th class="border-top-0">SKU</th>
                  <th class="border-top-0">Task</th>
                  <th class="border-top-0">Date</th>
                  <th class="border-top-0">Action</th>
                </tr>
              </thead>
              <tbody id="review-list-body">
                <!-- Review tasks populated here -->
              </tbody>
            </table>
        </div>

        <!-- Section B: Accepted Updates -->
        <h6 class="text-muted mb-2">Accepted (<span id="stat-accepted">0</span>)</h6>
        <div class="table-responsive mb-2 border rounded">
            <table class="table table-hover mb-0">
              <thead class="thead-light">
                <tr>
                  <th class="border-top-0">Product</th>
                  <th class="border-top-0">SKU</th>
                  <th class="border-top-0">Task</th>
                  <th class="border-top-0">Date</th>
                </tr>
              </thead>
              <tbody id="accepted-list-body">
                <!-- Accepted tasks populated here -->
              </tbody>
            </table>
        </div>

        <!-- Export & Confirm Bar -->
        <div class="d-flex justify-content-end align-items-center p-2">
            <button id="btn-export-details" class="btn btn-sm mr-2" onclick="AdminProductsView.exportUpdates()">Export</button>
            <button id="btn-confirm-details" class="btn btn-sm" onclick="AdminProductsView.confirmUpdates()" disabled>Confirm</button>
        </div>
        <div id="export-status" class="text-right mt-2"></div>

        <!-- Section C: Pending (Info only - awaiting manager action) -->
        <h6 class="text-muted mb-2 mt-4">Pending (<span id="stat-pending-details">0</span>)</h6>
        <div class="table-responsive border rounded" style="max-height: 200px; overflow-y: auto;">
            <table class="table table-sm mb-0">
              <thead class="thead-light">
                <tr>
                  <th class="border-top-0">SKU</th>
                  <th class="border-top-0">Product</th>
                  <th class="border-top-0">Title</th>
                  <th class="border-top-0">Date</th>
                </tr>
              </thead>
              <tbody id="pending-details-list-body">
                <!-- Pending detail tasks populated here -->
              </tbody>
            </table>
        </div>

      </div>
    </div>

    <!-- CARD 2: NEW PRODUCTS -->
    <div class="card mb-4">
      <div class="card-header bg-white font-weight-bold">
        New Products
      </div>
      <div class="card-body">
        
        <!-- Section A: Suggestions -->
        <h6 class="text-muted mb-2">Suggestions (<span id="stat-suggestions">0</span>)</h6>
        <div class="table-responsive mb-4 border rounded">
            <table class="table table-hover table-sm mb-0">
              <thead class="thead-light">
                <tr>
                  <th class="border-top-0">SKU</th>
                  <th class="border-top-0">Title</th>
                  <th class="border-top-0">Division</th>
                  <th class="border-top-0">Group</th>
                  <th class="border-top-0 text-right">Price</th>
                  <th class="border-top-0 text-right">Stock</th>
                  <th class="border-top-0">Action</th>
                </tr>
              </thead>
              <tbody id="suggestions-list-body">
                <!-- Suggestions tasks populated here -->
              </tbody>
            </table>
        </div>

        <!-- Section B: Review Submissions -->
        <h6 class="text-muted mb-2">Review Submissions (<span id="stat-submissions">0</span>)</h6>
        <div class="table-responsive mb-4 border rounded">
            <table class="table table-hover mb-0">
              <thead class="thead-light">
                <tr>
                  <th class="border-top-0">Product</th>
                  <th class="border-top-0">SKU</th>
                  <th class="border-top-0">Task</th>
                  <th class="border-top-0">Date</th>
                  <th class="border-top-0">Action</th>
                </tr>
              </thead>
              <tbody id="submissions-list-body">
                <!-- Submissions tasks populated here -->
              </tbody>
            </table>
        </div>

        <!-- Section C: Finalize Linkage -->
        <h6 class="text-muted mb-2">Finalize Linkage (<span id="stat-linkage">0</span>)</h6>
        <div class="table-responsive mb-4 border rounded">
            <table class="table table-hover mb-0">
              <thead class="thead-light">
                <tr>
                  <th class="border-top-0">Task</th>
                  <th class="border-top-0">SKU</th>
                  <th class="border-top-0">Status</th>
                  <th class="border-top-0">Action</th>
                </tr>
              </thead>
              <tbody id="linkage-list-body">
                <!-- Linkage tasks populated here -->
              </tbody>
            </table>
        </div>

        <!-- Section D: Export -->
        <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded mb-4">
            <div>
                <span class="font-weight-bold mr-2">Ready for Web:</span>
                <span id="stat-onboarding-export" class="badge badge-secondary">0</span>
            </div>
            <div>
                <button id="btn-export-new" class="btn btn-primary mr-2" onclick="AdminProductsView.exportNewProducts()">Export New Products</button>
            </div>
        </div>
        <div id="new-export-status" class="mt-2 small text-right"></div>

        <!-- Section E: Pending (Secondary) -->
        <h6 class="text-muted mb-2 mt-4">Pending (<span id="stat-pending-new">0</span>)</h6>
        <div class="table-responsive border rounded" style="max-height: 200px; overflow-y: auto;">
            <table class="table table-sm mb-0">
              <thead class="thead-light">
                <tr>
                  <th class="border-top-0">SKU</th>
                  <th class="border-top-0">Product</th>
                  <th class="border-top-0">Title</th>
                  <th class="border-top-0">Date</th>
                </tr>
              </thead>
              <tbody id="pending-new-list-body">
                <!-- Pending new product tasks populated here -->
              </tbody>
            </table>
        </div>

      </div>
    </div>

  </div>

    <!-- CARD 3: SKU MANAGEMENT -->
    <div class="card mb-4">
      <div class="card-header bg-white font-weight-bold">
        SKU Management
      </div>
      <div class="card-body">

        <!-- Action Buttons -->
        <div class="d-flex mb-4">
          <button class="btn btn-sm mr-3" onclick="AdminProductsView.openVendorSkuModal()">Vendor SKU Update</button>
          <button class="btn btn-sm" onclick="AdminProductsView.openReplacementModal()">Product Replacement</button>
        </div>

        <!-- Recent Updates -->
        <h6 class="text-muted mb-2">Recent SKU Updates</h6>
        <div class="table-responsive border rounded" style="max-height: 200px; overflow-y: auto;">
            <table class="table table-sm mb-0">
              <thead class="thead-light">
                <tr>
                  <th class="border-top-0">Date</th>
                  <th class="border-top-0">Type</th>
                  <th class="border-top-0">Old SKU</th>
                  <th class="border-top-0">New SKU</th>
                  <th class="border-top-0">Updated By</th>
                </tr>
              </thead>
              <tbody id="sku-updates-body">
                <!-- Recent SKU updates populated here -->
              </tbody>
            </table>
        </div>

      </div>
    </div>

  </div>

  <!-- Vendor SKU Update Modal -->
  <div class="modal-overlay" id="vendor-sku-modal">
    <div class="modal-container" style="max-width: 600px;">
      <div class="modal-header">
        <h5 class="mb-0">Vendor SKU Update</h5>
        <button type="button" class="close" onclick="AdminProductsView.closeVendorSkuModal()">&times;</button>
      </div>
      <div class="form-body">

        <!-- Step 1: Find Existing Product -->
        <div class="mb-4">
          <h6 class="text-muted">Step 1: Find Existing Product</h6>
          <div class="position-relative">
            <input type="text" class="form-control" id="vendor-search-sku" placeholder="Search by current SKU or name..." oninput="AdminProductsView.searchCurrentProduct()">
            <div id="vendor-search-results" class="position-absolute w-100 bg-white border rounded shadow-sm" style="display:none; max-height:200px; overflow-y:auto; z-index:100;"></div>
          </div>
          <div id="vendor-current-product" class="mt-3 p-3 bg-light rounded" style="display:none;">
            <div class="row">
              <div class="col-6">
                <small class="text-muted">SKU:</small>
                <div id="vendor-current-sku" class="font-weight-bold"></div>
              </div>
              <div class="col-6">
                <small class="text-muted">Web IDs:</small>
                <div id="vendor-current-webids"></div>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-12">
                <small class="text-muted">Comax Name (HE):</small>
                <div id="vendor-current-comax-name" class="hebrew-text"></div>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-6">
                <small class="text-muted">Web Name (EN):</small>
                <div id="vendor-current-web-name-en"></div>
              </div>
              <div class="col-6">
                <small class="text-muted">Web Name (HE):</small>
                <div id="vendor-current-web-name-he" class="hebrew-text"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: Enter New SKU -->
        <div class="mb-4">
          <h6 class="text-muted">Step 2: Enter New SKU</h6>
          <input type="text" class="form-control" id="vendor-new-sku" placeholder="Enter new SKU value..." oninput="AdminProductsView.validateNewSku()">
          <div id="vendor-new-sku-error" class="text-danger small mt-1" style="display:none;"></div>
          <div id="vendor-new-sku-valid" class="text-success small mt-1" style="display:none;"></div>
        </div>

        <!-- Step 3: Confirmation -->
        <div class="mb-3">
          <h6 class="text-muted">Step 3: Update External Systems</h6>
          <p class="small text-muted mb-2">Before confirming, update SKU from <strong><span id="vendor-label-old-sku">___</span></strong> to <strong><span id="vendor-label-new-sku">___</span></strong> in:</p>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="vendor-confirm-comax">
            <label class="form-check-label" for="vendor-confirm-comax">Comax (inventory system)</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="vendor-confirm-woo">
            <label class="form-check-label" for="vendor-confirm-woo">WooCommerce <span id="vendor-label-webids"></span></label>
          </div>
        </div>

      </div>
      <div class="modal-footer bg-light">
        <div id="vendor-modal-status" class="mr-auto small"></div>
        <button class="btn btn-sm" onclick="AdminProductsView.closeVendorSkuModal()">Cancel</button>
        <button class="btn btn-sm" id="vendor-submit-btn" onclick="AdminProductsView.submitVendorSkuUpdate()" disabled>Confirm - Update JLMops</button>
      </div>
    </div>
  </div>

  <!-- Product Replacement Modal -->
  <div class="modal-overlay" id="replacement-modal">
    <div class="modal-container" style="max-width: 700px;">
      <div class="modal-header">
        <h5 class="mb-0">Product Replacement</h5>
        <button type="button" class="close" onclick="AdminProductsView.closeReplacementModal()">&times;</button>
      </div>
      <div class="form-body">

        <!-- Step 1: Find Current Web Product -->
        <div class="mb-4">
          <h6 class="text-muted">Step 1: Find Current Web Product</h6>
          <div class="position-relative">
            <input type="text" class="form-control" id="replace-search-current" placeholder="Search by SKU..." oninput="AdminProductsView.searchCurrentWebProduct()">
            <div id="replace-search-current-results" class="position-absolute w-100 bg-white border rounded shadow-sm" style="display:none; max-height:200px; overflow-y:auto; z-index:100;"></div>
          </div>
          <div id="replace-current-product" class="mt-3 p-3 bg-light rounded" style="display:none;">
            <div class="row">
              <div class="col-4">
                <small class="text-muted">SKU:</small>
                <div id="replace-current-sku" class="font-weight-bold"></div>
              </div>
              <div class="col-4">
                <small class="text-muted">Web IDs:</small>
                <div id="replace-current-webids"></div>
              </div>
              <div class="col-4">
                <small class="text-muted">Comax IsWeb:</small>
                <div id="replace-current-isweb"></div>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-4">
                <small class="text-muted">Comax Name (HE):</small>
                <div id="replace-current-comax-name" class="hebrew-text"></div>
              </div>
              <div class="col-4">
                <small class="text-muted">Web Name (EN):</small>
                <div id="replace-current-web-name-en"></div>
              </div>
              <div class="col-4">
                <small class="text-muted">Web Name (HE):</small>
                <div id="replace-current-web-name-he" class="hebrew-text"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: Find Replacement Comax Product -->
        <div class="mb-4">
          <h6 class="text-muted">Step 2: Find Replacement Comax Product</h6>
          <div class="position-relative">
            <input type="text" class="form-control" id="replace-search-new" placeholder="Search by SKU or name (not on web)..." oninput="AdminProductsView.searchReplacementProduct()">
            <div id="replace-search-new-results" class="position-absolute w-100 bg-white border rounded shadow-sm" style="display:none; max-height:200px; overflow-y:auto; z-index:100;"></div>
          </div>
          <div id="replace-new-product" class="mt-3 p-3 bg-light rounded" style="display:none;">
            <div class="row">
              <div class="col-6">
                <small class="text-muted">SKU:</small>
                <div id="replace-new-sku" class="font-weight-bold"></div>
              </div>
              <div class="col-6">
                <small class="text-muted">Comax IsWeb:</small>
                <div id="replace-new-isweb"></div>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-12">
                <small class="text-muted">Comax Name (HE):</small>
                <div id="replace-new-comax-name" class="hebrew-text"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Confirmation -->
        <div class="mb-3">
          <h6 class="text-muted">Step 3: Update External Systems</h6>
          <p class="small text-muted mb-2">Before confirming:</p>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="replace-confirm-old-off">
            <label class="form-check-label" for="replace-confirm-old-off">Turn OFF old product (<span id="replace-label-old-sku">___</span>) on web in Comax</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="replace-confirm-new-on">
            <label class="form-check-label" for="replace-confirm-new-on">Turn ON new product (<span id="replace-label-new-sku">___</span>) on web in Comax</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="replace-confirm-woo">
            <label class="form-check-label" for="replace-confirm-woo">Update SKU in WooCommerce products <span id="replace-label-webids"></span></label>
          </div>
        </div>

      </div>
      <div class="modal-footer bg-light">
        <div id="replace-modal-status" class="mr-auto small"></div>
        <button class="btn btn-sm" onclick="AdminProductsView.closeReplacementModal()">Cancel</button>
        <button class="btn btn-sm" id="replace-submit-btn" onclick="AdminProductsView.submitReplacement()" disabled>Confirm - Update JLMops</button>
      </div>
    </div>
  </div>

  <!-- Suggestion Approval Modal -->
  <div class="modal-overlay" id="suggestion-modal">
    <div class="modal-container" style="max-width: 500px; max-height: auto;">
      <div class="modal-header">
        <h5 class="mb-0">Approve Suggestion</h5>
        <button type="button" class="close" onclick="document.getElementById('suggestion-modal').style.display='none'">&times;</button>
      </div>
      <div class="form-body">
        <p class="text-muted small">Define the official names for the new product.</p>
        <div class="form-group">
            <label>SKU</label>
            <input type="text" class="form-control" id="sugg-sku" readonly>
        </div>
        <div class="form-group">
            <label>Product Name EN</label>
            <input type="text" class="form-control" id="sugg-name-en">
        </div>
        <div class="form-group">
            <label>Product Name HE</label>
            <input type="text" class="form-control hebrew-text" id="sugg-name-he">
        </div>
      </div>
      <div class="modal-footer bg-light">
        <button class="btn btn-sm" onclick="document.getElementById('suggestion-modal').style.display='none'">Cancel</button>
        <button class="btn btn-sm" onclick="AdminProductsView.submitSuggestionApproval()">Approve & Create Task</button>
      </div>
    </div>
  </div>

  <!-- Linkage Modal -->
  <div class="modal-overlay" id="linkage-modal">
    <div class="modal-container" style="max-width: 500px; max-height: auto;">
      <div class="modal-header">
        <h5 class="mb-0">Link & Finalize Product</h5>
        <button type="button" class="close" onclick="document.getElementById('linkage-modal').style.display='none'">&times;</button>
      </div>
      <div class="form-body">
        <p class="text-muted small">Enter the WooCommerce IDs to finalize the Hot Insert.</p>
        <div class="form-group">
            <label>SKU</label>
            <input type="text" class="form-control" id="link-sku" readonly>
        </div>
        <div class="form-group">
            <label>WooCommerce ID (English)</label>
            <input type="text" class="form-control" id="link-woo-en" placeholder="e.g., 12345">
        </div>
        <div class="form-group">
            <label>WooCommerce ID (Hebrew)</label>
            <input type="text" class="form-control" id="link-woo-he" placeholder="e.g., 12346">
        </div>
      </div>
      <div class="modal-footer bg-light">
        <button class="btn border" onclick="document.getElementById('linkage-modal').style.display='none'">Cancel</button>
        <button class="btn btn-primary" onclick="AdminProductsView.submitLinkage()">Finalize Hot Insert</button>
      </div>
    </div>
  </div>

  <!-- Product Editor Modal (Reused Structure) -->
  <div class="modal-overlay" id="editor-modal">
    <div class="modal-container">
      <div class="modal-header">
        <div class="modal-product-info">
            <div id="header-name-en-display" class="header-item header-left"></div>
            <div id="header-sku-display" class="header-item header-center"></div>
            <div id="header-name-he-display" class="header-item header-right"></div>
        </div>
        <button type="button" class="close" aria-label="Close" onclick="AdminProductsView.closeModal()"><span aria-hidden="true">&times;</span></button>
      </div>
      
      <div class="form-body">
        <div class="tab-bar">
          <div class="tab-group">
            <div class="tab-btn active" onclick="AdminProductsView.switchTab('preview')">Preview</div>
            <div class="tab-btn" onclick="AdminProductsView.switchTab('desc')">Descriptions</div>
          </div>
        </div>

        <div id="tab-preview" class="tab-content active">
           <div class="comparison-grid">
             <div><div class="col-header">English Preview</div><div class="preview-box" id="preview-en"></div></div>
             <div><div class="col-header">Hebrew Preview</div><div class="preview-box hebrew-text" id="preview-he"></div></div>
           </div>
        </div>

        <div id="tab-desc" class="tab-content">
          <div class="comparison-grid">
            <!-- English Column -->
            <div>
              <div class="col-header">English</div>
              <div class="form-group"><label class="small text-muted mb-1">Short Description</label><textarea class="form-control desc-short" id="edit-ShortDescrEn"></textarea></div>
              <div class="form-group"><label class="small text-muted mb-1">Long Description</label><textarea class="form-control desc-long" id="edit-DescriptionEn"></textarea></div>
            </div>
            
            <!-- Hebrew Column -->
            <div>
              <div class="col-header">Hebrew</div>
              <div class="form-group"><label class="small text-muted mb-1">Short Description</label><textarea class="form-control hebrew-text desc-short" id="edit-ShortDescrHe"></textarea></div>
              <div class="form-group"><label class="small text-muted mb-1">Long Description</label><textarea class="form-control hebrew-text desc-long" id="edit-DescriptionHe"></textarea></div>
            </div>
          </div>
          <div class="mt-3 text-right">
              <button class="btn btn-sm" onclick="AdminProductsView.updateStagingAndRefresh()">Update Staging & Refresh Preview</button>
          </div>
        </div>

            </div> <!-- Closes form-body -->
      
            <datalist id="abv-options"></datalist>
            <div class="modal-footer bg-light">
              <div id="modal-status" class="mr-auto text-muted small"></div>
              <button class="btn btn-sm" onclick="AdminProductsView.closeModal()">Cancel</button>
              <button class="btn btn-sm" onclick="AdminProductsView.acceptChanges()">Accept & Update</button>
            </div>
          </div> <!-- Closes modal-container -->
        </div>
  <script>
    (function() {
    window.AdminProductsView = {};
    AdminProductsView.currentTaskId = null;
    AdminProductsView.currentSku = null;
    AdminProductsView.currentMasterData = {};
    AdminProductsView.lookupRegions = [];
    AdminProductsView.lookupGrapes = [];
    AdminProductsView.lookupKashrut = [];

    AdminProductsView.refreshView = function() {
      // Card 1 Refresh
      AdminProductsView.loadReviewList();
      AdminProductsView.loadAcceptedList();
      AdminProductsView.loadPendingDetailsList();

      // Card 2 Refresh
      AdminProductsView.loadSuggestionList();
      AdminProductsView.loadSubmissionsList();
      AdminProductsView.loadLinkageList();
      AdminProductsView.updateNewExportUI();
      AdminProductsView.loadPendingNewList();

      // Card 3 Refresh
      AdminProductsView.loadSkuUpdates();
    };

    // --- Card 3: SKU Management ---

    // Modal state
    AdminProductsView.vendorCurrentProduct = null;
    AdminProductsView.replaceCurrentProduct = null;
    AdminProductsView.replaceNewProduct = null;
    AdminProductsView.searchDebounceTimer = null;

    // Vendor SKU Update Modal
    AdminProductsView.openVendorSkuModal = function() {
        AdminProductsView.vendorCurrentProduct = null;
        AdminProductsView.vendorNewSkuValid = false;
        document.getElementById('vendor-search-sku').value = '';
        document.getElementById('vendor-new-sku').value = '';
        document.getElementById('vendor-current-product').style.display = 'none';
        document.getElementById('vendor-search-results').style.display = 'none';
        document.getElementById('vendor-new-sku-error').style.display = 'none';
        document.getElementById('vendor-new-sku-valid').style.display = 'none';
        document.getElementById('vendor-confirm-comax').checked = false;
        document.getElementById('vendor-confirm-woo').checked = false;
        document.getElementById('vendor-submit-btn').disabled = true;
        document.getElementById('vendor-modal-status').textContent = '';
        // Reset dynamic confirmation labels
        document.getElementById('vendor-label-old-sku').textContent = '___';
        document.getElementById('vendor-label-new-sku').textContent = '___';
        document.getElementById('vendor-label-webids').textContent = '';
        document.getElementById('vendor-sku-modal').style.display = 'flex';
    };

    AdminProductsView.closeVendorSkuModal = function() {
        document.getElementById('vendor-sku-modal').style.display = 'none';
    };

    AdminProductsView.searchCurrentProduct = function() {
        clearTimeout(AdminProductsView.searchDebounceTimer);
        const term = document.getElementById('vendor-search-sku').value.trim();
        const resultsDiv = document.getElementById('vendor-search-results');

        if (term.length < 2) {
            resultsDiv.style.display = 'none';
            return;
        }

        AdminProductsView.searchDebounceTimer = setTimeout(() => {
            google.script.run.withSuccessHandler(results => {
                resultsDiv.innerHTML = '';
                if (!results || results.length === 0) {
                    resultsDiv.innerHTML = '<div class="p-2 text-muted small">No products found</div>';
                } else {
                    results.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'p-2 border-bottom cursor-pointer';
                        div.style.cursor = 'pointer';
                        div.innerHTML = `<strong>${p.sku}</strong> - ${p.name}`;
                        div.onclick = () => AdminProductsView.selectVendorCurrentProduct(p.sku);
                        resultsDiv.appendChild(div);
                    });
                }
                resultsDiv.style.display = 'block';
            }).withFailureHandler(err => {
                resultsDiv.innerHTML = '<div class="p-2 text-danger small">Search failed</div>';
                resultsDiv.style.display = 'block';
            }).WebAppProducts_searchProducts(term);
        }, 300);
    };

    AdminProductsView.selectVendorCurrentProduct = function(sku) {
        document.getElementById('vendor-search-results').style.display = 'none';
        document.getElementById('vendor-search-sku').value = sku;

        google.script.run.withSuccessHandler(data => {
            if (!data || !data.comax) {
                document.getElementById('vendor-current-product').style.display = 'none';
                document.getElementById('vendor-modal-status').textContent = 'Product not found';
                document.getElementById('vendor-modal-status').className = 'mr-auto small text-danger';
                return;
            }
            AdminProductsView.vendorCurrentProduct = data;
            document.getElementById('vendor-current-sku').textContent = data.comax.sku;
            document.getElementById('vendor-current-comax-name').textContent = data.comax.nameHe || '-';
            document.getElementById('vendor-current-web-name-en').textContent = data.web ? data.web.nameEn || '-' : 'Not on web';
            document.getElementById('vendor-current-web-name-he').textContent = data.web ? data.web.nameHe || '-' : '-';
            document.getElementById('vendor-current-webids').textContent = data.web ? `${data.web.webIdEn} / ${data.web.webIdHe}` : 'Not on web';
            document.getElementById('vendor-current-product').style.display = 'block';
            // Update confirmation labels with actual SKU and Web IDs
            document.getElementById('vendor-label-old-sku').textContent = data.comax.sku;
            document.getElementById('vendor-label-webids').textContent = data.web ? `(products ${data.web.webIdEn} / ${data.web.webIdHe})` : '(not on web)';
            AdminProductsView.validateVendorForm();
        }).withFailureHandler(err => {
            document.getElementById('vendor-modal-status').textContent = 'Error: ' + err.message;
            document.getElementById('vendor-modal-status').className = 'mr-auto small text-danger';
        }).WebAppProducts_lookupProductBySku(sku);
    };

    AdminProductsView.vendorNewSkuValid = false;
    AdminProductsView.vendorNewSkuTimer = null;

    AdminProductsView.validateNewSku = function() {
        clearTimeout(AdminProductsView.vendorNewSkuTimer);
        const newSku = document.getElementById('vendor-new-sku').value.trim();
        const errorDiv = document.getElementById('vendor-new-sku-error');
        const validDiv = document.getElementById('vendor-new-sku-valid');
        const newSkuLabel = document.getElementById('vendor-label-new-sku');

        AdminProductsView.vendorNewSkuValid = false;
        validDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        newSkuLabel.textContent = newSku || '___';

        if (!newSku) {
            AdminProductsView.validateVendorForm();
            return;
        }

        if (AdminProductsView.vendorCurrentProduct && newSku === AdminProductsView.vendorCurrentProduct.comax.sku) {
            errorDiv.textContent = 'New SKU must be different from current SKU';
            errorDiv.style.display = 'block';
            AdminProductsView.validateVendorForm();
            return;
        }

        // Debounce the lookup
        AdminProductsView.vendorNewSkuTimer = setTimeout(() => {
            validDiv.textContent = 'Checking SKU...';
            validDiv.style.display = 'block';
            validDiv.className = 'text-muted small mt-1';

            google.script.run.withSuccessHandler(data => {
                if (data && data.comax) {
                    // SKU already exists - this is an error for vendor update
                    errorDiv.textContent = `SKU "${newSku}" already exists in JLMops (${data.comax.nameHe})`;
                    errorDiv.style.display = 'block';
                    validDiv.style.display = 'none';
                    AdminProductsView.vendorNewSkuValid = false;
                } else {
                    // SKU does not exist - this is valid for vendor update
                    validDiv.textContent = `SKU "${newSku}" is available (not in JLMops yet)`;
                    validDiv.className = 'text-success small mt-1';
                    validDiv.style.display = 'block';
                    errorDiv.style.display = 'none';
                    AdminProductsView.vendorNewSkuValid = true;
                }
                AdminProductsView.validateVendorForm();
            }).withFailureHandler(err => {
                validDiv.style.display = 'none';
                AdminProductsView.validateVendorForm();
            }).WebAppProducts_lookupProductBySku(newSku);
        }, 500);
    };

    AdminProductsView.validateVendorForm = function() {
        const hasProduct = AdminProductsView.vendorCurrentProduct !== null;
        const newSku = document.getElementById('vendor-new-sku').value.trim();
        const comaxChecked = document.getElementById('vendor-confirm-comax').checked;
        const wooChecked = document.getElementById('vendor-confirm-woo').checked;

        // Valid if: has current product, has new SKU, new SKU validated as available, both checkboxes checked
        const valid = hasProduct && newSku && AdminProductsView.vendorNewSkuValid && comaxChecked && wooChecked;

        document.getElementById('vendor-submit-btn').disabled = !valid;
    };

    // Add event listeners for validation
    document.getElementById('vendor-confirm-comax').addEventListener('change', AdminProductsView.validateVendorForm);
    document.getElementById('vendor-confirm-woo').addEventListener('change', AdminProductsView.validateVendorForm);

    AdminProductsView.submitVendorSkuUpdate = function() {
        if (!AdminProductsView.vendorCurrentProduct) return;

        const oldSku = AdminProductsView.vendorCurrentProduct.comax.sku;
        const newSku = document.getElementById('vendor-new-sku').value.trim();
        const statusDiv = document.getElementById('vendor-modal-status');

        statusDiv.textContent = 'Updating JLMops...';
        statusDiv.className = 'mr-auto small text-info';
        document.getElementById('vendor-submit-btn').disabled = true;

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                statusDiv.textContent = res.message;
                statusDiv.className = 'mr-auto small text-success';
                setTimeout(() => {
                    AdminProductsView.closeVendorSkuModal();
                    AdminProductsView.loadSkuUpdates();
                }, 1500);
            } else {
                statusDiv.textContent = 'Error: ' + res.message;
                statusDiv.className = 'mr-auto small text-danger';
                document.getElementById('vendor-submit-btn').disabled = false;
            }
        }).withFailureHandler(err => {
            statusDiv.textContent = 'Error: ' + err.message;
            statusDiv.className = 'mr-auto small text-danger';
            document.getElementById('vendor-submit-btn').disabled = false;
        }).WebAppProducts_vendorSkuUpdate(oldSku, newSku);
    };

    // Product Replacement Modal
    AdminProductsView.openReplacementModal = function() {
        AdminProductsView.replaceCurrentProduct = null;
        AdminProductsView.replaceNewProduct = null;
        document.getElementById('replace-search-current').value = '';
        document.getElementById('replace-search-new').value = '';
        document.getElementById('replace-current-product').style.display = 'none';
        document.getElementById('replace-new-product').style.display = 'none';
        document.getElementById('replace-search-current-results').style.display = 'none';
        document.getElementById('replace-search-new-results').style.display = 'none';
        document.getElementById('replace-confirm-old-off').checked = false;
        document.getElementById('replace-confirm-new-on').checked = false;
        document.getElementById('replace-confirm-woo').checked = false;
        document.getElementById('replace-submit-btn').disabled = true;
        document.getElementById('replace-modal-status').textContent = '';
        // Reset dynamic confirmation labels
        document.getElementById('replace-label-old-sku').textContent = '___';
        document.getElementById('replace-label-new-sku').textContent = '___';
        document.getElementById('replace-label-webids').textContent = '';
        document.getElementById('replacement-modal').style.display = 'flex';
    };

    AdminProductsView.closeReplacementModal = function() {
        document.getElementById('replacement-modal').style.display = 'none';
    };

    AdminProductsView.searchCurrentWebProduct = function() {
        clearTimeout(AdminProductsView.searchDebounceTimer);
        const term = document.getElementById('replace-search-current').value.trim();
        const resultsDiv = document.getElementById('replace-search-current-results');

        if (term.length < 2) {
            resultsDiv.style.display = 'none';
            return;
        }

        AdminProductsView.searchDebounceTimer = setTimeout(() => {
            google.script.run.withSuccessHandler(results => {
                resultsDiv.innerHTML = '';
                if (!results || results.length === 0) {
                    resultsDiv.innerHTML = '<div class="p-2 text-muted small">No web products found</div>';
                } else {
                    results.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'p-2 border-bottom';
                        div.style.cursor = 'pointer';
                        div.innerHTML = `<strong>${p.sku}</strong> - ${p.nameEn || p.nameHe || ''}`;
                        div.onclick = () => AdminProductsView.selectReplaceCurrentProduct(p.sku);
                        resultsDiv.appendChild(div);
                    });
                }
                resultsDiv.style.display = 'block';
            }).withFailureHandler(err => {
                resultsDiv.innerHTML = '<div class="p-2 text-danger small">Search failed</div>';
                resultsDiv.style.display = 'block';
            }).WebAppProducts_searchWebProducts(term);
        }, 300);
    };

    AdminProductsView.selectReplaceCurrentProduct = function(sku) {
        document.getElementById('replace-search-current-results').style.display = 'none';
        document.getElementById('replace-search-current').value = sku;

        google.script.run.withSuccessHandler(data => {
            if (!data || !data.comax) {
                document.getElementById('replace-current-product').style.display = 'none';
                return;
            }
            AdminProductsView.replaceCurrentProduct = data;
            document.getElementById('replace-current-sku').textContent = data.comax.sku;
            document.getElementById('replace-current-webids').textContent = data.web ? `${data.web.webIdEn} / ${data.web.webIdHe}` : '-';
            document.getElementById('replace-current-isweb').textContent = data.comax.isWeb ? '✓' : '☐';
            document.getElementById('replace-current-comax-name').textContent = data.comax.nameHe || '-';
            document.getElementById('replace-current-web-name-en').textContent = data.web ? data.web.nameEn || '-' : '-';
            document.getElementById('replace-current-web-name-he').textContent = data.web ? data.web.nameHe || '-' : '-';
            document.getElementById('replace-current-product').style.display = 'block';
            // Update confirmation label with actual SKU and Web IDs
            document.getElementById('replace-label-old-sku').textContent = data.comax.sku;
            document.getElementById('replace-label-webids').textContent = data.web ? `(${data.web.webIdEn} / ${data.web.webIdHe})` : '';
            AdminProductsView.validateReplaceForm();
        }).withFailureHandler(err => {
            document.getElementById('replace-modal-status').textContent = 'Error: ' + err.message;
            document.getElementById('replace-modal-status').className = 'mr-auto small text-danger';
        }).WebAppProducts_lookupProductBySku(sku);
    };

    AdminProductsView.searchReplacementProduct = function() {
        clearTimeout(AdminProductsView.searchDebounceTimer);
        const term = document.getElementById('replace-search-new').value.trim();
        const resultsDiv = document.getElementById('replace-search-new-results');

        if (term.length < 2) {
            resultsDiv.style.display = 'none';
            return;
        }

        AdminProductsView.searchDebounceTimer = setTimeout(() => {
            google.script.run.withSuccessHandler(results => {
                resultsDiv.innerHTML = '';
                if (!results || results.length === 0) {
                    resultsDiv.innerHTML = '<div class="p-2 text-muted small">No products found (not on web)</div>';
                } else {
                    results.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'p-2 border-bottom';
                        div.style.cursor = 'pointer';
                        div.innerHTML = `<strong>${p.sku}</strong> - ${p.name}`;
                        div.onclick = () => AdminProductsView.selectReplaceNewProduct(p.sku);
                        resultsDiv.appendChild(div);
                    });
                }
                resultsDiv.style.display = 'block';
            }).withFailureHandler(err => {
                resultsDiv.innerHTML = '<div class="p-2 text-danger small">Search failed</div>';
                resultsDiv.style.display = 'block';
            }).WebAppProducts_searchProductsForReplacement(term);
        }, 300);
    };

    AdminProductsView.selectReplaceNewProduct = function(sku) {
        document.getElementById('replace-search-new-results').style.display = 'none';
        document.getElementById('replace-search-new').value = sku;

        google.script.run.withSuccessHandler(data => {
            if (!data || !data.comax) {
                document.getElementById('replace-new-product').style.display = 'none';
                return;
            }
            AdminProductsView.replaceNewProduct = data;
            document.getElementById('replace-new-sku').textContent = data.comax.sku;
            document.getElementById('replace-new-isweb').textContent = (data.comax.isWeb ? '✓' : '☐') + ' (will be set ✓)';
            document.getElementById('replace-new-comax-name').textContent = data.comax.nameHe || '-';
            document.getElementById('replace-new-product').style.display = 'block';
            // Update confirmation label with actual SKU
            document.getElementById('replace-label-new-sku').textContent = data.comax.sku;
            AdminProductsView.validateReplaceForm();
        }).withFailureHandler(err => {
            document.getElementById('replace-modal-status').textContent = 'Error: ' + err.message;
            document.getElementById('replace-modal-status').className = 'mr-auto small text-danger';
        }).WebAppProducts_lookupProductBySku(sku);
    };

    AdminProductsView.validateReplaceForm = function() {
        const hasCurrent = AdminProductsView.replaceCurrentProduct !== null;
        const hasNew = AdminProductsView.replaceNewProduct !== null;
        const oldOffChecked = document.getElementById('replace-confirm-old-off').checked;
        const newOnChecked = document.getElementById('replace-confirm-new-on').checked;
        const wooChecked = document.getElementById('replace-confirm-woo').checked;

        const valid = hasCurrent && hasNew && oldOffChecked && newOnChecked && wooChecked;
        document.getElementById('replace-submit-btn').disabled = !valid;
    };

    // Add event listeners for validation
    document.getElementById('replace-confirm-old-off').addEventListener('change', AdminProductsView.validateReplaceForm);
    document.getElementById('replace-confirm-new-on').addEventListener('change', AdminProductsView.validateReplaceForm);
    document.getElementById('replace-confirm-woo').addEventListener('change', AdminProductsView.validateReplaceForm);

    AdminProductsView.submitReplacement = function() {
        if (!AdminProductsView.replaceCurrentProduct || !AdminProductsView.replaceNewProduct) return;

        const webIdEn = AdminProductsView.replaceCurrentProduct.web.webIdEn;
        const oldSku = AdminProductsView.replaceCurrentProduct.comax.sku;
        const newSku = AdminProductsView.replaceNewProduct.comax.sku;
        const statusDiv = document.getElementById('replace-modal-status');

        statusDiv.textContent = 'Updating JLMops...';
        statusDiv.className = 'mr-auto small text-info';
        document.getElementById('replace-submit-btn').disabled = true;

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                statusDiv.textContent = res.message;
                statusDiv.className = 'mr-auto small text-success';
                setTimeout(() => {
                    AdminProductsView.closeReplacementModal();
                    AdminProductsView.loadSkuUpdates();
                }, 4000);
            } else {
                statusDiv.textContent = 'Error: ' + res.message;
                statusDiv.className = 'mr-auto small text-danger';
                document.getElementById('replace-submit-btn').disabled = false;
            }
        }).withFailureHandler(err => {
            statusDiv.textContent = 'Error: ' + err.message;
            statusDiv.className = 'mr-auto small text-danger';
            document.getElementById('replace-submit-btn').disabled = false;
        }).WebAppProducts_webProductReassign(webIdEn, oldSku, newSku, true, true);
    };

    AdminProductsView.loadSkuUpdates = function() {
        const tbody = document.getElementById('sku-updates-body');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted small">Loading...</td></tr>';

        google.script.run.withSuccessHandler(updates => {
            tbody.innerHTML = '';
            if (!updates || updates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted small">No recent SKU updates.</td></tr>';
                return;
            }
            updates.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(u.date).toLocaleDateString()}</td>
                    <td>${u.type}</td>
                    <td>${u.oldSku}</td>
                    <td>${u.newSku}</td>
                    <td>${u.updatedBy}</td>
                `;
                tbody.appendChild(tr);
            });
        }).withFailureHandler(err => {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted small">Failed to load updates.</td></tr>';
        }).WebAppProducts_getRecentSkuUpdates();
    }

    // --- Card 1: Detail Updates ---
    
    AdminProductsView.loadReviewList = function() {
      const tbody = document.getElementById('review-list-body');
      tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
      
      google.script.run.withSuccessHandler(tasks => {
        tbody.innerHTML = '';
        document.getElementById('stat-review').textContent = tasks ? tasks.length : 0;
        
        if (!tasks || tasks.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">No updates to review.</td></tr>';
          return;
        }
        
        tasks.forEach(task => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${task.productName || ''}</td>
            <td>${task.sku}</td>
            <td>${task.title}</td>
            <td>${new Date(task.createdDate).toLocaleDateString()}</td>
            <td><button class="btn btn-sm" onclick="AdminProductsView.openEditor('${task.taskId}')">Review</button></td>
          `;
          tbody.appendChild(tr);
        });
      }).WebAppProducts_getAdminReviewTasks();
    };

    AdminProductsView.loadAcceptedList = function() {
        const tbody = document.getElementById('accepted-list-body');
        tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

        google.script.run.withSuccessHandler(tasks => {
            tbody.innerHTML = '';
            const count = tasks ? tasks.length : 0;
            document.getElementById('stat-accepted').textContent = count;

            // Enable/disable export button based on count (Confirm stays disabled until export succeeds)
            const hasItems = count > 0;
            document.getElementById('btn-export-details').disabled = !hasItems;
            document.getElementById('btn-confirm-details').disabled = true; // Always disabled until export

            if (!tasks || tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">No accepted updates.</td></tr>';
                return;
            }

            tasks.forEach(task => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${task.productName || ''}</td>
                    <td>${task.sku}</td>
                    <td>${task.title}</td>
                    <td>${new Date(task.createdDate).toLocaleDateString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }).WebAppProducts_getAcceptedTasks();
    };

    AdminProductsView.exportUpdates = function() {
        const count = document.getElementById('stat-accepted').textContent;
        if (!confirm(`Export ${count} accepted update(s) to spreadsheet?`)) return;

        const statusDiv = document.getElementById('export-status');
        statusDiv.textContent = 'Generating detail export...';
        statusDiv.className = 'text-right text-info mt-2';

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                statusDiv.innerHTML = `Export created. <a href="${res.fileUrl}" target="_blank">Open Sheet</a>`;
                statusDiv.className = 'text-right text-success mt-2';
                // Enable Confirm button after successful export
                document.getElementById('btn-confirm-details').disabled = false;
            } else {
                statusDiv.textContent = 'Export failed: ' + res.message;
                statusDiv.className = 'text-right text-danger mt-2';
            }
        }).WebAppProducts_exportAcceptedUpdates();
    };

    AdminProductsView.confirmUpdates = function() {
        if(!confirm('Confirm that you have updated the website with these details? This will close the tasks.')) return;
        const statusDiv = document.getElementById('export-status');
        statusDiv.textContent = 'Processing...';
        
        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                statusDiv.textContent = res.message;
                statusDiv.className = 'mt-2 small text-success';
                AdminProductsView.refreshView();
            } else {
                statusDiv.textContent = 'Error: ' + res.message;
                statusDiv.className = 'mt-2 small text-danger';
            }
        }).WebAppProducts_confirmWebUpdates();
    };

    AdminProductsView.loadPendingDetailsList = function() {
      const tbody = document.getElementById('pending-details-list-body');
      google.script.run.withSuccessHandler(tasks => {
        tbody.innerHTML = '';
        document.getElementById('stat-pending-details').textContent = tasks ? tasks.length : 0;
        if (!tasks || tasks.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted small">No pending tasks.</td></tr>';
          return;
        }
        tasks.forEach(task => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${task.sku}</td>
            <td>${task.productName || ''}</td>
            <td>${task.title}</td>
            <td>${new Date(task.createdDate).toLocaleDateString()}</td>
          `;
          tbody.appendChild(tr);
        });
      }).WebAppProducts_getPendingDetailTasks();
    };

    // --- Card 2: New Products ---

    AdminProductsView.loadSuggestionList = function() {
        const tbody = document.getElementById('suggestions-list-body');
        tbody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
        google.script.run.withSuccessHandler(tasks => {
            document.getElementById('stat-suggestions').textContent = tasks ? tasks.length : 0;
            tbody.innerHTML = '';
            if (!tasks || tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-3">No new suggestions.</td></tr>';
                return;
            }
            tasks.forEach(t => {
                const tr = document.createElement('tr');
                const price = t.price ? '₪' + t.price : '-';
                const stock = t.stock !== '' ? t.stock : '-';
                tr.innerHTML = `
                    <td>${t.sku}</td>
                    <td>${t.title}</td>
                    <td class="small">${t.division || '-'}</td>
                    <td class="small">${t.group || '-'}</td>
                    <td class="text-right">${price}</td>
                    <td class="text-right">${stock}</td>
                    <td>
                        <button class="btn btn-sm mr-1" onclick="AdminProductsView.openSuggestionModal('${t.taskId}', '${t.sku}', '${t.title}')">Accept</button>
                        <button class="btn btn-sm" onclick="AdminProductsView.cancelSuggestion('${t.taskId}')">Cancel</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }).WebAppProducts_getSuggestionTasks();
    };

    AdminProductsView.cancelSuggestion = function(taskId) {
        if (!confirm('Cancel this suggestion? The task will be marked as Cancelled.')) return;
        google.script.run.withSuccessHandler(result => {
            if (result.error) {
                alert('Error: ' + result.error);
            } else {
                AdminProductsView.loadSuggestionList();
            }
        }).WebAppTasks_updateTaskStatus(taskId, 'Cancelled');
    };

    AdminProductsView.loadSubmissionsList = function() {
        const tbody = document.getElementById('submissions-list-body');
        tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
        google.script.run.withSuccessHandler(tasks => {
            document.getElementById('stat-submissions').textContent = tasks ? tasks.length : 0;
            tbody.innerHTML = '';
            if (!tasks || tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">No submissions to review.</td></tr>';
                return;
            }
            tasks.forEach(t => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${t.productName || ''}</td>
                    <td>${t.sku}</td>
                    <td>${t.title}</td>
                    <td>${new Date(t.createdDate).toLocaleDateString()}</td>
                    <td><button class="btn btn-sm" onclick="AdminProductsView.openEditor('${t.taskId}')">Review</button></td>
                `;
                tbody.appendChild(tr);
            });
        }).WebAppProducts_getSubmissionsTasks();
    };

    AdminProductsView.loadLinkageList = function() {
        const tbody = document.getElementById('linkage-list-body');
        tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
        google.script.run.withSuccessHandler(tasks => {
            tbody.innerHTML = '';
            if (!tasks || tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">No finalized products waiting for link.</td></tr>';
                return;
            }
            tasks.forEach(t => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${t.title}</td>
                    <td>${t.sku}</td>
                    <td><span class="badge badge-success">${t.status}</span></td>
                    <td><button class="btn btn-sm btn-primary" onclick="AdminProductsView.openLinkageModal('${t.taskId}', '${t.sku}')">Link</button></td>
                `;
                tbody.appendChild(tr);
            });
        }).WebAppProducts_getLinkageTasks();
    };

    AdminProductsView.updateNewExportUI = function() {
        google.script.run.withSuccessHandler(tasks => {
            const count = tasks ? tasks.length : 0;
            const el = document.getElementById('stat-linkage');
            if(el) el.textContent = count; // Header count
            
            const exportEl = document.getElementById('stat-onboarding-export');
            if(exportEl) exportEl.textContent = count; // Footer count
            
            const btnExport = document.getElementById('btn-export-new');
            if(btnExport) btnExport.disabled = (count === 0);
        }).WebAppProducts_getLinkageTasks();
    };

    AdminProductsView.exportNewProducts = function() {
        const statusDiv = document.getElementById('new-export-status');
        statusDiv.textContent = 'Generating new product export...';
        statusDiv.className = 'mt-2 small text-info';
        
        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                statusDiv.innerHTML = `Export created. <a href="${res.fileUrl}" target="_blank">Open Sheet</a>`;
                statusDiv.className = 'mt-2 small text-success';
            } else {
                statusDiv.textContent = 'Export failed: ' + res.message;
                statusDiv.className = 'mt-2 small text-danger';
            }
        }).WebAppProducts_exportNewProducts();
    };
    
    AdminProductsView.loadPendingNewList = function() {
      const tbody = document.getElementById('pending-new-list-body');
      google.script.run.withSuccessHandler(tasks => {
        tbody.innerHTML = '';
        document.getElementById('stat-pending-new').textContent = tasks ? tasks.length : 0;
        if (!tasks || tasks.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted small">No pending tasks.</td></tr>';
          return;
        }
        tasks.forEach(task => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${task.sku}</td>
            <td>${task.productName || ''}</td>
            <td>${task.title}</td>
            <td>${new Date(task.createdDate).toLocaleDateString()}</td>
          `;
          tbody.appendChild(tr);
        });
      }).WebAppProducts_getPendingNewTasks();
    };

    // --- Modal Logic ---

    // Suggestion Logic
    AdminProductsView.openSuggestionModal = function(taskId, sku, title) {
        AdminProductsView.currentTaskId = taskId;
        AdminProductsView.currentSku = sku;
        document.getElementById('sugg-sku').value = sku;
        // Extract name from title "New Product Suggestion: [Name]" - this is the Hebrew name
        let name = title.replace('New Product Suggestion:', '').trim();
        document.getElementById('sugg-name-en').value = ''; // User must provide
        document.getElementById('sugg-name-he').value = name; // Suggest the Hebrew name from title
        document.getElementById('suggestion-modal').style.display = 'flex';
    };

    AdminProductsView.submitSuggestionApproval = function() {
        const nameEn = document.getElementById('sugg-name-en').value.trim();
        const nameHe = document.getElementById('sugg-name-he').value.trim();
        if (!nameEn || !nameHe) {
            alert('Please provide both Product Name EN and Product Name HE.');
            return;
        }
        if (!confirm(`Approve suggestion for ${nameEn}?`)) return;

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                document.getElementById('suggestion-modal').style.display = 'none';
                AdminProductsView.refreshView();
            } else {
                alert('Error: ' + res.message);
            }
        }).withFailureHandler(err => alert('Error: ' + err.message))
        .WebAppProducts_acceptSuggestion(AdminProductsView.currentTaskId, AdminProductsView.currentSku, nameEn, nameHe);
    };

    // Linkage Logic
    AdminProductsView.openLinkageModal = function(taskId, sku) {
        AdminProductsView.currentTaskId = taskId;
        AdminProductsView.currentSku = sku;
        document.getElementById('link-sku').value = sku;
        document.getElementById('link-woo-en').value = '';
        document.getElementById('link-woo-he').value = '';
        document.getElementById('linkage-modal').style.display = 'flex';
    };

    AdminProductsView.submitLinkage = function() {
        const wooEn = document.getElementById('link-woo-en').value.trim();
        const wooHe = document.getElementById('link-woo-he').value.trim();
        if (!wooEn || !wooHe) {
            alert('Please provide both WooCommerce IDs.');
            return;
        }
        if (isNaN(wooEn) || isNaN(wooHe)) {
             alert('IDs must be numeric.');
             return;
        }

        if (!confirm(`Finalize and Hot Insert ${AdminProductsView.currentSku}? This cannot be undone.`)) return;

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                alert('Success! Product is now live in JLMops.');
                document.getElementById('linkage-modal').style.display = 'none';
                AdminProductsView.refreshView();
            } else {
                alert('Error: ' + res.message);
            }
        }).withFailureHandler(err => alert('Error: ' + err.message))
        .WebAppProducts_finalizeProduct(AdminProductsView.currentTaskId, AdminProductsView.currentSku, wooEn, wooHe);
    };

    // --- Editor Logic (Simplified/Shared) ---
    AdminProductsView.openEditor = function(taskId) {
      AdminProductsView.currentTaskId = taskId;
      document.getElementById('editor-modal').style.display = 'flex';
      document.getElementById('modal-status').textContent = 'Loading data...';
      AdminProductsView.switchTab('preview');

      // Clear inputs
      document.getElementById('header-name-en-display').textContent = '';
      document.getElementById('header-sku-display').textContent = '';
      document.getElementById('header-name-he-display').textContent = '';
      document.getElementById('edit-ShortDescrHe').value = '';
      document.getElementById('edit-DescriptionHe').value = '';
      document.getElementById('edit-ShortDescrEn').value = '';
      document.getElementById('edit-DescriptionEn').value = '';
      document.getElementById('preview-en').innerHTML = '';
      document.getElementById('preview-he').innerHTML = '';

      google.script.run.withSuccessHandler(data => {
               AdminProductsView.currentSku = data.sku;
               AdminProductsView.currentMasterData = data.masterData || {}; 
               AdminProductsView.currentStagingData = data.stagingData || {}; 
               AdminProductsView.currentComaxData = data.comaxData || {};
               
               document.getElementById('header-sku-display').textContent = data.sku;
               document.getElementById('header-name-en-display').textContent = data.masterData.wdm_NameEn || '';
               document.getElementById('header-name-he-display').textContent = data.masterData.wdm_NameHe || '';

               AdminProductsView.populateEditor(data.masterData, data.stagingData, data.comaxData);
               AdminProductsView.updatePreview();
               document.getElementById('modal-status').textContent = '';
      }).WebAppProducts_loadProductEditorData(taskId);
    };

    AdminProductsView.populateEditor = function(m, s, c) {
        m = m || {}; s = s || {}; c = c || {};
        
        const setInp = (id, val) => document.getElementById(id).value = val || '';
        const val = (keySuffix) => {
            if (s && s['wds_' + keySuffix] !== undefined) return s['wds_' + keySuffix];
            if (m && m['wdm_' + keySuffix] !== undefined) return m['wdm_' + keySuffix];
            return '';
        };

        setInp('edit-ShortDescrHe', val('ShortDescrHe'));
        setInp('edit-DescriptionHe', val('DescriptionHe'));
        setInp('edit-ShortDescrEn', val('ShortDescrEn'));
        setInp('edit-DescriptionEn', val('DescriptionEn'));
    };

    AdminProductsView.getFormData = function() {
      const s = AdminProductsView.currentStagingData || {};
      const m = AdminProductsView.currentMasterData || {};
      const val = (keySuffix) => {
          if (s && s['wds_' + keySuffix] !== undefined) return s['wds_' + keySuffix];
          if (m && m['wdm_' + keySuffix] !== undefined) return m['wdm_' + keySuffix];
          return '';
      };

      const fd = {
        wdm_WebIdEn: m.wdm_WebIdEn,
        wdm_NameEn: m.wdm_NameEn,
        wdm_NameHe: m.wdm_NameHe,
        wdm_Region: val('Region'),
        wdm_ABV: val('ABV'),
        wdm_Intensity: val('Intensity'),
        wdm_Complexity: val('Complexity'),
        wdm_Acidity: val('Acidity'),
        wdm_Decant: val('Decant'),
        wdm_PairHarSweet: val('PairHarSweet'),
        wdm_PairHarIntense: val('PairHarIntense'),
        wdm_PairHarRich: val('PairHarRich'),
        wdm_PairHarMild: val('PairHarMild'),
        wdm_PairConSweet: val('PairConSweet'),
        wdm_PairConIntense: val('PairConIntense'),
        wdm_PairConRich: val('PairConRich'),
        wdm_PairConMild: val('PairConMild'),
        wdm_HeterMechira: val('HeterMechira'),
      };
      for(let i=1; i<=5; i++) fd[`wdm_GrapeG${i}`] = val(`GrapeG${i}`);
      for(let i=1; i<=5; i++) fd[`wdm_KashrutK${i}`] = val(`KashrutK${i}`);

      fd.wdm_ShortDescrHe = document.getElementById('edit-ShortDescrHe').value;
      fd.wdm_DescriptionHe = document.getElementById('edit-DescriptionHe').value;
      fd.wdm_ShortDescrEn = document.getElementById('edit-ShortDescrEn').value;
      fd.wdm_DescriptionEn = document.getElementById('edit-DescriptionEn').value;
      
      return fd;
    };

    AdminProductsView.updateStagingAndRefresh = function() {
        const formData = AdminProductsView.getFormData();
        document.getElementById('modal-status').textContent = 'Updating Staging...';
        
        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                document.getElementById('modal-status').textContent = 'Staging Updated. Refreshing Preview...';
                google.script.run.withSuccessHandler(data => {
                    AdminProductsView.currentStagingData = data.stagingData;
                    AdminProductsView.updatePreview();
                    document.getElementById('modal-status').textContent = 'Preview Refreshed.';
                }).WebAppProducts_loadProductEditorData(AdminProductsView.currentTaskId);
            } else {
                alert('Error: ' + res.message);
                document.getElementById('modal-status').textContent = '';
            }
        }).WebAppProducts_handleManagerSubmit(AdminProductsView.currentTaskId, AdminProductsView.currentSku, formData);
    };

    let previewDebounce;
    AdminProductsView.updatePreview = function() {
         const formData = AdminProductsView.getFormData();
         document.getElementById('preview-en').innerHTML = '<em>Generating preview...</em>';
         document.getElementById('preview-he').innerHTML = '<em>Generating preview...</em>';
         google.script.run.withSuccessHandler(res => {
             document.getElementById('preview-en').innerHTML = res.htmlEn;
             document.getElementById('preview-he').innerHTML = res.htmlHe;
         }).WebAppProducts_getPreview(AdminProductsView.currentSku, formData, AdminProductsView.currentComaxData);
    };
    
    document.querySelectorAll('textarea').forEach(el => {
        el.addEventListener('input', () => {
             clearTimeout(previewDebounce);
             previewDebounce = setTimeout(AdminProductsView.updatePreview, 800);
        });
    });

    AdminProductsView.closeModal = function() { document.getElementById('editor-modal').style.display = 'none'; };
    AdminProductsView.switchTab = function(tabName) {
        document.querySelectorAll('.tab-content').forEach(e=>e.style.display='none');
        document.getElementById('tab-'+tabName).style.display='block';
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(button => {
            if (button.onclick && button.onclick.toString().includes(`'${tabName}'`)) {
                button.classList.add('active');
            }
        });
    };

    AdminProductsView.acceptChanges = function() {
      if (!confirm(`Accept changes for ${AdminProductsView.currentSku}?`)) return;

      const formData = AdminProductsView.getFormData();
      document.getElementById('modal-status').textContent = 'Accepting...';
      google.script.run.withSuccessHandler(res => {
        if (res.success) {
          AdminProductsView.closeModal();
          AdminProductsView.refreshView();
        } else {
          alert('Error: ' + res.message);
        }
      }).WebAppProducts_handleAdminAccept(AdminProductsView.currentTaskId, AdminProductsView.currentSku, formData);
    };

    AdminProductsView.refreshView();
    })();
  </script>
</body>
</html>