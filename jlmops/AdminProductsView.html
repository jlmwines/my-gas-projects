<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    /* Styles reused from ManagerProductsView for consistency */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: flex-start; padding-top: 80px; overflow-y: auto; }
    .modal-container { background: white; width: 90%; max-width: 900px; max-height: 85vh; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-bottom: 50px; }
    .modal-header { padding: 10px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; background-color: #f8f9fa; border-radius: 8px 8px 0 0; }
    .modal-product-info { display: flex; justify-content: space-between; align-items: center; width: 100%; padding-right: 20px; }
    .header-item { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .header-left { text-align: left; font-weight: 600; color: #333; }
    .header-center { text-align: center; font-weight: 700; color: #007bff; font-size: 1.1em; }
    .header-right { text-align: right; direction: rtl; font-weight: 600; color: #333; }
    .form-body { flex: 1; overflow-y: auto; padding: 20px; }
    .tab-bar { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; justify-content: space-between; align-items: center; }
    .tab-group { display: flex; }
    .tab-btn { padding: 8px 15px; cursor: pointer; border-bottom: 2px solid transparent; color: #666; font-weight: 500; font-size: 14px; }
    .tab-btn:hover { color: #007bff; }
    .tab-btn.active { border-bottom-color: #007bff; color: #007bff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
    .col-header { font-weight: 600; color: #555; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
    .hebrew-text { direction: rtl; text-align: right; }
    select#edit-Region option { text-align: right !important; }
    .preview-box { background: #fafafa; border: 1px solid #eee; padding: 15px; border-radius: 4px; min-height: 200px; white-space: pre-wrap; font-size: 13px; }
    .desc-short, .desc-long { width: 100%; font-size: 14px; line-height: 1.4; padding: 8px; }
    div.desc-short, div.desc-long { background-color: #f8f9fa; border: 1px solid #ced4da; border-radius: 4px; overflow-y: auto; }
    textarea.desc-short, textarea.desc-long { resize: vertical; }
    .desc-short { min-height: 40px; }
    /* 3 lines approx */
    .desc-long { min-height: 120px; }
  </style>
</head>
<body>
  <div class="container-fluid p-4">
    
    <!-- Review Section -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Review Pending Updates</h5>
        <span id="stat-review" class="badge badge-secondary badge-pill">0</span>
      </div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th class="border-top-0">Task</th>
              <th class="border-top-0">SKU</th>
              <th class="border-top-0">Date</th>
              <th class="border-top-0">Action</th>
            </tr>
          </thead>
          <tbody id="review-list-body">
            <!-- Tasks will be populated here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Export Section -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Web Updates Export</h5>
            <span id="stat-export" class="badge badge-light badge-pill">0</span>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">

                <div>
                    <button id="btn-export" class="btn mr-2" onclick="AdminProductsView.exportUpdates()">Export Sheet</button>
                    <button id="btn-confirm" class="btn" onclick="AdminProductsView.confirmUpdates()">Mark as Completed</button>
                </div>
            </div>
            <div id="export-status" class="mt-2 small"></div>

            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                    <th class="border-top-0">Task</th>
                    <th class="border-top-0">SKU</th>
                    <th class="border-top-0">Date</th>
                    </tr>
                </thead>
                <tbody id="export-list-body">
                    <!-- Export tasks will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

  <!-- Product Editor Modal (Reused Structure) -->
  <div class="modal-overlay" id="editor-modal">
    <div class="modal-container">
      <div class="modal-header">
        <div class="modal-product-info">
            <div id="header-name-en-display" class="header-item header-left"></div>
            <div id="header-sku-display" class="header-item header-center"></div>
            <div id="header-name-he-display" class="header-item header-right"></div>
        </div>
        <button type="button" class="close" aria-label="Close" onclick="AdminProductsView.closeModal()"><span aria-hidden="true">&times;</span></button>
      </div>
      
      <div class="form-body">
        <div class="tab-bar">
          <div class="tab-group">
            <div class="tab-btn active" onclick="AdminProductsView.switchTab('preview')">Preview</div>
            <div class="tab-btn" onclick="AdminProductsView.switchTab('desc')">Descriptions</div>
          </div>
        </div>

        <div id="tab-preview" class="tab-content active">
           <div class="comparison-grid">
             <div><div class="col-header">English Preview</div><div class="preview-box" id="preview-en"></div></div>
             <div><div class="col-header">Hebrew Preview</div><div class="preview-box hebrew-text" id="preview-he"></div></div>
           </div>
        </div>

        <div id="tab-desc" class="tab-content">
          <div class="comparison-grid">
            <!-- English Column -->
            <div>
              <div class="col-header">English</div>
              <div class="form-group"><label class="small text-muted mb-1">Short Description</label><textarea class="form-control desc-short" id="edit-ShortDescrEn"></textarea></div>
              <div class="form-group"><label class="small text-muted mb-1">Long Description</label><textarea class="form-control desc-long" id="edit-DescriptionEn"></textarea></div>
            </div>
            
            <!-- Hebrew Column -->
            <div>
              <div class="col-header">Hebrew</div>
              <div class="form-group"><label class="small text-muted mb-1">Short Description</label><textarea class="form-control hebrew-text desc-short" id="edit-ShortDescrHe"></textarea></div>
              <div class="form-group"><label class="small text-muted mb-1">Long Description</label><textarea class="form-control hebrew-text desc-long" id="edit-DescriptionHe"></textarea></div>
            </div>
          </div>
          <div class="mt-3 text-right">
              <button class="btn btn-sm" onclick="AdminProductsView.updateStagingAndRefresh()">Update Staging & Refresh Preview</button>
          </div>
        </div>

            </div> <!-- Closes form-body -->
      
            <datalist id="abv-options"></datalist>
            <div class="modal-footer bg-light">
              <div id="modal-status" class="mr-auto text-muted small"></div>
              <button class="btn border" onclick="AdminProductsView.closeModal()">Cancel</button>
              <button class="btn" onclick="AdminProductsView.acceptChanges()">Accept & Update</button>
            </div>
          </div> <!-- Closes modal-container -->
        </div>
  <script>
    (function() {
    window.AdminProductsView = {};
    AdminProductsView.currentTaskId = null;
    AdminProductsView.currentSku = null;
    AdminProductsView.currentMasterData = {};
    AdminProductsView.lookupRegions = [];
    AdminProductsView.lookupGrapes = [];
    AdminProductsView.lookupKashrut = [];

    AdminProductsView.refreshView = function() {
      AdminProductsView.loadReviewList();
      AdminProductsView.loadExportStats();
    };

    AdminProductsView.loadExportStats = function() {
        const tbody = document.getElementById('export-list-body');
        tbody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>'; // 3 columns for task, sku, date

        google.script.run.withSuccessHandler(tasks => {
            const count = tasks ? tasks.length : 0;
            const el = document.getElementById('stat-export');
            if(el) el.textContent = count;
            
            const hasItems = count > 0;
            document.getElementById('btn-export').disabled = !hasItems;
            document.getElementById('btn-confirm').disabled = !hasItems;

            tbody.innerHTML = ''; // Clear loading message
            if (!tasks || tasks.length === 0) {
              tbody.innerHTML = '<tr><td colspan="3">No tasks for export.</td></tr>';
              return;
            }

            tasks.forEach(task => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${task.title}</td>
                  <td>${task.sku}</td>
                  <td>${new Date(task.createdDate).toLocaleDateString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }).WebAppProducts_getAcceptedTasks();
    };

    AdminProductsView.loadReviewList = function() {
      const tbody = document.getElementById('review-list-body');
      tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
      
      google.script.run.withSuccessHandler(tasks => {
        tbody.innerHTML = '';
        if (!tasks || tasks.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4">No tasks for review.</td></tr>';
          document.getElementById('stat-review').textContent = '0';
          return;
        }
        document.getElementById('stat-review').textContent = tasks.length;
        
        tasks.forEach(task => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${task.title}</td>
            <td>${task.sku}</td>
            <td>${new Date(task.createdDate).toLocaleDateString()}</td>
            <td><button class="btn btn-sm" onclick="AdminProductsView.openEditor('${task.taskId}')">Review</button></td>
          `;
          tbody.appendChild(tr);
        });
      }).WebAppProducts_getAdminReviewTasks();
    };

    AdminProductsView.exportUpdates = function() {
        const statusDiv = document.getElementById('export-status');
        statusDiv.textContent = 'Generating export...';
        statusDiv.className = 'mt-2 small text-info';
        
        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                statusDiv.innerHTML = `Success! Export created. <a href="${res.fileUrl}" target="_blank">Open Sheet</a>`;
                statusDiv.className = 'mt-2 small text-success';
            } else {
                statusDiv.textContent = 'Export failed: ' + res.message;
                statusDiv.className = 'mt-2 small text-danger';
            }
        }).WebAppProducts_exportAcceptedUpdates();
    };

    AdminProductsView.confirmUpdates = function() {
        if(!confirm('This will mark all accepted tasks as "Completed". Ensure you have already exported and uploaded the data. Continue?')) return;

        const statusDiv = document.getElementById('export-status');
        statusDiv.textContent = 'Processing...';
        
        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                statusDiv.textContent = res.message;
                statusDiv.className = 'mt-2 small text-success';
                AdminProductsView.refreshView();
            } else {
                statusDiv.textContent = 'Error: ' + res.message;
                statusDiv.className = 'mt-2 small text-danger';
            }
        }).WebAppProducts_confirmWebUpdates();
    };

    // --- Editor Logic (Simplified/Shared) ---
    AdminProductsView.openEditor = function(taskId) {
      AdminProductsView.currentTaskId = taskId;
      document.getElementById('editor-modal').style.display = 'flex';
      document.getElementById('modal-status').textContent = 'Loading data...';
      AdminProductsView.switchTab('preview');

      // Clear inputs and display areas before loading new data
      // Clear header elements
      document.getElementById('header-name-en-display').textContent = '';
      document.getElementById('header-sku-display').textContent = '';
      document.getElementById('header-name-he-display').textContent = '';

      // Clear description textareas
      document.getElementById('edit-ShortDescrHe').value = '';
      document.getElementById('edit-DescriptionHe').value = '';
      document.getElementById('edit-ShortDescrEn').value = '';
      document.getElementById('edit-DescriptionEn').value = '';

      // Clear preview boxes
      document.getElementById('preview-en').innerHTML = '';
      document.getElementById('preview-he').innerHTML = '';

      
      google.script.run.withSuccessHandler(data => {
               AdminProductsView.currentSku = data.sku;
               AdminProductsView.currentMasterData = data.masterData || {}; 
               AdminProductsView.currentStagingData = data.stagingData || {}; 
               AdminProductsView.currentComaxData = data.comaxData || {}; // Store Comax Data
               
               document.getElementById('header-sku-display').textContent = data.sku;
               document.getElementById('header-name-en-display').textContent = data.masterData.wdm_NameEn || '';
               document.getElementById('header-name-he-display').textContent = data.masterData.wdm_NameHe || '';

               AdminProductsView.populateEditor(data.masterData, data.stagingData, data.comaxData);
               AdminProductsView.updatePreview(); // Trigger initial preview
               document.getElementById('modal-status').textContent = '';
      }).WebAppProducts_loadProductEditorData(taskId);
    };

    AdminProductsView.populateEditor = function(m, s, c) {
        m = m || {}; s = s || {}; c = c || {};
        
        const setVal = (id, val) => document.getElementById(id).textContent = val || '-';
        const setInp = (id, val) => document.getElementById(id).value = val || '';

        // Helper to get value from Staging (wds_) or fallback to Master (wdm_)
        const val = (keySuffix) => {
            if (s && s['wds_' + keySuffix] !== undefined) return s['wds_' + keySuffix];
            if (m && m['wdm_' + keySuffix] !== undefined) return m['wdm_' + keySuffix];
            return '';
        };

        // Populate editable textareas with staging data, or master data as fallback
        setInp('edit-ShortDescrHe', val('ShortDescrHe'));
        setInp('edit-DescriptionHe', val('DescriptionHe'));
        setInp('edit-ShortDescrEn', val('ShortDescrEn'));
        setInp('edit-DescriptionEn', val('DescriptionEn'));
    };

    AdminProductsView.getFormData = function() {
      // 1. Start with values from Staging (or Master fallback) for ALL fields
      // This preserves data for fields not in the Admin UI (Region, Grapes, etc.)
      const s = AdminProductsView.currentStagingData || {};
      const m = AdminProductsView.currentMasterData || {};
      
      const val = (keySuffix) => {
          if (s && s['wds_' + keySuffix] !== undefined) return s['wds_' + keySuffix];
          if (m && m['wdm_' + keySuffix] !== undefined) return m['wdm_' + keySuffix];
          return '';
      };

      // Construct full object with all required keys for ProductService
      const fd = {
        wdm_WebIdEn: m.wdm_WebIdEn, // Explicitly preserve WebIdEn
        wdm_NameEn: m.wdm_NameEn,
        wdm_NameHe: m.wdm_NameHe,
        wdm_Region: val('Region'),
        wdm_ABV: val('ABV'),
        wdm_Intensity: val('Intensity'),
        wdm_Complexity: val('Complexity'),
        wdm_Acidity: val('Acidity'),
        wdm_Decant: val('Decant'),
        
        wdm_PairHarSweet: val('PairHarSweet'),
        wdm_PairHarIntense: val('PairHarIntense'),
        wdm_PairHarRich: val('PairHarRich'),
        wdm_PairHarMild: val('PairHarMild'),
        wdm_PairConSweet: val('PairConSweet'),
        wdm_PairConIntense: val('PairConIntense'),
        wdm_PairConRich: val('PairConRich'),
        wdm_PairConMild: val('PairConMild'),
        
        wdm_HeterMechira: val('HeterMechira'),
      };
      for(let i=1; i<=5; i++) fd[`wdm_GrapeG${i}`] = val(`GrapeG${i}`);
      for(let i=1; i<=5; i++) fd[`wdm_KashrutK${i}`] = val(`KashrutK${i}`);

      // 2. Overwrite with Editable Description Fields from DOM
      fd.wdm_ShortDescrHe = document.getElementById('edit-ShortDescrHe').value;
      fd.wdm_DescriptionHe = document.getElementById('edit-DescriptionHe').value;
      fd.wdm_ShortDescrEn = document.getElementById('edit-ShortDescrEn').value;
      fd.wdm_DescriptionEn = document.getElementById('edit-DescriptionEn').value;
      
      return fd;
    };

    AdminProductsView.updateStagingAndRefresh = function() {
        const formData = AdminProductsView.getFormData();
        document.getElementById('modal-status').textContent = 'Updating Staging...';
        
        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                document.getElementById('modal-status').textContent = 'Staging Updated. Refreshing Preview...';
                // Reload editor data to ensure local state matches backend state
                // But for speed, just update preview with local formData is fine, 
                // though re-fetching ensures we have the exact saved state.
                // Let's re-fetch to be safe and update currentStagingData
                google.script.run.withSuccessHandler(data => {
                    AdminProductsView.currentStagingData = data.stagingData;
                    AdminProductsView.updatePreview();
                    document.getElementById('modal-status').textContent = 'Preview Refreshed.';
                }).WebAppProducts_loadProductEditorData(AdminProductsView.currentTaskId);
            } else {
                alert('Error: ' + res.message);
                document.getElementById('modal-status').textContent = '';
            }
        }).WebAppProducts_handleManagerSubmit(AdminProductsView.currentTaskId, AdminProductsView.currentSku, formData);
    };

    let previewDebounce;
    AdminProductsView.updatePreview = function() {
         // Use current form data directly for immediate feedback
         const formData = AdminProductsView.getFormData();
         
         document.getElementById('preview-en').innerHTML = '<em>Generating preview...</em>';
         document.getElementById('preview-he').innerHTML = '<em>Generating preview...</em>';
         
         google.script.run.withSuccessHandler(res => {
             document.getElementById('preview-en').innerHTML = res.htmlEn;
             document.getElementById('preview-he').innerHTML = res.htmlHe;
         }).WebAppProducts_getPreview(AdminProductsView.currentSku, formData, AdminProductsView.currentComaxData);
    };
    
    document.querySelectorAll('textarea').forEach(el => {
        el.addEventListener('input', () => {
             clearTimeout(previewDebounce);
             previewDebounce = setTimeout(AdminProductsView.updatePreview, 800); // Longer debounce for typing
        });
    });

    AdminProductsView.closeModal = function() { document.getElementById('editor-modal').style.display = 'none'; };
    AdminProductsView.switchTab = function(tabName) {
        document.querySelectorAll('.tab-content').forEach(e=>e.style.display='none');
        document.getElementById('tab-'+tabName).style.display='block';
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        
        // Find the button that corresponds to the tabName and add the active class
        document.querySelectorAll('.tab-btn').forEach(button => {
            if (button.onclick && button.onclick.toString().includes(`'${tabName}'`)) {
                button.classList.add('active');
            }
        });
    };

    AdminProductsView.acceptChanges = function() {
      const formData = AdminProductsView.getFormData();
      document.getElementById('modal-status').textContent = 'Accepting...';
      google.script.run.withSuccessHandler(res => {
        if (res.success) {
          AdminProductsView.closeModal();
          AdminProductsView.refreshView();
        } else {
          alert('Error: ' + res.message);
        }
      }).WebAppProducts_handleAdminAccept(AdminProductsView.currentTaskId, AdminProductsView.currentSku, formData);
    };

    AdminProductsView.refreshView();
    })();
  </script>
</body>
</html>