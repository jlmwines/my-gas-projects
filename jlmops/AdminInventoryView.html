<div class="container-fluid">
  <!-- Section 1: Inventory Review Table -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center" style="background: transparent;">
          <h5>Inventory Counts to Review</h5>
          <button id="btn-process-counts" class="btn btn-light" disabled>Processing counts disabled</button>
        </div>
        <div class="card-body">

          <!-- Container for the review table -->
          <div id="inventory-review-table-container">
            <!-- Table will be dynamically generated here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Section 2: Comax Inventory Synchronization (Moved Up) -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5>Comax Inventory Synchronization</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive mb-3" style="max-height: 300px; overflow-y: auto;">
                <table class="table table-sm table-hover" id="comax-export-table">
                    <thead>
                        <tr>
                            <th class="text-center">Comax</th>
                            <th class="text-center">Total</th>
                            <th class="text-center">Brurya</th>
                            <th class="text-center">Storage</th>
                            <th class="text-center">Office</th>
                            <th class="text-center">Shop</th>
                            <th class="text-center">SKU</th>
                            <th class="text-right">Product Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
            <div id="comax-inventory-message-area" style="margin-bottom: 0.5rem;"></div>
            <button id="btn-comax-export" class="btn btn-light" disabled>Comax Export</button>
            <button id="btn-comax-updated" class="btn btn-light ml-2" disabled>Comax Updated</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Section 3: Task Creation Controls -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5>Create New Count Tasks</h5>
        </div>
        <div class="card-body">
          <h6>Bulk Task Creation</h6>
          <div class="form-row align-items-end">
            <div class="col-auto">
              <label for="max-stock-bulk">Max Stock Quantity</label>
              <input type="number" id="max-stock-bulk" class="form-control" placeholder="e.g., 12" value="12">
            </div>
            <div class="col-auto">
              <label for="max-days-bulk">Not Counted in Days</label>
              <input type="number" id="max-days-bulk" class="form-control" placeholder="e.g., 90" value="90">
            </div>
             <div class="col-auto" style="padding-bottom: 10px;">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="chk-web-only" checked>
                    <label class="form-check-label" for="chk-web-only">Web Products Only</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="chk-wine-only" checked>
                    <label class="form-check-label" for="chk-wine-only">Wine Only (Div 1)</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="chk-zero-stock">
                    <label class="form-check-label" for="chk-zero-stock">Include 0 Stock</label>
                </div>
            </div>
            <div class="col-auto">
              <button id="btn-generate-bulk-tasks" class="btn">Generate Tasks</button>
            </div>
          </div>
          <hr>
          <h6>Spot-Check Task Creation</h6>
          <div class="form-row align-items-end" style="position: relative;">
            <div class="col">
                <label for="spot-check-search">Product</label>
                <input type="text" id="spot-check-search" class="form-control" placeholder="Search by Name or SKU">
                <!-- Autocomplete container will be appended here by JS -->
            </div>
            <div class="col">
               <label for="spot-check-note">Note (Optional)</label>
               <input type="text" id="spot-check-note" class="form-control" placeholder="Reason for check...">
            </div>
            <div class="col-auto">
              <button id="btn-create-spot-task" class="btn">Create Spot Check</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Section 4: Open Tasks List (Manager Queue) -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5>Open Inventory Tasks (Manager Queue)</h5>
          <span id="open-tasks-count" class="badge badge-secondary">0</span>
        </div>
        <div class="card-body">

          <!-- Container for the open tasks table -->
          <div id="open-tasks-table-container">
            <!-- Table will be dynamically generated here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Task Preview Modal -->
<div class="modal fade" id="bulkPreviewModal" tabindex="-1" aria-labelledby="bulkPreviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkPreviewModalLabel">Confirm Bulk Task Generation</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="bulkPreviewSummary"></p>
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Product Name</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody id="bulkPreviewTableBody">
                    <!-- Rows will be inserted here -->
                </tbody>
            </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="btn-confirm-bulk-generation">Confirm & Generate</button>
      </div>
    </div>
  </div>
</div>

<style>
    /* Toast Notification Styles */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background-color: #28a745; /* Green for success */
        color: white;
        border-radius: 5px;
        z-index: 1050;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        opacity: 0;
        transition: opacity 0.5s, top 0.5s;
    }
    .toast-notification.error {
        background-color: #dc3545; /* Red for error */
    }
    .toast-notification.warning {
        background-color: #ffc107; /* Yellow for warning */
        color: #212529;
    }
    .toast-notification.show {
        opacity: 1;
        top: 30px;
    }
    
    #autocomplete-results {
        position: absolute;
        top: 100%;
        left: 5px; /* Align with input padding */
        right: 5px;
        border: 1px solid #ccc;
        background-color: white;
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        border-radius: 0 0 4px 4px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    #autocomplete-results div {
        padding: 8px 12px;
        cursor: pointer;
    }
    #autocomplete-results div:hover {
        background-color: #f0f0f0;
    }
</style>

<script>
(function() {
  const reviewContainer = document.getElementById('inventory-review-table-container');
  const processBtn = document.getElementById('btn-process-counts');

  /**
   * Main function to load all data for the view.
   */
  function loadAdminViewData() {
    reviewContainer.innerHTML = '<p class="text-center"><em>Loading review tasks...</em></p>';
    google.script.run
      .withSuccessHandler(renderAdminView)
      .withFailureHandler(handleError)
      .WebAppInventory_getAdminInventoryViewData();
  }

  /**
   * Renders the different components of the admin view.
   * @param {object} data - The data object from the backend.
   */
  function renderAdminView(data) {
    if (data.error) {
      handleError({ message: data.error });
      return;
    }
    renderReviewTable(data.reviewTasks || []);
    renderOpenTasksTable(data.openTasks || []);
  }

  /**
   * Renders the 'Open Tasks (Manager Queue)' table.
   * @param {Array<object>} tasks - The array of open tasks.
   */
  function renderOpenTasksTable(tasks) {
    const container = document.getElementById('open-tasks-table-container');
    const countSpan = document.getElementById('open-tasks-count');

    if (countSpan) {
        countSpan.textContent = tasks.length;
    }

    if (tasks.length === 0) {
      container.innerHTML = '<p>No open tasks in the manager queue.</p>';
      return;
    }

    let tableHtml = `
      <table class="table table-sm table-hover">
        <thead>
          <tr>
            <th>Date</th>
            <th>Task Title</th>
          </tr>
        </thead>
        <tbody>
    `;

    tasks.forEach(task => {
      // Format date
      let dateStr = '';
      try {
          const dateObj = new Date(task.createdDate);
          dateStr = dateObj.toLocaleDateString();
      } catch (e) {
          dateStr = task.createdDate;
      }

      tableHtml += `
        <tr>
          <td>${dateStr}</td>
          <td>${task.title}</td>
        </tr>
      `;
    });

    tableHtml += `
        </tbody>
      </table>
    `;
    container.innerHTML = tableHtml;
  }

  /**
   * Renders the 'Inventory Counts to Review' table.
   * @param {Array<object>} tasks - The array of task objects for review.
   */
  function renderReviewTable(tasks) {
    if (tasks.length === 0) {
      reviewContainer.innerHTML = '<p>No inventory counts are currently awaiting review.</p>';
      return;
    }

    let tableHtml = `
      <table class="table table-sm table-hover">
        <thead>
          <tr>

            <th class="text-center">Comax</th>
            <th class="text-center">Total</th>
            <th class="text-center">Brurya</th>
            <th class="text-center">Storage</th>
            <th class="text-center">Office</th>
            <th class="text-center">Shop</th>
            <th class="text-center">SKU</th>
            <th class="text-right">Product Name</th>
            <th class="text-center"><input type="checkbox" id="check-all-reviews"></th>
          </tr>
        </thead>
        <tbody>
    `;

    tasks.forEach(task => {
      tableHtml += `
        <tr data-task-id="${task.taskId}" data-sku="${task.sku}">
          <td class="text-center">${task.comaxQty}</td>
          <td class="text-center">${task.totalQty}</td>
          <td class="text-center">${task.bruryaQty}</td>
          <td class="text-center">${task.storageQty}</td>
          <td class="text-center">${task.officeQty}</td>
          <td class="text-center">${task.shopQty}</td>
          <td class="text-center">${task.sku}</td>
          <td class="text-right">${task.productName}</td>
          <td class="text-center"><input type="checkbox" class="review-checkbox"></td>
        </tr>
      `;
    });

    tableHtml += `
        </tbody>
      </table>
    `;
    reviewContainer.innerHTML = tableHtml;
    const checkAllCheckbox = document.getElementById('check-all-reviews');
    if (checkAllCheckbox) {
      checkAllCheckbox.addEventListener('change', () => {
        const individualCheckboxes = document.querySelectorAll('.review-checkbox');
        individualCheckboxes.forEach(checkbox => {
          checkbox.checked = checkAllCheckbox.checked;
        });
        updateProcessButtonState();
      });
    }
    addCheckboxEventListeners();
    updateProcessButtonState();
  }

  /**
   * Attaches event listeners to all review checkboxes.
   */
  function addCheckboxEventListeners() {
    const individualCheckboxes = document.querySelectorAll('.review-checkbox');
    individualCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        updateProcessButtonState();
        const checkAllCheckbox = document.getElementById('check-all-reviews');
        if (checkAllCheckbox) {
          const allChecked = Array.from(individualCheckboxes).every(cb => cb.checked);
          checkAllCheckbox.checked = allChecked;
        }
      });
    });
  }

  /**
   * Updates the disabled state of the process button based on checked checkboxes.
   */
  function updateProcessButtonState() {
    const checkedCheckboxes = document.querySelectorAll('.review-checkbox:checked');
    processBtn.disabled = checkedCheckboxes.length === 0;
    if (checkedCheckboxes.length > 0) {
      processBtn.textContent = `Process ${checkedCheckboxes.length} Count${checkedCheckboxes.length > 1 ? 's' : ''}`;
    } else {
      processBtn.textContent = 'Processing counts disabled';
    }
  }

  /**
   * Handles the click event for the process counts button.
   */
  function handleProcessCounts() {
    if (!confirm("Are you sure you want to process the selected inventory counts?")) {
      return;
    }
    processBtn.disabled = true;
    processBtn.textContent = 'Processing...';

    const taskIds = [];
    document.querySelectorAll('.review-checkbox:checked').forEach(checkbox => {
      const row = checkbox.closest('tr');
      if (row && row.dataset.taskId) {
        taskIds.push(row.dataset.taskId);
      }
    });

    if (taskIds.length === 0) {
      showToast('No tasks selected for processing.', 'warning');
      processBtn.disabled = false;
      processBtn.textContent = 'Processing counts disabled';
      return;
    }

    google.script.run
      .withSuccessHandler(response => {
        if (response.success) {
          showToast(`${response.completed} counts processed successfully.`);
          loadAdminViewData(); // Reload data to reflect changes
          if (window.refreshSystemHealthWidget) {
            window.refreshSystemHealthWidget();
          }
        } else {
          showToast(`Error processing counts: ${response.message}`, 'error');
        }
        processBtn.disabled = false;
        processBtn.textContent = 'Processing counts disabled';
      })
      .withFailureHandler(err => {
        showToast(`Error processing counts: ${err.message}`, 'error');
        processBtn.disabled = false;
        processBtn.textContent = 'Processing counts disabled';
      })
      .WebAppInventory_acceptInventoryCounts(taskIds);
  }

  processBtn.addEventListener('click', handleProcessCounts);

  /**
   * Generic error handler for google.script.run failures.
   * @param {Error} error - The error object.
   */
  function handleError(error) {
    console.error('An error occurred:', error.message);
    showToast(`Error: ${error.message}`, 'error');
  }

  /**
   * Displays a toast notification.
   * @param {string} message The message to display.
   * @param {string} type The type of toast (success, error, warning).
   */
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    // Animate in
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);

    // Animate out and remove
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            if (toast.parentNode) {
                document.body.removeChild(toast);
            }
        }, 500);
    }, 3000);
  }

  // --- Bulk Generation Logic ---
  const bulkBtn = document.getElementById('btn-generate-bulk-tasks');
  const daysInput = document.getElementById('max-days-bulk');
  const stockInput = document.getElementById('max-stock-bulk');
  const webOnlyChk = document.getElementById('chk-web-only');
  const wineOnlyChk = document.getElementById('chk-wine-only');
  const zeroStockChk = document.getElementById('chk-zero-stock');

  function handleBulkGeneration() {
      const days = daysInput.value;
      const stock = stockInput.value;
      
      if (!days && !stock) {
          showToast("Please enter at least one condition (Days or Stock).", 'warning');
          return;
      }
      
      bulkBtn.disabled = true;
      bulkBtn.textContent = 'Checking...';
      
      const payload = {
          days: days,
          stock: stock,
          webOnly: webOnlyChk.checked,
          wineOnly: wineOnlyChk.checked,
          zeroStock: zeroStockChk.checked
      };
      
      // Preview first
      google.script.run
        .withSuccessHandler(previewRes => {
            if (previewRes.success) {
                if (previewRes.candidates.length === 0) {
                     showToast("No tasks match these criteria.", 'warning');
                     bulkBtn.disabled = false;
                     bulkBtn.textContent = 'Generate Tasks';
                     return;
                }
                
                // Populate Modal
                const tbody = document.getElementById('bulkPreviewTableBody');
                tbody.innerHTML = '';
                previewRes.candidates.forEach(c => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${c.sku}</td><td>${c.name}</td><td>${c.reason}</td>`;
                    tbody.appendChild(row);
                });
                
                document.getElementById('bulkPreviewSummary').textContent = `Found ${previewRes.candidates.length} products matching your criteria.`;
                
                // Setup Confirm Button
                const confirmBtn = document.getElementById('btn-confirm-bulk-generation');
                // Remove old listeners to prevent duplicates (cloning node trick)
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                newConfirmBtn.addEventListener('click', () => {
                    $('#bulkPreviewModal').modal('hide'); // Hide modal (requires jQuery/Bootstrap JS)
                    bulkBtn.textContent = 'Generating...';
                    google.script.run
                        .withSuccessHandler(genRes => {
                            if (genRes.success) {
                                showToast(`Generated ${genRes.count} new tasks.`);
                                loadAdminViewData(); // Refresh lists
                            } else {
                                showToast(genRes.message, 'error');
                            }
                            bulkBtn.disabled = false;
                            bulkBtn.textContent = 'Generate Tasks';
                        })
                        .withFailureHandler(err => {
                            handleError(err);
                            bulkBtn.disabled = false;
                            bulkBtn.textContent = 'Generate Tasks';
                        })
                        .WebAppInventory_generateBulkTasks(payload);
                });

                // Show Modal
                $('#bulkPreviewModal').modal('show');
                bulkBtn.disabled = false;
                bulkBtn.textContent = 'Generate Tasks'; // Reset button state as modal handles flow now

            } else {
                showToast(previewRes.message, 'error');
                bulkBtn.disabled = false;
                bulkBtn.textContent = 'Generate Tasks';
            }
        })
        .withFailureHandler(err => {
            handleError(err);
            bulkBtn.disabled = false;
            bulkBtn.textContent = 'Generate Tasks';
        })
        .WebAppInventory_previewBulkTasks(payload);
  }
  
  bulkBtn.addEventListener('click', handleBulkGeneration);

  // --- Spot Check Logic ---
  const spotBtn = document.getElementById('btn-create-spot-task');
  const spotInput = document.getElementById('spot-check-search');
  const spotNote = document.getElementById('spot-check-note');
  let debounceTimer;
  let selectedSpotProduct = null;

  function handleSpotSearch(e) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const term = e.target.value;
            if (term.length < 2) {
                clearAutocomplete();
                return;
            }
            google.script.run
                .withSuccessHandler(renderAutocomplete)
                .withFailureHandler(err => showToast('Search failed: ' + err.message, 'error'))
                .WebAppInventory_searchComaxProducts(term);
        }, 300);
  }

  function renderAutocomplete(results) {
        clearAutocomplete();
        if (!results || results.length === 0) return;

        const container = document.createElement('div');
        container.id = 'autocomplete-results';
        
        results.forEach(item => {
            const div = document.createElement('div');
            div.textContent = `${item.name} (${item.sku})`;
            div.addEventListener('click', () => {
                spotInput.value = `${item.name} (${item.sku})`;
                selectedSpotProduct = item; // Store selected item
                clearAutocomplete();
            });
            container.appendChild(div);
        });
        
        // Append to the parent .col of the input
        spotInput.parentNode.style.position = 'relative';
        spotInput.parentNode.appendChild(container);
  }

  function clearAutocomplete() {
      const el = document.getElementById('autocomplete-results');
      if (el) el.remove();
  }
  
  function handleCreateSpotTask() {
      if (!selectedSpotProduct && !spotInput.value) {
          showToast("Please select a product.", 'warning');
          return;
      }
      // Extract SKU if user typed manually or pasted
      let sku = selectedSpotProduct ? selectedSpotProduct.sku : null;
      
      // Fallback logic if they typed a SKU directly
      if (!sku) {
          const val = spotInput.value;
          const match = val.match(/\(([^)]+)\)$/);
          sku = match ? match[1] : val; 
      }

      spotBtn.disabled = true;
      spotBtn.textContent = 'Creating...';
      
      google.script.run
        .withSuccessHandler(res => {
            if (res.success) {
                showToast('Spot check task created.');
                spotInput.value = '';
                spotNote.value = '';
                selectedSpotProduct = null;
                loadAdminViewData();
            } else {
                showToast(res.message, 'error');
            }
            spotBtn.disabled = false;
            spotBtn.textContent = 'Create Spot Check';
        })
        .withFailureHandler(err => {
            handleError(err);
            spotBtn.disabled = false;
            spotBtn.textContent = 'Create Spot Check';
        })
        .WebAppInventory_createSpotCheckTask(sku, spotNote.value);
  }
  
  spotInput.addEventListener('keyup', handleSpotSearch);
  spotBtn.addEventListener('click', handleCreateSpotTask);
  
  // Close autocomplete on click outside
  document.addEventListener('click', (e) => {
      if (e.target !== spotInput) clearAutocomplete();
  });

  // Initial load
  loadAdminViewData();
  loadComaxSyncData(); // Load data for the new Comax Sync card

  /**
   * Loads data specifically for the Comax Sync card.
   */
  function loadComaxSyncData() {
      google.script.run
          .withSuccessHandler(renderComaxSyncCard)
          .withFailureHandler(handleError)
          .WebAppInventory_getAdminComaxSyncData();
  }

  /**
   * Renders the Comax Sync card based on the provided data.
   * @param {object} data - The data object from the backend.
   */
  function renderComaxSyncCard(data) {
    const comaxExportBtn = document.getElementById('btn-comax-export');
    const comaxConfirmBtn = document.getElementById('btn-comax-updated');
    const comaxMessageArea = document.getElementById('comax-inventory-message-area');
    const tableBody = document.querySelector('#comax-export-table tbody');

    // Reset button states
    comaxExportBtn.disabled = true;
    comaxConfirmBtn.disabled = true;
    comaxMessageArea.innerHTML = '';
    comaxExportBtn.className = 'btn btn-light'; 
    comaxConfirmBtn.className = 'btn btn-light ml-2';
    tableBody.innerHTML = ''; // Clear table

    if (data.error) {
        comaxMessageArea.innerHTML = `<p class="text-danger">${data.error}</p>`;
        return;
    }

    // Render Table of Accepted Tasks
    if (data.acceptedTasks && data.acceptedTasks.length > 0) {
        data.acceptedTasks.forEach(task => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="text-center">${task.comaxQty}</td>
                <td class="text-center">${task.totalQty}</td>
                <td class="text-center">${task.bruryaQty}</td>
                <td class="text-center">${task.storageQty}</td>
                <td class="text-center">${task.officeQty}</td>
                <td class="text-center">${task.shopQty}</td>
                <td class="text-center">${task.sku}</td>
                <td class="text-right">${task.productName}</td>
            `;
            tableBody.appendChild(row);
        });
    } else {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="8" class="text-center text-muted">No accepted tasks waiting for export.</td>';
        tableBody.appendChild(row);
    }

    if (data.openComaxInventoryConfirmationTask) {
        comaxMessageArea.innerHTML = `<div class="alert alert-warning" style="padding: 0.5rem 1rem;">${data.openComaxInventoryConfirmationTask.notes}</div>`;
        comaxConfirmBtn.disabled = false;
        comaxConfirmBtn.onclick = function() { handleComaxConfirmClick(data.openComaxInventoryConfirmationTask.id); };
    } else if (data.comaxInventoryExportCount > 0) {
        // comaxMessageArea.innerHTML = `<p>${data.comaxInventoryExportCount} items ready for export.</p>`; // Redundant with table
        comaxExportBtn.disabled = false;
        comaxExportBtn.onclick = function() { handleComaxExportClick(); };
    } else {
        // comaxMessageArea.innerHTML = '<p style="font-size: 0.85rem;" class="text-muted">No items to export.</p>'; // Redundant with table message
    }
  }

  /**
   * Handles the click event for the 'Comax Export' button.
   */
  function handleComaxExportClick() {
    const exportBtn = document.getElementById('btn-comax-export');
    const messageArea = document.getElementById('comax-inventory-message-area');
    
    if (confirm("Export Comax adjustments?")) {
      exportBtn.disabled = true;
      messageArea.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Processing...';

      google.script.run
        .withSuccessHandler(response => {
          if (response && response.message) {
            alert(response.message);
          }
          loadAdminViewData(); // Reload all data
          loadComaxSyncData(); // Reload Comax Sync data specifically
          if (window.refreshSystemHealthWidget) {
            window.refreshSystemHealthWidget();
          }
        })
        .withFailureHandler(err => {
            handleError(err);
            exportBtn.disabled = false;
            messageArea.innerHTML = `<p class="text-danger">Error: ${err.message}</p>`;
        })
        .WebAppInventory_generateComaxInventoryExport();
    }
  }

  /**
   * Handles the click event for the 'Comax Updated' button.
   * @param {string} taskId - The ID of the confirmation task to complete.
   */
  function handleComaxConfirmClick(taskId) {
    if (!taskId) {
        handleError('Error: Task ID is missing. Please check the logs.');
        return;
    }

    const confirmBtn = document.getElementById('btn-comax-updated');
    const messageArea = document.getElementById('comax-inventory-message-area');

    if (confirm("Confirm Comax adjustment applied and closed?")) {
      confirmBtn.disabled = true;
      messageArea.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Processing...';
      
      google.script.run
        .withSuccessHandler(wasCompleted => {
          if (!wasCompleted) {
            handleError('Failed to confirm task.');
          }
          loadAdminViewData(); // Reload all data
          loadComaxSyncData(); // Reload Comax Sync data specifically
          if (window.refreshSystemHealthWidget) {
            window.refreshSystemHealthWidget();
          }
        })
        .withFailureHandler(err => {
            handleError(err);
            confirmBtn.disabled = false;
            messageArea.innerHTML = `<p class="text-danger">Error: ${err.message}</p>`;
        })
        .WebAppTasks_completeTaskById(taskId);
    }
  }
})();
</script>