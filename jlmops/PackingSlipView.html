<div>
  <h2>Packing Slips</h2>
  <p>Select orders to print packing slips for.</p>
  <button class="btn btn-primary mb-3" onclick="generateSelectedPackingSlips()">Print Selected</button>
  <div id="orders-list"></div>
  <div id="print-result" class="mt-3"></div>
</div>

<script>
  function loadPackingSlipsData() {
    const ordersListDiv = document.getElementById('orders-list');
    ordersListDiv.innerHTML = 'Loading packable orders...';

    try {
      google.script.run
        .withSuccessHandler(orders => {
          if (orders.length === 0) {
            ordersListDiv.innerHTML = '<p>No orders are currently ready for packing.</p>';
            return;
          }

          let tableHtml = '<table class="table table-hover"><thead><tr><th><input type="checkbox" onclick="toggleAll(this)"></th><th>Order ID</th><th>Status</th><th>Customer Note</th><th></th></tr></thead><tbody>';
          orders.forEach(order => {
            let giftButton = '';
            if (order.customerNote) {
              giftButton = `<button class="btn btn-sm btn-secondary" onclick="createGiftMessage('${order.orderId}', '${order.customerNote}')">Create Gift Doc</button>`;
            }
            tableHtml += `<tr><td><input type="checkbox" class="order-checkbox" value="${order.orderId}"></td><td>${order.orderId}</td><td>${order.status}</td><td>${order.customerNote || ''}</td><td>${giftButton}</td></tr>`;
          });
          tableHtml += '</tbody></table>';
          ordersListDiv.innerHTML = tableHtml;
        })
        .withFailureHandler(err => {
          ordersListDiv.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        })
        .getPackableOrders();
    } catch (e) {
      alert('A client-side error occurred: ' + e.message);
    }
  }

  function toggleAll(source) {
    const checkboxes = document.querySelectorAll('.order-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.checked = source.checked;
    });
  }

  function createGiftMessage(orderId, noteContent) {
    const printResultDiv = document.getElementById('print-result');
    printResultDiv.innerHTML = `Creating gift message for order ${orderId}...`;

    google.script.run
      .withSuccessHandler(docUrl => {
        printResultDiv.innerHTML = `<div class="alert alert-success">Successfully created gift message. <a href="${docUrl}" target="_blank">Open Document</a></div>`;
      })
      .withFailureHandler(err => {
        printResultDiv.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
      })
      .createGiftMessageDoc(orderId, noteContent);
  }

  function generateSelectedPackingSlips() {
    const printResultDiv = document.getElementById('print-result');
    printResultDiv.innerHTML = 'Generating document...';
    const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
    const orderIds = Array.from(selectedCheckboxes).map(cb => cb.value);

    if (orderIds.length === 0) {
      printResultDiv.innerHTML = '<div class="alert alert-warning">Please select at least one order to print.</div>';
      return;
    }

    google.script.run
      .withSuccessHandler(docUrl => {
        printResultDiv.innerHTML = `<div class="alert alert-success">Successfully generated document. <a href="${docUrl}" target="_blank">Open Document</a></div>`;
        // Refresh the list
        loadPackingSlipsData();
      })
      .withFailureHandler(err => {
        printResultDiv.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
      })
      .generatePackingSlips(orderIds);
  }

  // Self-execute to load the data as soon as the view is loaded.
  loadPackingSlipsData();
</script>