<div class="row">
  <div class="col-md-3" id="system-widget-placeholder">
    <p>Loading System Widget...</p>
  </div>
  <div class="col-md-3" id="orders-widget-placeholder">
    <p>Placeholder for Orders Widget</p>
  </div>
  <div class="col-md-3" id="inventory-widget-placeholder">
    <p>Placeholder for Inventory Widget</p>
  </div>
  <div class="col-md-3" id="products-widget-placeholder">
    <p>Placeholder for Products Widget</p>
  </div>
</div>

<script>
  /**
   * A generic function to execute scripts within a string of HTML.
   * This function needs to be available in the global scope for the widgets.
   * @param {HTMLElement} element - The element containing the new HTML.
   */
  function executeScriptsInElement(element) {
    const scripts = Array.from(element.getElementsByTagName('script'));
    scripts.forEach(s => {
      const newScript = document.createElement('script');
      newScript.textContent = s.textContent;
      s.parentNode.replaceChild(newScript, s);
    });
  }

  /**
   * Displays an error message. This needs to be available for the widgets.
   * @param {Error} err - The error object from a failed google.script.run call.
   */
  function showError(err) {
    // This function relies on an 'error-display' element in the main Dashboard.html
    // We are calling a function that should exist in the parent frame.
    // This is not ideal, but it's the current architecture.
    // A better solution would be a shared event bus.
    if (window.parent && window.parent.showError) {
      window.parent.showError(err);
    } else {
      console.error(err);
    }
  }

  /**
   * Loads a widget into a specified placeholder.
   * @param {string} widgetName - The name of the widget view to load.
   * @param {string} placeholderId - The ID of the div to load the widget into.
   */
  function loadWidget(widgetName, placeholderId) {
    const placeholder = document.getElementById(placeholderId);
    if (!placeholder) {
      console.error('Placeholder not found:', placeholderId);
      return;
    }
    
    google.script.run
      .withSuccessHandler(html => {
        placeholder.innerHTML = html;
        executeScriptsInElement(placeholder);
      })
      .withFailureHandler(err => {
        placeholder.innerHTML = `<p class="text-danger">Error loading ${widgetName}: ${err.message}</p>`;
      })
      .getView(widgetName);
  }

  // Load Widgets - The HTML is loaded first
  loadWidget('SystemHealthWidget', 'system-widget-placeholder');
  loadWidget('AdminOrdersWidget', 'orders-widget-placeholder');
  loadWidget('AdminInventoryWidget', 'inventory-widget-placeholder');
  loadWidget('AdminProductsWidget', 'products-widget-placeholder');

  /**
   * Orchestrates the fetching of all dashboard data in a single round-trip.
   * This replaces the individual data fetches inside each widget.
   */
  function loadDashboardData() {
    console.log('Fetching aggregated dashboard data...');
    google.script.run
      .withSuccessHandler(response => {
        if (!response.success) {
          showError({ message: response.error });
          return;
        }

        // Distribute data to widgets
        // We use a short timeout to ensure the HTML injection (loadWidget) has finished.
        // Since loadWidget is async (google.script.run), there's a race condition risk.
        // A robust solution uses Promises, but for simplicity in this context,
        // we check if the function exists, or retry.
        
        distributeDataWhenReady(response);
      })
      .withFailureHandler(showError)
      .WebAppDashboard_getAdminDashboardData();
  }

  /**
   * Retries distributing data until the widget scripts are loaded.
   */
  function distributeDataWhenReady(data, attempts = 0) {
    if (attempts > 50) { // Give up after 5 seconds
      console.error('Widgets took too long to load. Data distribution failed.');
      return;
    }

    // Check if all update functions are defined in the global scope
    const missing = [];
    if (typeof updateSystemHealthView !== 'function') missing.push('updateSystemHealthView');
    if (typeof updateOrdersWidget !== 'function') missing.push('updateOrdersWidget');
    if (typeof updateInventoryView !== 'function') missing.push('updateInventoryView');
    if (typeof updateProductsWidget !== 'function') missing.push('updateProductsWidget');

    if (missing.length === 0) {
      console.log('All widgets ready. Distributing data.');
      updateSystemHealthView(data.system);
      updateOrdersWidget(data.orders);
      updateInventoryView(data.inventory);
      updateProductsWidget(data.products);
    } else {
      // Not ready yet, wait and retry
      if (attempts % 10 === 0) {
          console.log(`Waiting for widgets: ${missing.join(', ')} (attempt ${attempts})`);
      }
      setTimeout(() => distributeDataWhenReady(data, attempts + 1), 100);
    }
  }

  // Initiate data load immediately.
  // Ideally, this runs parallel to the HTML loading.
  loadDashboardData();
</script>
