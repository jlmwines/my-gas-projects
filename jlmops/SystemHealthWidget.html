<div id="system-health-widget" style="padding: 0;">
  <p>Loading...</p>
</div>

<script>
  /**
   * Populates the system health widget with detailed status.
   * @param {Object} dashboardData - The full dashboard data from the backend.
   */
  function updateSystemHealthWidget(dashboardData) {
    const widget = document.getElementById('system-health-widget');
    if (dashboardData.error) {
      widget.innerHTML = `<p class="text-danger">${dashboardData.error}</p>`;
      return;
    }

    const data = dashboardData.systemHealthData;
    if (!data) {
      widget.innerHTML = `<p class="text-warning">System health data is unavailable.</p>`;
      return;
    }

    let html = '<h5>System Health</h5>';

    // 1. Overall Status
    if (data.isHealthy) {
      html += '<p class="text-success mb-2"><strong>Healthy</strong></p>';
    } else {
      data.alerts.forEach(alert => {
        html += `<p class="text-danger mb-1">${alert}</p>`;
      });
    }
    html += '<hr class="my-2">';

    // 2. Job Counts
    html += `<p class="mb-1" style="font-size: 0.9rem;">Recent Failed Jobs: <span class="badge ${data.recentFailedJobs > 0 ? 'badge-danger' : 'badge-secondary'}">${data.recentFailedJobs}</span></p>`;
    html += `<p class="mb-1" style="font-size: 0.9rem;">Quarantined Jobs: <span class="badge ${data.quarantinedJobs > 0 ? 'badge-warning' : 'badge-secondary'}">${data.quarantinedJobs}</span></p>`;
    html += `<p class="mb-1" style="font-size: 0.9rem;">Blocked Jobs: <span class="badge ${data.blockedJobs > 0 ? 'badge-info' : 'badge-secondary'}">${data.blockedJobs}</span></p>`;
    html += '<hr class="my-2">';

    // 3. Validation Status
    const lastValidationColor = data.isValidationRecent ? 'text-success' : 'text-danger';
    html += `<p class="${lastValidationColor} mb-2" style="font-size: 0.9rem;">Last Validation: ${data.lastValidationTimestamp}</p>`;
    
    // 4. Action Link
    html += `<a href="#" onclick="runValidation(); return false;" style="font-size: 0.9rem;">Validate Now</a>`;
    html += `<p id="validation-status" class="mt-1" style="font-size: 0.8rem;"></p>`;
    
    widget.innerHTML = html;
  }

  /**
   * Handles the 'validate now' link click.
   */
  function runValidation() {
    const statusElement = document.getElementById('validation-status');
    statusElement.innerText = 'Creating job...';
    statusElement.className = 'text-info';

    google.script.run
      .withSuccessHandler(response => {
        if (response.success) {
          statusElement.innerText = `Job created. Refreshing...`;
          statusElement.className = 'text-success';
          // Refresh the widget data after a short delay to allow the orchestrator to pick up the job
          setTimeout(() => google.script.run.withSuccessHandler(updateSystemHealthWidget).withFailureHandler(showError).getDashboardData(), 3000);
        } else {
          statusElement.innerText = `Failed to create job: ${response.error}`;
          statusElement.className = 'text-danger';
        }
      })
      .withFailureHandler(error => {
        statusElement.innerText = `Failed: ${error.message}`;
        statusElement.className = 'text-danger';
        showError(error);
      })
      .createMasterValidationJob();
  }

  // Initial data load for this view
  google.script.run.withSuccessHandler(updateSystemHealthWidget).withFailureHandler(showError).getDashboardData();
</script>
