<div id="system-health-widget" style="padding: 0;">
  <p>Loading...</p>
</div>

<script>
  /**
   * Populates the system health widget based on the final approved design.
   * @param {Object} data - The health data from the backend.
   */
  function updateSystemHealthView(data) {
    const widget = document.getElementById('system-health-widget');
    const indicator = window.parent.document.getElementById('system-health-indicator');

    if (data.error) {
      widget.innerHTML = `<p class="text-danger">${data.error}</p>`;
      if (indicator) indicator.style.color = 'orange';
      return;
    }

    // Update main health indicator color in the parent dashboard
    if (indicator) {
      indicator.style.color = data.isHealthy ? 'green' : 'red';
    }

    let finalHtml = '<h5>System Health</h5>';

    // 1. Alerts Area
    if (data.isHealthy) {
      finalHtml += '<p class="text-success"><strong>Healthy</strong></p>';
    } else {
      data.alerts.forEach(alert => {
        finalHtml += `<p class="text-danger mb-1">${alert}</p>`;
      });
    }
    finalHtml += '<hr class="my-2">';

    // 2. Validation Status
    const lastValidationColor = data.isValidationRecent ? 'text-success' : 'text-danger';
    finalHtml += `<p class="${lastValidationColor} mb-2" style="font-size: 0.9rem;">Last Validation: ${data.lastValidationTimestamp}</p>`;
    finalHtml += `<div id="system-health-validation-results" class="mt-2" style="font-size: 0.8rem;"></div>`;
    
    // 3. Confirmed Critical Validations
    if (data.passedValidations && data.passedValidations.length > 0) {
      data.passedValidations.forEach(confirmation => {
        finalHtml += `<p class="mb-1" style="font-size: 0.8rem;">${confirmation}</p>`;
      });
    }

    // 4. Action Link
    finalHtml += '<hr class="my-2">';
    finalHtml += `<a href="#" onclick="runValidation(); return false;" style="font-size: 0.9rem;">Validate Now</a>`;
    finalHtml += `<p id="validation-status" class="mt-1" style="font-size: 0.8rem;"></p>`;
    
    widget.innerHTML = finalHtml;
  }

  /**
   * Handles the 'validate now' link click.
   */
  function runValidation() {
    const resultsDiv = document.getElementById('system-health-validation-results');
    const statusElement = document.getElementById('validation-status');
    resultsDiv.innerHTML = ''; // Clear previous results
    statusElement.innerText = 'Running validation...';
    statusElement.className = 'text-info';

    google.script.run
      .withSuccessHandler(response => {
        statusElement.innerText = ''; // Clear status message
        let html = '';
        if (response.results && response.results.length > 0) {
          html += `<h5>Detailed Results:</h5><ul>`;
          response.results.forEach(result => {
            const statusClass = result.status === 'PASSED' ? 'text-success' : 'text-danger';
            html += `<li class="${statusClass}">${result.ruleName}: ${result.status} - ${result.message || ''}</li>`;
          });
          html += `</ul>`;
        } else if (response.success) {
            html = `<p class="alert alert-success">Validation completed successfully. ${response.message}</p>`;
        } else {
            html = `<p class="alert alert-danger">Validation failed: ${response.error || 'Unknown error'}</p>`;
        }
        resultsDiv.innerHTML = html;

        // Update timestamp display - a bit of a hack to find the parent p tag
        const allP = document.getElementById('system-health-widget').getElementsByTagName('p');
        for(let i=0; i < allP.length; i++) {
          if (allP[i].innerText.startsWith('Last Validation:')) {
            allP[i].innerText = 'Last Validation: Just now';
            allP[i].className = 'text-success mb-2';
            break;
          }
        }
      })
      .withFailureHandler(error => {
        statusElement.innerText = ''; // Clear status message
        resultsDiv.innerHTML = `<p class="alert alert-danger">Failed to run validation: ${error.message}</p>`;
        showError(error);
      })
      .WebAppSystem_runMasterValidationAndReturnResults();
  }

  // Initial data load for this view
  google.script.run.withSuccessHandler(updateSystemHealthView).withFailureHandler(showError).WebAppSystem_getSystemHealthDashboardData();
</script>
