<div id="system-health-widget-container" style="padding: 0;">
  <div class="card">
    <div class="card-header">
      <h5>System</h5>
    </div>
    <div class="card-body" id="system-health-widget-body">
      <p>Loading System Health...</p>
    </div>
  </div>
</div>

<style>
  .text-warning-dark {
    color: #d39e00 !important; /* Darker amber for better visibility */
  }
</style>

<script>
  /**
   * Populates the system health widget based on the final approved design.
   * @param {Object} data - The health data from the backend.
   */
  function updateSystemHealthView(data) {
    const widgetBody = document.getElementById('system-health-widget-body'); // Targeting the body
    const indicator = window.parent.document.getElementById('system-health-indicator');

    if (data.error) {
      widgetBody.innerHTML = `<p class="text-danger">${data.error}</p>`;
      if (indicator) indicator.style.color = 'orange';
      return;
    }

    // Update main health indicator color in the parent dashboard
    if (indicator) {
      indicator.style.color = data.isHealthy ? 'green' : 'red';
    }

    let finalHtml = ''; // Remove the h5 and hr, as they are now in the card structure

    // Place healthy notice, last validation, and validate now link here
    if (data.isHealthy) {
      finalHtml += '<p class="text-success"><strong>Healthy</strong></p>';
    } else {
      // Display specific failure tasks if available
      if (data.activeFailureTasks && data.activeFailureTasks.length > 0) {
        finalHtml += '<h6 class="text-danger">Attention Needed</h6>';
        finalHtml += '<ul class="list-group list-group-flush mb-3">';
        data.activeFailureTasks.forEach(task => {
           finalHtml += `<li class="list-group-item p-2 border-0 bg-light mb-1">`;
           finalHtml += `<div class="fw-bold text-danger" style="font-size: 0.85rem;">${task.title}</div>`;
           if (task.notes) {
               finalHtml += `<div class="text-muted" style="font-size: 0.75rem;">${task.notes}</div>`;
           }
           finalHtml += `</li>`;
        });
        finalHtml += '</ul>';
      } else {
        // Fallback to summary alerts if no detailed tasks found (legacy behavior)
        data.alerts.forEach(alert => {
            finalHtml += `<p class="text-danger mb-1">${alert}</p>`;
        });
      }
    }

    const lastValidationColor = data.isValidationRecent ? 'text-success' : 'text-danger';
    finalHtml += `<p class="${lastValidationColor} mb-2" style="font-size: 0.9rem;">Last Validation: ${data.lastValidationTimestamp}</p>`;
    finalHtml += `<a href="#" onclick="runValidation(); return false;" style="font-size: 0.9rem;">Validate Now</a>`;
    finalHtml += `<p id="validation-status" class="mt-1" style="font-size: 0.8rem;"></p>`;
    finalHtml += '<hr class="my-2">'; // Divider after validation section

    // NEW Sync Status Display
    if (data.syncStatusSummary && data.syncStatusSummary.text) {
        finalHtml += `<div id="widget-sync-status" class="mt-2" style="font-size: 0.9rem;">`;
        finalHtml += `<p class="mb-0 ${data.syncStatusSummary.color}">${data.syncStatusSummary.text}</p>`;
        finalHtml += `</div>`;
        finalHtml += '<hr class="my-2">'; // Divider after sync status
    }

    // This section (Confirmed Critical Validations) should remain in its original place relative to validation.
    // It's part of the general system health status, not specific to the daily sync.
    finalHtml += `<div id="system-health-validation-results" class="mt-2" style="font-size: 0.8rem;"></div>`;
    if (data.passedValidations && data.passedValidations.length > 0) {
      data.passedValidations.forEach(confirmation => {
        finalHtml += `<p class="mb-1" style="font-size: 0.8rem;">${confirmation}</p>`;
      });
    }

    widgetBody.innerHTML = finalHtml; // Update widgetBody content
  }

  /**
   * Handles the 'validate now' link click.
   */
  function runValidation() {
    const resultsDiv = document.getElementById('system-health-validation-results');
    const statusElement = document.getElementById('validation-status');
    resultsDiv.innerHTML = ''; // Clear previous results
    statusElement.innerText = 'Running validation...';
    statusElement.className = 'text-info';

    google.script.run
      .withSuccessHandler(response => {
        statusElement.innerText = ''; // Clear status message
        let html = '';
        if (response.results && response.results.length > 0) {
          html += `<h5>Detailed Results:</h5><ul>`;
          response.results.forEach(result => {
            const statusClass = result.status === 'PASSED' ? 'text-success' : 'text-danger';
            html += `<li class="${statusClass}">${result.ruleName}: ${result.status} - ${result.message || ''}</li>`;
          });
          html += `</ul>`;
        } else if (response.success) {
            html = `<p class="alert alert-success">Validation completed successfully. ${response.message}</p>`;
        } else {
            html = `<p class="alert alert-danger">Validation failed: ${response.error || 'Unknown error'}</p>`;
        }
        resultsDiv.innerHTML = html;

        // Update timestamp display - a bit of a hack to find the parent p tag
        const allP = document.getElementById('system-health-widget-body').getElementsByTagName('p'); // Updated ID
        for(let i=0; i < allP.length; i++) {
          if (allP[i].innerText.startsWith('Last Validation:')) {
            allP[i].innerText = 'Last Validation: Just now';
            allP[i].className = 'text-success mb-2';
            break;
          }
        }
      })
      .withFailureHandler(error => {
        statusElement.innerText = ''; // Clear status message
        resultsDiv.innerHTML = `<p class="alert alert-danger">Failed to run validation: ${error.message}</p>`;
        showError(error);
      })
      .WebAppSystem_runMasterValidationAndReturnResults();
  }

  /**
   * Fetches and displays the latest system health data.
   */
  function _fetchAndDisplaySystemHealth() {
    google.script.run
      .withSuccessHandler(updateSystemHealthView)
      .withFailureHandler(showError)
      .WebAppSystem_getSystemHealthDashboardData();
  }

  // Expose the refresh function globally
  window.refreshSystemHealthWidget = _fetchAndDisplaySystemHealth;

  // Initial data load for this view
  _fetchAndDisplaySystemHealth();
</script>
