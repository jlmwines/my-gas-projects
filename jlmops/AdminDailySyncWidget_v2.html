<style>
    .sync-card-title {
        height: 3rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    .sync-icon {
        font-size: 1.6rem;
        margin: 0.5rem 0;
    }
</style>

<div class="card shadow-sm mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div class="text-start">
            <span id="sessionIdDisplay" class="small text-muted"></span>
        </div>
        <div class="text-end">
            <a href="#" id="resetSyncLink" onclick="window.SyncWidget.resetSync(); return false;" class="text-decoration-none text-secondary fw-bold">Reset</a>
        </div>
    </div>
    <div class="card-body">

        <!-- Failure Banner -->
        <div id="failureBanner" class="alert alert-danger d-none mb-3">
            <button type="button" class="close float-end" onclick="window.SyncWidget.dismissFailures()" style="background:none;border:none;font-size:1.2rem;line-height:1;opacity:0.7;">&times;</button>
            <strong>Import Failures:</strong>
            <span id="failureList"></span>
        </div>

        <!-- 6-Step Display (Invoices + 5 Steps) -->
        <div class="row row-cols-6 g-2 mb-3">
            <!-- Step 0: Pre-Sync Status -->
            <div class="col">
                <div class="card h-100" id="invoiceCard">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">Pre-Sync</h6>
                        <div id="invoiceIcon" class="sync-icon">üìÅ</div>
                        <div id="invoiceMessage" class="small">
                            <div><span id="invoiceCount" class="fw-bold">...</span></div>
                            <div><span id="reviewCount" class="fw-bold">...</span></div>
                        </div>
                        <div id="invoiceAction" class="mt-1"></div>
                    </div>
                </div>
            </div>
            <!-- Step 1: Web Product Import -->
            <div class="col">
                <div class="card h-100" id="step1Card">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">1. Web Product Import</h6>
                        <div id="step1Icon" class="sync-icon">‚è∏Ô∏è</div>
                        <div id="step1Message" class="text-muted small"></div>
                        <div id="step1Action"></div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Web Order Import -->
            <div class="col">
                <div class="card h-100" id="step2Card">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">2. Web Order Import</h6>
                        <div id="step2Icon" class="sync-icon">‚è∏Ô∏è</div>
                        <div id="step2Message" class="text-muted small"></div>
                        <div id="step2Action"></div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Update Comax Orders -->
            <div class="col">
                <div class="card h-100" id="step3Card">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">3. Update Comax Orders</h6>
                        <div id="step3Icon" class="sync-icon">‚è∏Ô∏è</div>
                        <div id="step3Message" class="text-muted small"></div>
                        <div id="step3Action"></div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Import Comax Products -->
            <div class="col">
                <div class="card h-100" id="step4Card">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">4. Import Comax Products</h6>
                        <div id="step4Icon" class="sync-icon">‚è∏Ô∏è</div>
                        <div id="step4Message" class="text-muted small"></div>
                        <div id="step4Action"></div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Update Web Inventory -->
            <div class="col">
                <div class="card h-100" id="step5Card">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">5. Update Web Inventory</h6>
                        <div id="step5Icon" class="sync-icon">‚è∏Ô∏è</div>
                        <div id="step5Message" class="text-muted small"></div>
                        <div id="step5Action"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shared Message & Action Area -->
        <div class="card mt-3 border-primary">
            <div class="card-body py-3 row align-items-center">
                <div id="sharedMessage" class="col-4">
                    <span class="text-muted">Ready to start sync</span>
                </div>
                <div id="sharedAction" class="col-4 text-center">
                    <!-- Action button rendered here -->
                </div>
                <div class="col-4"></div>
            </div>
        </div>

        <!-- Progress Log -->
        <div id="progressLog" class="mt-2 text-muted" style="font-size: 1rem;"></div>

        <!-- Error Display -->
        <div id="errorDisplay" class="alert alert-danger d-none"></div>
    </div>
    <div class="card-footer text-muted" id="footerStatus">
        Ready
    </div>
</div>

<script>
(function() {
    'use strict';

    // Clear any existing interval from previous widget instance
    if (window._syncWidgetPollInterval) {
        clearInterval(window._syncWidgetPollInterval);
        window._syncWidgetPollInterval = null;
    }

    // Reset all widget state on load
    window._lastLoggedStatus = null;
    window.lastMessageTimestamp = 0;

    // Module state
    var currentSessionId = null;
    var pollInterval = null;
    var lastActionTime = 0;
    var currentPollIntervalMs = null;
    var dismissedFailures = {};
    var progressEntries = [];
    var previousStepStatuses = {};

    // Constants
    var ULTRA_FAST_POLL_MS = 500;
    var ACTIVE_POLL_MS = 1000;
    var IDLE_POLL_MS = 10000;
    var ACTION_GRACE_PERIOD_MS = 5000;

    var ICONS = {
        waiting: '‚è∏Ô∏è',
        processing: 'üîÑ',
        completed: '‚úÖ',
        skipped: '‚è≠Ô∏è',
        failed: '‚ùå'
    };

    var actionInProgress = false; // Prevent double-clicks
    var loggedActions = {}; // Track what we've logged to prevent duplicates

    function updateSharedAreaImmediate(stepNum, stepName, actionText) {
        var msgEl = document.getElementById('sharedMessage');
        var actionEl = document.getElementById('sharedAction');
        msgEl.innerHTML = '<strong>Step ' + stepNum + ': ' + stepName + '</strong> - <span class="text-primary">' + actionText + '</span>';
        actionEl.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
        // Don't log "Importing..." - wait for result
    }

    function addProgressEntry(text, isSuccess) {
        // Prevent duplicate entries
        var key = text.replace(/\d+:\d+:\d+ [AP]M/g, '').trim();
        if (loggedActions[key]) return;
        loggedActions[key] = true;

        var icon = isSuccess ? '‚úì' : '‚Ä¢';
        var cls = isSuccess ? 'text-success' : 'text-muted';
        var time = new Date().toLocaleTimeString('he-IL', { timeZone: 'Asia/Jerusalem' });
        progressEntries.push('<span class="' + cls + '">' + icon + ' ' + time + ' - ' + text + '</span>');
        if (progressEntries.length > 10) progressEntries.shift();
        document.getElementById('progressLog').innerHTML = progressEntries.join('<br>');
    }

    function updateUI(status) {
        var now = Date.now();

        // Don't overwrite recent user actions
        if (now - lastActionTime < ACTION_GRACE_PERIOD_MS) {
            return;
        }

        // Track message timestamps to prevent stale overwrites
        var messageTimestamp = new Date(status.lastUpdated || 0).getTime();
        var currentMessageTimestamp = window.lastMessageTimestamp || 0;

        if (messageTimestamp > 0 && messageTimestamp <= currentMessageTimestamp) {
            return;
        }

        window.lastMessageTimestamp = messageTimestamp;

        currentSessionId = status.sessionId;

        // Update session display
        document.getElementById('sessionIdDisplay').textContent = status.sessionId ? 'Session: ' + status.sessionId : '';

        // Update each step (pass currentStep so we only show actions for the active step)
        var currentStep = status.currentStep || 0;
        var ordersPending = status.ordersPendingExportCount || 0;
        updateStep(1, status.step1, currentStep === 1, currentStep);
        updateStep(2, status.step2, currentStep === 2, currentStep);
        updateStep(3, status.step3, currentStep === 3, currentStep, ordersPending);
        updateStep(4, status.step4, currentStep === 4, currentStep);
        updateStep(5, status.step5, currentStep === 5, currentStep, status.webExportFilename);

        // Log progress on step completion transitions with context
        var steps = [null, status.step1, status.step2, status.step3, status.step4, status.step5];
        for (var i = 1; i <= 5; i++) {
            var stepData = steps[i];
            var stepStatus = stepData ? stepData.status : null;
            var prevStatus = previousStepStatuses['step' + i];

            var isCompleted = stepStatus === 'completed' && prevStatus !== 'completed';
            var isSkipped = stepStatus === 'skipped' && prevStatus !== 'skipped';
            // Detect step 3 export ready (waiting after processing) - needs confirmation
            var isOrderExportReady = i === 3 && stepStatus === 'waiting' && prevStatus === 'processing';
            // Detect step 5 export ready (waiting after processing)
            var isExportReady = i === 5 && stepStatus === 'waiting' && prevStatus === 'processing';

            if (isCompleted || isSkipped || isExportReady || isOrderExportReady) {
                var logMsg = '';
                var msg = stepData.message || '';

                switch (i) {
                    case 1: // Web Product Import
                        var match = msg.match(/(\d+)/);
                        logMsg = 'Web products imported' + (match ? ' (' + match[1] + ')' : '');
                        break;
                    case 2: // Web Order Import
                        var match2 = msg.match(/(\d+)/);
                        logMsg = 'Web orders imported' + (match2 ? ' (' + match2[1] + ')' : '');
                        break;
                    case 3: // Update Comax Orders
                        if (isSkipped || (msg.indexOf('No') >= 0 && msg.indexOf('order') >= 0)) {
                            logMsg = 'No orders to export (skipped)';
                        } else if (isOrderExportReady) {
                            // Extract count from message like "Export complete. 2 orders exported."
                            var countMatch = msg.match(/(\d+)\s*orders?\s*exported/i);
                            logMsg = 'Orders exported' + (countMatch ? ' (' + countMatch[1] + ')' : '') + ' - awaiting confirmation';
                        } else {
                            logMsg = 'Orders exported to Comax';
                        }
                        break;
                    case 4: // Import Comax Products
                        logMsg = 'Comax products imported';
                        break;
                    case 5: // Update Web Inventory
                        if (isSkipped || (msg.indexOf('No') >= 0 && msg.indexOf('changes') >= 0)) {
                            logMsg = 'Web inventory skipped (no changes)';
                        } else if (isExportReady) {
                            // Extract filename from message like "Export ready: filename.csv"
                            var fileMatch = msg.match(/Export ready:\s*(.+)/);
                            logMsg = 'Web export created' + (fileMatch ? ': ' + fileMatch[1] : '');
                        } else {
                            logMsg = 'Web inventory updated';
                        }
                        break;
                }

                if (logMsg) {
                    addProgressEntry(logMsg, true);
                }
            }
            previousStepStatuses['step' + i] = stepStatus;
        }

        // Update footer with date and time (Israel timezone)
        document.getElementById('footerStatus').textContent = status.lastUpdated ?
            'Last updated: ' + new Date(status.lastUpdated).toLocaleString('he-IL', { timeZone: 'Asia/Jerusalem' }) : 'Ready';

        // Update shared message/action area
        updateSharedArea(status);

        // Check for any failures (only if session active)
        if (status.sessionId) {
            checkForFailures();
        }
    }

    function btn(action, label) {
        return '<button class="btn btn-sm" onclick="window.SyncWidget.' + action + '(); return false;">' + label + '</button>';
    }

    function spinner() {
        return '<div class="spinner-border spinner-border-sm" role="status"></div>';
    }

    function updateSharedArea(status) {
        var msgEl = document.getElementById('sharedMessage');
        var actionEl = document.getElementById('sharedAction');
        var stage = status.currentStage || 'IDLE';
        var orderCount = status.ordersPendingExportCount || 0;

        // Get step statuses
        var s1 = status.step1 ? status.step1.status : null;
        var s2 = status.step2 ? status.step2.status : null;
        var s3 = status.step3 ? status.step3.status : null;
        var s4 = status.step4 ? status.step4.status : null;
        var s5 = status.step5 ? status.step5.status : null;

        var message = '';
        var actionHtml = '';

        // Determine what to show based on stage + step status
        // Check processing states first, IDLE last

        // Step 1 processing
        if ((stage === 'WEB_PRODUCTS_IMPORTING' || stage === 'WEB_IMPORT_PROCESSING') && s1 !== 'completed') {
            message = 'Importing web products...';
            actionHtml = spinner();
        }
        // Step 1 done, step 2 ready
        else if (s1 === 'completed' && s2 !== 'completed' && s2 !== 'processing') {
            message = 'Products imported. Import orders';
            actionHtml = btn('importOrders', 'Import Orders');
        }
        // Step 2 processing
        else if (stage === 'WEB_ORDERS_IMPORTING' || s2 === 'processing') {
            message = 'Importing web orders...';
            actionHtml = spinner();
        }
        // Step 2 done, orders to export (but not yet exported)
        else if (stage === 'WAITING_FOR_COMAX' && orderCount > 0 && s3 !== 'completed' && !status.comaxOrdersExported) {
            message = orderCount + ' orders to export';
            actionHtml = btn('exportToComax', 'Export Orders');
        }
        // Step 2 done, no orders - skip to step 4
        else if ((stage === 'WAITING_FOR_COMAX' || stage === 'READY_FOR_COMAX_IMPORT') && orderCount === 0 && s4 !== 'completed' && s4 !== 'processing') {
            message = 'No orders. Import Comax products';
            actionHtml = btn('startComaxImport', 'Import Comax');
        }
        // Orders exported, need confirmation
        else if (s3 === 'waiting' && status.comaxOrdersExported) {
            message = 'Orders exported. Confirm upload';
            actionHtml = btn('confirmComax', 'Confirm');
        }
        // Ready for Comax import (either explicit stage OR step 3 completed while waiting)
        else if (stage === 'READY_FOR_COMAX_IMPORT' || (stage === 'WAITING_FOR_COMAX' && s3 === 'completed')) {
            message = 'Import Comax products';
            actionHtml = btn('startComaxImport', 'Import Comax');
        }
        // Comax importing
        else if (stage === 'COMAX_IMPORT_PROCESSING') {
            message = 'Importing Comax products...';
            actionHtml = spinner();
        }
        // Validating
        else if (stage === 'VALIDATING') {
            message = 'Running validation...';
            actionHtml = spinner();
        }
        // Ready for web export
        else if (stage === 'READY_FOR_WEB_EXPORT') {
            message = 'Generate web inventory export';
            actionHtml = btn('generateWebExport', 'Generate');
        }
        // Web export processing
        else if (stage === 'WEB_EXPORT_PROCESSING') {
            message = 'Generating export...';
            actionHtml = spinner();
        }
        // Web export ready for confirmation
        else if (stage === 'WEB_EXPORT_GENERATED') {
            message = 'Export ready. Confirm upload';
            actionHtml = btn('confirmWeb', 'Confirm');
        }
        // Complete
        else if (stage === 'COMPLETE') {
            message = '<span class="text-success">Sync complete</span>';
            if (!previousStepStatuses.syncComplete) {
                addProgressEntry('Daily sync completed', true);
                previousStepStatuses.syncComplete = true;
            }
        }
        // Failed - show retry button
        else if (stage === 'FAILED') {
            message = '<span class="text-danger">Failed: ' + (status.errorMessage || 'Unknown') + '</span>';
            actionHtml = btn('retryFailed', 'Retry');
        }
        // IDLE - no session (check last so processing states take priority)
        else if (stage === 'IDLE' || !status.sessionId) {
            message = 'Start daily sync';
            actionHtml = btn('importProducts', 'Start Import');
        }
        // Fallback - show actual stage for debugging
        else {
            message = 'Stage: ' + stage;
        }

        msgEl.innerHTML = message;
        actionEl.innerHTML = actionHtml;
    }

    function updateInvoiceFolder() {
        google.script.run
            .withSuccessHandler(function(info) {
                var countEl = document.getElementById('invoiceCount');
                var reviewEl = document.getElementById('reviewCount');
                var actionEl = document.getElementById('invoiceAction');
                var iconEl = document.getElementById('invoiceIcon');
                var card = document.getElementById('invoiceCard');

                // Reset card styling
                card.className = 'card h-100';

                var hasIssues = false;

                // Invoice count display
                if (info.count === 0) {
                    countEl.innerHTML = '<span class="text-success">Invoices: 0</span>';
                } else if (info.count > 0) {
                    countEl.innerHTML = '<span class="text-warning">Invoices: ' + info.count + '</span>';
                    hasIssues = true;
                } else {
                    countEl.innerHTML = '<span class="text-muted">Invoices: N/A</span>';
                }

                // Review count display
                var reviewCount = info.reviewCount || 0;
                if (reviewCount === 0) {
                    reviewEl.innerHTML = '<span class="text-success">Reviews: 0</span>';
                } else {
                    reviewEl.innerHTML = '<span class="text-warning">Reviews: ' + reviewCount + '</span>';
                    hasIssues = true;
                }

                // Icon and card styling based on overall status
                if (hasIssues) {
                    iconEl.textContent = '‚ö†Ô∏è';
                    card.classList.add('border-warning');
                    if (info.folderUrl) {
                        actionEl.innerHTML = '<a href="' + info.folderUrl + '" target="_blank" class="small fw-bold text-primary text-decoration-none">Open Folder</a>';
                    }
                } else {
                    iconEl.textContent = '‚úÖ';
                    card.classList.add('border-primary');
                    actionEl.innerHTML = '';
                }
            })
            .withFailureHandler(function(err) {
                console.error('Failed to load pre-sync info:', err);
                document.getElementById('invoiceCount').innerHTML = '<span class="text-danger">Error</span>';
                document.getElementById('reviewCount').innerHTML = '';
            })
            .getInventoryReceiptsInfo();
    }

    function updateStep(stepNum, stepData, isActive, currentStep, extraData) {
        var card = document.getElementById('step' + stepNum + 'Card');
        var icon = document.getElementById('step' + stepNum + 'Icon');
        var message = document.getElementById('step' + stepNum + 'Message');
        var action = document.getElementById('step' + stepNum + 'Action');

        // Reset card styling
        card.className = 'card h-100';

        // Minimal step box display - icon only
        // All details go to shared area and progress log
        message.innerHTML = '';
        action.innerHTML = '';

        if (!stepData) {
            icon.textContent = ICONS.waiting;
            if (isActive || (stepNum === 1 && currentStep === 0)) {
                card.classList.add('border-primary');
            }
            return;
        }

        // Update icon based on status
        icon.textContent = ICONS[stepData.status] || ICONS.waiting;

        // Color code card by status
        if (isActive) {
            card.classList.add('border-primary', 'shadow');
        } else if (stepData.status === 'completed') {
            card.classList.add('border-success', 'bg-light');
        } else if (stepData.status === 'skipped') {
            card.classList.add('border-secondary', 'bg-light');
        } else if (stepData.status === 'failed') {
            card.classList.add('border-danger');
        }
    }

    // Action functions - all check actionInProgress to prevent double-clicks
    function importProducts() {
        if (actionInProgress) return;
        actionInProgress = true;
        lastActionTime = Date.now();
        updateSharedAreaImmediate(1, 'Web Product Import', 'Importing...');

        var step1Card = document.getElementById('step1Card');
        var step1Icon = document.getElementById('step1Icon');
        step1Card.className = 'card h-100 border-primary shadow';
        step1Icon.textContent = 'üîÑ';

        var originalActionTime = lastActionTime;

        google.script.run
            .withSuccessHandler(function(status) {
                actionInProgress = false;
                if (lastActionTime === originalActionTime) {
                    updateUI(status);
                    adjustPolling(status);
                }
            })
            .withFailureHandler(function(err) {
                actionInProgress = false;
                step1Card.classList.add('border-danger');
                step1Icon.textContent = '‚ùå';
                updateSharedAreaImmediate(1, 'Web Product Import', 'Failed: ' + (err.message || err));
            })
            .importWebProductsBackend();
    }

    function importOrders() {
        if (actionInProgress) return;
        actionInProgress = true;
        lastActionTime = Date.now();
        updateSharedAreaImmediate(2, 'Web Order Import', 'Importing...');

        var step2Card = document.getElementById('step2Card');
        var step2Icon = document.getElementById('step2Icon');
        step2Card.className = 'card h-100 border-primary shadow';
        step2Icon.textContent = 'üîÑ';

        var originalActionTime = lastActionTime;

        google.script.run
            .withSuccessHandler(function(status) {
                actionInProgress = false;
                if (lastActionTime === originalActionTime) {
                    updateUI(status);
                    adjustPolling(status);
                }
            })
            .withFailureHandler(function(err) {
                actionInProgress = false;
                step2Card.classList.add('border-danger');
                step2Icon.textContent = '‚ùå';
                updateSharedAreaImmediate(2, 'Web Order Import', 'Failed: ' + (err.message || err));
            })
            .importWebOrdersBackend();
    }

    function exportToComax() {
        if (actionInProgress) return;
        actionInProgress = true;
        lastActionTime = Date.now();
        updateSharedAreaImmediate(3, 'Update Comax Orders', 'Exporting...');

        var step3Card = document.getElementById('step3Card');
        var step3Icon = document.getElementById('step3Icon');
        step3Card.className = 'card h-100 border-primary shadow';
        step3Icon.textContent = 'üîÑ';

        var originalActionTime = lastActionTime;

        google.script.run
            .withSuccessHandler(function(status) {
                actionInProgress = false;
                if (lastActionTime === originalActionTime) {
                    updateUI(status);
                    adjustPolling(status);
                }
            })
            .withFailureHandler(function(err) {
                actionInProgress = false;
                step3Card.classList.add('border-danger');
                step3Icon.textContent = '‚ùå';
                updateSharedAreaImmediate(3, 'Update Comax Orders', 'Failed: ' + (err.message || err));
            })
            .exportComaxOrdersBackend();
    }

    function confirmComax() {
        if (!confirm('Confirm that orders have been uploaded to Comax?')) {
            return;
        }
        if (actionInProgress) return;
        actionInProgress = true;
        lastActionTime = Date.now();
        updateSharedAreaImmediate(3, 'Update Comax Orders', 'Confirming...');

        var step3Card = document.getElementById('step3Card');
        var step3Icon = document.getElementById('step3Icon');
        step3Card.className = 'card h-100 border-primary shadow';
        step3Icon.textContent = 'üîÑ';

        var originalActionTime = lastActionTime;

        google.script.run
            .withSuccessHandler(function(status) {
                actionInProgress = false;
                if (lastActionTime === originalActionTime) {
                    updateUI(status);
                    adjustPolling(status);
                }
            })
            .withFailureHandler(function(err) {
                actionInProgress = false;
                step3Card.classList.add('border-danger');
                step3Icon.textContent = '‚ùå';
                updateSharedAreaImmediate(3, 'Update Comax Orders', 'Failed: ' + (err.message || err));
            })
            .confirmComaxUpdateBackend();
    }

    function startComaxImport() {
        if (actionInProgress) return;
        actionInProgress = true;
        lastActionTime = Date.now();
        updateSharedAreaImmediate(4, 'Import Comax Products', 'Starting...');

        var step4Card = document.getElementById('step4Card');
        var step4Icon = document.getElementById('step4Icon');
        step4Card.className = 'card h-100 border-primary shadow';
        step4Icon.textContent = 'üîÑ';

        var originalActionTime = lastActionTime;

        google.script.run
            .withSuccessHandler(function(status) {
                actionInProgress = false;
                if (lastActionTime === originalActionTime) {
                    updateUI(status);
                    adjustPolling(status);
                }
            })
            .withFailureHandler(function(err) {
                actionInProgress = false;
                step4Card.classList.add('border-danger');
                step4Icon.textContent = '‚ùå';
                updateSharedAreaImmediate(4, 'Import Comax Products', 'Failed: ' + (err.message || err));
            })
            .startComaxImportBackend();
    }

    function generateWebExport() {
        if (actionInProgress) return;
        actionInProgress = true;
        lastActionTime = Date.now();
        updateSharedAreaImmediate(5, 'Update Web Inventory', 'Generating...');

        var step5Card = document.getElementById('step5Card');
        var step5Icon = document.getElementById('step5Icon');
        step5Card.className = 'card h-100 border-primary shadow';
        step5Icon.textContent = 'üîÑ';

        var originalActionTime = lastActionTime;

        google.script.run
            .withSuccessHandler(function(status) {
                actionInProgress = false;
                if (lastActionTime === originalActionTime) {
                    updateUI(status);
                    adjustPolling(status);
                }
            })
            .withFailureHandler(function(err) {
                actionInProgress = false;
                step5Card.classList.add('border-danger');
                step5Icon.textContent = '‚ùå';
                updateSharedAreaImmediate(5, 'Update Web Inventory', 'Failed: ' + (err.message || err));
            })
            .generateWebExportBackend();
    }

    function confirmWeb() {
        if (!confirm('Confirm that web inventory has been uploaded to the website?')) {
            return;
        }
        if (actionInProgress) return;
        actionInProgress = true;
        lastActionTime = Date.now();
        updateSharedAreaImmediate(5, 'Update Web Inventory', 'Confirming...');

        var step5Card = document.getElementById('step5Card');
        var step5Icon = document.getElementById('step5Icon');
        step5Card.className = 'card h-100 border-primary shadow';
        step5Icon.textContent = 'üîÑ';

        var originalActionTime = lastActionTime;

        google.script.run
            .withSuccessHandler(function(status) {
                actionInProgress = false;
                if (lastActionTime === originalActionTime) {
                    updateUI(status);
                    adjustPolling(status);
                }
            })
            .withFailureHandler(function(err) {
                actionInProgress = false;
                step5Card.classList.add('border-danger');
                step5Icon.textContent = '‚ùå';
                updateSharedAreaImmediate(5, 'Update Web Inventory', 'Failed: ' + (err.message || err));
            })
            .confirmWebInventoryUpdateBackend();
    }

    function skipOrders() {
        // Skip order export when there are no orders - calls same backend which handles it
        if (actionInProgress) return;
        actionInProgress = true;
        lastActionTime = Date.now();
        updateSharedAreaImmediate(3, 'Update Comax Orders', 'Skipping (no orders)...');
        addProgressEntry('No orders to export - skipped', true);

        var step3Card = document.getElementById('step3Card');
        var step3Icon = document.getElementById('step3Icon');
        step3Card.className = 'card h-100 border-primary shadow';
        step3Icon.textContent = 'üîÑ';

        var originalActionTime = lastActionTime;

        google.script.run
            .withSuccessHandler(function(status) {
                actionInProgress = false;
                if (lastActionTime === originalActionTime) {
                    updateUI(status);
                    adjustPolling(status);
                }
            })
            .withFailureHandler(function(err) {
                actionInProgress = false;
                step3Card.classList.add('border-danger');
                step3Icon.textContent = '‚ùå';
                updateSharedAreaImmediate(3, 'Update Comax Orders', 'Failed: ' + (err.message || err));
            })
            .exportComaxOrdersBackend();
    }

    function checkForFailures() {
        if (!currentSessionId) return;

        google.script.run
            .withSuccessHandler(function(failures) {
                var banner = document.getElementById('failureBanner');
                var failureList = document.getElementById('failureList');

                // Filter out dismissed failures
                var activeFailures = failures.filter(function(f) {
                    return !dismissedFailures[f.jobType + f.error];
                });

                if (activeFailures.length > 0) {
                    failureList.innerHTML = activeFailures.map(function(f) {
                        return '<div class="mb-1"><strong>' + f.jobType + ':</strong> ' + f.error + '</div>';
                    }).join('');
                    banner.classList.remove('d-none');
                } else {
                    banner.classList.add('d-none');
                }
            })
            .withFailureHandler(function(err) {
                console.error('Failure check error:', err);
            })
            .getRecentFailures(currentSessionId);
    }

    function dismissFailures() {
        var failureList = document.getElementById('failureList');
        if (failureList.innerHTML) {
            var failures = failureList.querySelectorAll('div');
            failures.forEach(function(div) {
                dismissedFailures[div.textContent] = true;
            });
        }
        document.getElementById('failureBanner').classList.add('d-none');
    }

    function resetSync() {
        if (!confirm('Reset the sync workflow? This will clear the current session and all progress.')) {
            return;
        }

        lastActionTime = Date.now();
        document.getElementById('footerStatus').textContent = 'Resetting...';

        // Clear progress log and step tracking
        progressEntries = [];
        previousStepStatuses = {};
        loggedActions = {};
        document.getElementById('progressLog').innerHTML = '';

        google.script.run
            .withSuccessHandler(function(status) {
                updateUI(status);
                adjustPolling(status);
                // Also refresh invoice count after reset
                updateInvoiceFolder();
                document.getElementById('footerStatus').textContent = 'Reset complete';
            })
            .withFailureHandler(function(err) {
                document.getElementById('footerStatus').textContent = 'Reset failed: ' + (err.message || err);
            })
            .resetSyncStateBackend();
    }

    function retryFailed() {
        lastActionTime = Date.now();
        document.getElementById('footerStatus').textContent = 'Retrying...';

        google.script.run
            .withSuccessHandler(function(status) {
                updateUI(status);
                adjustPolling(status);
                document.getElementById('footerStatus').textContent = 'Ready to retry';
            })
            .withFailureHandler(function(err) {
                document.getElementById('footerStatus').textContent = 'Retry failed: ' + (err.message || err);
            })
            .retryFailedStepBackend();
    }

    function refreshStatus() {
        var timeSinceAction = Date.now() - lastActionTime;
        if (timeSinceAction < ACTION_GRACE_PERIOD_MS) {
            return;
        }

        google.script.run
            .withSuccessHandler(function(status) {
                updateUI(status);
                adjustPolling(status);
            })
            .withFailureHandler(function(err) {
                console.error('Poll error:', err);
            })
            .getSyncStateFromBackend();
    }

    function adjustPolling(status) {
        var now = Date.now();
        var timeSinceAction = now - lastActionTime;
        var newInterval;

        if (timeSinceAction < 5000) {
            newInterval = ULTRA_FAST_POLL_MS;
        } else {
            var isActive = status.sessionId && status.currentStep >= 1 && status.currentStep <= 5;
            var anyProcessing = isActive && [status.step1, status.step2, status.step3, status.step4, status.step5]
                .some(function(step) { return step && step.status === 'processing'; });

            if (anyProcessing) {
                newInterval = ACTIVE_POLL_MS;
            } else if (isActive) {
                newInterval = IDLE_POLL_MS;
            } else {
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    currentPollIntervalMs = null;
                    window._syncWidgetPollInterval = null;
                }
                return;
            }
        }

        if (newInterval !== currentPollIntervalMs) {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            currentPollIntervalMs = newInterval;
            pollInterval = setInterval(refreshStatus, newInterval);
            window._syncWidgetPollInterval = pollInterval;
        }
    }

    // Expose public API on window
    window.SyncWidget = {
        importProducts: importProducts,
        importOrders: importOrders,
        exportToComax: exportToComax,
        skipOrders: skipOrders,
        confirmComax: confirmComax,
        startComaxImport: startComaxImport,
        generateWebExport: generateWebExport,
        confirmWeb: confirmWeb,
        resetSync: resetSync,
        retryFailed: retryFailed,
        dismissFailures: dismissFailures
    };

    // Initialize widget
    console.log('SyncWidget: Initializing (fresh load or navigation)');
    refreshStatus();
    updateInvoiceFolder();

})();
</script>
