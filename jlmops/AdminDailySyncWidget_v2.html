<style>
    .sync-card-title {
        height: 3rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    .sync-icon {
        font-size: 1.6rem;
        margin: 0.5rem 0;
    }
</style>

<div class="card shadow-sm mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div class="text-start">
            <span id="sessionIdDisplay" class="small text-muted"></span>
        </div>
        <div class="text-end">
            <a href="#" id="resetSyncLink" onclick="window.SyncWidget.resetSync(); return false;" class="text-decoration-none text-secondary fw-bold">Reset</a>
        </div>
    </div>
    <div class="card-body">

        <!-- 6-Step Display (Invoices + 5 Steps) -->
        <div class="row row-cols-6 g-2 mb-3">
            <!-- Step 0: Pre-Sync Status -->
            <div class="col">
                <div class="card h-100" id="invoiceCard">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">Pre-Sync</h6>
                        <div id="invoiceIcon" class="sync-icon">üìÅ</div>
                        <div id="invoiceMessage" class="small">
                            <div><span id="invoiceCount" class="fw-bold">...</span></div>
                            <div><span id="reviewCount" class="fw-bold">...</span></div>
                        </div>
                        <div id="invoiceAction" class="mt-1"></div>
                    </div>
                </div>
            </div>
            <!-- Step 1: Web Product Import -->
            <div class="col">
                <div class="card h-100" id="step1Card">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">1. Web Product Import</h6>
                        <div id="step1Icon" class="sync-icon">‚è∏Ô∏è</div>
                        <div id="step1Message" class="text-muted small"></div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Web Order Import -->
            <div class="col">
                <div class="card h-100" id="step2Card">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">2. Web Order Import</h6>
                        <div id="step2Icon" class="sync-icon">‚è∏Ô∏è</div>
                        <div id="step2Message" class="text-muted small"></div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Update Comax Orders -->
            <div class="col">
                <div class="card h-100" id="step3Card">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">3. Update Comax Orders</h6>
                        <div id="step3Icon" class="sync-icon">‚è∏Ô∏è</div>
                        <div id="step3Message" class="text-muted small"></div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Import Comax Products -->
            <div class="col">
                <div class="card h-100" id="step4Card">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">4. Import Comax Products</h6>
                        <div id="step4Icon" class="sync-icon">‚è∏Ô∏è</div>
                        <div id="step4Message" class="text-muted small"></div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Update Web Inventory -->
            <div class="col">
                <div class="card h-100" id="step5Card">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">5. Update Web Inventory</h6>
                        <div id="step5Icon" class="sync-icon">‚è∏Ô∏è</div>
                        <div id="step5Message" class="text-muted small"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shared Message & Action Area -->
        <div class="card mt-3 border-primary">
            <div class="card-body py-3 row align-items-center">
                <div id="sharedMessage" class="col-4">
                    <span class="text-muted">Ready to start sync</span>
                </div>
                <div id="sharedAction" class="col-4 text-center">
                    <!-- Action button rendered here -->
                </div>
                <div class="col-4"></div>
            </div>
        </div>

        <!-- Progress Log -->
        <div id="progressLog" class="mt-2 text-muted" style="font-size: 1rem;"></div>

        <!-- Error Display -->
        <div id="errorDisplay" class="alert alert-danger d-none"></div>
    </div>
    <div class="card-footer text-muted" id="footerStatus">
        Ready
    </div>
</div>

<script>
(function() {
    'use strict';

    // Clear any existing interval from previous widget instance
    if (window._syncWidgetPollInterval) {
        clearInterval(window._syncWidgetPollInterval);
        window._syncWidgetPollInterval = null;
    }

    // Reset all widget state on load
    window._lastLoggedStatus = null;
    window.lastMessageTimestamp = 0;

    // Module state
    var currentSessionId = null;
    var pollInterval = null;
    var currentPollIntervalMs = null;
    var progressEntries = [];
    var previousStepStatuses = {};
    var lastActionTimestamp = null;

    // Constants
    var ACTIVE_POLL_MS = 1000;
    var IDLE_POLL_MS = 10000;

    var ICONS = {
        waiting: '‚è∏Ô∏è',
        processing: 'üîÑ',
        completed: '‚úÖ',
        skipped: '‚è≠Ô∏è',
        failed: '‚ùå'
    };

    var actionInProgress = false;
    var loggedActions = {};

    // =====================================================================
    //  STAGE CONFIG LOOKUP TABLE ‚Äî Single source of truth for UI rendering
    // =====================================================================

    var STAGE_CONFIG = {
        IDLE:                   { message: 'Start daily sync',                     button: ['importProducts', 'Start Import'] },
        IMPORTING_PRODUCTS:     { message: 'Importing products...',                button: null, spinner: true },
        IMPORTING_ORDERS:       { message: 'Products imported. Import orders',     button: ['importOrders', 'Import Orders'] },
        WAITING_ORDER_EXPORT:   { message: '{count} orders to export',             button: ['exportToComax', 'Export Orders'] },
        EXPORTING_ORDERS:       { message: 'Exporting orders...',                  button: null, spinner: true },
        WAITING_ORDER_CONFIRM:  { message: 'Upload to Comax, then confirm',       button: ['confirmComax', 'Confirm'], confirm: true },
        WAITING_COMAX_IMPORT:   { message: 'Import Comax products',               button: ['startComaxImport', 'Import Comax'] },
        IMPORTING_COMAX:        { message: 'Importing Comax products...',          button: null, spinner: true },
        VALIDATING:             { message: 'Running validation...',                button: null, spinner: true },
        WAITING_WEB_EXPORT:     { message: 'Generate web inventory export',        button: ['generateWebExport', 'Generate'] },
        GENERATING_WEB_EXPORT:  { message: 'Generating export...',                 button: null, spinner: true },
        WAITING_WEB_CONFIRM:    { message: 'Upload to website, then confirm',      button: ['confirmWeb', 'Confirm'], confirm: true },
        COMPLETE:               { message: '<span class="text-success">Sync complete</span>', button: null },
        FAILED:                 { message: 'Failed: {error}',                      button: ['retryFailed', 'Retry'] }
    };

    // =====================================================================
    //  UI UPDATE
    // =====================================================================

    function updateUI(status) {
        currentSessionId = status.sessionId;

        // Session display
        document.getElementById('sessionIdDisplay').textContent =
            status.sessionId ? 'Session: ' + status.sessionId : '';

        // Update step cards
        var steps = status.steps || {};
        for (var i = 1; i <= 5; i++) {
            updateStepCard(i, steps['step' + i]);
        }

        // Log progress on step transitions
        logStepTransitions(steps);

        // Update footer
        document.getElementById('footerStatus').textContent = status.lastUpdated ?
            'Last updated: ' + new Date(status.lastUpdated).toLocaleString('he-IL', { timeZone: 'Asia/Jerusalem' }) : 'Ready';

        // Update shared message/action from stage lookup
        updateSharedArea(status);
    }

    function updateStepCard(stepNum, stepData) {
        var card = document.getElementById('step' + stepNum + 'Card');
        var icon = document.getElementById('step' + stepNum + 'Icon');
        var message = document.getElementById('step' + stepNum + 'Message');

        card.className = 'card h-100';
        message.innerHTML = '';

        if (!stepData) {
            icon.textContent = ICONS.waiting;
            return;
        }

        icon.textContent = ICONS[stepData.status] || ICONS.waiting;
        message.innerHTML = stepData.message || '';

        if (stepData.status === 'completed') {
            card.classList.add('border-success', 'bg-light');
        } else if (stepData.status === 'skipped') {
            card.classList.add('border-secondary', 'bg-light');
        } else if (stepData.status === 'failed') {
            card.classList.add('border-danger');
        } else if (stepData.status === 'processing') {
            card.classList.add('border-primary', 'shadow');
        }
    }

    function updateSharedArea(status) {
        var msgEl = document.getElementById('sharedMessage');
        var actionEl = document.getElementById('sharedAction');
        var stage = status.stage || 'IDLE';

        var config = STAGE_CONFIG[stage];
        if (!config) {
            msgEl.innerHTML = 'Stage: ' + stage;
            actionEl.innerHTML = '';
            return;
        }

        // Build message with template substitutions
        var message = config.message;
        message = message.replace('{count}', status.ordersPendingExportCount || 0);
        message = message.replace('{error}', '<span class="text-danger">' + (status.errorMessage || 'Unknown') + '</span>');

        // Add filename context for confirm stages
        if (stage === 'WAITING_ORDER_CONFIRM' && status.comaxOrderExportFilename) {
            message = 'Export: ' + status.comaxOrderExportFilename + '. Upload to Comax, then confirm';
        }
        if (stage === 'WAITING_WEB_CONFIRM' && status.webExportFilename) {
            message = 'Export: ' + status.webExportFilename + '. Upload to website, then confirm';
        }

        msgEl.innerHTML = message;

        // Build action button or spinner
        if (config.spinner) {
            actionEl.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
        } else if (config.button) {
            var buttons = btn(config.button[0], config.button[1]);
            if (config.altButton) {
                buttons += ' ' + btn(config.altButton[0], config.altButton[1]);
            }
            actionEl.innerHTML = buttons;
        } else {
            actionEl.innerHTML = '';
        }

        // Log sync complete once
        if (stage === 'COMPLETE' && !previousStepStatuses.syncComplete) {
            addProgressEntry('Daily sync completed', true);
            previousStepStatuses.syncComplete = true;
        }
    }

    function btn(action, label) {
        return '<button class="btn btn-sm" onclick="window.SyncWidget.' + action + '(); return false;">' + label + '</button>';
    }

    function addProgressEntry(text, isSuccess) {
        var key = text.replace(/\d+:\d+:\d+ [AP]M/g, '').trim();
        if (loggedActions[key]) return;
        loggedActions[key] = true;

        var icon = isSuccess ? '‚úì' : '‚Ä¢';
        var cls = isSuccess ? 'text-success' : 'text-muted';
        var time = new Date().toLocaleTimeString('he-IL', { timeZone: 'Asia/Jerusalem' });
        progressEntries.push('<span class="' + cls + '">' + icon + ' ' + time + ' - ' + text + '</span>');
        if (progressEntries.length > 10) progressEntries.shift();
        document.getElementById('progressLog').innerHTML = progressEntries.join('<br>');
    }

    function logStepTransitions(steps) {
        var stepNames = {
            1: 'Web products',
            2: 'Web orders',
            3: 'Comax orders',
            4: 'Comax products',
            5: 'Web inventory'
        };

        for (var i = 1; i <= 5; i++) {
            var stepData = steps['step' + i];
            var newStatus = stepData ? stepData.status : null;
            var prevStatus = previousStepStatuses['step' + i];
            var msg = stepData ? stepData.message : '';

            if (newStatus === 'completed' && prevStatus !== 'completed') {
                addProgressEntry(stepNames[i] + ' - ' + (msg || 'completed'), true);
            } else if (newStatus === 'skipped' && prevStatus !== 'skipped') {
                addProgressEntry(stepNames[i] + ' - skipped', true);
            }

            previousStepStatuses['step' + i] = newStatus;
        }
    }

    // =====================================================================
    //  INVOICE FOLDER (Pre-Sync card)
    // =====================================================================

    function updateInvoiceFolder() {
        google.script.run
            .withSuccessHandler(function(info) {
                var countEl = document.getElementById('invoiceCount');
                var reviewEl = document.getElementById('reviewCount');
                var actionEl = document.getElementById('invoiceAction');
                var iconEl = document.getElementById('invoiceIcon');
                var card = document.getElementById('invoiceCard');

                card.className = 'card h-100';
                var hasIssues = false;

                if (info.count === 0) {
                    countEl.innerHTML = '<span class="text-success">Invoices: 0</span>';
                } else if (info.count > 0) {
                    countEl.innerHTML = '<span class="text-warning">Invoices: ' + info.count + '</span>';
                    hasIssues = true;
                } else {
                    countEl.innerHTML = '<span class="text-muted">Invoices: N/A</span>';
                }

                var reviewCount = info.reviewCount || 0;
                if (reviewCount === 0) {
                    reviewEl.innerHTML = '<span class="text-success">Reviews: 0</span>';
                } else {
                    reviewEl.innerHTML = '<span class="text-warning">Reviews: ' + reviewCount + '</span>';
                    hasIssues = true;
                }

                if (hasIssues) {
                    iconEl.textContent = '‚ö†Ô∏è';
                    card.classList.add('border-warning');
                    if (info.folderUrl) {
                        actionEl.innerHTML = '<a href="' + info.folderUrl + '" target="_blank" class="small fw-bold text-primary text-decoration-none">Open Folder</a>';
                    }
                } else {
                    iconEl.textContent = '‚úÖ';
                    card.classList.add('border-primary');
                    actionEl.innerHTML = '';
                }
            })
            .withFailureHandler(function(err) {
                console.error('Failed to load pre-sync info:', err);
                document.getElementById('invoiceCount').innerHTML = '<span class="text-danger">Error</span>';
                document.getElementById('reviewCount').innerHTML = '';
            })
            .getInventoryReceiptsInfo();
    }

    // =====================================================================
    //  ACTION FUNCTIONS
    // =====================================================================

    var lastError = null;
    var actionTimeout = null;

    function runAction(backendFn, stepNum, actionLabel) {
        // Immediately disable button to prevent double-clicks
        var actionBtns = document.querySelectorAll('#sharedAction button');
        actionBtns.forEach(function(b) { b.disabled = true; });

        if (actionInProgress) {
            console.warn('SyncWidget: Action blocked - previous action still in progress');
            document.getElementById('footerStatus').textContent = 'Previous action still running...';
            return;
        }
        actionInProgress = true;
        lastError = null;
        console.log('SyncWidget: Running ' + backendFn);

        // Immediate UI feedback
        var msgEl = document.getElementById('sharedMessage');
        var actionEl = document.getElementById('sharedAction');
        msgEl.innerHTML = '<strong>' + actionLabel + '</strong>';
        actionEl.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
        document.getElementById('footerStatus').textContent = actionLabel;

        if (stepNum) {
            var card = document.getElementById('step' + stepNum + 'Card');
            var icon = document.getElementById('step' + stepNum + 'Icon');
            card.className = 'card h-100 border-primary shadow';
            icon.textContent = 'üîÑ';
        }

        // Safety: reset actionInProgress after 2 minutes if handler never fires
        if (actionTimeout) clearTimeout(actionTimeout);
        actionTimeout = setTimeout(function() {
            if (actionInProgress) {
                console.error('SyncWidget: Action timed out after 2 minutes');
                actionInProgress = false;
                document.getElementById('footerStatus').textContent = 'Action timed out - refreshing...';
                refreshNow();
            }
        }, 120000);

        google.script.run
            .withSuccessHandler(function(status) {
                if (actionTimeout) clearTimeout(actionTimeout);
                actionInProgress = false;
                console.log('SyncWidget: ' + backendFn + ' succeeded. Stage: ' + (status && status.stage));
                // Build progress message with context from status
                var progressMsg = actionLabel + ' - done';
                if (status.webExportFilename && status.webExportFilename !== 'No Changes Detected') {
                    progressMsg = 'Export file: ' + status.webExportFilename;
                }
                if (status.ordersPendingExportCount > 0 && backendFn === 'importWebOrdersBackend') {
                    progressMsg = 'Orders imported. ' + status.ordersPendingExportCount + ' ready for export';
                }
                addProgressEntry(progressMsg, true);
                lastActionTimestamp = status.lastUpdated;
                updateUI(status);
                adjustPolling(status);
            })
            .withFailureHandler(function(err) {
                if (actionTimeout) clearTimeout(actionTimeout);
                actionInProgress = false;
                var errorMsg = err.message || String(err);
                lastError = errorMsg;
                console.error('SyncWidget: ' + backendFn + ' failed:', errorMsg);
                if (stepNum) {
                    document.getElementById('step' + stepNum + 'Card').classList.add('border-danger');
                    document.getElementById('step' + stepNum + 'Icon').textContent = '‚ùå';
                }
                msgEl.innerHTML = '<span class="text-danger">Failed: ' + errorMsg + '</span>';
                actionEl.innerHTML = '<button class="btn btn-sm" onclick="window.SyncWidget.refreshNow(); return false;">Refresh</button>';
                addProgressEntry('ERROR: ' + actionLabel + ' - ' + errorMsg, false);
                document.getElementById('footerStatus').textContent = 'Action failed - see error above';
            })
            [backendFn]();
    }

    function importProducts() {
        runAction('importWebProductsBackend', 1, 'Importing products...');
    }

    function importOrders() {
        runAction('importWebOrdersBackend', 2, 'Importing orders...');
    }

    function exportToComax() {
        runAction('exportComaxOrdersBackend', 3, 'Exporting orders...');
    }

    function confirmComax() {
        if (!confirm('Confirm that orders have been uploaded to Comax?')) return;
        runAction('confirmComaxUpdateBackend', 3, 'Confirming...');
    }

    function startComaxImport() {
        runAction('startComaxImportBackend', 4, 'Importing Comax products...');
    }

    function generateWebExport() {
        runAction('generateWebExportBackend', 5, 'Generating export...');
    }

    function confirmWeb() {
        if (!confirm('Confirm that web inventory has been uploaded to the website?')) return;
        runAction('confirmWebInventoryUpdateBackend', 5, 'Confirming...');
    }

    function retryFailed() {
        document.getElementById('footerStatus').textContent = 'Retrying...';

        google.script.run
            .withSuccessHandler(function(status) {
                updateUI(status);
                adjustPolling(status);
                document.getElementById('footerStatus').textContent = 'Ready to retry';
            })
            .withFailureHandler(function(err) {
                document.getElementById('footerStatus').textContent = 'Retry failed: ' + (err.message || err);
            })
            .retryFailedStepBackend();
    }

    function resetSync() {
        if (!confirm('Reset the sync workflow? This will clear the current session and all progress.')) return;

        document.getElementById('footerStatus').textContent = 'Resetting...';

        progressEntries = [];
        previousStepStatuses = {};
        loggedActions = {};
        document.getElementById('progressLog').innerHTML = '';

        google.script.run
            .withSuccessHandler(function(status) {
                updateUI(status);
                adjustPolling(status);
                updateInvoiceFolder();
                document.getElementById('footerStatus').textContent = 'Reset complete';
            })
            .withFailureHandler(function(err) {
                document.getElementById('footerStatus').textContent = 'Reset failed: ' + (err.message || err);
            })
            .resetSyncStateBackend();
    }

    // =====================================================================
    //  POLLING
    // =====================================================================

    function refreshStatus() {
        // Don't poll while error is showing
        if (lastError) return;

        google.script.run
            .withSuccessHandler(function(status) {
                if (actionInProgress) {
                    // Update step cards and progress ‚Äî but NOT the action area
                    var steps = status.steps || {};
                    for (var i = 1; i <= 5; i++) {
                        updateStepCard(i, steps['step' + i]);
                    }
                    logStepTransitions(steps);

                    // Update message to reflect current backend stage
                    var stage = status.stage || 'IDLE';
                    var config = STAGE_CONFIG[stage];
                    if (config) {
                        var message = config.message;
                        message = message.replace('{count}', status.ordersPendingExportCount || 0);
                        message = message.replace('{error}', '<span class="text-danger">'
                            + (status.errorMessage || 'Unknown') + '</span>');
                        document.getElementById('sharedMessage').innerHTML = message;
                    }

                    // Update footer timestamp
                    document.getElementById('footerStatus').textContent = status.lastUpdated
                        ? 'Last updated: ' + new Date(status.lastUpdated).toLocaleString(
                            'he-IL', { timeZone: 'Asia/Jerusalem' })
                        : 'Processing...';

                    adjustPolling(status);
                    return;
                }
                // Discard stale poll responses that pre-date the last action
                if (lastActionTimestamp && status.lastUpdated &&
                    new Date(status.lastUpdated) < new Date(lastActionTimestamp)) {
                    console.log('SyncWidget: Discarding stale poll (polled: ' + status.lastUpdated + ', action: ' + lastActionTimestamp + ')');
                    return;
                }
                lastActionTimestamp = null;
                // Normal path (no action running): full UI update
                updateUI(status);
                adjustPolling(status);
            })
            .withFailureHandler(function(err) {
                console.error('Poll error:', err);
            })
            .getSyncStateFromBackend();
    }

    function adjustPolling(status) {
        var stage = status.stage || 'IDLE';
        var config = STAGE_CONFIG[stage];
        var newInterval;

        // Processing stages (spinner) = fast poll
        if (config && config.spinner) {
            newInterval = ACTIVE_POLL_MS;
        }
        // Active session but waiting for user = slow poll
        else if (status.sessionId && stage !== 'IDLE' && stage !== 'COMPLETE') {
            newInterval = IDLE_POLL_MS;
        }
        // No session or complete = stop polling
        else {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
                currentPollIntervalMs = null;
                window._syncWidgetPollInterval = null;
            }
            return;
        }

        if (newInterval !== currentPollIntervalMs) {
            if (pollInterval) clearInterval(pollInterval);
            currentPollIntervalMs = newInterval;
            pollInterval = setInterval(refreshStatus, newInterval);
            window._syncWidgetPollInterval = pollInterval;
        }
    }

    // =====================================================================
    //  PUBLIC API & INIT
    // =====================================================================

    function refreshNow() {
        lastError = null;
        refreshStatus();
    }

    window.SyncWidget = {
        importProducts: importProducts,
        importOrders: importOrders,
        exportToComax: exportToComax,
        confirmComax: confirmComax,
        startComaxImport: startComaxImport,
        generateWebExport: generateWebExport,
        confirmWeb: confirmWeb,
        resetSync: resetSync,
        retryFailed: retryFailed,
        refreshNow: refreshNow
    };

    console.log('SyncWidget: Initializing (stage-based state machine)');
    refreshStatus();
    updateInvoiceFolder();

})();
</script>
