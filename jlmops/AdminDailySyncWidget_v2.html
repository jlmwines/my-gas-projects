<style>
    .sync-card-title {
        height: 3rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    .sync-icon {
        font-size: 1.6rem;
        margin: 0.5rem 0;
    }
</style>

<div class="card shadow-sm mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div class="text-start">
            <span id="sessionIdDisplay" class="small text-muted"></span>
        </div>
        <div class="text-end">
            <a href="#" id="resetSyncLink" onclick="window.SyncWidget.resetSync(); return false;" class="text-decoration-none text-secondary fw-bold">Reset</a>
        </div>
    </div>
    <div class="card-body">

        <!-- Failure Banner -->
        <div id="failureBanner" class="alert alert-danger d-none mb-3">
            <button type="button" class="close float-end" onclick="window.SyncWidget.dismissFailures()" style="background:none;border:none;font-size:1.2rem;line-height:1;opacity:0.7;">&times;</button>
            <strong>Import Failures:</strong>
            <span id="failureList"></span>
        </div>

        <!-- 6-Step Display (Invoices + 5 Steps) -->
        <div class="row row-cols-6 g-2 mb-3">
            <!-- Step 0: Invoices -->
            <div class="col">
                <div class="card h-100" id="invoiceCard">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">Comax Invoices</h6>
                        <div id="invoiceIcon" class="sync-icon">üìÅ</div>
                        <div id="invoiceMessage" class="small">
                            <span id="invoiceCount" class="fw-bold">...</span>
                        </div>
                        <div id="invoiceAction" class="mt-1"></div>
                    </div>
                </div>
            </div>
            <!-- Step 1: Import Web Products -->
            <div class="col">
                <div class="card h-100" id="step1Card">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">1. Web Products</h6>
                        <div id="step1Icon" class="sync-icon">‚è∏Ô∏è</div>
                        <div id="step1Message" class="text-muted small">Pending...</div>
                        <div id="step1Action"></div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Import Web Orders -->
            <div class="col">
                <div class="card h-100" id="step2Card">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">2. Web Orders</h6>
                        <div id="step2Icon" class="sync-icon">‚è∏Ô∏è</div>
                        <div id="step2Message" class="text-muted small">Auto-import</div>
                        <div id="step2Action"></div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Export to Comax -->
            <div class="col">
                <div class="card h-100" id="step3Card">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">3. Order Export</h6>
                        <div id="step3Icon" class="sync-icon">‚è∏Ô∏è</div>
                        <div id="step3Message" class="text-muted small">Pending...</div>
                        <div id="step3Action"></div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Import Comax Data -->
            <div class="col">
                <div class="card h-100" id="step4Card">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">4. Comax Products</h6>
                        <div id="step4Icon" class="sync-icon">‚è∏Ô∏è</div>
                        <div id="step4Message" class="text-muted small">Pending...</div>
                        <div id="step4Action"></div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Export Web Inventory -->
            <div class="col">
                <div class="card h-100" id="step5Card">
                    <div class="card-body p-2 text-center">
                        <h6 class="card-title sync-card-title">5. Web Inventory</h6>
                        <div id="step5Icon" class="sync-icon">‚è∏Ô∏è</div>
                        <div id="step5Message" class="text-muted small">Pending...</div>
                        <div id="step5Action"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Display -->
        <div id="errorDisplay" class="alert alert-danger d-none"></div>
    </div>
    <div class="card-footer text-muted" id="footerStatus">
        Ready
    </div>
</div>

<script>
(function() {
    'use strict';

    // Clear any existing interval from previous widget instance
    if (window._syncWidgetPollInterval) {
        clearInterval(window._syncWidgetPollInterval);
        window._syncWidgetPollInterval = null;
    }

    // Reset all widget state on load
    window._lastLoggedStatus = null;
    window.lastMessageTimestamp = 0;

    // Module state
    var currentSessionId = null;
    var pollInterval = null;
    var lastActionTime = 0;
    var currentPollIntervalMs = null;
    var dismissedFailures = {};

    // Constants
    var ULTRA_FAST_POLL_MS = 500;
    var ACTIVE_POLL_MS = 1000;
    var IDLE_POLL_MS = 10000;
    var ACTION_GRACE_PERIOD_MS = 5000;

    var ICONS = {
        waiting: '‚è∏Ô∏è',
        processing: 'üîÑ',
        completed: '‚úÖ',
        failed: '‚ùå'
    };

    function updateUI(status) {
        var now = Date.now();

        // Don't overwrite recent user actions
        if (now - lastActionTime < ACTION_GRACE_PERIOD_MS) {
            return;
        }

        // Track message timestamps to prevent stale overwrites
        var messageTimestamp = new Date(status.lastUpdated || 0).getTime();
        var currentMessageTimestamp = window.lastMessageTimestamp || 0;

        if (messageTimestamp > 0 && messageTimestamp <= currentMessageTimestamp) {
            return;
        }

        window.lastMessageTimestamp = messageTimestamp;

        currentSessionId = status.sessionId;

        // Update session display
        document.getElementById('sessionIdDisplay').textContent = status.sessionId ? 'Session: ' + status.sessionId : '';

        // Update each step
        updateStep(1, status.step1, status.currentStep === 1);
        updateStep(2, status.step2, status.currentStep === 2);
        updateStep(3, status.step3, status.currentStep === 3);
        updateStep(4, status.step4, status.currentStep === 4);
        updateStep(5, status.step5, status.currentStep === 5);

        // Update footer
        document.getElementById('footerStatus').textContent = status.lastUpdated ?
            'Last updated: ' + new Date(status.lastUpdated).toLocaleTimeString() : 'Ready';

        // Check for any failures (only if session active)
        if (status.sessionId) {
            checkForFailures();
        }
    }

    function updateInvoiceFolder() {
        google.script.run
            .withSuccessHandler(function(info) {
                var countEl = document.getElementById('invoiceCount');
                var actionEl = document.getElementById('invoiceAction');
                var iconEl = document.getElementById('invoiceIcon');

                if (info.count === 0) {
                    countEl.innerHTML = '<span class="text-success">0 files</span>';
                    iconEl.textContent = '‚úÖ';
                    actionEl.innerHTML = '';
                } else if (info.count > 0) {
                    countEl.innerHTML = '<span class="text-warning">' + info.count + ' file' + (info.count > 1 ? 's' : '') + '</span>';
                    iconEl.textContent = '‚ö†Ô∏è';
                    if (info.folderUrl) {
                        actionEl.innerHTML = '<a href="' + info.folderUrl + '" target="_blank" class="small fw-bold text-primary text-decoration-none">Open Folder</a>';
                    }
                } else {
                    countEl.innerHTML = '<span class="text-muted">N/A</span>';
                    iconEl.textContent = 'üìÅ';
                }
            })
            .withFailureHandler(function(err) {
                console.error('Failed to load invoice count:', err);
                document.getElementById('invoiceCount').innerHTML = '<span class="text-danger">Error</span>';
            })
            .getInventoryReceiptsInfo();
    }

    function updateStep(stepNum, stepData, isActive) {
        var card = document.getElementById('step' + stepNum + 'Card');
        var icon = document.getElementById('step' + stepNum + 'Icon');
        var message = document.getElementById('step' + stepNum + 'Message');
        var action = document.getElementById('step' + stepNum + 'Action');

        // Reset card styling
        card.className = 'card h-100';

        if (!stepData) {
            // No data yet - waiting
            icon.textContent = ICONS.waiting;
            message.textContent = 'Pending...';
            action.innerHTML = '';
            // Show appropriate action for each step
            if (stepNum === 1) {
                action.innerHTML = '<a href="#" onclick="window.SyncWidget.importProducts(); return false;" class="d-block fw-bold text-primary text-decoration-none mt-2">Import Products</a>';
            } else if (stepNum === 2) {
                action.innerHTML = '<a href="#" onclick="window.SyncWidget.importOrders(); return false;" class="d-block fw-bold text-primary text-decoration-none mt-2">Import Now</a>';
                message.textContent = 'Auto-import';
            } else if (stepNum === 3) {
                action.innerHTML = '<a href="#" onclick="window.SyncWidget.exportToComax(); return false;" class="d-block fw-bold text-primary text-decoration-none mt-2">Export Orders</a>';
            } else if (stepNum === 4) {
                action.innerHTML = '<a href="#" onclick="window.SyncWidget.startComaxImport(); return false;" class="d-block fw-bold text-primary text-decoration-none mt-2">Start Import</a>';
            } else if (stepNum === 5) {
                action.innerHTML = '<a href="#" onclick="window.SyncWidget.generateWebExport(); return false;" class="d-block fw-bold text-primary text-decoration-none mt-2">Generate Export</a>';
            }
            return;
        }

        // Update icon and message
        icon.textContent = ICONS[stepData.status] || ICONS.waiting;
        message.textContent = stepData.message || stepData.status;

        // Highlight active step
        if (isActive) {
            card.classList.add('border-primary', 'shadow');
        }

        // Handle action links based on step and status
        if (stepData.status === 'waiting') {
            if (stepNum === 1) {
                action.innerHTML = '<a href="#" onclick="window.SyncWidget.importProducts(); return false;" class="d-block fw-bold text-primary text-decoration-none mt-1">Import Products</a>';
            } else if (stepNum === 2) {
                action.innerHTML = '<a href="#" onclick="window.SyncWidget.importOrders(); return false;" class="d-block fw-bold text-primary text-decoration-none mt-1">Import Now</a>';
            } else if (stepNum === 3) {
                var isExportComplete = stepData.message && stepData.message.indexOf('Ready to confirm') !== -1;
                if (isExportComplete) {
                    action.innerHTML = '<a href="#" onclick="window.SyncWidget.exportToComax(); return false;" class="d-block fw-bold text-primary text-decoration-none mt-1">Export Orders</a>' +
                        '<a href="#" onclick="window.SyncWidget.confirmComax(); return false;" class="d-block fw-bold text-success text-decoration-none mt-1">Confirm Upload</a>';
                } else {
                    action.innerHTML = '<a href="#" onclick="window.SyncWidget.exportToComax(); return false;" class="d-block fw-bold text-primary text-decoration-none mt-1">Export Orders</a>';
                }
            } else if (stepNum === 4) {
                action.innerHTML = '<a href="#" onclick="window.SyncWidget.startComaxImport(); return false;" class="d-block fw-bold text-primary text-decoration-none mt-1">Start Import</a>';
            } else if (stepNum === 5) {
                var isExportComplete5 = stepData.message && stepData.message.indexOf('Ready to confirm') !== -1;
                if (isExportComplete5) {
                    action.innerHTML = '<a href="#" onclick="window.SyncWidget.generateWebExport(); return false;" class="d-block fw-bold text-primary text-decoration-none mt-1">Generate Export</a>' +
                        '<a href="#" onclick="window.SyncWidget.confirmWeb(); return false;" class="d-block fw-bold text-success text-decoration-none mt-1">Confirm Upload</a>';
                } else {
                    action.innerHTML = '<a href="#" onclick="window.SyncWidget.generateWebExport(); return false;" class="d-block fw-bold text-primary text-decoration-none mt-1">Generate Export</a>';
                }
            } else {
                action.innerHTML = '';
            }
        } else if (stepData.status === 'processing') {
            action.innerHTML = '<div class="spinner-border spinner-border-sm mt-2" role="status"></div>';
        } else {
            action.innerHTML = '';
        }

        // Color code by status
        if (stepData.status === 'completed') {
            card.classList.add('bg-light');
        } else if (stepData.status === 'failed') {
            card.classList.add('border-danger');
        }
    }

    // Action functions
    function importProducts() {
        var timestamp = new Date().toLocaleTimeString();
        lastActionTime = Date.now();
        doImportProducts(timestamp);
    }

    function doImportProducts(timestamp) {
        var step1Card = document.getElementById('step1Card');
        var step1Action = document.getElementById('step1Action');
        var step1Icon = document.getElementById('step1Icon');
        var step1Message = document.getElementById('step1Message');

        step1Action.innerHTML = '<div class="spinner-border spinner-border-sm mt-2" role="status"></div><div class="small text-muted mt-1">' + timestamp + '</div>';
        step1Icon.textContent = 'üîÑ';
        step1Message.innerHTML = '<strong>Importing products...</strong> <small class="text-muted">(' + timestamp + ')</small>';

        var originalActionTime = lastActionTime;

        google.script.run
            .withSuccessHandler(function(status) {
                if (lastActionTime === originalActionTime) {
                    updateUI(status);
                    adjustPolling(status);
                }
            })
            .withFailureHandler(function(err) {
                step1Card.style.borderColor = '#dc3545';
                step1Message.innerHTML = '<span class="text-danger">Failed: ' + (err.message || err) + '</span>';
                step1Action.innerHTML = '<a href="#" onclick="window.SyncWidget.importProducts(); return false;" class="small">Retry</a>';
            })
            .importWebProductsBackend();
    }

    function importOrders() {
        var timestamp = new Date().toLocaleTimeString();
        lastActionTime = Date.now();

        var step2Card = document.getElementById('step2Card');
        var step2Action = document.getElementById('step2Action');
        var step2Icon = document.getElementById('step2Icon');
        var step2Message = document.getElementById('step2Message');

        step2Card.style.borderColor = '#0d6efd';
        step2Card.style.borderWidth = '2px';
        step2Action.innerHTML = '<div class="spinner-border spinner-border-sm mt-2" role="status"></div><div class="small text-muted mt-1">' + timestamp + '</div>';
        step2Icon.textContent = 'üîÑ';
        step2Message.innerHTML = '<strong>Importing orders...</strong> <small class="text-muted">(' + timestamp + ')</small>';

        var originalActionTime = lastActionTime;

        google.script.run
            .withSuccessHandler(function(status) {
                if (lastActionTime === originalActionTime) {
                    updateUI(status);
                    adjustPolling(status);
                }
            })
            .withFailureHandler(function(err) {
                step2Card.style.borderColor = '#dc3545';
                step2Message.innerHTML = '<span class="text-danger">Failed: ' + (err.message || err) + '</span>';
                step2Action.innerHTML = '<a href="#" onclick="window.SyncWidget.importOrders(); return false;" class="small">Retry</a>';
            })
            .importWebOrdersBackend();
    }

    function exportToComax() {
        var timestamp = new Date().toLocaleTimeString();
        lastActionTime = Date.now();

        var step3Card = document.getElementById('step3Card');
        var step3Action = document.getElementById('step3Action');
        var step3Icon = document.getElementById('step3Icon');
        var step3Message = document.getElementById('step3Message');

        step3Card.style.borderColor = '#0d6efd';
        step3Card.style.borderWidth = '2px';
        step3Action.innerHTML = '<div class="spinner-border spinner-border-sm mt-2" role="status"></div><div class="small text-muted mt-1">' + timestamp + '</div>';
        step3Icon.textContent = 'üîÑ';
        step3Message.innerHTML = '<strong>Exporting orders...</strong> <small class="text-muted">(' + timestamp + ')</small>';

        var originalActionTime = lastActionTime;

        google.script.run
            .withSuccessHandler(function(status) {
                if (lastActionTime === originalActionTime) {
                    updateUI(status);
                    adjustPolling(status);
                }
            })
            .withFailureHandler(function(err) {
                step3Card.style.borderColor = '#dc3545';
                step3Message.innerHTML = '<span class="text-danger">Failed: ' + (err.message || err) + '</span>';
                step3Action.innerHTML = '<a href="#" onclick="window.SyncWidget.exportToComax(); return false;" class="small">Retry</a>';
            })
            .exportComaxOrdersBackend();
    }

    function confirmComax() {
        if (!confirm('Confirm that orders have been uploaded to Comax?')) {
            return;
        }

        var timestamp = new Date().toLocaleTimeString();
        lastActionTime = Date.now();

        var step3Card = document.getElementById('step3Card');
        var step3Action = document.getElementById('step3Action');
        var step3Icon = document.getElementById('step3Icon');
        var step3Message = document.getElementById('step3Message');

        step3Card.style.borderColor = '#0d6efd';
        step3Card.style.borderWidth = '2px';
        step3Action.innerHTML = '<div class="spinner-border spinner-border-sm mt-2" role="status"></div><div class="small text-muted mt-1">' + timestamp + '</div>';
        step3Icon.textContent = 'üîÑ';
        step3Message.innerHTML = '<strong>Confirming upload...</strong> <small class="text-muted">(' + timestamp + ')</small>';

        var originalActionTime = lastActionTime;

        google.script.run
            .withSuccessHandler(function(status) {
                if (lastActionTime === originalActionTime) {
                    updateUI(status);
                    adjustPolling(status);
                }
            })
            .withFailureHandler(function(err) {
                step3Card.style.borderColor = '#dc3545';
                step3Message.innerHTML = '<span class="text-danger">Failed: ' + (err.message || err) + '</span>';
                step3Action.innerHTML = '<a href="#" onclick="window.SyncWidget.confirmComax(); return false;" class="small">Retry</a>';
            })
            .confirmComaxUpdateBackend();
    }

    function startComaxImport() {
        var timestamp = new Date().toLocaleTimeString();
        lastActionTime = Date.now();

        var step4Card = document.getElementById('step4Card');
        var step4Action = document.getElementById('step4Action');
        var step4Icon = document.getElementById('step4Icon');
        var step4Message = document.getElementById('step4Message');

        step4Card.style.borderColor = '#0d6efd';
        step4Card.style.borderWidth = '2px';
        step4Action.innerHTML = '<div class="spinner-border spinner-border-sm mt-2" role="status"></div><div class="small text-muted mt-1">' + timestamp + '</div>';
        step4Icon.textContent = 'üîÑ';
        step4Message.innerHTML = '<strong>Starting import...</strong> <small class="text-muted">(' + timestamp + ')</small>';

        var originalActionTime = lastActionTime;

        google.script.run
            .withSuccessHandler(function(status) {
                if (lastActionTime === originalActionTime) {
                    updateUI(status);
                    adjustPolling(status);
                }
            })
            .withFailureHandler(function(err) {
                step4Card.style.borderColor = '#dc3545';
                step4Message.innerHTML = '<span class="text-danger">Failed: ' + (err.message || err) + '</span>';
                step4Action.innerHTML = '<a href="#" onclick="window.SyncWidget.startComaxImport(); return false;" class="small">Retry</a>';
            })
            .startComaxImportBackend();
    }

    function generateWebExport() {
        var timestamp = new Date().toLocaleTimeString();
        lastActionTime = Date.now();

        var step5Card = document.getElementById('step5Card');
        var step5Action = document.getElementById('step5Action');
        var step5Icon = document.getElementById('step5Icon');
        var step5Message = document.getElementById('step5Message');

        step5Card.style.borderColor = '#0d6efd';
        step5Card.style.borderWidth = '2px';
        step5Action.innerHTML = '<div class="spinner-border spinner-border-sm mt-2" role="status"></div><div class="small text-muted mt-1">' + timestamp + '</div>';
        step5Icon.textContent = 'üîÑ';
        step5Message.innerHTML = '<strong>Generating export...</strong> <small class="text-muted">(' + timestamp + ')</small>';

        var originalActionTime = lastActionTime;

        google.script.run
            .withSuccessHandler(function(status) {
                if (lastActionTime === originalActionTime) {
                    updateUI(status);
                    adjustPolling(status);
                }
            })
            .withFailureHandler(function(err) {
                step5Card.style.borderColor = '#dc3545';
                step5Message.innerHTML = '<span class="text-danger">Failed: ' + (err.message || err) + '</span>';
                step5Action.innerHTML = '<a href="#" onclick="window.SyncWidget.generateWebExport(); return false;" class="small">Retry</a>';
            })
            .generateWebExportBackend();
    }

    function confirmWeb() {
        var timestamp = new Date().toLocaleTimeString();
        lastActionTime = Date.now();

        var step5Card = document.getElementById('step5Card');
        var step5Icon = document.getElementById('step5Icon');
        var step5Message = document.getElementById('step5Message');
        var step5Action = document.getElementById('step5Action');

        step5Card.style.borderColor = '#0d6efd';
        step5Card.style.borderWidth = '2px';
        step5Action.innerHTML = '<div class="spinner-border spinner-border-sm mt-2" role="status"></div><div class="small text-muted mt-1">' + timestamp + '</div>';
        step5Icon.textContent = 'üîÑ';
        step5Message.innerHTML = '<strong>Confirming...</strong> <small class="text-muted">(' + timestamp + ')</small>';

        var originalActionTime = lastActionTime;

        google.script.run
            .withSuccessHandler(function(status) {
                if (lastActionTime === originalActionTime) {
                    updateUI(status);
                    adjustPolling(status);
                }
            })
            .withFailureHandler(function(err) {
                step5Card.style.borderColor = '#dc3545';
                step5Message.innerHTML = '<span class="text-danger">Failed: ' + (err.message || err) + '</span>';
                step5Action.innerHTML = '<a href="#" onclick="window.SyncWidget.confirmWeb(); return false;" class="small">Retry</a>';
            })
            .confirmWebInventoryUpdateBackend();
    }

    function checkForFailures() {
        if (!currentSessionId) return;

        google.script.run
            .withSuccessHandler(function(failures) {
                var banner = document.getElementById('failureBanner');
                var failureList = document.getElementById('failureList');

                // Filter out dismissed failures
                var activeFailures = failures.filter(function(f) {
                    return !dismissedFailures[f.jobType + f.error];
                });

                if (activeFailures.length > 0) {
                    failureList.innerHTML = activeFailures.map(function(f) {
                        return '<div class="mb-1"><strong>' + f.jobType + ':</strong> ' + f.error + '</div>';
                    }).join('');
                    banner.classList.remove('d-none');
                } else {
                    banner.classList.add('d-none');
                }
            })
            .withFailureHandler(function(err) {
                console.error('Failure check error:', err);
            })
            .getRecentFailures(currentSessionId);
    }

    function dismissFailures() {
        var failureList = document.getElementById('failureList');
        if (failureList.innerHTML) {
            var failures = failureList.querySelectorAll('div');
            failures.forEach(function(div) {
                dismissedFailures[div.textContent] = true;
            });
        }
        document.getElementById('failureBanner').classList.add('d-none');
    }

    function resetSync() {
        if (!confirm('Reset the sync workflow? This will clear the current session and all progress.')) {
            return;
        }

        lastActionTime = Date.now();
        document.getElementById('footerStatus').textContent = 'Resetting...';

        google.script.run
            .withSuccessHandler(function(status) {
                updateUI(status);
                adjustPolling(status);
                // Also refresh invoice count after reset
                updateInvoiceFolder();
                document.getElementById('footerStatus').textContent = 'Reset complete';
            })
            .withFailureHandler(function(err) {
                document.getElementById('footerStatus').textContent = 'Reset failed: ' + (err.message || err);
            })
            .resetSyncStateBackend();
    }

    function refreshStatus() {
        var timeSinceAction = Date.now() - lastActionTime;
        if (timeSinceAction < ACTION_GRACE_PERIOD_MS) {
            return;
        }

        google.script.run
            .withSuccessHandler(function(status) {
                updateUI(status);
                adjustPolling(status);
            })
            .withFailureHandler(function(err) {
                console.error('Poll error:', err);
            })
            .getSyncStateFromBackend();
    }

    function adjustPolling(status) {
        var now = Date.now();
        var timeSinceAction = now - lastActionTime;
        var newInterval;

        if (timeSinceAction < 5000) {
            newInterval = ULTRA_FAST_POLL_MS;
        } else {
            var isActive = status.sessionId && status.currentStep >= 1 && status.currentStep <= 5;
            var anyProcessing = isActive && [status.step1, status.step2, status.step3, status.step4, status.step5]
                .some(function(step) { return step && step.status === 'processing'; });

            if (anyProcessing) {
                newInterval = ACTIVE_POLL_MS;
            } else if (isActive) {
                newInterval = IDLE_POLL_MS;
            } else {
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    currentPollIntervalMs = null;
                    window._syncWidgetPollInterval = null;
                }
                return;
            }
        }

        if (newInterval !== currentPollIntervalMs) {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            currentPollIntervalMs = newInterval;
            pollInterval = setInterval(refreshStatus, newInterval);
            window._syncWidgetPollInterval = pollInterval;
        }
    }

    // Expose public API on window
    window.SyncWidget = {
        importProducts: importProducts,
        importOrders: importOrders,
        exportToComax: exportToComax,
        confirmComax: confirmComax,
        startComaxImport: startComaxImport,
        generateWebExport: generateWebExport,
        confirmWeb: confirmWeb,
        resetSync: resetSync,
        dismissFailures: dismissFailures
    };

    // Initialize widget
    console.log('SyncWidget: Initializing (fresh load or navigation)');
    refreshStatus();
    updateInvoiceFolder();

})();
</script>
