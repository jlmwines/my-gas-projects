<div class="container-fluid">
    <h1 class="mt-4">Brurya Inventory Management</h1>
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table mr-1"></i>
            Current Brurya Stock
        </div>
        <div class="card-body">
            <div class="form-group">
                <input type="text" class="form-control" id="productSearch" placeholder="Search by SKU or Name">
            </div>
            <div class="table-responsive">
                <table class="table table-bordered" id="bruryaInventoryTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Product Name</th>
                            <th>Brurya Quantity</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Inventory items will be loaded here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <button class="btn btn-primary mt-3" id="saveBruryaInventory">Save Changes</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Client-side JavaScript for Brurya Inventory Management
        const productSearch = document.getElementById('productSearch');
        const bruryaInventoryTableBody = document.querySelector('#bruryaInventoryTable tbody');
        const saveBruryaInventoryButton = document.getElementById('saveBruryaInventory');

        let currentInventory = []; // Stores the current state of inventory displayed

        // Function to load and display inventory
        function loadBruryaInventory() {
            google.script.run
                .withSuccessHandler(function(inventoryData) {
                    currentInventory = inventoryData;
                    renderInventoryTable(currentInventory);
                })
                .withFailureHandler(function(error) {
                    console.error("Error loading Brurya inventory:", error);
                    alert("Failed to load Brurya inventory: " + error.message);
                })
                .getBruryaStockData(); // This function will be added to WebApp.js
        }

        // Function to render the inventory table
        function renderInventoryTable(inventory) {
            bruryaInventoryTableBody.innerHTML = ''; // Clear existing rows
            if (inventory.length === 0) {
                bruryaInventoryTableBody.innerHTML = '<tr><td colspan="4">No items in Brurya inventory.</td></tr>';
                return;
            }

            inventory.forEach(item => {
                const row = bruryaInventoryTableBody.insertRow();
                row.dataset.sku = item.sku; // Store SKU on the row for easy access

                row.insertCell(0).textContent = item.sku;
                // Placeholder for product name - will need a lookup
                row.insertCell(1).textContent = item.productName || 'Loading...'; 
                
                const qtyCell = row.insertCell(2);
                const qtyInput = document.createElement('input');
                qtyInput.type = 'number';
                qtyInput.value = item.bruryaQty;
                qtyInput.min = '0';
                qtyInput.classList.add('form-control');
                qtyInput.addEventListener('change', function() {
                    // Mark row as changed
                    row.classList.add('table-warning'); 
                });
                qtyCell.appendChild(qtyInput);

                const actionCell = row.insertCell(3);
                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remove';
                removeButton.classList.add('btn', 'btn-danger', 'btn-sm');
                removeButton.addEventListener('click', function() {
                    if (confirm(`Are you sure you want to remove ${item.sku} from Brurya inventory?`)) {
                        qtyInput.value = 0; // Set quantity to 0 for removal
                        row.classList.add('table-warning'); // Mark for saving
                    }
                });
                actionCell.appendChild(removeButton);
            });
            // After rendering, fetch product names
            fetchProductNames(inventory.map(item => item.sku));
        }

        // Function to fetch product names (client-side)
        function fetchProductNames(skus) {
            google.script.run
                .withSuccessHandler(function(productNamesMap) {
                    document.querySelectorAll('#bruryaInventoryTable tbody tr').forEach(row => {
                        const sku = row.dataset.sku;
                        if (productNamesMap[sku]) {
                            row.cells[1].textContent = productNamesMap[sku];
                        } else {
                            row.cells[1].textContent = 'N/A';
                        }
                    });
                })
                .withFailureHandler(function(error) {
                    console.error("Error fetching product names:", error);
                })
                .getProductNamesBySkus(skus); // This function will be added to WebApp.js
        }


        // Search functionality (client-side filtering for now)
        productSearch.addEventListener('keyup', function() {
            const searchTerm = productSearch.value.toLowerCase();
            const filteredInventory = currentInventory.filter(item => 
                item.sku.toLowerCase().includes(searchTerm) || 
                (item.productName && item.productName.toLowerCase().includes(searchTerm))
            );
            renderInventoryTable(filteredInventory);
        });

        // Save changes functionality
        saveBruryaInventoryButton.addEventListener('click', function() {
            const changes = [];
            document.querySelectorAll('#bruryaInventoryTable tbody tr.table-warning').forEach(row => {
                const sku = row.dataset.sku;
                const newQty = parseFloat(row.querySelector('input[type="number"]').value);
                if (!isNaN(newQty)) {
                    changes.push({ sku: sku, quantity: newQty });
                }
            });

            if (changes.length > 0) {
                google.script.run
                    .withSuccessHandler(function() {
                        alert("Brurya inventory updated successfully!");
                        loadBruryaInventory(); // Reload to reflect saved changes and clear warnings
                    })
                    .withFailureHandler(function(error) {
                        console.error("Error saving Brurya inventory:", error);
                        alert("Failed to save Brurya inventory: " + error.message);
                    })
                    .saveBruryaInventoryChanges(changes); // This function will be added to WebApp.js
            } else {
                alert("No changes to save.");
            }
        });

        // Initial load
        loadBruryaInventory();
    });
</script>