<style>
    .new-sync-card {
        border: 2px solid #0d6efd;
    }
    .new-sync-step {
        padding: 0.5rem;
        border-radius: 0.25rem;
        text-align: center;
    }
    .new-sync-step.waiting { background: #f8f9fa; }
    .new-sync-step.processing { background: #fff3cd; }
    .new-sync-step.completed { background: #d1e7dd; }
    .new-sync-step.failed { background: #f8d7da; }
    .new-sync-stage {
        font-size: 1.1rem;
        font-weight: bold;
        padding: 0.75rem;
        background: #e7f1ff;
        border-radius: 0.25rem;
    }
    .new-sync-action {
        font-size: 1rem;
        padding: 0.5rem;
        background: #f0f0f0;
        border-radius: 0.25rem;
    }
</style>

<div class="card shadow-sm mb-3 new-sync-card">
    <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
        <span><strong>NEW Sync System (Testing)</strong></span>
        <span id="newSessionId" class="small"></span>
    </div>
    <div class="card-body">

        <!-- Current Stage Display -->
        <div class="mb-3">
            <div class="small text-muted mb-1">Current Stage:</div>
            <div id="newStageDisplay" class="new-sync-stage">Loading...</div>
        </div>

        <!-- Next Action Display -->
        <div class="mb-3">
            <div class="small text-muted mb-1">Next Action:</div>
            <div id="newNextAction" class="new-sync-action">Loading...</div>
        </div>

        <!-- Step Status Grid -->
        <div class="row row-cols-5 g-2 mb-3">
            <div class="col">
                <div id="newStep1" class="new-sync-step waiting">
                    <div class="small fw-bold">Step 1</div>
                    <div id="newStep1Status">-</div>
                </div>
            </div>
            <div class="col">
                <div id="newStep2" class="new-sync-step waiting">
                    <div class="small fw-bold">Step 2</div>
                    <div id="newStep2Status">-</div>
                </div>
            </div>
            <div class="col">
                <div id="newStep3" class="new-sync-step waiting">
                    <div class="small fw-bold">Step 3</div>
                    <div id="newStep3Status">-</div>
                </div>
            </div>
            <div class="col">
                <div id="newStep4" class="new-sync-step waiting">
                    <div class="small fw-bold">Step 4</div>
                    <div id="newStep4Status">-</div>
                </div>
            </div>
            <div class="col">
                <div id="newStep5" class="new-sync-step waiting">
                    <div class="small fw-bold">Step 5</div>
                    <div id="newStep5Status">-</div>
                </div>
            </div>
        </div>

        <!-- Error Display -->
        <div id="newErrorDisplay" class="alert alert-danger d-none"></div>

        <!-- Action Buttons (for testing new system) -->
        <div id="newActionButtons" class="text-center">
            <!-- Buttons will be rendered based on stage -->
        </div>

        <!-- Raw Data (for debugging) -->
        <details class="mt-3">
            <summary class="small text-muted">Raw Data (debug)</summary>
            <pre id="newRawData" class="small bg-light p-2 mt-2" style="max-height: 200px; overflow: auto;"></pre>
        </details>

    </div>
    <div class="card-footer text-muted small" id="newFooterStatus">
        Loading...
    </div>
</div>

<script>
(function() {
    'use strict';

    // Clear any existing interval from previous widget instance
    if (window._newSyncWidgetPollInterval) {
        clearInterval(window._newSyncWidgetPollInterval);
        window._newSyncWidgetPollInterval = null;
    }

    var pollInterval = null;
    var POLL_MS = 3000;

    function updateUI(status) {
        // Session ID
        document.getElementById('newSessionId').textContent =
            status.sessionId ? 'Session: ' + status.sessionId : 'No session';

        // Stage - the clear name
        var stageEl = document.getElementById('newStageDisplay');
        stageEl.textContent = status.stage || 'UNKNOWN';
        stageEl.className = 'new-sync-stage';
        if (status.stage === 'COMPLETE') stageEl.classList.add('text-success');
        if (status.stage === 'FAILED') stageEl.classList.add('text-danger');

        // Next Action
        document.getElementById('newNextAction').textContent = status.nextAction || '-';

        // Step statuses
        var stepDetails = status.stepDetails || {};
        for (var i = 1; i <= 5; i++) {
            var stepEl = document.getElementById('newStep' + i);
            var statusEl = document.getElementById('newStep' + i + 'Status');
            var stepStatus = stepDetails['step' + i] || 'waiting';

            stepEl.className = 'new-sync-step ' + stepStatus;
            statusEl.textContent = stepStatus;
        }

        // Error display
        var errorEl = document.getElementById('newErrorDisplay');
        if (status.errorMessage) {
            errorEl.textContent = status.errorMessage;
            errorEl.classList.remove('d-none');
        } else {
            errorEl.classList.add('d-none');
        }

        // Action buttons based on stage
        var actionEl = document.getElementById('newActionButtons');
        var buttons = '';

        switch(status.stage) {
            case 'IDLE':
                buttons = '<button class="btn" onclick="window.NewSyncWidget.start()">Start Sync</button>';
                break;
            case 'READY_TO_EXPORT_ORDERS':
                buttons = '<button class="btn" onclick="window.NewSyncWidget.exportOrders()">Export Orders</button>';
                break;
            case 'WAITING_ORDER_EXPORT_CONFIRM':
                buttons = '<button class="btn" onclick="window.NewSyncWidget.confirmOrderExport()">Confirm Order Export</button>';
                break;
            case 'READY_TO_IMPORT_COMAX_PRODUCTS':
                buttons = '<button class="btn" onclick="window.NewSyncWidget.importComax()">Import Comax</button>';
                break;
            case 'READY_TO_EXPORT_WEB_INVENTORY':
                buttons = '<button class="btn" onclick="window.NewSyncWidget.exportWeb()">Generate Export</button>';
                break;
            case 'WAITING_WEB_EXPORT_CONFIRM':
                buttons = '<button class="btn" onclick="window.NewSyncWidget.confirmWebExport()">Confirm Web Export</button>';
                break;
            case 'COMPLETE':
                buttons = '<span class="text-success">Sync Complete</span>';
                break;
            case 'FAILED':
                buttons = '<button class="btn" onclick="window.NewSyncWidget.reset()">Reset</button>';
                break;
            default:
                // Processing states - show spinner
                if (status.stage && status.stage.indexOf('IMPORTING') >= 0 ||
                    status.stage && status.stage.indexOf('EXPORTING') >= 0 ||
                    status.stage === 'VALIDATING') {
                    buttons = '<div class="spinner-border spinner-border-sm" role="status"></div> Processing...';
                }
        }
        actionEl.innerHTML = buttons;

        // Raw data for debugging
        document.getElementById('newRawData').textContent = JSON.stringify(status, null, 2);

        // Footer
        document.getElementById('newFooterStatus').textContent =
            'Last update: ' + (status.lastUpdate ? new Date(status.lastUpdate).toLocaleTimeString() : '-');
    }

    function refreshStatus() {
        google.script.run
            .withSuccessHandler(function(status) {
                updateUI(status);
            })
            .withFailureHandler(function(err) {
                document.getElementById('newFooterStatus').textContent = 'Error: ' + (err.message || err);
            })
            .getSyncSessionStatus();
    }

    // Action functions - these call the EXISTING backend functions
    // The new SyncSessionService gets updated via dual-write
    function start() {
        google.script.run
            .withSuccessHandler(function() { refreshStatus(); })
            .withFailureHandler(function(err) { alert('Error: ' + err.message); })
            .startDailySyncBackend();
    }

    function exportOrders() {
        google.script.run
            .withSuccessHandler(function() { refreshStatus(); })
            .withFailureHandler(function(err) { alert('Error: ' + err.message); })
            .exportComaxOrdersBackend();
    }

    function confirmOrderExport() {
        if (!confirm('Confirm orders uploaded to Comax?')) return;
        google.script.run
            .withSuccessHandler(function() { refreshStatus(); })
            .withFailureHandler(function(err) { alert('Error: ' + err.message); })
            .confirmComaxUpdateBackend();
    }

    function importComax() {
        google.script.run
            .withSuccessHandler(function() { refreshStatus(); })
            .withFailureHandler(function(err) { alert('Error: ' + err.message); })
            .startComaxImportBackend();
    }

    function exportWeb() {
        google.script.run
            .withSuccessHandler(function() { refreshStatus(); })
            .withFailureHandler(function(err) { alert('Error: ' + err.message); })
            .generateWebExportBackend();
    }

    function confirmWebExport() {
        if (!confirm('Confirm inventory uploaded to website?')) return;
        google.script.run
            .withSuccessHandler(function() { refreshStatus(); })
            .withFailureHandler(function(err) { alert('Error: ' + err.message); })
            .confirmWebInventoryUpdateBackend();
    }

    function reset() {
        if (!confirm('Reset sync state?')) return;
        google.script.run
            .withSuccessHandler(function() { refreshStatus(); })
            .withFailureHandler(function(err) { alert('Error: ' + err.message); })
            .resetSyncStateBackend();
    }

    // Expose public API
    window.NewSyncWidget = {
        start: start,
        exportOrders: exportOrders,
        confirmOrderExport: confirmOrderExport,
        importComax: importComax,
        exportWeb: exportWeb,
        confirmWebExport: confirmWebExport,
        reset: reset,
        refresh: refreshStatus
    };

    // Initialize
    console.log('NewSyncWidget: Initializing (reads from SyncSessionService)');
    refreshStatus();

    // Start polling
    pollInterval = setInterval(refreshStatus, POLL_MS);
    window._newSyncWidgetPollInterval = pollInterval;

})();
</script>
