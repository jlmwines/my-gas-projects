<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <script src="//ssl.gstatic.com/docs/script/apps-script-impl.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .header h1 {
            margin-bottom: 0;
            margin-right: 15px;
            padding-left: 1rem; /* Align with nav-link text */
            font-size: 1.25rem;
        }
        .header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 10px 20px; /* Match sidebar padding */
            border-bottom: 1px solid #ccc;
            height: 60px;
            background: #f8f9fa;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1030;
        }
        .jlmops-role-switcher {
            position: relative;
        }
        .jlmops-role-switcher select {
            /* color: white !important; Removed */
            /* background-color: #212529 !important; Removed */
            /* border: 1px solid #555; Removed */
        }
        .jlmops-role-switcher select option {
            /* color: white !important; Removed */
            /* background-color: #343a40 !important; Removed */
        }
        /* Force dark background for primary buttons */
        /* .jlmops-btn-dark {
            background-color: #212529 !important;
            border-color: #212529 !important;
            color: white !important; Removed */
        /* } */
        .main-body {
            display: flex;
            flex-grow: 1;
            margin-top: 60px; /* Height of the header */
        }
        .sidebar {
            width: 250px;
            height: calc(100vh - 60px);
            position: fixed;
            background: #f8f9fa;
            padding: 20px;
        }
        .sidebar ul.nav li {
            list-style-type: none; /* Remove bullet points */
        }
        .content {
            margin-left: 270px;
            padding: 20px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>JLM Wines</h1>
        <div class="jlmops-role-switcher">
            <select id="roleSelect" class="form-control form-control-sm" style="min-width: 150px;">
                <? for (let r of availableRoles) { ?>
                    <option value="<?= r ?>" <?= r === initialRole ? 'selected' : '' ?>><?= r.charAt(0).toUpperCase() + r.slice(1) ?></option>
                <? } ?>
            </select>
        </div>
    </div>

    <div class="main-body">
      <div class="sidebar">
        <!-- Admin Navigation -->
        <ul id="admin-nav" class="nav flex-column" style="display: none;">
          <li class="nav-item"><a class="nav-link" href="javascript:void(0);" onclick="switchRole()">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="javascript:void(0);" onclick="loadView('AdminSyncView')">Sync</a></li> <!-- NEW SYNC LINK -->
          <li class="nav-item"><a class="nav-link" href="javascript:void(0);" onclick="loadView('AdminOrders')">Orders</a></li>
          <li class="nav-item"><a class="nav-link" href="javascript:void(0);" onclick="loadView('AdminInventory')">Inventory</a></li>
          <li class="nav-item"><a class="nav-link" href="javascript:void(0);" onclick="loadView('AdminProducts')">Products</a></li>
          <li class="nav-item"><a class="nav-link" href="javascript:void(0);" onclick="loadView('Development')">Development</a></li>
        </ul>
        <!-- Manager Navigation -->
        <ul id="manager-nav" class="nav flex-column" style="display: none;">
          <li class="nav-item"><a class="nav-link" href="javascript:void(0);" onclick="switchRole()">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="javascript:void(0);" onclick="loadView('ManagerOrders')">Orders</a></li>
          <li class="nav-item"><a class="nav-link" href="javascript:void(0);" onclick="loadView('ManagerInventory')">Inventory</a></li>
          <li class="nav-item"><a class="nav-link" href="javascript:void(0);" onclick="loadView('ManagerProducts')">Products</a></li>
        </ul>
      </div>

      <div id="content" class="content">
        <!-- Content will be loaded here -->
      </div>
    </div>

    <script>
      /**
       * Displays an error message.
       */
      function showError(err) {
        const contentDiv = document.getElementById('content');
        contentDiv.innerHTML = `<div class="alert alert-danger">An error occurred: ${err.message}</div>`;
      }

      /**
       * Executes scripts found within an HTML string.
       */
      function executeScriptsInElement(element) {
        const scripts = Array.from(element.getElementsByTagName('script'));
        scripts.forEach(s => {
          const newScript = document.createElement('script');
          newScript.textContent = s.textContent;
          s.parentNode.replaceChild(newScript, s);
        });
      }

      /**
       * Shows/hides navigation links based on role.
       */
      function setNavigationForRole(role) {
        const adminNav = document.getElementById('admin-nav');
        const managerNav = document.getElementById('manager-nav');

        if (role === 'admin') {
            adminNav.style.display = 'block';
            managerNav.style.display = 'none';
        } else { // Assumes 'manager'
            adminNav.style.display = 'none';
            managerNav.style.display = 'block';
        }
      }

      /**
       * Loads a view into the content area and highlights the active navigation link.
       * @param {string} viewName - The name of the view to load.
       * @param {HTMLElement} [linkElement] - The navigation link element that was clicked.
       */
      function loadView(viewName, linkElement) {
        const viewContent = document.getElementById('content');
        viewContent.innerHTML = '<h2>Loading...</h2>';

        // Highlight Navigation
        const activeNavId = document.getElementById('admin-nav').style.display === 'block' ? 'admin-nav' : 'manager-nav';
        const navLinks = document.querySelectorAll(`#${activeNavId} .nav-link`);
        
        navLinks.forEach(link => {
            link.classList.remove('active');
            link.classList.remove('font-weight-bold');
            link.style.color = '#007bff'; // Default link color
        });

        let activeLink = linkElement;
        
        // If no element passed, try to find it by viewName
        if (!activeLink) {
            // Special case for Dashboards called via switchRole
            if (viewName === 'AdminDashboard' || viewName === 'ManagerDashboard') {
                 // Find the link that calls switchRole() which implies Dashboard
                 activeLink = Array.from(navLinks).find(link => link.getAttribute('onclick').includes('switchRole'));
            } else {
                 activeLink = Array.from(navLinks).find(link => link.getAttribute('onclick').includes(`'${viewName}'`));
            }
        }

        if (activeLink) {
            activeLink.classList.add('active');
            activeLink.classList.add('font-weight-bold');
            activeLink.style.color = '#0056b3'; // darker active color
        }

        google.script.run
          .withSuccessHandler(html => {
            viewContent.innerHTML = html;
            executeScriptsInElement(viewContent);
          })
          .withFailureHandler(showError)
          .getView(viewName);
      }
      
      /**
       * Handles the role change event.
       */
      function switchRole() {
        const selectedRole = document.getElementById('roleSelect').value;
        setNavigationForRole(selectedRole);
        
        if (selectedRole === 'admin') {
            loadView('AdminDashboard');
        } else if (selectedRole === 'manager') {
            loadView('ManagerDashboard');
        } else {
            document.getElementById('content').innerHTML = '<h2>Invalid Role</h2>';
        }
      }

      // Initial setup on page load
      window.onload = function() {
        // Add event listener to the dropdown
        document.getElementById('roleSelect').addEventListener('change', switchRole);
        
        // Load the initial view and set navigation based on the role passed from the server
        const initialRole = document.getElementById('roleSelect').value;
        setNavigationForRole(initialRole);
        if (initialRole === 'admin') {
            loadView('AdminDashboard');
        } else if (initialRole === 'manager') {
            loadView('ManagerDashboard');
        }
      };
    </script>
</body>
</html>
