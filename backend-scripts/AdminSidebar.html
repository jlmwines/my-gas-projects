<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        body { font-family: sans-serif; padding: 0; margin: 0; font-size: 12px; background-color: #f8f9fa;}
        .accordion-section { border-bottom: 1px solid #ccc; }
        .accordion-header { background-color: #f1f1f1; padding: 6px 10px; cursor: pointer; font-weight: bold; position: relative; font-size: 12px; }
        .accordion-header:hover { background-color: #e1e1e1; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; border-top: 1px solid #ccc; background-color: #fff;}
        .accordion-inner { padding: 10px; }
        .sub-section-title { font-weight: bold; margin-top: 10px; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 4px;}
        .sub-section-title:first-child { margin-top: 0; }
        .loading { color: #888; }
        label { display: block; margin-bottom: 4px; }
        input, select, button { width: 100%; padding: 6px; margin-bottom: 8px; box-sizing: border-box; font-size: 12px; }
        button { background-color: #4285f4; color: white; border: none; cursor: pointer; text-align: center; border-radius: 4px;}
        .review-task-button { padding: 4px; } /* Reduced padding for review task buttons */
        button.utility-btn { background-color: #6c757d; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        ul a { text-decoration: none; color: #0000EE; cursor: pointer; }
        ul a:hover { text-decoration: underline; }
        ul span { color: #555; }
        #sync-buttons-container button {
            text-align: left;
            background-color: #ffffff;
            color: #333;
            border: 1px solid #ccc;
            margin-bottom: 4px;
        }
        #sync-buttons-container button:hover:not(:disabled) {
            background-color: #e9ecef;
        }
        #sync-buttons-container button:disabled {
            background-color: #e9ecef;
            color: #6c757d;
        }
        .status-line {
            font-size: 11px;
            color: #6c757d;
            padding: 0 4px 8px 4px;
        }
        .indicator {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%) rotate(0deg);
            transition: transform 0.2s ease-in-out;
            border-top: 5px solid transparent;
            border-left: 5px solid #555;
            border-bottom: 5px solid transparent;
            height: 0;
            width: 0;
        }
        .accordion-header.active .indicator {
            transform: translateY(-50%) rotate(90deg);
        }
        .active-review-link {
            font-weight: bold;
        }
        #review-section .accordion-inner {
            max-height: 600px; /* Adjust as needed */
            overflow-y: auto;
        }
    </style>
</head>
<body>

    <div id="invoices-section" class="accordion-section">
        <div class="accordion-header">Invoices<span class="indicator"></span></div>
        <div class="accordion-content">
            <div class="accordion-inner">
                <p style="margin: 0 0 10px 0;">Files in folder: <span id="invoice-file-count">...</span></p>
                <a href="https://drive.google.com/drive/folders/1VNKUGl1tgrV-cdj0KiM5SQ8Kvsw9WoNb" target="_blank">Open Invoices Folder</a>
            </div>
        </div>
    </div>

    <div id="sync-section" class="accordion-section">
        <div class="accordion-header">Daily Sync<span class="indicator"></span></div>
        <div class="accordion-content">
            <div class="accordion-inner">
                <div id="sync-buttons-container">
                    <button id="btn-step-beginSync" onclick="runSyncStep('beginSync', 'This will reset the workflow state and create a new backup. Proceed?')">1. Begin Sync</button>
                    <div id="status-beginSync" class="status-line"></div>

                    <button id="btn-step-ordersSync" onclick="runSyncStep('ordersSync', 'This will import and merge new orders. Proceed?')">2. Orders Sync</button>
                    <div id="status-ordersSync" class="status-line"></div>

                    <button id="btn-step-productSync" onclick="runSyncStep('productSync', 'This will import and process product files. Proceed?')">3. Product Sync</button>
                    <div id="status-productSync" class="status-line"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="review-section" class="accordion-section">
        <div class="accordion-header">Review Tasks<span class="indicator"></span></div>
        <div class="accordion-content">
            <div class="accordion-inner">
                <div id="review-tasks-list"><p class="loading">Loading...</p></div>
                <div id="review-status" style="margin-top: 15px; padding: 10px; border: 1px solid #ccc; background-color: #f8f9fa; display: none;"></div>
                
                <button class="review-task-button" onclick="runUtility('processNewProductApprovals', 'Are you sure you want to process approved products?', 'ProductsNew')">Process New Product Approvals</button>
                <button class="review-task-button" onclick="runUtility('markAllAsAccepted')">Mark All Inventory as Accepted</button>
                <button class="review-task-button" onclick="runUtility('processAndExportReviewedInventory')">Process & Export Inventory</button>
                <button class="review-task-button" onclick="runUtility('processProductDetailApprovals')">Process Product Detail Approvals</button>
                <button class="review-task-button" onclick="runUtility('processFinalDetailClosures')">Process Final Detail Closures</button>
            </div>
        </div>
    </div>

    <div id="admin-tasks-section" class="accordion-section">
        <div class="accordion-header">Admin Tasks<span class="indicator"></span></div>
        <div class="accordion-content">
            <div class="accordion-inner">
                <div id="admin-assigned-tasks-list"><p class="loading">Loading...</p></div>
            </div>
        </div>
    </div>

    <div id="tasks-section" class="accordion-section">
        <div class="accordion-header">Create Tasks <span class="indicator"></span></div>
        <div class="accordion-content">
            <div class="accordion-inner">
                <p style="margin: 0 0 10px 0;">Assigned Inventory Tasks: <span id="task-count-display">...</span></p>
                <button id="create-low-stock-btn">Create Low Stock Tasks</button>
                <button id="create-periodic-btn">Create Periodic Review Tasks</button>

                <div class="sub-section-title">Task Creation Settings</div>
                <label for="setting-limit">Task Limit</label>
                <input type="number" id="setting-limit">
                <label for="setting-low-stock">Low Stock Threshold</label>
                <input type="number" id="setting-low-stock">
                <label for="setting-periodic">Periodic Review (Days)</label>
                <input type="number" id="setting-periodic">
                <button id="save-settings-btn">Save Settings</button>
            </div>
        </div>
    </div>

    <div id="utilities-section" class="accordion-section">
        <div class="accordion-header">Utilities & Settings <span class="indicator"></span></div>
        <div class="accordion-content">
            <div class="accordion-inner">
                <button id="util-snapshot-btn">Create Manual Snapshot</button>
                <button id="util-restore-btn">Restore from Snapshot</button>
                <button id="util-archive-btn">Archive Old Orders</button>

                <div class="sub-section-title">Workflow Reset</div>
                <select id="util-reset-select">
                    <option value="" selected disabled>Select a reset point...</option>
                    <option value="resetStateToStart">Start of Workflow</option>
                    <option value="resetStatePostBackup">After Backup</option>
                    <option value="resetStatePostImportsAndOrders">After Imports & Orders</option>
                    <option value="resetStatePostReview">After Review</option>
                    <option value="resetStatePostFinalize">After Finalize</option>
                </select>
                <button id="util-reset-execute-btn" disabled>Execute Reset</button>
            </div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 20px;">
        <button class="action" onclick="refreshSidebar()">Refresh Sidebar</button>
    </div>

    <script>
        // --- SYNC PANEL SCRIPT ---
        function runSyncStep(stepName, confirmationMessage) {
            if (confirmationMessage && !confirm(confirmationMessage)) return;
            const button = document.getElementById('btn-step-' + stepName);
            const status = document.getElementById('status-' + stepName);
            button.disabled = true;
            status.textContent = "Processing...";
            
            const functionMap = {
                'beginSync': 'runInitialSyncStep',
                'ordersSync': 'runOrdersStep',
                'productSync': 'runProductsStep'
            };
            const functionName = functionMap[stepName];

            google.script.run
                .withSuccessHandler(result => {
                    status.textContent = result;
                    button.disabled = false;
                })
                .withFailureHandler(error => {
                    status.textContent = "Error: " + error.message;
                    button.disabled = false;
                })
                [functionName]();
        }

        // --- MAIN SIDEBAR SCRIPT ---
        let currentActiveLinkElement = null;

        document.addEventListener("DOMContentLoaded", () => {
            google.script.run
                .withSuccessHandler(initializeSidebar)
                .withFailureHandler(handleError)
                .getSidebarData();
        });

        function initializeSidebar(data) {
            setupAccordion(data);
            renderReviewTasks(data.adminTasks);
            renderAdminAssignedTasks(data.bwTasks);
            populateTaskCreatorPanel(data.taskPanel);
            document.getElementById('invoice-file-count').textContent = data.invoiceFileCount;
            attachUtilityListeners();
        }
        
        function setupAccordion(data) {
            const allHeaders = document.querySelectorAll('.accordion-header');
            
            allHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    const isActive = this.classList.contains('active');

                    allHeaders.forEach(h => {
                        h.classList.remove('active');
                        h.nextElementSibling.style.maxHeight = null;
                    });

                    if (!isActive) {
                        this.classList.add('active');
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }
                });
            });

            const invoicesHeader = document.querySelector('#invoices-section .accordion-header');
            if (invoicesHeader) {
                const invoicesContent = invoicesHeader.nextElementSibling;
                invoicesHeader.classList.add('active');
                invoicesContent.style.maxHeight = invoicesContent.scrollHeight + 'px';
            }
        }

        function renderReviewTasks(tasks) {
            const container = document.getElementById('review-tasks-list');
            container.innerHTML = '';

            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<p style="margin:0;">No review tasks defined.</p>';
                return;
            }

            const list = document.createElement('ul');
            list.style.listStyleType = 'none';
            list.style.margin = '0';
            list.style.padding = '0';

            tasks.forEach(group => {
                const listItem = document.createElement('li');
                listItem.style.marginBottom = '8px';
                const text = `${group.label}: ${group.count}`;

                if (group.count > 0 && group.functionName) {
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = text;
                    link.onclick = (e) => {
                        e.preventDefault();
                        setLoadingState(true);
                        showReviewStatus('Loading sheet...');

                        if (currentActiveLinkElement) {
                            currentActiveLinkElement.classList.remove('active-review-link');
                        }
                        e.target.classList.add('active-review-link');
                        currentActiveLinkElement = e.target;

                        google.script.run
                            .withSuccessHandler(showReviewStatus)
                            .withFailureHandler(handleError)
                            [group.functionName]();
                    };
                    listItem.appendChild(link);
                } else {
                    const span = document.createElement('span');
                    span.textContent = text;
                    listItem.appendChild(span);
                }
                list.appendChild(listItem);
            });
            container.appendChild(list);
        }

        function renderAdminAssignedTasks(tasks) {
            const container = document.getElementById('admin-assigned-tasks-list');
            container.innerHTML = '';

            if (!tasks) {
                container.innerHTML = '<p style="margin:0;">Could not load admin tasks.</p>';
                return;
            }
            if (tasks.length === 0) {
                container.innerHTML = '<p style="margin:0;">No admin task types assigned.</p>';
                return;
            }

            const list = document.createElement('ul');
            list.style.listStyleType = 'none';
            list.style.margin = '0';
            list.style.padding = '0';

            tasks.forEach(group => {
                const listItem = document.createElement('li');
                listItem.style.marginBottom = '8px';
                const span = document.createElement('span');
                span.textContent = `${group.label}: ${group.count}`;
                listItem.appendChild(span);
                list.appendChild(listItem);
            });
            container.appendChild(list);
        }
        
        function populateTaskCreatorPanel(data) {
            if (!data || data.error) {
                handleError({ message: data ? data.error : "Failed to load task panel info." });
                return;
            }
            document.getElementById('task-count-display').textContent = `${data.assignedTaskCount} / ${data.settings.defaultLimit}`;
            document.getElementById('setting-limit').value = data.settings.defaultLimit;
            document.getElementById('setting-low-stock').value = data.settings.lowStock;
            document.getElementById('setting-periodic').value = data.settings.periodicDays;
            
            document.getElementById('create-low-stock-btn').addEventListener('click', () => createTask('Low Stock'));
            document.getElementById('create-periodic-btn').addEventListener('click', () => createTask('Periodic Review'));
        }

        function attachUtilityListeners() {
            document.getElementById('util-snapshot-btn').addEventListener('click', () => runUtility('createManualSnapshot', "Create a new manual snapshot?"));
            document.getElementById('util-restore-btn').addEventListener('click', () => runUtility('showAdvancedRestoreDialog'));
            document.getElementById('util-archive-btn').addEventListener('click', () => runUtility('archiveOldOrderLogRecords', "This will archive old order records. Proceed?"));

            const resetSelect = document.getElementById('util-reset-select');
            const resetExecuteBtn = document.getElementById('util-reset-execute-btn');
            resetSelect.addEventListener('change', () => {
                resetExecuteBtn.disabled = !resetSelect.value;
            });
            resetExecuteBtn.addEventListener('click', () => {
                const functionToRun = resetSelect.value;
                if (functionToRun) {
                    const selectedText = resetSelect.options[resetSelect.selectedIndex].text;
                    runUtility(functionToRun, `Are you sure you want to reset the workflow to: "${selectedText}"?`);
                    resetSelect.value = '';
                    resetExecuteBtn.disabled = true;
                }
            });
            
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
        }
        
        function runUtility(functionName, confirmMessage, arg1) {
            if (confirmMessage && !confirm(confirmMessage)) return;
            setLoadingState(true);
            showReviewStatus(`Running ${functionName}...`);
            
            const runner = google.script.run
                .withSuccessHandler(result => {
                    showReviewStatus(result);
                    refreshSidebar();
                })
                .withFailureHandler(handleError);

            if (arg1 !== undefined) {
                runner[functionName](arg1);
            } else {
                runner[functionName]();
            }
        }

        function createTask(type) {
            setLoadingState(true);
            google.script.run
                .withSuccessHandler(showReviewStatus)
                .withFailureHandler(handleError)
                .createTasksFromSidebar(type);
        }

        function saveSettings() {
            setLoadingState(true);
            const settings = {
                defaultLimit: document.getElementById('setting-limit').value,
                lowStock: document.getElementById('setting-low-stock').value,
                periodicDays: document.getElementById('setting-periodic').value
            };
            google.script.run
                .withSuccessHandler(showReviewStatus)
                .withFailureHandler(handleError)
                .saveTaskSettings(settings);
        }

        function showReviewStatus(message) {
            const statusDiv = document.getElementById('review-status');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = '#f8f9fa';
            statusDiv.style.borderColor = '#ccc';
            setLoadingState(false);
        }

        function handleError(error) {
            const statusDiv = document.getElementById('review-status');
            statusDiv.textContent = 'Error: ' + error.message;
            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = '#f8d7da';
            statusDiv.style.borderColor = '#f5c6cb';
            setLoadingState(false);
        }
        
        function setLoadingState(isLoading) {
            document.querySelectorAll('button, a').forEach(el => {
                if (isLoading) {
                    el.style.pointerEvents = 'none';
                    el.style.opacity = '0.5';
                } else {
                    el.style.pointerEvents = 'auto';
                    el.style.opacity = '1';
                }
            });
        }

        function refreshSidebar() {
            setLoadingState(true);
            google.script.run
                .withSuccessHandler(result => {
                    initializeSidebar(result);
                    setLoadingState(false);
                })
                .withFailureHandler(error => {
                    handleError(error);
                    setLoadingState(false);
                })
                .getSidebarData();
        }
    </script>
</body>
</html>