<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; }
        .header { padding: 10px 15px; background-color: #f1f1f1; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 8px; }
        .header-sku { font-size: 14px; }
        .header-name { color: #555; font-size: 14px; }
        .container { padding: 15px; padding-bottom: 70px; }
        .tab-bar { border-bottom: 1px solid #ccc; margin-bottom: 15px; }
        .tab { display: inline-block; padding: 8px 12px; cursor: pointer; border: 1px solid transparent; border-bottom: none; margin-bottom: -1px; }
        .tab.active { border-color: #ccc; border-bottom: 1px solid white; background-color: white; border-radius: 4px 4px 0 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .column { padding-right: 15px; }
        .column:last-child { padding-right: 0; padding-left: 15px; border-left: 1px solid #eee; }
        .column-header { display: flex; justify-content: space-between; align-items: center; margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; }
        .column-header h5 { margin: 0; font-size: 14px; color: #333; }
        .form-row { margin-bottom: 12px; }
        .checkbox-row { display: flex; align-items: center; margin-bottom: 8px; }
        .checkbox-row label { margin-bottom: 0; margin-left: 8px; font-weight: normal; }
        label { font-weight: bold; display: block; margin-bottom: 4px; font-size: 13px; }
        .current-text { font-size: 13px; color: #444; background-color: #f9f9f9; padding: 6px; border-radius: 4px; min-height: 21px; word-wrap: break-word; }
        .debug-code { font-size: 11px; color: #999; font-family: monospace; margin-top: 2px; }
        input[type="text"], input[type="url"], textarea, select { width: 100%; padding: 6px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        textarea { resize: vertical; }
        .tab-controls button { padding: 4px 8px; font-size: 12px; margin-left: 5px; }
        .navigation { position: fixed; bottom: 0; left: 0; width: 100%; padding: 10px 15px; background-color: #f8f9fa; border-top: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        #record-indicator { font-size: 13px; color: #555; }
        .hebrew { direction: rtl; text-align: right; }
        #edit-אזור {
            text-align: center;
            direction: rtl;
        }
        .preview-output {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 10px;
            min-height: 200px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 13px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <span id="header-sku" class="header-sku"></span>
            <span id="header-name-en" class="header-name"></span>
            <span id="header-year" class="header-name"></span>
        </div>
        <span id="header-name-he" class="header-name hebrew"></span>
    </div>

    <div class="container">
        <div class="tab-bar">
            <div class="tab active" onclick="openTab(event, 'descriptions')">Descriptions</div>
            <div class="tab" onclick="openTab(event, 'specs')">Specs</div>
            <div class="tab" onclick="openTab(event, 'attributes')">Attributes</div>
            <div class="tab" onclick="openTab(event, 'pairing')">Pairing</div>
            <div class="tab" onclick="openTab(event, 'grapes')">Grapes</div>
            <div class="tab" onclick="openTab(event, 'kashrut')">Kashrut</div>
            <div class="tab" onclick="openTab(event, 'preview')">Preview</div>
        </div>

        <div id="descriptions" class="tab-content active">
             <div class="tab-grid"><div class="column"><div class="column-header"><h5>Current</h5></div><div class="form-row"><label>תיאור קצר</label><div class="current-text hebrew" id="current-קצר"></div></div><div class="form-row"><label>תיאור ארוך</label><div class="current-text hebrew" id="current-תיאור ארוך"></div></div><div class="form-row"><label>Short Description</label><div class="current-text" id="current-Short"></div></div><div class="form-row"><label>Description</label><div class="current-text" id="current-Description"></div></div></div><div class="column"><div class="column-header"><h5>Edit</h5><div class="tab-controls"><button onclick="copyTabData('descriptions')">Fill →</button><button class="secondary" onclick="clearTabData('descriptions')">Clear</button></div></div><div class="form-row"><label for="edit-קצר">תיאור קצר</label><textarea class="hebrew" id="edit-קצר"></textarea></div><div class="form-row"><label for="edit-תיאור ארוך">תיאור ארוך</label><textarea class="hebrew" id="edit-תיאור ארוך"></textarea></div><div class="form-row"><label for="edit-Short">Short Description</label><textarea id="edit-Short"></textarea></div><div class="form-row"><label for="edit-Description">Description</label><textarea id="edit-Description"></textarea></div></div></div>
        </div>
        
        <div id="specs" class="tab-content">
            <div class="tab-grid"><div class="column"><div class="column-header"><h5>Current</h5></div><div class="form-row"><label>Region (אזור)</label><div class="current-text hebrew" id="current-אזור"></div></div><div class="form-row"><label>Alcohol by Volume</label><div class="current-text" id="current-ABV"></div></div><div class="form-row"><label>Size</label><div class="current-text" id="current-CMX SIZE"></div></div><div class="form-row"><label>Division</label><div class="current-text" id="current-CMX DIV"></div></div><div class="form-row"><label>Group</label><div class="current-text" id="current-CMX GROUP"></div></div><div class="form-row"><label>Year</label><div class="current-text" id="current-CMX YEAR"></div></div></div><div class="column"><div class="column-header"><h5>Edit</h5><div class="tab-controls"><button onclick="copyTabData('specs')">Fill →</button><button class="secondary" onclick="clearTabData('specs')">Clear</button></div></div><div class="form-row"><label for="edit-אזור">Region (אזור)</label><select class="hebrew" id="edit-אזור"></select></div><div class="form-row"><label for="edit-ABV">Alcohol by Volume (%)</label><input type="text" id="edit-ABV" list="abv-options"></div></div></div>
        </div>

        <div id="attributes" class="tab-content">
            <div class="tab-grid"><div class="column"><div class="column-header"><h5>Current</h5></div><div class="form-row"><label>Intensity</label><div class="current-text" id="current-Intensity"></div></div><div class="form-row"><label>Complexity</label><div class="current-text" id="current-Complexity"></div></div><div class="form-row"><label>Acidity</label><div class="current-text" id="current-Acidity"></div></div><div class="form-row"><label>Decant</label><div class="current-text" id="current-Decant"></div></div></div><div class="column"><div class="column-header"><h5>Edit</h5><div class="tab-controls"><button onclick="copyTabData('attributes')">Fill →</button><button class="secondary" onclick="clearTabData('attributes')">Clear</button></div></div><div class="form-row"><label for="edit-Intensity">Intensity (1-5)</label><select id="edit-Intensity"></select></div><div class="form-row"><label for="edit-Complexity">Complexity (1-5)</label><select id="edit-Complexity"></select></div><div class="form-row"><label for="edit-Acidity">Acidity (1-5)</label><select id="edit-Acidity"></select></div><div class="form-row"><label for="edit-Decant">Decant (minutes)</label><select id="edit-Decant"></select></div></div></div>
        </div>

        <div id="pairing" class="tab-content">
            <div class="tab-grid"><div class="column"><div class="column-header"><h5>Current</h5></div><label>Harmonize</label><div class="current-text" id="current-Harmonize"></div><br><label>Contrast</label><div class="current-text" id="current-Contrast"></div></div><div class="column"><div class="column-header"><h5>Edit</h5><div class="tab-controls"><button onclick="copyTabData('pairing')">Fill →</button><button class="secondary" onclick="clearTabData('pairing')">Clear</button></div></div><label>Harmonize With</label><div class="checkbox-row"><input type="checkbox" id="edit-Sweet Har"><label for="edit-Sweet Har">Sweet</label></div><div class="checkbox-row"><input type="checkbox" id="edit-Intense Har"><label for="edit-Intense Har">Intense</label></div><div class="checkbox-row"><input type="checkbox" id="edit-Rich Har"><label for="edit-Rich Har">Rich</label></div><div class="checkbox-row"><input type="checkbox" id="edit-Mild Har"><label for="edit-Mild Har">Mild</label></div><br><label>Contrast With</label><div class="checkbox-row"><input type="checkbox" id="edit-Sweet Con"><label for="edit-Sweet Con">Sweet</label></div><div class="checkbox-row"><input type="checkbox" id="edit-Intense Con"><label for="edit-Intense Con">Intense</label></div><div class="checkbox-row"><input type="checkbox" id="edit-Rich Con"><label for="edit-Rich Con">Rich</label></div><div class="checkbox-row"><input type="checkbox" id="edit-Mild Con"><label for="edit-Mild Con">Mild</label></div></div></div>
        </div>

        <div id="grapes" class="tab-content">
             <div class="tab-grid"><div class="column"><div class="column-header"><h5>Current</h5></div><div class="form-row"><label>Grape 1</label><div class="current-text" id="current-G1"></div></div><div class="form-row"><label>Grape 2</label><div class="current-text" id="current-G2"></div></div><div class="form-row"><label>Grape 3</label><div class="current-text" id="current-G3"></div></div><div class="form-row"><label>Grape 4</label><div class="current-text" id="current-G4"></div></div><div class="form-row"><label>Grape 5</label><div class="current-text" id="current-G5"></div></div></div><div class="column"><div class="column-header"><h5>Edit</h5><div class="tab-controls"><button onclick="copyTabData('grapes')">Fill →</button><button class="secondary" onclick="clearTabData('grapes')">Clear</button></div></div><div class="form-row"><label for="edit-G1">Grape 1</label><select id="edit-G1"></select></div><div class="form-row"><label for="edit-G2">Grape 2</label><select id="edit-G2"></select></div><div class="form-row"><label for="edit-G3">Grape 3</label><select id="edit-G3"></select></div><div class="form-row"><label for="edit-G4">Grape 4</label><select id="edit-G4"></select></div><div class="form-row"><label for="edit-G5">Grape 5</label><select id="edit-G5"></select></div></div></div>
        </div>

        <div id="kashrut" class="tab-content">
             <div class="tab-grid"><div class="column"><div class="column-header"><h5>Current</h5></div>
                <div class="form-row">
                    <label>Heter Mechira (היתר מכירה)</label>
                    <div class="current-text" id="current-היתר מכירה"></div>
                </div>
                 <div class="form-row"><label>Kashrut 1</label><div class="current-text" id="current-K1-text"></div><div class="debug-code">Code: <span id="current-K1-code"></span></div></div>
                 <div class="form-row"><label>Kashrut 2</label><div class="current-text" id="current-K2-text"></div><div class="debug-code">Code: <span id="current-K2-code"></span></div></div>
                 <div class="form-row"><label>Kashrut 3</label><div class="current-text" id="current-K3-text"></div><div class="debug-code">Code: <span id="current-K3-code"></span></div></div>
                 <div class="form-row"><label>Kashrut 4</label><div class="current-text" id="current-K4-text"></div><div class="debug-code">Code: <span id="current-K4-code"></span></div></div>
                 <div class="form-row"><label>Kashrut 5</label><div class="current-text" id="current-K5-text"></div><div class="debug-code">Code: <span id="current-K5-code"></span></div></div>
            </div><div class="column"><div class="column-header"><h5>Edit</h5><div class="tab-controls"><button onclick="copyTabData('kashrut')">Fill →</button><button class="secondary" onclick="clearTabData('kashrut')">Clear</button></div></div>
                  <div class="checkbox-row">
                      <input type="checkbox" id="edit-היתר מכירה">
                      <label for="edit-היתר מכירה">Heter Mechira (היתר מכירה)</label>
                  </div>
                 <div class="form-row"><label for="edit-K1">Kashrut 1</label><select id="edit-K1"></select></div>
                 <div class="form-row"><label for="edit-K2">Kashrut 2</label><select id="edit-K2"></select></div>
                 <div class="form-row"><label for="edit-K3">Kashrut 3</label><select id="edit-K3"></select></div>
                 <div class="form-row"><label for="edit-K4">Kashrut 4</label><select id="edit-K4"></select></div>
                 <div class="form-row"><label for="edit-K5">Kashrut 5</label><select id="edit-K5"></select></div>
            </div></div>
        </div>
        <div id="preview" class="tab-content">
            <div class="tab-grid">
                <div class="column">
                    <div class="column-header"><h5>English</h5></div>
                    <div class="preview-output" id="edited-english-preview"></div>
                </div>
                <div class="column">
                    <div class="column-header"><h5>Hebrew</h5></div>
                    <div class="preview-output hebrew" id="edited-hebrew-preview"></div> 
                </div>
            </div>
        </div>

        <datalist id="abv-options"></datalist>
        <datalist id="decant-options"></datalist>
        <div class="navigation">
            <div><button id="prev-btn" class="action" onclick="navigate('prev')">&lt; Previous</button><button id="next-btn" class="action" onclick="navigate('next')">Next &gt;</button></div>
            <div id="record-indicator"></div>
            <div><button class="action" id="submit-btn">Submit for Review</button><button id="close-btn" onclick="google.script.host.close()">Close</button></div>
        </div>
    </div>

    <script>
        let originalData = {}, allSkus = [], currentSkuIndex = -1, lookupMaps = {};
        const initialSku = "<?!= sku ?>";
        const selectedUser = "<?!= selectedUser ?>";

        window.onload = function() {
            console.log(`DetailsForm loaded for SKU: ${initialSku} with user filter: ${selectedUser}`);
            fetchAndDisplayData(initialSku);
        };
        
        function fetchAndDisplayData(sku) {
            document.getElementById('record-indicator').textContent = 'Loading...';
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.status === 'success') {
                        originalData = result;
                        
                        lookupMaps.grapes = new Map((originalData.lookupData.grapes || []).map(d => [String(d[0]).toUpperCase(), d[1]]));
                        lookupMaps.kashrut = new Map((originalData.lookupData.kashrut || []).map(d => [String(d[1]).toUpperCase(), d[2]]));
                        lookupMaps.regions = new Map((originalData.lookupData.regions || []).map(d => [d[0], d[1]]));
                        lookupMaps.texts_en = new Map((originalData.lookupData.texts || []).map(d => [d[0], d[1]]));
                        lookupMaps.texts_he = new Map((originalData.lookupData.texts || []).map(d => [d[0], d[2]]));
                        lookupMaps.grapes_en = lookupMaps.grapes; 
                        lookupMaps.kashrut_en = lookupMaps.kashrut; 
                        lookupMaps.regions_en = lookupMaps.regions; 
                        lookupMaps.grapes_he = new Map((originalData.lookupData.grapes || []).map(d => [String(d[0]).toUpperCase(), d[2]]));
                        lookupMaps.kashrut_he = new Map((originalData.lookupData.kashrut || []).map(d => [String(d[1]).toUpperCase(), d[3]]));
                        lookupMaps.regions_he = new Map((originalData.lookupData.regions || []).map(d => [d[0], d[0]]));
                        
                        displayHeader(result.productData);
                        displayAllMasterData(result.productData);
                        populateAllDropdowns(result.lookupData);
                        updateNavigation(sku);
                        setTimeout(alignFieldHeights, 0); 
                        updatePreviewTab();
                    } else { 
                        document.getElementById('record-indicator').textContent = `Error: ${result.message}`; 
                    }
                })
                .withFailureHandler(function(error) { 
                    document.getElementById('record-indicator').textContent = `Error: ${error.message}`; 
                })
                ._server_getProductDetailsForForm(sku);
        }

        function displayHeader(productData) {
            document.getElementById('header-sku').textContent = `SKU: ${productData['SKU'] || 'N/A'}`;
            document.getElementById('header-name-en').textContent = productData['NAME'] || '';
            document.getElementById('header-year').textContent = productData['CMX YEAR'] ? `- ${productData['CMX YEAR']}` : '';
            document.getElementById('header-name-he').textContent = productData['שם היין'] || '';
        }

        function displayAllMasterData(productData) {
            const textFields = ['Short', 'Description', 'קצר', 'תיאור ארוך', 'Intensity', 'Complexity', 'Acidity', 'Decant', 'CMX SIZE', 'CMX DIV', 'CMX GROUP', 'CMX YEAR'];
            textFields.forEach(f => { const el = document.getElementById(`current-${f}`); if (el) el.textContent = productData[f] || ''; });
            const currentRegionEl = document.getElementById('current-אזור');
            if (currentRegionEl) currentRegionEl.textContent = productData['אזור'] || '';
            const abvEl = document.getElementById('current-ABV');
            if (abvEl) { const abv = parseFloat(productData['ABV']); abvEl.textContent = !isNaN(abv) ? `${(abv * 100).toFixed(1)}%` : ''; }
            for (let i = 1; i <= 5; i++) {
                const gCode = productData[`G${i}`]?.toUpperCase();
                const gEl = document.getElementById(`current-G${i}`);
                if (gEl) gEl.textContent = lookupMaps.grapes.get(gCode) || '';
                const kCode = productData[`K${i}`]?.toUpperCase();
                const kTextEl = document.getElementById(`current-K${i}-text`);
                const kCodeEl = document.getElementById(`current-K${i}-code`);
                if (kTextEl) kTextEl.textContent = lookupMaps.kashrut.get(kCode) || '';
                if (kCodeEl) kCodeEl.textContent = productData[`K${i}`] || '';
            }
            const harFields = {'Sweet Har':'Sweet', 'Intense Har':'Intense', 'Rich Har':'Rich', 'Mild Har':'Mild'};
            const conFields = {'Sweet Con':'Sweet', 'Intense Con':'Intense', 'Rich Con':'Rich', 'Mild Con':'Mild'};
            document.getElementById('current-Harmonize').textContent = Object.keys(harFields).filter(f => productData[f] == 1).map(f => harFields[f]).join(', ');
            document.getElementById('current-Contrast').textContent = Object.keys(conFields).filter(f => productData[f] == 1).map(f => conFields[f]).join(', ');
            const hmEl = document.getElementById('current-היתר מכירה');
            if (hmEl) hmEl.textContent = productData['היתר מכירה'] == 1 ? 'Yes' : 'No';
        }

        function populateAllDropdowns(lookupData) {
            populateSelect(['edit-Intensity', 'edit-Complexity', 'edit-Acidity'], [[1,1],[2,2],[3,3],[4,4],[5,5]]);
            populateSelect(['edit-Decant'], [['', '-- Select --'],[15,15],[30,30],[45,45],[60,60]]);
            let abvOptions = []; 
            for (let i = 12.0; i <= 14.5; i += 0.5) { abvOptions.push(i.toFixed(1)); }
            populateDatalist('abv-options', abvOptions);
            if (!lookupData) return;
            populateSelect(['edit-אזור'], (lookupData.regions || []).map(d => [d[0], d[0]]));
            populateSelect(['edit-G1','edit-G2','edit-G3','edit-G4','edit-G5'], (lookupData.grapes || []).map(d => [String(d[0]).toUpperCase(), d[1]]));
            populateSelect(['edit-K1','edit-K2','edit-K3','edit-K4','edit-K5'], (lookupData.kashrut || []).map(k => [String(k[1]).toUpperCase(), k[2]]));
        }
        
        function populateSelect(selectIds, options) {
            if (!options) return;
            selectIds.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                select.innerHTML = '';
                select.appendChild(new Option('-- None --', ''));
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = Array.isArray(opt) ? opt[0] : opt;
                    option.textContent = Array.isArray(opt) ? (String(opt[1] || opt[0])) : String(opt);
                    select.appendChild(option);
                });
                select.selectedIndex = 0;
            });
        }

        function populateDatalist(datalistId, options) {
            const datalist = document.getElementById(datalistId);
            if (!datalist) return;
            datalist.innerHTML = '';
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                datalist.appendChild(option);
            });
        }
        
        function formatList(items, lastSeparator = ' or ', maxLength = 5) {
            if (!items || items.length === 0) return '';
            const filteredItems = items.filter(Boolean).slice(0, maxLength);
            if (filteredItems.length === 0) return '';
            if (filteredItems.length === 1) return filteredItems[0];
            const allButLast = filteredItems.slice(0, -1);
            const lastItem = filteredItems.slice(-1)[0];
            return `${allButLast.join(', ')}${lastSeparator}${lastItem}`;
        }

        function copyTabData(tabName) {
            const data = originalData.productData;
            if (!data) return;
            const fieldsByTab = {
                'descriptions': ['Short', 'Description', 'קצר', 'תיאור ארוך'], 'specs': ['אזור', 'ABV'], 'attributes': ['Intensity', 'Complexity', 'Acidity', 'Decant'],
                'pairing': ['Sweet Har', 'Intense Har', 'Rich Har', 'Mild Har', 'Sweet Con', 'Intense Con', 'Rich Con', 'Mild Con'], 'grapes': ['G1', 'G2', 'G3', 'G4', 'G5'], 'kashrut': ['K1', 'K2', 'K3', 'K4', 'K5']
            };
            if (!fieldsByTab[tabName]) return;
            fieldsByTab[tabName].forEach(f => {
                const el = document.getElementById(`edit-${f}`);
                if (!el) return;
                const valueFromData = data[f];
                if (el.type === 'checkbox') el.checked = (valueFromData == 1);
                else if (el.tagName === 'SELECT') {
                    let valueToSet = (valueFromData != null) ? String(valueFromData) : '';
                    if (f.startsWith('G') || f.startsWith('K')) valueToSet = valueToSet.toUpperCase();
                    el.value = valueToSet;
                    if (el.value !== valueToSet) el.selectedIndex = 0;
                } else if (f === 'ABV') {
                    const abvValue = parseFloat(valueFromData);
                    el.value = !isNaN(abvValue) ? (abvValue * 100).toFixed(1) : '';
                } else el.value = valueFromData || '';
            });
        }
        
        function clearTabData(tabName) {
            const fieldsByTab = {
                'descriptions': ['Short', 'Description', 'קצר', 'תיאור ארוך'], 'specs': ['אזור', 'ABV'], 'attributes': ['Intensity', 'Complexity', 'Acidity', 'Decant'],
                'pairing': ['Sweet Har', 'Intense Har', 'Rich Har', 'Mild Har', 'Sweet Con', 'Intense Con', 'Rich Con', 'Mild Con'], 'grapes': ['G1', 'G2', 'G3', 'G4', 'G5'], 'kashrut': ['K1', 'K2', 'K3', 'K4', 'K5']
            };
            if (!fieldsByTab[tabName]) return;
            fieldsByTab[tabName].forEach(f => {
                const el = document.getElementById(`edit-${f}`);
                if (!el) return;
                if (el.type === 'checkbox') el.checked = false;
                else if (el.tagName === 'SELECT') el.selectedIndex = 0; 
                else el.value = ''; 
            });
        }
        
        function alignFieldHeights() { const textAreas = ['קצר', 'תיאור ארוך', 'Short', 'Description']; textAreas.forEach(id => { const currentEl = document.getElementById(`current-${id}`); const editEl = document.getElementById(`edit-${id}`); if (currentEl && editEl) { editEl.style.height = `${currentEl.offsetHeight}px`; } }); }
        function updateNavigation(currentSku) { allSkus = (originalData.allSkus || []).map(String); currentSkuIndex = allSkus.indexOf(String(currentSku)); document.getElementById('record-indicator').textContent = `Record ${currentSkuIndex + 1} of ${allSkus.length}`; document.getElementById('prev-btn').disabled = (currentSkuIndex <= 0); document.getElementById('next-btn').disabled = (currentSkuIndex >= allSkus.length - 1); }
        function navigate(direction) { let newIndex = currentSkuIndex; if (direction === 'prev' && currentSkuIndex > 0) newIndex--; else if (direction === 'next' && currentSkuIndex < allSkus.length - 1) newIndex++; if (newIndex !== currentSkuIndex) { clearAllEditFields(); fetchAndDisplayData(allSkus[newIndex]); } }
        function clearAllEditFields() { const allTabs = ['descriptions', 'specs', 'attributes', 'pairing', 'grapes', 'kashrut']; allTabs.forEach(tab => clearTabData(tab)); }
        function openTab(evt, tabName) { 
            let tabcontent = document.getElementsByClassName("tab-content"); 
            for (let i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
            let tablinks = document.getElementsByClassName("tab"); 
            for (let i = 0; i < tablinks.length; i++) tablinks[i].className = tablinks[i].className.replace(" active", "");
            document.getElementById(tabName).style.display = "block"; 
            evt.currentTarget.className += " active"; 
            if (tabName === 'preview') updatePreviewTab();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const fieldsToMonitor = [ 'edit-Short', 'edit-Description', 'edit-Intensity', 'edit-Complexity', 'edit-Acidity', 'edit-Decant', 'edit-Sweet Har', 'edit-Intense Har', 'edit-Rich Har', 'edit-Mild Har', 'edit-Sweet Con', 'edit-Intense Con', 'edit-Rich Con', 'edit-Mild Con', 'edit-G1', 'edit-G2', 'edit-G3', 'edit-G4', 'edit-G5', 'edit-K1', 'edit-K2', 'edit-K3', 'edit-K4', 'edit-K5', 'edit-אזור', 'edit-ABV' ];
            fieldsToMonitor.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updatePreviewTab);
                    element.addEventListener('change', updatePreviewTab);
                }
            });
        });

        function updatePreviewTab() {
            document.getElementById('edited-english-preview').innerHTML = generateCompiledDescription('en');
            document.getElementById('edited-hebrew-preview').innerHTML = generateCompiledDescription('he');
        }
        
        function generateCompiledDescription(lang) {
    if (!originalData || !originalData.productData) return "";

    let editedData = {};
    const fieldsToGather = [ 'Short', 'Description', 'קצר', 'תיאור ארוך', 'אזור', 'ABV', 'Intensity', 'Complexity', 'Acidity', 'Decant', 'היתר מכירה', 'Sweet Har', 'Intense Har', 'Rich Har', 'Mild Har', 'Sweet Con', 'Intense Con', 'Rich Con', 'Mild Con', 'G1', 'G2', 'G3', 'G4', 'G5', 'K1', 'K2', 'K3', 'K4', 'K5' ];
    fieldsToGather.forEach(f => {
        const el = document.getElementById(`edit-${f}`);
        if (el) {
            if (el.type === 'checkbox') editedData[f] = el.checked ? 1 : 0;
            else editedData[f] = el.value || '';
        }
    });

    let staticData = originalData.productData;
    let compiledLines = [];

    // --- Language-specific configurations ---
    const isEn = lang === 'en';
    const productName = isEn ? staticData['NAME'] : (staticData['שם היין'] || staticData['NAME']);
    const longDescField = (isEn ? editedData['Description'] : editedData['תיאור ארוך']) || (isEn ? staticData['Description'] : staticData['תיאור ארוך']);
    const regionLabel = isEn ? 'Region' : 'אזור';
    const grapeLabel = isEn ? 'Grape(s)' : 'ענב(ים)';
    const kashrutLabel = isEn ? 'Kashrut' : 'כשרות';
    const vintageLabel = isEn ? 'Vintage' : 'בציר';
    const volumeLabel = isEn ? 'Volume' : 'נפח';
    const abvLabel = isEn ? 'ABV' : 'כוהל בנפח';
    const intensityLabel = isEn ? 'Intensity (1-5)' : 'עוצמה (מ-1 עד 5)';
    const complexityLabel = isEn ? 'Complexity (1-5)' : 'מורכבות (מ-1 עד 5)';
    const acidityLabel = isEn ? 'Acidity (1-5)' : 'חומציות (מ-1 עד 5)';
    const decantLabel = isEn ? 'Recommended decanting' : 'מומלץ לאוורור';
    const harmonizeLabel = isEn ? 'Harmonize with' : 'הרמוניה עם טעמים';
    const contrastLabel = isEn ? 'Contrast with' : 'קונטרסט עם טעמים';
    
    const textLookupMap = isEn ? lookupMaps.texts_en : lookupMaps.texts_he;
    const regionLookupMap = isEn ? lookupMaps.regions_en : lookupMaps.regions_he;
    const grapeLookupMap = isEn ? lookupMaps.grapes_en : lookupMaps.grapes_he;
    const kashrutLookupMap = isEn ? lookupMaps.kashrut_en : lookupMaps.kashrut_he;
    
    const harMapping = isEn ? {'Sweet Har':'sweet', 'Intense Har':'intense', 'Rich Har':'rich', 'Mild Har':'mild'}
                             : {'Sweet Har':'מתוקים', 'Intense Har':'עזים', 'Rich Har':'עשירים', 'Mild Har':'עדינים'};
    const conMapping = isEn ? {'Sweet Con':'sweet', 'Intense Con':'intense', 'Rich Con':'rich', 'Mild Con':'mild'}
                             : {'Sweet Con':'מתוקים', 'Intense Con':'עזים', 'Rich Con':'עשירים', 'Mild Con':'עדינים'};

    // **CORRECTED AREA 1: Define variables at the top level of the function**
    const heterMechira = editedData['היתר מכירה'] == 1;
    const heterMechiraText = isEn ? '*** Heter Mechira ***' : '*** היתר מכירה ***';

    // Section 1: Name and Descriptions
    let shortDescValue = (isEn ? editedData['Short'] : editedData['קצר']) || (isEn ? staticData['Short'] : staticData['קצר']);
    if (shortDescValue) {
        // This is the FIRST use of the variables
        if (heterMechira) {
            shortDescValue += ` ${heterMechiraText}`;
        }
        compiledLines.push(`${shortDescValue}<hr>`);
    }

    if (productName || longDescField) {
        compiledLines.push((productName ? `${productName} ` : '') + (longDescField ? longDescField.replace(/\n/g, '<br>') : ''));
    }

    const addSectionBreak = () => { if (compiledLines.length > 0 && compiledLines[compiledLines.length - 1] !== '') compiledLines.push(''); };

    // Section 2 & 3: Core Details, Attributes, and Pairings
    let combinedDetails = [];
    
    // -- Core Details --
    const groupKey = staticData['CMX GROUP'];
    if (groupKey && textLookupMap.has(groupKey)) combinedDetails.push(textLookupMap.get(groupKey));
    const year = staticData['CMX YEAR'];
    if (year) combinedDetails.push(`${vintageLabel}: ${year}`);
    const abv = parseFloat(editedData['ABV']);
    if (!isNaN(abv) && abv > 0) combinedDetails.push(`${abvLabel}: ${abv.toFixed(1)}%`);
    const size = staticData['CMX SIZE'];
    if (size) combinedDetails.push(`${volumeLabel}: ${size} ${isEn ? 'ML' : 'מ”ל'}`);
    const regionKey = editedData['אזור'];
    if (regionKey && regionLookupMap.has(regionKey)) combinedDetails.push(`${regionLabel}: ${regionLookupMap.get(regionKey)}`);
    const grapeNames = [editedData.G1, editedData.G2, editedData.G3, editedData.G4, editedData.G5]
        .map(g => String(g || '').toUpperCase()).filter(g => g && grapeLookupMap.has(g)).map(g => grapeLookupMap.get(g));
    if (grapeNames.length > 0) combinedDetails.push(`${grapeLabel}: ${formatList(grapeNames, ', ')}`);

    // -- Attributes and Pairings --
    const intensity = parseInt(editedData['Intensity']);
    if (!isNaN(intensity) && intensity > 0) combinedDetails.push(`${intensityLabel}: ${intensity}`);
    const complexity = parseInt(editedData['Complexity']);
    if (!isNaN(complexity) && complexity > 0) combinedDetails.push(`${complexityLabel}: ${complexity}`);
    const acidity = parseInt(editedData['Acidity']);
    if (!isNaN(acidity) && acidity > 0) combinedDetails.push(`${acidityLabel}: ${acidity}`);
    const harmonizes = Object.keys(harMapping).filter(f => editedData[f] == 1).map(f => harMapping[f]);
    if (harmonizes.length > 0) combinedDetails.push(`${harmonizeLabel}: ${formatList(harmonizes, (isEn ? ' or ' : ' או '))}${(isEn ? ' flavors' : '')}`);
    const contrasts = Object.keys(conMapping).filter(f => editedData[f] == 1).map(f => conMapping[f]);
    if (contrasts.length > 0) combinedDetails.push(`${contrastLabel}: ${formatList(contrasts, (isEn ? ' or ' : ' או '))}${(isEn ? ' flavors' : '')}`);
    const decant = parseInt(editedData['Decant']);
    if (!isNaN(decant) && decant > 0) combinedDetails.push(`${decantLabel} – ${decant} ${isEn ? 'minutes' : 'דקות'}`);
    
    if (combinedDetails.length > 0) {
        addSectionBreak();
        compiledLines.push(...combinedDetails);
    }

    // **CORRECTED AREA 2: The kashrut section with its own separate if-block**
    let kashrutSection = [];
    const kashrutNames = [editedData.K1, editedData.K2, editedData.K3, editedData.K4, editedData.K5]
        .map(k => String(k || '').toUpperCase())
        .filter(k => k && kashrutLookupMap.has(k))
        .map(k => kashrutLookupMap.get(k));

    if (kashrutNames.length > 0) {
        kashrutSection.push(`${kashrutLabel}: ${kashrutNames.join(', ')}`);
    }

    // This is the SECOND use of the variables
    if (heterMechira) {
        if (kashrutSection.length > 0) {
            kashrutSection[0] += ` ${heterMechiraText}`;
        } else {
            kashrutSection.push(heterMechiraText);
        }
    }

    if (kashrutSection.length > 0) {
        addSectionBreak();
        compiledLines.push(...kashrutSection);
    }

    return compiledLines.join('<br>');
}

    document.getElementById('submit-btn').addEventListener('click', handleSubmit);

    function handleSubmit() {
        const editedData = getEditedData();
        if (Object.keys(editedData).length === 0) {
            // Using a simple alert here as it's just an info message, not a confirmation.
            alert('No changes were detected to submit.');
            return;
        }
        // 1. Check for blank description fields
        const blankFields = [];
        const fieldsToCheck = {
            'edit-קצר': 'תיאור קצר',
            'edit-תיאור ארוך': 'תיאור ארוך',
            'edit-Short': 'Short Description',
            'edit-Description': 'Description'
        };

        for (const id in fieldsToCheck) {
            const element = document.getElementById(id);
            // Check if the element exists and its value is empty after trimming whitespace
            if (element && element.value.trim() === '') {
                blankFields.push(fieldsToCheck[id]);
            }
        }

        // 2. Build a dynamic confirmation message
        let confirmationMessage = 'Are you sure you want to submit these edits for review?';
        if (blankFields.length > 0) {
            // If there are blank fields, add a warning to the message.
            // The '\n' creates a new line in the pop-up dialog.
            confirmationMessage += '\n\n⚠️ Warning: The following description fields are blank:\n- ' + blankFields.join('\n- ');
        }

        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true; // Disable button while confirming

        // Call the new server-side confirmation dialog
        google.script.run
            .withSuccessHandler(function(response) {
                if (response === 'YES') {
                    // If user clicked "Yes", proceed with submission
                    submitBtn.textContent = 'Submitting...';
                    google.script.run
                        .withSuccessHandler(function(submitResult) {
                            if (submitResult.status === 'success') {
                                // The polling mechanism in the parent will handle the UI refresh.
                                google.script.host.close();
                            } else {
                                alert('Submission failed: ' + submitResult.message);
                                submitBtn.disabled = false;
                                submitBtn.textContent = 'Submit for Review';
                            }
                        })
                        .withFailureHandler(function(error) {
                            alert('An error occurred during submission: ' + error.message);
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Submit for Review';
                        })
                        ._server_submitProductDetails(originalData.productData['SKU'], editedData, selectedUser);
                } else {
                    // If user clicked "No" or closed the dialog, re-enable the button.
                    submitBtn.disabled = false;
                }
            })
            ._server_showConfirmationDialog(confirmationMessage);
    }
    
    function getEditedData() {
        const data = {};
        const fieldsToGather = ['SKU', 'שם היין', 'NAME', 'קצר', 'Short', 'תיאור ארוך', 'Description', 'אזור', 'ABV', 'Intensity', 'Complexity', 'Acidity', 'Sweet Con', 'Intense Con', 'Rich Con', 'Mild Con', 'Sweet Har', 'Intense Har', 'Rich Har', 'Mild Har', 'Decant', 'היתר מכירה', 'K1', 'K2', 'K3', 'K4', 'K5', 'G1', 'G2', 'G3', 'G4', 'G5'];

        fieldsToGather.forEach(f => {
            const el = document.getElementById(`edit-${f}`);
            const originalValue = originalData.productData[f] !== undefined ? String(originalData.productData[f]).trim() : '';

            let editedValue = '';
            if (el) {
                if (el.type === 'checkbox') {
                    editedValue = el.checked ? 1 : '';
                    if (String(editedValue) !== originalValue) {
                        data[f] = editedValue;
                    }
                } else if (f === 'ABV') {
                  const abvInput = el.value.trim();
                  
                  // Format the input as a string with a '%' sign, or as an empty string.
                  editedValue = (abvInput !== '') ? `${abvInput}%` : '';

                  // If the newly formatted string is different from the original, add it to the data to be submitted.
                  if (editedValue !== originalValue) {
                      data[f] = editedValue;
                  }
              } else {
                    editedValue = el.value.trim();
                    if (f.startsWith('K') || f.startsWith('G')) {
                        if (editedValue !== originalValue) {
                             data[f] = editedValue;
                        }
                    } else {
                        if (editedValue !== originalValue) {
                            data[f] = editedValue;
                        }
                    }
                }
            } else if (originalValue !== '') {
                data[f] = originalValue;
            }
        });

        if (originalData.productData['SKU'] !== undefined) {
            data['SKU'] = originalData.productData['SKU'];
        }

        return data;
    }
    </script>
</body>
</html>