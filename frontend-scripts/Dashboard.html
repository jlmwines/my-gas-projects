<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <style>
        /* General body and container styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        .container {
            padding: 8px;
        }

        /* Accordion styles */
        .accordion-button {
            background-color: #e9eef6;
            color: #444;
            cursor: pointer;
            padding: 12px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 14px;
            transition: 0.4s;
            border-radius: 4px;
            margin-top: 5px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .accordion-button:hover, .accordion-button.active {
            background-color: #d0d9e8;
        }
        
        .accordion-button::after {
            content: '\25B6'; /* Right-pointing triangle */
            font-size: 10px;
            color: #777;
            transition: transform 0.3s;
        }

        .accordion-button.active::after {
            transform: rotate(90deg); /* Down-pointing triangle */
        }

        .panel {
            padding: 0 15px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
        }
        
        .panel-content {
            padding: 15px 0;
        }

        /* Styles for the "New Products" section */
        #new-product-needs-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #new-product-needs-list li {
            padding: 8px 5px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        #new-product-needs-list li:hover {
            background-color: #f1f3f4;
        }
        
        #new-product-needs-list li a {
            text-decoration: none;
            color: #1a73e8;
        }
        
        .submit-button-container {
            margin-top: 15px;
            text-align: center;
        }

    </style>
</head>
<body>
    <div class="container">
        <button class="accordion-button">Orders</button>
        <div class="panel">
            <div class="panel-content">
                <div id="orders-link-container" style="font-size: 13px; padding: 0 5px; margin-bottom: 10px;">
                    <a id="refresh-orders-link" href="#" onclick="refreshPackingList(event)" style="text-decoration: none; color: #1a73e8; cursor: pointer;">Checking for open orders...</a>
                </div>
                <div id="packing-message" class="message-area" style="display: none;"></div>
                <div style="text-align: center; margin-top: 5px;">
                    <button id="generate-packing-selected-btn" class="action" onclick="generatePackingSlips('selected')" style="display: none;">Create Selected</button>
                    <button id="generate-packing-all-btn" class="action" onclick="generatePackingSlips('all')" style="display: none;">Create All</button>
                </div>
            </div>
        </div>

        <button class="accordion-button">Product Counts</button>
        <div class="panel">
            <div class="panel-content">
                <div id="product-counts-link-container" style="font-size: 13px; padding: 0 5px; margin-bottom: 10px;">
                    <a id="load-counts-link" href="#" onclick="loadInventoryTasks(event)" style="text-decoration: none; color: #1a73e8; cursor: pointer;">Checking for count tasks...</a>
                </div>
                <div id="inventory-message" class="message-area"></div>
                <div style="text-align: center;">
                    <button id="submit-inventory-btn" class="action" onclick="submitInventoryCounts()" style="display: none;">Submit Product Counts</button>
                </div>
                
                <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0 15px 0;">

                <div style="display: flex; gap: 10px; justify-content: center;">
                  <button id="sync-comax-btn" class="action" onclick="syncComaxDirectory()" style="flex: 1;">Sync Comax</button>
                  <button id="load-brurya-btn" class="action" onclick="loadBruryaSheet()" style="flex: 1;">Brurya Count</button> 
                </div>
                <div style="text-align: center; margin-top: 5px;">
                     <button id="submit-brurya-btn" class="action" onclick="submitBruryaCounts()" style="display: none;">Submit Brurya Counts</button>
                </div>
            </div>
        </div>

        <button class="accordion-button">Product Details</button>
        <div class="panel">
            <div class="panel-content">
                <div id="product-details-link-container" style="font-size: 13px; padding: 0 5px; margin-bottom: 10px;">
                    <a id="list-updates-link" href="#" onclick="listProductDetailTasks(event)" style="text-decoration: none; color: #1a73e8; cursor: pointer;">Checking for product updates...</a>
                </div>
                <div id="new-product-task-link-container" style="font-size: 13px; padding: 0 5px; margin-bottom: 10px; margin-top: 10px;">
                    <a id="list-new-products-link" href="#" onclick="listNewProductTasks(event)" style="text-decoration: none; color: #1a73e8; cursor: pointer;">Checking for new products...</a>
                </div>
                <div id="details-message" class="message-area"></div>
                <div style="text-align: center; margin-top: 5px;">
                    <button id="view-details-btn" class="action" onclick="viewProductDetails()" style="display: none;">View / Edit Details</button>
                </div>
            </div>
        </div>

        <button class="accordion-button">New Products</button>
        <div class="panel">
            <div class="panel-content">
                <ul id="new-product-needs-list">
                    <li>Loading needs...</li>
                </ul>
                <div class="action-links" style="padding: 0 5px; margin-top: 15px; font-size: 13px;">
                    <div>
                        <a id="show-optional-link" href="#" onclick="showOptionalWines(event)" style="text-decoration: none; color: #1a73e8; cursor: pointer;">Add New Wines</a>
                    </div>
                    <div style="margin-top: 8px;">
                        <a id="show-other-products-link" href="#" onclick="showOtherProducts(event)" style="text-decoration: none; color: #1a73e8; cursor: pointer;">Add Other Products</a>
                    </div>
                </div>
                <div class="submit-button-container">
                    <button class="action" id="submit-suggestions-btn">Submit Suggestions</button>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
          <button class="action" onclick="refreshSidebar()">Refresh Sidebar</button>
        </div>
    </div>

  <script>
    function refreshSidebar() {
        // Hide buttons that might have been revealed
        document.getElementById('generate-packing-selected-btn').style.display = 'none';
        document.getElementById('generate-packing-all-btn').style.display = 'none';
        document.getElementById('submit-inventory-btn').style.display = 'none';
        document.getElementById('submit-brurya-btn').style.display = 'none';
        document.getElementById('view-details-btn').style.display = 'none';

        // Clear messages
        clearMessage('packing-message');
        clearMessage('inventory-message');
        clearMessage('details-message');

        // --- Run all startup data fetches ---
        google.script.run.withSuccessHandler(updateOrderCountLink).withFailureHandler(handleOrderCountLinkError).getOpenOrderCount();
        google.script.run.withSuccessHandler(updateProductCountLink).withFailureHandler(handleProductCountLinkError).getProductCountTasks();
        google.script.run.withSuccessHandler(updateProductDetailLink).withFailureHandler(handleProductDetailLinkError).getProductDetailTaskCount();
        google.script.run.withSuccessHandler(updateNewProductLink).withFailureHandler(handleNewProductLinkError).getNewProductTaskCount();
        fetchStockHealthNeeds();
        google.script.run.activateHomeSheet();
    }

    // --- Combined Page Initialization ---
    document.addEventListener("DOMContentLoaded", function() {
        // 1. Initialize accordions
        const accordions = document.getElementsByClassName("accordion-button");
        for (let i = 0; i < accordions.length; i++) {
            accordions[i].addEventListener("click", function() {
                this.classList.toggle("active");
                const panel = this.nextElementSibling;
                if (panel.style.maxHeight) {
                    panel.style.maxHeight = null;
                } else {
                    panel.style.maxHeight = (panel.scrollHeight + 60) + "px";
                }
            });
        }
        
        // 2. Add event listener for the Submit button
        document.getElementById('submit-suggestions-btn').addEventListener('click', submitSuggestions);
        
        // --- Run all startup data fetches ---
        google.script.run.withSuccessHandler(updateOrderCountLink).withFailureHandler(handleOrderCountLinkError).getOpenOrderCount();
        google.script.run.withSuccessHandler(updateProductCountLink).withFailureHandler(handleProductCountLinkError).getProductCountTasks();
        google.script.run.withSuccessHandler(updateProductDetailLink).withFailureHandler(handleProductDetailLinkError).getProductDetailTaskCount();
        google.script.run.withSuccessHandler(updateNewProductLink).withFailureHandler(handleNewProductLinkError).getNewProductTaskCount();
        fetchStockHealthNeeds();
        google.script.run.activateHomeSheet();
    });

    function updateNewProductLink(result) {
        const count = result.data.count;
        const link = document.getElementById('list-new-products-link');
        const panelButton = link.closest('.panel').previousElementSibling;
        if (count > 0) {
            link.innerHTML = `<strong>${count} New Product(s) Available</strong>`;
            if (!panelButton.classList.contains('active')) panelButton.click();
        } else {
            link.textContent = 'No new products to add.';
        }
    }
    function handleNewProductLinkError(error) {
        document.getElementById('list-new-products-link').textContent = 'Error loading new products.';
    }

    function updateProductDetailLink(result) {
        const count = result.data.count;
        const link = document.getElementById('list-updates-link');
        const panelButton = link.closest('.panel').previousElementSibling;
        if (count > 0) {
            link.innerHTML = `<strong>${count} Product Update(s) Available</strong>`;
            if (!panelButton.classList.contains('active')) panelButton.click();
        } else {
            link.textContent = 'No pending product updates.';
        }
    }
    function handleProductDetailLinkError(error) {
        document.getElementById('list-updates-link').textContent = 'Error loading updates.';
    }

    function updateProductCountLink(result) {
        const count = result.data.count;
        const link = document.getElementById('load-counts-link');
        const panelButton = link.closest('.panel').previousElementSibling;
        if (count > 0) {
            link.innerHTML = `<strong>Review ${count} Product Count(s)</strong>`;
            if (!panelButton.classList.contains('active')) panelButton.click();
        } else {
            link.textContent = 'No pending product counts.';
        }
    }
    function handleProductCountLinkError(error) {
        document.getElementById('load-counts-link').textContent = 'Error loading counts.';
    }

    function updateOrderCountLink(result) {
        if (!result || !result.data) {
             document.getElementById('refresh-orders-link').textContent = 'Error loading order count.';
             return;
        }
        const count = result.data.count;
        const link = document.getElementById('refresh-orders-link');
        const ordersButton = link.closest('.panel').previousElementSibling;
        if (count > 0) {
            link.innerHTML = `<strong>View ${count} Open Order(s)</strong>`;
            if (!ordersButton.classList.contains('active')) ordersButton.click();
        } else {
            link.textContent = 'No open orders.';
        }
    }
    function handleOrderCountLinkError(error) {
        document.getElementById('refresh-orders-link').textContent = 'Error loading order count.';
    }

    // --- UI Helpers ---
    function showMessage(elementId, message, isError = false) {
        const element = document.getElementById(elementId);
        if (!element) return;
        element.innerHTML = message;
        element.className = 'message-area ' + (isError ? 'error-message' : 'success-message');
    }

    function clearMessage(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;
        element.textContent = '';
        element.className = 'message-area';
    }

    function displayError(error) {
        const list = document.getElementById('new-product-needs-list');
        list.innerHTML = `<li style="color: red;">Error: ${error.message}</li>`;
    }

    // --- New Products Workflow ---
    function fetchStockHealthNeeds() {
        const list = document.getElementById('new-product-needs-list');
        list.innerHTML = '<li>Loading needs...</li>';
        google.script.run.withSuccessHandler(displayNeeds).withFailureHandler(displayError).getStockHealthNeeds();
    }

    function displayNeeds(result) {
        const list = document.getElementById('new-product-needs-list');
        if (result.status !== 'success') {
            displayError({ message: result.message });
            return;
        }
        const needs = result.data;
        if (needs.length === 0) {
            list.innerHTML = '<li>All stock health checks passed.</li>';
        } else {
            list.innerHTML = '';
            for (let i = 0; i < needs.length; i++) {
                const need = needs[i];
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = '#';
                link.textContent = `${need.description} is low. Needs ${need.deficiency} more.`;
                link.onclick = function(event) {
                    event.preventDefault();
                    this.textContent = 'Filtering...';
                    google.script.run.withSuccessHandler(() => { fetchStockHealthNeeds(); }).withFailureHandler(displayError).populateAndFilterNewProducts(need.filter);
                };
                listItem.appendChild(link);
                list.appendChild(listItem);
            }
        }
        const panel = list.closest('.panel');
        if (panel && panel.style.maxHeight) {
            panel.style.maxHeight = (panel.scrollHeight + 60) + "px";
        }
    }

    function showOptionalWines(event) {
        event.preventDefault();
        const list = document.getElementById('new-product-needs-list');
        list.innerHTML = '<li>Loading optional wines...</li>';
        google.script.run
            .withSuccessHandler(function(result) {
                if (result && result.status === 'success') {
                    list.innerHTML = `<li style="color: #155724;">${result.message}</li>`;
                    setTimeout(fetchStockHealthNeeds, 3000);
                } else {
                    const errorMessage = result ? result.message : 'An unknown error occurred.';
                    list.innerHTML = `<li style="color: #721c24;">Error: ${errorMessage}</li>`;
                }
            })
            .withFailureHandler(displayError)
            .populateOptionalWines();
    }

    function showOtherProducts(event) {
        event.preventDefault();
        const list = document.getElementById('new-product-needs-list');
        list.innerHTML = '<li>Loading other products...</li>';
        google.script.run
            .withSuccessHandler(function(result) {
                if (result && result.status === 'success') {
                    list.innerHTML = `<li style="color: #155724;">${result.message}</li>`;
                    setTimeout(fetchStockHealthNeeds, 3000);
                } else {
                    const errorMessage = result ? result.message : 'An unknown error occurred.';
                    list.innerHTML = `<li style="color: #721c24;">Error: ${errorMessage}</li>`;
                }
            })
            .withFailureHandler(displayError)
            .populateOtherProducts();
    }

    function submitSuggestions() {
        const list = document.getElementById('new-product-needs-list');
        list.innerHTML = '<li>Submitting suggestions...</li>';
        document.getElementById('submit-suggestions-btn').disabled = true;
        google.script.run
            .withSuccessHandler(function(result) {
                document.getElementById('submit-suggestions-btn').disabled = false;
                if (result && result.status === 'success') {
                    list.innerHTML = `<li style="color: #155724;">${result.message}</li>`;
                    setTimeout(fetchStockHealthNeeds, 3000);
                } else {
                    const errorMessage = result ? result.message : 'An unknown error occurred.';
                    list.innerHTML = `<li style="color: #721c24;">Error: ${errorMessage}</li>`;
                    setTimeout(fetchStockHealthNeeds, 4000);
                }
            })
            .withFailureHandler(function(error) {
                document.getElementById('submit-suggestions-btn').disabled = false;
                displayError(error);
            })
            .createNewProductTasks();
    }

    // --- Packing Slip Workflow ---
    function refreshPackingList(event) {
        if (event) event.preventDefault();
        const packingMessage = document.getElementById('packing-message');
        const createSelectedBtn = document.getElementById('generate-packing-selected-btn');
        const createAllBtn = document.getElementById('generate-packing-all-btn');
        packingMessage.style.display = 'block';
        createSelectedBtn.style.display = 'inline-block';
        createAllBtn.style.display = 'inline-block';
        createSelectedBtn.disabled = true;
        createAllBtn.disabled = true;
        clearMessage('packing-message');
        document.body.style.cursor = 'wait';
        showMessage('packing-message', 'Refreshing packing list...');
        const panel = packingMessage.closest('.panel');
        if (panel && panel.style.maxHeight) {
            panel.style.maxHeight = (panel.scrollHeight + 60) + "px";
             setTimeout(() => {
              panel.style.maxHeight = (panel.scrollHeight + 60) + "px";
              }, 300);
        }
        google.script.run
            .withSuccessHandler(function(result) {
                document.body.style.cursor = 'default';
                showMessage('packing-message', result.message, result.status !== 'success');
                if (result.status === 'success') {
                    createSelectedBtn.disabled = false;
                    createAllBtn.disabled = false;
                }
            })
            .withFailureHandler(function(error) {
                document.body.style.cursor = 'default';
                showMessage('packing-message', `Error refreshing list: ${error.message}`, true);
            })
            .refreshAndWritePackingListServer();
    }

    function generatePackingSlips(type) {
        showMessage('packing-message', `Generating packing slips for ${type} orders...`);
        document.body.style.cursor = 'wait';
        function handleSuccess(result) {
            document.body.style.cursor = 'default';
            if (result.status !== 'success') {
                showMessage('packing-message', result.message, true);
                return;
            }
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = result.message;
            const links = tempDiv.querySelectorAll('a');
            if (links.length > 0) {
                links.forEach(link => window.open(link.href, '_blank'));
                showMessage('packing-message', 'Documents created. Check pop-ups.', false);
            } else {
                showMessage('packing-message', result.message, false);
            }
            google.script.run.withSuccessHandler(updateOrderCountLink).getOpenOrderCount();
        }
        function handleError(error) {
            document.body.style.cursor = 'default';
            showMessage('packing-message', `Error generating slips: ${error.message}`, true);
        }
        if (type === 'all') {
            google.script.run.withSuccessHandler(handleSuccess).withFailureHandler(handleError).generatePackingDocs([]);
        } else {
            google.script.run.withSuccessHandler(handleSuccess).withFailureHandler(handleError).processSelectedOrdersServer();
        }
    }

    // --- Inventory / Product Counts Workflow ---
    function loadInventoryTasks(event) {
        if (event) event.preventDefault();
        document.getElementById('submit-inventory-btn').style.display = 'none';
        clearMessage('inventory-message');
        document.body.style.cursor = 'wait';
        showMessage('inventory-message', 'Loading inventory tasks...');
        google.script.run
            .withSuccessHandler(function(result) {
                if (result.status === 'success') {
                    google.script.run
                        .withSuccessHandler(function() {
                            document.body.style.cursor = 'default';
                            showMessage('inventory-message', result.message || 'Inventory tasks loaded.', false);
                            if (result.data && result.data.length > 0) {
                                document.getElementById('submit-inventory-btn').style.display = 'block';
                            }
                        })
                        .withFailureHandler(function(error) {
                            document.body.style.cursor = 'default';
                            showMessage('inventory-message', `Error writing to sheet: ${error.message}`, true);
                        })
                        .writeInventoryDataToSheet(result.data);
                } else {
                    document.body.style.cursor = 'default';
                    showMessage('inventory-message', result.message || 'Failed to load tasks.', true);
                }
            })
            .withFailureHandler(function(error) {
                document.body.style.cursor = 'default';
                showMessage('inventory-message', `Error loading tasks: ${error.message}`, true);
            })
            .loadInventoryTasksServer('All Users');
    }

    function submitInventoryCounts() {
        clearMessage('inventory-message');
        document.body.style.cursor = 'wait';
        showMessage('inventory-message', 'Submitting inventory counts...');
        google.script.run
            .withSuccessHandler(function(sheetData) {
                const inventoryUpdates = sheetData.map(row => ({
                    sku: row[2], brurya: row[6], storage: row[7], office: row[8], shop: row[9]
                })).filter(item => item.sku && (item.storage !== '' || item.office !== '' || item.shop !== ''));
                if (inventoryUpdates.length === 0) {
                    document.body.style.cursor = 'default';
                    showMessage('inventory-message', 'No new quantities entered. Submission cancelled.', true);
                    return;
                }
                google.script.run
                    .withSuccessHandler(function(result) {
                        document.body.style.cursor = 'default';
                        showMessage('inventory-message', result.message, result.status !== 'success');
                        if (result.status === 'success') {
                             google.script.run.withSuccessHandler(updateProductCountLink).getProductCountTasks();
                             document.getElementById('submit-inventory-btn').style.display = 'none';
                        }
                    })
                    .withFailureHandler(function(error) {
                        document.body.style.cursor = 'default';
                        showMessage('inventory-message', `Error submitting counts: ${error.message}`, true);
                    })
                    .submitInventoryCountsServer(inventoryUpdates);
            })
            .withFailureHandler(function(error) {
                document.body.style.cursor = 'default';
                showMessage('inventory-message', `Error reading sheet for submission: ${error.message}`, true);
            })
            .getInventorySheetData();
    }
    
    function syncComaxDirectory() {
        clearMessage('inventory-message');
        document.body.style.cursor = 'wait';
        showMessage('inventory-message', 'Syncing Comax directory...');
        google.script.run
            .withSuccessHandler(function(result) {
                document.body.style.cursor = 'default';
                showMessage('inventory-message', result.message, result.status !== 'success');
            })
            .withFailureHandler(function(error) {
                document.body.style.cursor = 'default';
                showMessage('inventory-message', `Error syncing Comax: ${error.message}`, true);
            })
            .getComaxData();
    }

    function loadBruryaSheet() {
        document.getElementById('submit-brurya-btn').style.display = 'none';
        clearMessage('inventory-message');
        document.body.style.cursor = 'wait';
        showMessage('inventory-message', 'Loading Brurya sheet...');
        google.script.run
            .withSuccessHandler(function(result) {
                document.body.style.cursor = 'default';
                showMessage('inventory-message', result.message, result.status !== 'success');
                if (result.status === 'success') {
                    document.getElementById('submit-brurya-btn').style.display = 'inline-block';
                }
            })
            .withFailureHandler(function(error) {
                document.body.style.cursor = 'default';
                showMessage('inventory-message', `Error loading Brurya sheet: ${error.message}`, true);
            })
            .loadBruryaSheetServer();
    }

    async function submitBruryaCounts() {
        clearMessage('inventory-message');
        document.body.style.cursor = 'wait';
        showMessage('inventory-message', 'Submitting Brurya counts...');
        try {
            const sheetData = await new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getBruryaSheetData();
            });
            const dataToSubmit = sheetData.filter(row => row[0]);
            if (dataToSubmit.length === 0) {
                throw new Error("No items found in Brurya sheet to submit.");
            }
            const result = await new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).submitBruryaCountsViaUrlFetchServer(dataToSubmit);
            });
            document.body.style.cursor = 'default';
            showMessage('inventory-message', result.message, result.status !== 'success');
            if (result.submissionOccurred) {
                loadBruryaSheet();
            }
        } catch (error) {
            document.body.style.cursor = 'default';
            showMessage('inventory-message', `Error submitting Brurya counts: ${error.message}`, true);
        }
    }

    // --- Product Details Workflow ---
    function listNewProductTasks(event) {
      if (event) event.preventDefault(); 
        document.getElementById('view-details-btn').disabled = true;
        clearMessage('details-message');
        document.body.style.cursor = 'wait';
        showMessage('details-message', 'Fetching new product tasks...');
        google.script.run
            .withSuccessHandler(function(result) {
                document.body.style.cursor = 'default';
                showMessage('details-message', result.message || 'Task list processed.', result.status !== 'success');
                if (result.status === 'success' && result.data && result.data.length > 0) {
                    const viewBtn = document.getElementById('view-details-btn');
                     viewBtn.disabled = false;
                     viewBtn.style.display = 'inline-block';
                }
            })
            .withFailureHandler(function(error) {
                document.body.style.cursor = 'default';
                showMessage('details-message', `Error fetching tasks: ${error.message}`, true);
            })
            .getNewProductTasks('All Users');
    }   

    function listProductDetailTasks(event) {
      if (event) event.preventDefault(); 
        document.getElementById('view-details-btn').disabled = true;
        clearMessage('details-message');
        document.body.style.cursor = 'wait';
        showMessage('details-message', 'Fetching product update tasks...');
        google.script.run
            .withSuccessHandler(function(result) {
                document.body.style.cursor = 'default';
                showMessage('details-message', result.message || 'Task list processed.', result.status !== 'success');
                if (result.status === 'success' && result.data && result.data.length > 0) {
                    const viewBtn = document.getElementById('view-details-btn');
                     viewBtn.disabled = false;
                     viewBtn.style.display = 'inline-block';
                }
            })
            .withFailureHandler(function(error) {
                document.body.style.cursor = 'default';
                showMessage('details-message', `Error fetching tasks: ${error.message}`, true);
            })
            .getProductDetailTasks('All Users');
    }   

    function viewProductDetails() {
        showMessage('details-message', 'Getting selected product...', false);
        document.body.style.cursor = 'wait';
        google.script.run
            .withSuccessHandler(function(result) {
                if (result.status === 'success' && result.sku) {
                    showMessage('details-message', `Opening editor for ${result.sku}...`, false);
                    google.script.run
                        .withSuccessHandler(function() {
                            document.body.style.cursor = 'default';
                            const pollInterval = setInterval(function() {
                                google.script.run
                                    .withSuccessHandler(function(isComplete) {
                                        if (isComplete) {
                                            clearInterval(pollInterval);
                                            // After modal is closed, refresh the count and the list.
                                            google.script.run.withSuccessHandler(updateProductDetailLink).getProductDetailTaskCount();
                                            listProductDetailTasks();
                                        }
                                    })
                                    ._server_checkModalStatus();
                            }, 2000);
                        })
                        .withFailureHandler(function(error) {
                            document.body.style.cursor = 'default';
                            showMessage('details-message', `Error opening form: ${error.message}`, true);
                        })
                        .showDetailsForm(result.sku, 'All Users');
                } else {
                    document.body.style.cursor = 'default';
                    showMessage('details-message', result.message, true);
                }
            })
            .withFailureHandler(function(error) {
                document.body.style.cursor = 'default';
                showMessage('details-message', `Error getting selection: ${error.message}`, true);
            })
            .getSkuFromActiveCell();
    }
</script>

</body>
</html>
